<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î™©Ìè¨Ïãú ÌÜµÌï©ÎèÑÏÑúÍ¥Ä ÌôàÌéòÏù¥ÏßÄ Í∞úÌé∏ ÌòÑÌô© Í¥ÄÎ¶¨</title>
    
    <!-- Supabase JavaScript Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #8d6e63 0%, #5d4037 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .login-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 450px;
            width: 90%;
            text-align: center;
        }

        .login-header h2 {
            color: #8d6e63;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .login-header p {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .login-tabs {
            display: flex;
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
        }

        .login-tab {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .login-tab.active {
            background: #8d6e63;
            color: white;
        }

        .login-form .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .login-form label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .login-form input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .login-form input:focus {
            outline: none;
            border-color: #8d6e63;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #8d6e63, #a1887f);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(141, 110, 99, 0.3);
        }

        .login-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #8d6e63;
        }

        .login-info p {
            margin: 5px 0;
            font-size: 12px;
            color: #666;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #f5f3f0 0%, #e8e2db 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.08);
            border: 1px solid #d7ccc8;
        }

        .mokpo-header {
            background: rgba(139, 115, 85, 0.95);
            color: white;
            padding: 15px 30px;
            margin: -30px -30px 20px -30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .mokpo-header .logo {
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mokpo-header .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }

        .user-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .user-badge.admin {
            background: #28a745;
            color: white;
        }

        .user-badge.viewer {
            background: #17a2b8;
            color: white;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #8d6e63;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin: 0;
        }

        .status-indicator-inline {
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .status-indicator-inline:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .status-indicator-inline.clickable {
            cursor: pointer;
            user-select: none;
        }

        .status-indicator-inline.clickable:hover {
            background: linear-gradient(45deg, #20c997, #17a2b8);
        }

        .status-indicator-inline.clickable:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .readonly-notice {
            background: linear-gradient(45deg, #17a2b8, #20c997);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            display: none;
            line-height: 1.6;
        }

        .editing-indicator {
            background: linear-gradient(45deg, #ff9800, #f57c00);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            animation: pulse 2s infinite;
        }

        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(40, 167, 69, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1000;
            display: none;
            backdrop-filter: blur(10px);
        }

        .conflict-warning {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            display: none;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1px;
            background: #e9ecef;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }

        .menu-column {
            background: white;
            min-height: 400px;
        }

        .menu-header {
            background: linear-gradient(45deg, #8d6e63, #a1887f);
            color: white;
            padding: 15px 12px;
            font-weight: 700;
            font-size: 16px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .menu-header:hover {
            background: linear-gradient(45deg, #6d4c41, #8d6e63);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .menu-header.active {
            background: linear-gradient(45deg, #4caf50, #66bb6a);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .menu-header::after {
            content: "üìÇ";
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
        }

        .menu-header.active::after {
            content: "üìÇ‚úÖ";
        }

        .menu-item {
            padding: 10px 12px;
            border-bottom: 1px solid #f8f9fa;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
            color: #333;
            text-align: center;
            position: relative;
        }

        .menu-item:hover {
            background: #f8f9fa;
            color: #8d6e63;
            font-weight: 600;
            transform: translateX(3px);
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item.page-exists {
            background: linear-gradient(45deg, rgba(141, 110, 99, 0.1), rgba(161, 136, 127, 0.1));
            border-left: 3px solid #8d6e63;
        }

        .menu-item.page-completed {
            background: linear-gradient(45deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.1));
            border-left: 3px solid #28a745;
        }

        .menu-item.page-completed::after {
            content: "‚úì";
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: #28a745;
            font-weight: bold;
        }

        .menu-item.current-page {
            background: linear-gradient(45deg, rgba(63, 81, 181, 0.15), rgba(63, 81, 181, 0.15));
            border-left: 4px solid #3f51b5;
            font-weight: 700;
            color: #3f51b5;
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(63, 81, 181, 0.2);
        }

        .menu-item.current-page::before {
            content: "üëÅÔ∏è";
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
        }

        .page-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .nav-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
            color: #333;
        }

        .nav-btn:hover:not(:disabled) {
            background: #8d6e63;
            color: white;
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .page-counter {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            flex-wrap: wrap;
        }

        .page-selector {
            padding: 8px 12px;
            border: 2px solid #8d6e63;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            background: white;
            color: #8d6e63;
            min-width: 140px;
        }

        .page-selector:disabled {
            background: #f8f9fa;
            color: #6c757d;
            border-color: #dee2e6;
            cursor: not-allowed;
        }

        .page-title {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(45deg, #8d6e63, #a1887f);
            color: white;
            border-radius: 10px;
            font-size: 20px;
            font-weight: 600;
        }

        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .comparison-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            min-height: 600px;
            display: flex;
            flex-direction: column;
        }

        .comparison-panel:hover {
            transform: translateY(-5px);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
            flex-shrink: 0;
        }

        .before-header {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .after-header {
            background: linear-gradient(45deg, #4ecdc4, #44bd32);
            color: white;
        }

        .panel-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .image-btn {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .image-container {
            margin-bottom: 15px;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: white;
            min-height: 300px;
            max-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            flex: 2;
            overflow: hidden;
        }

        .image-placeholder {
            text-align: center;
            color: #6c757d;
            font-size: 14px;
        }

        .uploaded-image {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            object-fit: contain;
        }

        .image-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: none;
        }

        .image-container:hover .image-controls {
            display: block;
        }

        .image-controls button {
            background: rgba(220, 53, 69, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 14px;
            cursor: pointer;
            margin-left: 5px;
        }

        .content-area {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            background: #f8f9fa;
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .content-area textarea {
            width: 100%;
            height: 100%;
            min-height: 150px;
            border: none;
            background: transparent;
            resize: none;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.6;
            flex: 1;
        }

        .content-area textarea:focus {
            outline: none;
        }

        .content-area textarea:disabled {
            background: #f8f9fa;
            color: #6c757d;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #8d6e63, #a1887f);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(141, 110, 99, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #dee2e6;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c82333;
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .progress-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .progress-bar {
            background: #e9ecef;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #8d6e63, #a1887f);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .project-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .info-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .info-item strong {
            display: block;
            color: #8d6e63;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .info-item span {
            color: #333;
            font-size: 16px;
            font-weight: 600;
        }

        .notes-section {
            margin-top: 30px;
            padding: 20px;
            background: #fff3cd;
            border-radius: 10px;
            border-left: 5px solid #ffc107;
        }

        .notes-section h4 {
            color: #856404;
            margin-bottom: 15px;
        }

        .notes-section textarea {
            width: 100%;
            padding: 15px;
            border: 1px solid #ffd700;
            border-radius: 8px;
            background: white;
            min-height: 120px;
            font-family: inherit;
        }

        .notes-section textarea:disabled {
            background: #f8f9fa;
            color: #6c757d;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }

        .modal-content.large {
            max-width: 900px;
            margin: 5% auto;
            text-align: left;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .modal-title.save {
            color: #28a745;
        }

        .modal-message {
            color: #333;
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 25px;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        .modal-btn-ok {
            background: #28a745;
            color: white;
        }

        .modal-btn-ok:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .backup-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #e8f5e8;
            border-radius: 15px;
            border-left: 5px solid #28a745;
        }

        .backup-section h4 {
            color: #155724;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .backup-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .backup-btn {
            padding: 12px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .backup-btn:hover:not(:disabled) {
            background: #218838;
            transform: translateY(-2px);
        }

        .backup-btn.secondary {
            background: #17a2b8;
        }

        .backup-btn.secondary:hover:not(:disabled) {
            background: #138496;
        }

        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            display: none;
        }

        .menu-editor {
            max-height: 600px;
            overflow-y: auto;
        }

        .category-editor {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            margin-bottom: 20px;
            background: white;
        }

        .category-header {
            background: linear-gradient(45deg, #8d6e63, #a1887f);
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-title {
            font-weight: 600;
            font-size: 16px;
        }

        .category-controls {
            display: flex;
            gap: 10px;
        }

        .small-btn {
            padding: 5px 10px;
            font-size: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .small-btn.edit {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .small-btn.delete {
            background: #dc3545;
            color: white;
        }

        .small-btn:hover {
            transform: scale(1.05);
        }

        .menu-items-list {
            padding: 20px;
        }

        .menu-item-editor {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .menu-item-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 14px;
        }

        .menu-item-editor .small-btn {
            min-width: 60px;
        }

        .add-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            background: #e8f5e8;
            border-radius: 8px;
            border: 2px dashed #28a745;
        }

        .add-category-section {
            margin-top: 30px;
            padding: 20px;
            background: #fff3cd;
            border-radius: 10px;
            border: 2px dashed #ffc107;
        }

        .editor-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }

        @media (max-width: 1200px) {
            .menu-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .comparison-container {
                grid-template-columns: 1fr;
            }
            
            .menu-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .page-navigation {
                flex-direction: column;
                gap: 10px;
            }
            
            .project-info {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 15px;
            }

            .header h1 {
                font-size: 24px;
            }

            .status-indicator-inline {
                font-size: 11px;
                padding: 8px 12px;
            }

            /* Î™®Î∞îÏùºÏóêÏÑú Ï†ëÏÜçÏûê Ïàò ÌëúÏãú Í∞ÑÏÜåÌôî */
            #onlineUsersCount span:nth-child(3) {
                display: none; /* "Î™Ö Ï†ëÏÜç" ÌÖçÏä§Ìä∏ Ïà®ÍπÄ */
            }
            
            /* Î™®Î∞îÏùºÏóêÏÑú Î≤ÑÌäº ÌÅ¨Í∏∞ Ï°∞Ï†ï */
            .header button {
                font-size: 10px !important;
                padding: 4px 8px !important;
            }
        }

        @media (max-width: 480px) {
            .menu-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ -->
    <div id="loginScreen" class="login-overlay" style="display: none;">
        <div class="login-container">
            <div class="login-header">
                <h2>üèõÔ∏è Î™©Ìè¨Ïãú ÌÜµÌï©ÎèÑÏÑúÍ¥Ä</h2>
                <p>ÌôàÌéòÏù¥ÏßÄ Í∞úÌé∏ ÌòÑÌô© Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú</p>
            </div>
            
            <div class="login-tabs">
                <button class="login-tab active" onclick="switchTab('admin')">Îã¥ÎãπÍ≥µÎ¨¥Ïõê</button>
                <button class="login-tab" onclick="switchTab('viewer')">ÏóÖÏ≤¥ Îã¥ÎãπÏûê</button>
            </div>
            
            <div class="login-form">
                <div class="form-group">
                    <label id="loginLabel">Í¥ÄÎ¶¨Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                    <input type="password" id="loginInput" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                </div>
                
                <div class="form-group" style="text-align: left;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; color: #666;">
                        <input type="checkbox" id="rememberLogin" checked style="margin: 0;">
                        Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú Ïú†ÏßÄ (24ÏãúÍ∞Ñ)
                    </label>
                </div>
                
                <button class="login-btn" onclick="attemptLogin()">üîì Ï†ëÏÜçÌïòÍ∏∞</button>
                <div class="login-info">
                    <p id="loginInfoText">üí° Îã¥ÎãπÍ≥µÎ¨¥ÏõêÏùÄ Î™®Îì† ÎÇ¥Ïö©ÏùÑ Ìé∏ÏßëÌï† Ïàò ÏûàÏäµÎãàÎã§</p>
                    <p>üîí Î™®Îì† Îç∞Ïù¥ÌÑ∞Îäî ÏïàÏ†ÑÌïòÍ≤å Ï†ÄÏû•Îê©ÎãàÎã§</p>
                    <p>üîê Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú Ïú†ÏßÄ Ïãú ÏÉàÎ°úÍ≥†Ïπ®Ìï¥ÎèÑ ÏûêÎèô Î°úÍ∑∏Ïù∏Îê©ÎãàÎã§</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="mainContent" style="display: none;">
        <div class="mokpo-header">
            <div class="logo">
                üèõÔ∏è Î™©Ìè¨ÏãúÌÜµÌï©ÎèÑÏÑúÍ¥Ä MOKPO CITY LIBRARY
            </div>
            <div class="user-info">
                <span class="user-badge" id="userBadge">Í¥ÄÎ¶¨Ïûê</span>
                <span id="userName">Îã¥ÎãπÍ≥µÎ¨¥Ïõê</span>
                <button class="logout-btn" onclick="logout()">Î°úÍ∑∏ÏïÑÏõÉ</button>
            </div>
        </div>
        
        <div class="header">
            <h1>üèõÔ∏è Î™©Ìè¨Ïãú ÌÜµÌï©ÎèÑÏÑúÍ¥Ä ÌôàÌéòÏù¥ÏßÄ Í∞úÌé∏ ÌòÑÌô© Í¥ÄÎ¶¨</h1>
            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                <div class="status-indicator-inline">
                    ‚òÅÔ∏è ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî Ï§ë...
                </div>
                <div id="onlineUsersCount" class="status-indicator-inline clickable" onclick="showOnlineUsersModal()" title="ÌÅ¥Î¶≠ÌïòÎ©¥ Ï†ëÏÜçÏûê ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§">
                    <span style="display: flex; align-items: center; gap: 5px;">
                        <span style="width: 8px; height: 8px; background: white; border-radius: 50%; animation: pulse 2s infinite;"></span>
                        <span style="font-weight: 600;">1</span>
                        <span style="font-size: 11px;">Î™Ö Ï†ëÏÜç</span>
                        <span style="font-size: 10px; opacity: 0.8;">‚óê</span>
                    </span>
                </div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="console.log('Backup clicked!'); if(currentUserType === 'admin') { downloadBackup(); } else { alert('Í¥ÄÎ¶¨ÏûêÎßå ÏÇ¨Ïö© Í∞ÄÎä•Ìï©ÎãàÎã§.'); }" id="downloadBackupBtn" style="padding: 6px 12px; font-size: 11px;">
                        üì• Îã§Ïö¥Î°úÎìú
                    </button>
                    <button class="btn btn-secondary" onclick="if(currentUserType === 'admin') { uploadBackup(); } else { alert('Í¥ÄÎ¶¨ÏûêÎßå ÏÇ¨Ïö© Í∞ÄÎä•Ìï©ÎãàÎã§.'); }" id="uploadBackupBtn" style="padding: 6px 12px; font-size: 11px;">
                        üì§ Î∂àÎü¨Ïò§Í∏∞
                    </button>
                    <button class="btn btn-secondary" onclick="if(currentUserType === 'admin') { clearStorageAndRetry(); } else { alert('Í¥ÄÎ¶¨ÏûêÎßå ÏÇ¨Ïö© Í∞ÄÎä•Ìï©ÎãàÎã§.'); }" id="clearStorageBtn" style="padding: 6px 12px; font-size: 11px;">
                        üßπ Ï†ÄÏû•ÏÜåÏ†ïÎ¶¨
                    </button>
                    <button class="btn btn-secondary" onclick="if(currentUserType === 'admin') { createCompressedBackup(); } else { alert('Í¥ÄÎ¶¨ÏûêÎßå ÏÇ¨Ïö© Í∞ÄÎä•Ìï©ÎãàÎã§.'); }" id="compressedBackupBtn" style="padding: 6px 12px; font-size: 11px;">
                        üóúÔ∏è ÏïïÏ∂ïÎ∞±ÏóÖ
                    </button>
                    <button class="btn btn-secondary" onclick="showDataSizeAnalysis()" style="padding: 6px 12px; font-size: 11px;">
                        üìä Î∂ÑÏÑù
                    </button>
                </div>
            </div>
        </div>

        <div class="readonly-notice" id="readonlyNotice">
            üìñ ÌòÑÏû¨ <strong>ÏùΩÍ∏∞ Ï†ÑÏö© Î™®Îìú</strong>ÏûÖÎãàÎã§. ÏßÑÌñâ ÏÉÅÌô©ÏùÑ ÌôïÏù∏Ìï† Ïàò ÏûàÏßÄÎßå Ìé∏ÏßëÏùÄ Ìï† Ïàò ÏóÜÏäµÎãàÎã§.
        </div>

        <div class="editing-indicator" id="editingIndicator" style="display: none;">
            ‚úèÔ∏è Îã§Î•∏ ÏÇ¨Ïö©ÏûêÍ∞Ä Ìé∏Ïßë Ï§ëÏûÖÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.
        </div>

        <div class="conflict-warning" id="conflictWarning" style="display: none;">
            ‚ö†Ô∏è Îç∞Ïù¥ÌÑ∞ Ï∂©ÎèåÏù¥ Í∞êÏßÄÎêòÏóàÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®ÌïòÏó¨ ÏµúÏã† Îç∞Ïù¥ÌÑ∞Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.
        </div>

        <div style="margin-bottom: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="color: #8B7355; margin: 0; text-align: center; flex: 1;">üìã Î™©Ìè¨ÏãúÌÜµÌï©ÎèÑÏÑúÍ¥Ä Ï£ºÏöî Î©îÎâ¥ Íµ¨Ï°∞</h4>
                <button class="btn btn-primary" onclick="openMenuEditor()" id="menuEditBtn" style="display: none;">‚öôÔ∏è Î©îÎâ¥ Ìé∏Ïßë</button>
            </div>
            
            <div class="menu-grid" id="menuGrid">
                <!-- Î©îÎâ¥Í∞Ä ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
            </div>
            
            <div style="background: linear-gradient(45deg, #495057, #6c757d); color: white; padding: 15px; margin-top: 15px; border-radius: 8px; font-size: 14px; text-align: center;">
                <strong>üìå Í∞úÌé∏ Î∞©Ìñ•:</strong> Î™©Ìè¨ÏãúÌÜµÌï©ÎèÑÏÑúÍ¥ÄÏùò Í∏∞Ï°¥ Î©îÎâ¥ Íµ¨Ï°∞Î•º ÍπîÎÅîÌïòÍ≤å Ï†ïÎ¶¨ÌïòÏó¨ ÏÇ¨Ïö©ÏûêÍ∞Ä ÏâΩÍ≤å Ï∞æÏùÑ Ïàò ÏûàÎèÑÎ°ù Í∞úÌé∏<br>
                <strong>üí° ÏÇ¨Ïö©Î≤ï:</strong> Í∞Å Î©îÎâ¥Î•º ÌÅ¥Î¶≠ÌïòÎ©¥ Ìï¥Îãπ ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌïòÍ≥† Í∞úÌé∏ ÌòÑÌô©ÏùÑ ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§
            </div>
        </div>

        <div class="page-navigation">
            <button class="nav-btn" id="prevBtn" onclick="previousPage()">‚óÄ Ïù¥Ï†Ñ</button>
            <div class="page-counter">
                <span id="currentPageNum">1</span> / <span id="totalPageNum">6</span>
                
                <!-- ÎåÄÎ©îÎâ¥ ÏÑ†ÌÉù -->
                <select class="page-selector" id="categorySelector" onchange="onCategoryChange(this.value)">
                    <option value="">üìÇ ÎåÄÎ©îÎâ¥ ÏÑ†ÌÉù</option>
                    <!-- ÏòµÏÖòÏù¥ ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
                </select>
                
                <!-- ÏÜåÎ©îÎâ¥ ÏÑ†ÌÉù -->
                <select class="page-selector" id="pageSelector" onchange="goToPage(this.value)" disabled>
                    <option value="">üìÑ ÏÜåÎ©îÎâ¥ ÏÑ†ÌÉù</option>
                    <!-- ÏòµÏÖòÏù¥ ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
                </select>
            </div>
            <button class="nav-btn" id="nextBtn" onclick="nextPage()">Îã§Ïùå ‚ñ∂</button>
        </div>

        <div class="page-title" id="pageTitle">
            Î©îÏù∏ ÌéòÏù¥ÏßÄ
        </div>

        <div class="comparison-container">
            <div class="comparison-panel">
                <div class="panel-header before-header">
                    <h3>üìã Í∞úÌé∏ Ï†Ñ (ÌòÑÏû¨ ÏÉÅÌÉú)</h3>
                    <button class="image-btn" onclick="uploadBeforeImage()" id="beforeImageBtn">üì∑ Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú</button>
                </div>
                <div class="image-container" id="beforeImageContainer">
                    <div class="image-placeholder">
                        ÌòÑÏû¨ ÌôîÎ©¥ Ïù¥ÎØ∏ÏßÄÎ•º ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî
                    </div>
                    <div class="image-controls">
                        <button onclick="removeBeforeImage()">√ó</button>
                    </div>
                </div>
                <div class="content-area">
                    <textarea id="beforeContent" placeholder="ÌòÑÏû¨ ÌéòÏù¥ÏßÄÏùò Î¨∏Ï†úÏ†êÍ≥º Í∞úÏÑ†Ïù¥ ÌïÑÏöîÌïú Î∂ÄÎ∂ÑÏùÑ ÏûëÏÑ±ÌïòÏÑ∏Ïöî..."></textarea>
                </div>
            </div>

            <div class="comparison-panel">
                <div class="panel-header after-header">
                    <h3>‚úÖ Í∞úÌé∏ ÌõÑ (Î™©Ìëú ÏÉÅÌÉú)</h3>
                    <button class="image-btn" onclick="uploadAfterImage()" id="afterImageBtn">üì∑ Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú</button>
                </div>
                <div class="image-container" id="afterImageContainer">
                    <div class="image-placeholder">
                        Î™©Ìëú ÌôîÎ©¥ Ïù¥ÎØ∏ÏßÄÎ•º ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî
                    </div>
                    <div class="image-controls">
                        <button onclick="removeAfterImage()">√ó</button>
                    </div>
                </div>
                <div class="content-area">
                    <textarea id="afterContent" placeholder="Ïö∏Ï£ºÌÜµÌï©ÎèÑÏÑúÍ¥ÄÏùÑ Ï∞∏Í≥†Ìïú Í∞úÌé∏ Î™©ÌëúÏôÄ ÏôÑÎ£å ÏÇ¨Ìï≠ÏùÑ ÏûëÏÑ±ÌïòÏÑ∏Ïöî..."></textarea>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="savePage()" id="saveBtn">üíæ ÌòÑÏû¨ ÌéòÏù¥ÏßÄ Ï†ÄÏû•</button>
        </div>

        <div class="notes-section">
            <h4>üìù ÏóÖÎ¨¥ ÏßÄÏãúÏÇ¨Ìï≠ Î∞è Î©îÎ™®</h4>
            <textarea id="workNotes" placeholder="ÏóÖÏ≤¥Ïóê Ï†ÑÎã¨Ìï† ÏóÖÎ¨¥ ÏßÄÏãúÏÇ¨Ìï≠Ïù¥ÎÇò Ï§ëÏöîÌïú Î©îÎ™®Î•º ÏûëÏÑ±ÌïòÏÑ∏Ïöî...

ÏòàÏãú:
- 3Î∂ÑÍ∏∞ ÏôÑÎ£å ÏòàÏ†ï Ìï≠Î™©: ÌîÑÎ°úÍ∑∏Îû® Ïã†Ï≤≠ ÌéòÏù¥ÏßÄ, Ìù¨ÎßùÎèÑÏÑú Ïã†Ï≤≠ ÌéòÏù¥ÏßÄ
- 4Î∂ÑÍ∏∞ Ïö∞ÏÑ† ÏßÑÌñâ Ìï≠Î™©: Ï†ÑÏ≤¥ Í≤åÏãúÌåê ÏãúÏä§ÌÖú Í∞úÌé∏
- Ïö∏Ï£ºÌÜµÌï©ÎèÑÏÑúÍ¥Ä Ï∞∏Í≥† Ìè¨Ïù∏Ìä∏: ÍπîÎÅîÌïú ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò, ÏßÅÍ¥ÄÏ†ÅÏù∏ Í≤ÄÏÉâ UI
- Î©îÏù∏ ÌéòÏù¥ÏßÄ Í∞úÌé∏ ÏôÑÎ£å - ÎÇòÎ®∏ÏßÄ ÏÑ∏Î∂Ä ÌéòÏù¥ÏßÄ Í∞úÌé∏ Ïö∞ÏÑ† ÏßÑÌñâ ÌïÑÏöî"></textarea>
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn btn-primary" onclick="saveWorkNotes()" id="saveNotesBtn">üíæ ÏóÖÎ¨¥ ÏßÄÏãúÏÇ¨Ìï≠ Ï†ÄÏû•</button>
            </div>
        </div>

        <div class="progress-section">
            <h4>üìà Ï†ÑÏ≤¥ ÏßÑÌñâÎ•†</h4>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 16.7%"></div>
            </div>
            <p id="progressText">16.7% ÏôÑÎ£å (1/6 ÌéòÏù¥ÏßÄ)</p>
        </div>

        <div class="project-info">
            <div class="info-item">
                <strong>ÌòÑÏû¨ Î∂ÑÍ∏∞</strong>
                <span>3Î∂ÑÍ∏∞ ÏßÑÌñâ Ï§ë</span>
            </div>
            <div class="info-item">
                <strong>Î≤§ÏπòÎßàÌÇπ ÏÇ¨Ïù¥Ìä∏</strong>
                <span>Ïö∏Ï£ºÌÜµÌï©ÎèÑÏÑúÍ¥Ä</span>
            </div>
            <div class="info-item">
                <strong>Ï†ÑÏ≤¥ ÌéòÏù¥ÏßÄ</strong>
                <span id="totalPages">6Í∞ú</span>
            </div>
            <div class="info-item">
                <strong>ÏôÑÎ£å ÌéòÏù¥ÏßÄ</strong>
                <span id="completedPages">1Í∞ú</span>
            </div>
        </div>
    </div>

    <!-- ÎèôÍ∏∞Ìôî ÏÉÅÌÉú ÌëúÏãú -->
    <div class="sync-indicator" id="syncIndicator">
        üîÑ ÎèôÍ∏∞Ìôî Ï§ë...
    </div>

    <!-- Ï†ÄÏû• ÏôÑÎ£å Î™®Îã¨ -->
    <div id="saveModal" class="modal">
        <div class="modal-content">
            <div class="modal-title save">‚úÖ Ï†ÄÏû• ÏôÑÎ£å</div>
            <div class="modal-message" id="saveMessage">
                Ï†ÄÏû•Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-ok" onclick="closeSaveModal()">ÌôïÏù∏</button>
            </div>
        </div>
    </div>

    <!-- Î©îÎâ¥ Ìé∏Ïßë Î™®Îã¨ -->
    <div id="menuEditorModal" class="modal">
        <div class="modal-content large">
            <div class="modal-title" style="text-align: center; margin-bottom: 20px; color: #8d6e63;">
                ‚öôÔ∏è Î©îÎâ¥ Íµ¨Ï°∞ Ìé∏Ïßë
            </div>
            
            <div class="menu-editor" id="menuEditor">
                <!-- Î©îÎâ¥ Ìé∏Ïßë ÎÇ¥Ïö©Ïù¥ ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
            </div>
            
            <div class="add-category-section">
                <h4 style="color: #856404; margin-bottom: 15px;">‚ûï ÏÉà ÎåÄÎ©îÎâ¥ Ï∂îÍ∞Ä</h4>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="newCategoryName" placeholder="ÏÉà ÎåÄÎ©îÎâ¥ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" 
                           style="flex: 1; padding: 10px; border: 1px solid #ffd700; border-radius: 5px;">
                    <button class="btn btn-primary" onclick="addNewCategory()">Ï∂îÍ∞Ä</button>
                </div>
            </div>
            
            <div class="editor-buttons">
                <button class="btn btn-primary" onclick="saveMenuStructure()">üíæ Ï†ÄÏû•</button>
                <button class="btn btn-secondary" onclick="closeMenuEditor()">Ï∑®ÏÜå</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== SUPABASE ÏÑ§Ï†ï ====================
        // üîß Supabase ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Ï†ï (ÏÇ¨Ïö©ÏûêÍ∞Ä Î≥ÄÍ≤ΩÌï¥Ïïº Ìï®)
        // 
        // üìù ÏÑ§Ï†ï Î∞©Î≤ï:
        // 1. https://supabase.com ÏóêÏÑú ÏÉà ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ±
        // 2. ÌîÑÎ°úÏ†ùÌä∏ ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú Settings > API Î©îÎâ¥Î°ú Ïù¥Îèô
        // 3. ÏïÑÎûò Í∞íÎì§ÏùÑ Î≥µÏÇ¨ÌïòÏó¨ ÍµêÏ≤¥:
        //    - Project URL ‚Üí SUPABASE_URL
        //    - anon public key ‚Üí SUPABASE_ANON_KEY
        // 4. SQL EditorÏóêÏÑú ÌÖåÏù¥Î∏î ÏÉùÏÑ± (Ïï± Ïã§Ìñâ Ïãú ÏïàÎÇ¥ ÌëúÏãúÎê®)
        // 5. ÌéòÏù¥ÏßÄ ÏÉàÎ°úÍ≥†Ïπ®
        //
        // ‚ö†Ô∏è Ï£ºÏùò: Ïã§Ï†ú ÌîÑÎ°úÏ†ùÌä∏ÏóêÏÑúÎäî RLS(Row Level Security) ÏÑ§Ï†ï Í∂åÏû•
        //
        const SUPABASE_URL = 'https://ifuixpcizqkyhubjsqmf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmdWl4cGNpenFreWh1YmpzcW1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxNDgyMzEsImV4cCI6MjA2ODcyNDIzMX0.iyPP4G2R8FsxXriYyxIVDGrS76K1Nt6p1kaaxF9nd6M';

        // Supabase ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï¥àÍ∏∞Ìôî
        let supabase = null;
        let isSupabaseReady = false;
        let onlineUsersChannel = null; // Ïã§ÏãúÍ∞Ñ Ï†ëÏÜçÏûê Ï±ÑÎÑê
        let dataChannel = null; // Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî Ï±ÑÎÑê
        let currentOnlineCount = 1; // ÌòÑÏû¨ Ï†ëÏÜçÏûê Ïàò (Í∏∞Î≥∏Í∞í: ÏûêÍ∏∞ ÏûêÏã†)
        let onlineUsers = new Set(); // Ï†ëÏÜç Ï§ëÏù∏ ÏÇ¨Ïö©ÏûêÎì§
        let isEditing = false; // ÌòÑÏû¨ Ìé∏Ïßë Ï§ëÏù∏ÏßÄ Ïó¨Î∂Ä
        let editingUser = null; // Ìé∏Ïßë Ï§ëÏù∏ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥
        let lastDataVersion = null; // ÎßàÏßÄÎßâ Îç∞Ïù¥ÌÑ∞ Î≤ÑÏ†Ñ
        let isReceivingUpdate = false; // Ïô∏Î∂Ä ÏóÖÎç∞Ïù¥Ìä∏ ÏàòÏã† Ï§ëÏù∏ÏßÄ Ïó¨Î∂Ä

        // Supabase Ï¥àÍ∏∞Ìôî Ìï®Ïàò
        function initializeSupabase() {
            try {
                if (SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY_HERE') {
                    // Supabase ÏÑ§Ï†ïÏù¥ ÏïàÎêú Í≤ΩÏö∞ localStorage ÏÇ¨Ïö©
                    isSupabaseReady = false;
                    initializeLocalOnlineCount(); // Î°úÏª¨ ÏãúÎÆ¨Î†àÏù¥ÏÖò
                    return false;
                }
                
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                isSupabaseReady = true;
                
                // Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
                testSupabaseConnection();
                
                // Ïã§ÏãúÍ∞Ñ Ï†ëÏÜçÏûê Ïàò Ï¥àÍ∏∞Ìôî
                initializeOnlineUsers();
                
                return true;
            } catch (error) {
                isSupabaseReady = false;
                initializeLocalOnlineCount(); // Î°úÏª¨ ÏãúÎÆ¨Î†àÏù¥ÏÖò
                return false;
            }
        }

        // Ïã§ÏãúÍ∞Ñ Ï†ëÏÜçÏûê Í¥ÄÎ¶¨ (Supabase Realtime)
        function initializeOnlineUsers() {
            if (!supabase) return;
            
            try {
                // Í≥†Ïú†Ìïú ÏÇ¨Ïö©Ïûê ID ÏÉùÏÑ±
                const userId = generateUserId();
                
                // Realtime Ï±ÑÎÑê ÏÉùÏÑ±
                onlineUsersChannel = supabase.channel('online_users', {
                    config: {
                        presence: {
                            key: userId
                        }
                    }
                });

                // Ï†ëÏÜçÏûê ÏÉÅÌÉú Î≥ÄÌôî Í∞êÏßÄ
                onlineUsersChannel
                    .on('presence', { event: 'sync' }, () => {
                        const presenceState = onlineUsersChannel.presenceState();
                        const users = Object.keys(presenceState);
                        currentOnlineCount = users.length;
                        
                        // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                        onlineUsers.clear();
                        users.forEach(userId => {
                            const userData = presenceState[userId][0];
                            onlineUsers.add(userData);
                        });
                        
                        updateOnlineCountDisplay();
                    })
                    .on('presence', { event: 'join' }, ({ newPresences }) => {
                        // ÏÉà ÏÇ¨Ïö©Ïûê Ï†ëÏÜç
                        updateOnlineCountDisplay();
                    })
                    .on('presence', { event: 'leave' }, ({ leftPresences }) => {
                        // ÏÇ¨Ïö©Ïûê Ìá¥Ïû•
                        updateOnlineCountDisplay();
                    });

                // Ï±ÑÎÑê Íµ¨ÎèÖ Î∞è ÏûêÏã†Ïùò presence Îì±Î°ù
                onlineUsersChannel.subscribe(async (status) => {
                    if (status === 'SUBSCRIBED') {
                        // ÏûêÏã†Ïùò Ï†ïÎ≥¥Î•º presenceÏóê Îì±Î°ù
                        await onlineUsersChannel.track({
                            userId: userId,
                            userType: currentUserType || 'guest',
                            joinedAt: new Date().toISOString(),
                            lastSeen: new Date().toISOString(),
                            userAgent: navigator.userAgent.substring(0, 100) // Í∞ÑÎã®Ìïú Î∏åÎùºÏö∞Ï†Ä Ï†ïÎ≥¥
                        });
                    }
                });

            } catch (error) {
                // Realtime Ïã§Ìå® Ïãú Î°úÏª¨ ÏãúÎÆ¨Î†àÏù¥ÏÖò
                initializeLocalOnlineCount();
            }
        }

        // Í≥†Ïú†Ìïú ÏÇ¨Ïö©Ïûê ID ÏÉùÏÑ±
        function generateUserId() {
            // Í∏∞Ï°¥ IDÍ∞Ä ÏûàÏúºÎ©¥ Ïû¨ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ ÏÉàÎ°ú ÏÉùÏÑ±
            let userId = localStorage.getItem('mokpo_user_id');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('mokpo_user_id', userId);
            }
            return userId;
        }

        // Î°úÏª¨ Ï†ëÏÜçÏûê Ïàò ÏãúÎÆ¨Î†àÏù¥ÏÖò (Supabase Ïó∞Í≤∞ Ïã§Ìå® Ïãú)
        function initializeLocalOnlineCount() {
            // Ïã§Ï†ú Ïã§ÏãúÍ∞ÑÏùÄ ÏïÑÎãàÏßÄÎßå ÎèôÏ†ÅÏù∏ ÎäêÎÇåÏùÑ Ï£ºÍ∏∞ ÏúÑÌïú ÏãúÎÆ¨Î†àÏù¥ÏÖò
            currentOnlineCount = Math.floor(Math.random() * 3) + 1; // 1-3Î™Ö ÏÇ¨Ïù¥
            updateOnlineCountDisplay();
            
            // Ï£ºÍ∏∞Ï†ÅÏúºÎ°ú ÏïΩÍ∞ÑÏî© Î≥ÄÌôî (Ïã§Ï†ú ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûàÎäî Í≤ÉÏ≤òÎüº)
            setInterval(() => {
                const change = Math.random() - 0.5; // -0.5 ~ 0.5
                if (Math.random() < 0.3) { // 30% ÌôïÎ•†Î°ú Î≥ÄÌôî
                    currentOnlineCount = Math.max(1, Math.min(5, currentOnlineCount + (change > 0 ? 1 : -1)));
                    updateOnlineCountDisplay();
                }
            }, 45000); // 45Ï¥àÎßàÎã§ Ï≤¥ÌÅ¨
        }

        // Ï†ëÏÜçÏûê Ïàò ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
        function updateOnlineCountDisplay() {
            const onlineIndicator = document.getElementById('onlineUsersCount');
            if (onlineIndicator) {
                const isRealtime = isSupabaseReady && onlineUsersChannel;
                onlineIndicator.innerHTML = `
                    <span style="display: flex; align-items: center; gap: 5px;">
                        <span style="width: 8px; height: 8px; background: #28a745; border-radius: 50%; animation: pulse 2s infinite;"></span>
                        <span style="font-weight: 600;">${currentOnlineCount}</span>
                        <span style="font-size: 11px;">${currentOnlineCount === 1 ? 'Î™Ö Ï†ëÏÜç' : 'Î™Ö Ï†ëÏÜç'}</span>
                        ${isRealtime ? 
                            '<span style="font-size: 10px; color: #28a745;">‚óè</span>' : 
                            '<span style="font-size: 10px; color: #ffc107;">‚óê</span>'
                        }
                    </span>
                `;
                
                // ÌéÑÏä§ Ïï†ÎãàÎ©îÏù¥ÏÖò Ï∂îÍ∞Ä
                if (!document.getElementById('pulse-animation')) {
                    const style = document.createElement('style');
                    style.id = 'pulse-animation';
                    style.textContent = `
                        @keyframes pulse {
                            0% { opacity: 1; transform: scale(1); }
                            50% { opacity: 0.7; transform: scale(1.1); }
                            100% { opacity: 1; transform: scale(1); }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }
        }

        // Ï†ëÏÜçÏûê ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î™®Îã¨
        function showOnlineUsersModal() {
            if (!currentUserType) {
                alert('Î°úÍ∑∏Ïù∏ ÌõÑ Ïù¥Ïö© Í∞ÄÎä•Ìï©ÎãàÎã§.');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '9999';
            
            const usersList = Array.from(onlineUsers).map((user, index) => {
                const userType = user.userType === 'admin' ? 'üëî Í¥ÄÎ¶¨Ïûê' : 
                               user.userType === 'viewer' ? 'üë®‚Äçüíº ÏóÖÏ≤¥' : 'üë§ Í≤åÏä§Ìä∏';
                const joinTime = new Date(user.joinedAt).toLocaleTimeString('ko-KR');
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px;">
                        <div>
                            <span style="font-weight: 600;">${userType}</span>
                            <div style="font-size: 12px; color: #666;">Ï†ëÏÜç ÏãúÍ∞Ñ: ${joinTime}</div>
                        </div>
                        <span style="width: 8px; height: 8px; background: #28a745; border-radius: 50%;"></span>
                    </div>
                `;
            }).join('');
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-title" style="color: #28a745; margin-bottom: 20px; text-align: center;">
                        üë• ÌòÑÏû¨ Ï†ëÏÜçÏûê ÌòÑÌô©
                    </div>
                    <div style="margin-bottom: 20px;">
                        <div style="text-align: center; padding: 15px; background: #e8f5e8; border-radius: 10px; margin-bottom: 20px;">
                            <span style="font-size: 24px; font-weight: bold; color: #28a745;">${currentOnlineCount}Î™Ö</span>
                            <div style="font-size: 14px; color: #666; margin-top: 5px;">
                                ${isSupabaseReady ? 'üì° Ïã§ÏãúÍ∞Ñ Ïó∞Í≤∞Îê®' : 'üíæ Î°úÏª¨ Î™®Îìú'}
                            </div>
                        </div>
                        ${onlineUsers.size > 0 ? usersList : `
                            <div style="text-align: center; padding: 20px; color: #666;">
                                ${isSupabaseReady ? 'Ï†ëÏÜçÏûê Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...' : 'Î°úÏª¨ Î™®ÎìúÏóêÏÑúÎäî ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º Ï†úÍ≥µÌïòÏßÄ ÏïäÏäµÎãàÎã§.'}
                            </div>
                        `}
                    </div>
                    <div style="text-align: center;">
                        <button class="btn btn-primary" onclick="closeOnlineUsersModal()">
                            ‚úñÔ∏è Îã´Í∏∞
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            window.closeOnlineUsersModal = () => {
                modal.remove();
            };
            
            // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî Ï¥àÍ∏∞Ìôî
        function initializeDataSync() {
            if (!supabase) return;
            
            try {
                // Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî Ï±ÑÎÑê ÏÉùÏÑ±
                dataChannel = supabase.channel('data_sync', {
                    config: {
                        broadcast: { self: false } // ÏûêÏã†Ïùò Î∏åÎ°úÎìúÏ∫êÏä§Ìä∏Îäî Î∞õÏßÄ ÏïäÏùå
                    }
                });

                // Îç∞Ïù¥ÌÑ∞ Î≥ÄÍ≤Ω ÏïåÎ¶º ÏàòÏã†
                dataChannel
                    .on('broadcast', { event: 'data_updated' }, (payload) => {
                        handleRemoteDataUpdate(payload.payload);
                    })
                    .on('broadcast', { event: 'editing_started' }, (payload) => {
                        handleEditingStarted(payload.payload);
                    })
                    .on('broadcast', { event: 'editing_stopped' }, (payload) => {
                        handleEditingStopped(payload.payload);
                    });

                // Ï±ÑÎÑê Íµ¨ÎèÖ
                dataChannel.subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        // Íµ¨ÎèÖ ÏÑ±Í≥µ
                        updateConnectionStatus('‚òÅÔ∏è Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî ÌôúÏÑ±Ìôî');
                    }
                });

            } catch (error) {
                // ÎèôÍ∏∞Ìôî Ïã§Ìå® ÏãúÏóêÎèÑ Í∏∞Î≥∏ Í∏∞Îä•ÏùÄ Ïú†ÏßÄ
            }
        }

        // ÏõêÍ≤© Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ Ï≤òÎ¶¨
        function handleRemoteDataUpdate(updateData) {
            if (isReceivingUpdate) return; // Ï§ëÎ≥µ ÏóÖÎç∞Ïù¥Ìä∏ Î∞©ÏßÄ
            
            console.log('ÏõêÍ≤© Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ ÏàòÏã†:', updateData.sessionId);
            
            // ÌòÑÏû¨ Ìé∏Ïßë Ï§ëÏù∏ ÏÇ¨Ïö©ÏûêÎäî ÏõêÍ≤© ÏóÖÎç∞Ïù¥Ìä∏Î•º Î¨¥Ïãú (Îç∞Ïù¥ÌÑ∞ ÏÜêÏã§ Î∞©ÏßÄ)
            if (isActivelyEditing && editingSessionId && updateData.sessionId !== editingSessionId) {
                console.log('Ìé∏Ïßë Ï§ëÏù¥ÎØÄÎ°ú ÏõêÍ≤© ÏóÖÎç∞Ïù¥Ìä∏ Î¨¥Ïãú');
                showUpdateConflictWarning(updateData);
                return;
            }
            
            isReceivingUpdate = true;
            
            try {
                // ÌòÑÏû¨ Ìé∏Ïßë Ï§ëÏù¥ ÏïÑÎãê ÎïåÎßå ÏóÖÎç∞Ïù¥Ìä∏ Ï†ÅÏö©
                if (!isEditing && !hasUnsavedChanges) {
                    if (updateData.pages) {
                        pages = updateData.pages;
                        initializePages();
                        updateAllDisplays();
                        renderMenuGrid();
                    }
                    
                    if (updateData.workNotes !== undefined) {
                        workNotes = updateData.workNotes;
                        const workNotesElement = document.getElementById('workNotes');
                        if (workNotesElement && document.activeElement !== workNotesElement) {
                            workNotesElement.value = workNotes;
                        }
                    }
                    
                    if (updateData.menuStructure) {
                        menuStructure = updateData.menuStructure;
                        renderMenuGrid();
                    }
                    
                    // ÏóÖÎç∞Ïù¥Ìä∏ ÏïåÎ¶º ÌëúÏãú
                    showUpdateNotification(updateData.updatedBy);
                } else {
                    console.log('Ìé∏Ïßë Ï§ëÏù¥ÎØÄÎ°ú ÏóÖÎç∞Ïù¥Ìä∏ ÏßÄÏó∞');
                    // Ìé∏ÏßëÏù¥ ÎÅùÎÇú ÌõÑ ÏóÖÎç∞Ïù¥Ìä∏ÌïòÎèÑÎ°ù ÏòàÏïΩ
                    scheduleDelayedUpdate(updateData);
                }
                
            } catch (error) {
                console.error('ÏõêÍ≤© ÏóÖÎç∞Ïù¥Ìä∏ Ï≤òÎ¶¨ Ïã§Ìå®:', error);
            } finally {
                isReceivingUpdate = false;
            }
        }

        // ÏßÄÏó∞Îêú ÏóÖÎç∞Ïù¥Ìä∏ Ïä§ÏºÄÏ§ÑÎßÅ
        function scheduleDelayedUpdate(updateData) {
            setTimeout(() => {
                if (!isActivelyEditing && !hasUnsavedChanges) {
                    console.log('ÏßÄÏó∞Îêú ÏóÖÎç∞Ïù¥Ìä∏ Ï†ÅÏö©');
                    handleRemoteDataUpdate(updateData);
                } else {
                    // Ïó¨Ï†ÑÌûà Ìé∏Ïßë Ï§ëÏù¥Î©¥ Îã§Ïãú ÏßÄÏó∞
                    scheduleDelayedUpdate(updateData);
                }
            }, 5000); // 5Ï¥à ÌõÑ Îã§Ïãú ÏãúÎèÑ
        }

        // ÏóÖÎç∞Ïù¥Ìä∏ Ï∂©Îèå Í≤ΩÍ≥†
        function showUpdateConflictWarning(updateData) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 200px;
                right: 20px;
                background: linear-gradient(45deg, #ff9800, #f57c00);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 600;
                font-size: 13px;
                max-width: 300px;
                animation: slideInRight 0.3s ease;
            `;
            
            notification.innerHTML = `
                ‚ö†Ô∏è Îã§Î•∏ ÏÇ¨Ïö©ÏûêÍ∞Ä Îç∞Ïù¥ÌÑ∞Î•º ÏóÖÎç∞Ïù¥Ìä∏ÌñàÏäµÎãàÎã§<br>
                <small>Ìé∏Ïßë ÏôÑÎ£å ÌõÑ ÏûêÎèôÏúºÎ°ú ÎèôÍ∏∞ÌôîÎê©ÎãàÎã§</small>
            `;
            
            document.body.appendChild(notification);
            
            // 10Ï¥à ÌõÑ ÏûêÎèô Ï†úÍ±∞
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 10000);
        }

        // Ìé∏Ïßë ÏãúÏûë ÏïåÎ¶º Ï≤òÎ¶¨
        function handleEditingStarted(editData) {
            if (editData.userId !== generateUserId()) {
                editingUser = editData;
                showEditingNotification(editData);
                
                // Ìé∏Ïßë Î∂àÍ∞Ä ÏÉÅÌÉúÎ°ú UI ÏóÖÎç∞Ïù¥Ìä∏
                if (currentUserType === 'admin') {
                    setEditingDisabled(true, `${editData.userType === 'admin' ? 'Îã§Î•∏ Í¥ÄÎ¶¨Ïûê' : 'Îã§Î•∏ ÏÇ¨Ïö©Ïûê'}Í∞Ä Ìé∏Ïßë Ï§ëÏûÖÎãàÎã§`);
                }
            }
        }

        // Ìé∏Ïßë Ï¢ÖÎ£å ÏïåÎ¶º Ï≤òÎ¶¨
        function handleEditingStopped(editData) {
            if (editData.userId !== generateUserId()) {
                editingUser = null;
                hideEditingNotification();
                
                // Ìé∏Ïßë Í∞ÄÎä• ÏÉÅÌÉúÎ°ú UI Î≥µÏõê
                if (currentUserType === 'admin') {
                    setEditingDisabled(false);
                }
            }
        }

        // Ìé∏Ïßë ÌôúÎèô Ï∂îÏ†Å Ìï®ÏàòÎì§
        function markEditingActivity() {
            lastEditTime = new Date().getTime();
            hasUnsavedChanges = true;
            isActivelyEditing = true;
            
            // Ìé∏Ïßë ÏÑ∏ÏÖò ID ÏÉùÏÑ± (Ï§ëÎ≥µ Ï†ÄÏû• Î∞©ÏßÄ)
            if (!editingSessionId) {
                editingSessionId = generateUserId() + '_' + Date.now();
            }
            
            console.log('Ìé∏Ïßë ÌôúÎèô Í∞êÏßÄ:', new Date().toLocaleTimeString());
        }

        function checkEditingActivity() {
            if (!lastEditTime) return false;
            
            const now = new Date().getTime();
            const timeSinceLastEdit = now - lastEditTime;
            
            // 5Î∂Ñ Ïù¥ÏÉÅ Ìé∏Ïßë ÌôúÎèôÏù¥ ÏóÜÏúºÎ©¥ ÎπÑÌôúÏÑ±ÏúºÎ°ú Í∞ÑÏ£º
            if (timeSinceLastEdit > 5 * 60 * 1000) {
                isActivelyEditing = false;
                editingSessionId = null;
                return false;
            }
            
            return isActivelyEditing;
        }

        // Ìé∏Ïßë ÏãúÏûë Î∏åÎ°úÎìúÏ∫êÏä§Ìä∏
        function broadcastEditingStarted() {
            if (dataChannel && currentUserType === 'admin') {
                markEditingActivity();
                
                dataChannel.send({
                    type: 'broadcast',
                    event: 'editing_started',
                    payload: {
                        userId: generateUserId(),
                        userType: currentUserType,
                        startTime: new Date().toISOString(),
                        sessionId: editingSessionId
                    }
                });
                isEditing = true;
            }
        }

        // Ìé∏Ïßë Ï¢ÖÎ£å Î∏åÎ°úÎìúÏ∫êÏä§Ìä∏
        function broadcastEditingStopped() {
            if (dataChannel && isEditing) {
                dataChannel.send({
                    type: 'broadcast',
                    event: 'editing_stopped',
                    payload: {
                        userId: generateUserId(),
                        userType: currentUserType,
                        endTime: new Date().toISOString(),
                        sessionId: editingSessionId
                    }
                });
                isEditing = false;
                isActivelyEditing = false;
                editingSessionId = null;
            }
        }

        // Îç∞Ïù¥ÌÑ∞ Î≥ÄÍ≤Ω Î∏åÎ°úÎìúÏ∫êÏä§Ìä∏
        function broadcastDataUpdate() {
            if (dataChannel && currentUserType === 'admin' && editingSessionId) {
                console.log('Îç∞Ïù¥ÌÑ∞ Î≥ÄÍ≤Ω Î∏åÎ°úÎìúÏ∫êÏä§Ìä∏ Ï†ÑÏÜ°');
                dataChannel.send({
                    type: 'broadcast',
                    event: 'data_updated',
                    payload: {
                        pages: pages,
                        workNotes: workNotes,
                        menuStructure: menuStructure,
                        updatedBy: currentUserType,
                        userId: generateUserId(),
                        sessionId: editingSessionId,
                        timestamp: new Date().toISOString()
                    }
                });
            }
        }

        // ÏóÖÎç∞Ïù¥Ìä∏ ÏïåÎ¶º ÌëúÏãú
        function showUpdateNotification(updatedBy) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: linear-gradient(45deg, #17a2b8, #20c997);
                color: white;
                padding: 12px 16px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 600;
                font-size: 13px;
                max-width: 280px;
                animation: slideInRight 0.3s ease;
            `;
            
            notification.innerHTML = `
                üîÑ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§<br>
                <small>${updatedBy === 'admin' ? 'Í¥ÄÎ¶¨Ïûê' : 'Îã§Î•∏ ÏÇ¨Ïö©Ïûê'}Ïóê ÏùòÌï¥ Î≥ÄÍ≤ΩÎê®</small>
            `;
            
            document.body.appendChild(notification);
            
            // 4Ï¥à ÌõÑ ÏûêÎèô Ï†úÍ±∞
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        // Ìé∏Ïßë Ï§ë ÏïåÎ¶º ÌëúÏãú
        function showEditingNotification(editData) {
            // Í∏∞Ï°¥ ÏïåÎ¶º Ï†úÍ±∞
            hideEditingNotification();
            
            // ÏÉÅÎã® Ìé∏Ïßë Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ ÌëúÏãú
            const editingIndicator = document.getElementById('editingIndicator');
            if (editingIndicator) {
                editingIndicator.style.display = 'block';
                editingIndicator.innerHTML = `
                    ‚úèÔ∏è ${editData.userType === 'admin' ? 'Îã§Î•∏ Í¥ÄÎ¶¨Ïûê' : 'ÏóÖÏ≤¥ Îã¥ÎãπÏûê'}Í∞Ä Ìé∏Ïßë Ï§ëÏûÖÎãàÎã§. 
                    <span style="font-size: 12px; opacity: 0.8;">Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.</span>
                `;
            }
            
            // Ïö∞Ï∏° ÏïåÎ¶º
            const notification = document.createElement('div');
            notification.id = 'editingNotification';
            notification.style.cssText = `
                position: fixed;
                top: 140px;
                right: 20px;
                background: linear-gradient(45deg, #ff9800, #f57c00);
                color: white;
                padding: 12px 16px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 600;
                font-size: 13px;
                max-width: 280px;
                animation: slideInRight 0.3s ease;
            `;
            
            notification.innerHTML = `
                ‚úèÔ∏è Îã§Î•∏ ÏÇ¨Ïö©ÏûêÍ∞Ä Ìé∏Ïßë Ï§ëÏûÖÎãàÎã§<br>
                <small>${editData.userType === 'admin' ? 'Í¥ÄÎ¶¨Ïûê' : 'ÏóÖÏ≤¥ Îã¥ÎãπÏûê'}Í∞Ä ÏàòÏ†ï Ï§ë...</small>
            `;
            
            document.body.appendChild(notification);
        }

        // Ìé∏Ïßë Ï§ë ÏïåÎ¶º Ïà®ÍπÄ
        function hideEditingNotification() {
            // ÏÉÅÎã® Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ Ïà®ÍπÄ
            const editingIndicator = document.getElementById('editingIndicator');
            if (editingIndicator) {
                editingIndicator.style.display = 'none';
            }
            
            // Ïö∞Ï∏° ÏïåÎ¶º Ï†úÍ±∞
            const notification = document.getElementById('editingNotification');
            if (notification) {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }
        }

        // ÎèôÍ∏∞Ìôî ÏÉÅÌÉú ÌëúÏãú
        function showSyncIndicator(message = 'üîÑ ÎèôÍ∏∞Ìôî Ï§ë...') {
            const syncIndicator = document.getElementById('syncIndicator');
            if (syncIndicator) {
                syncIndicator.textContent = message;
                syncIndicator.style.display = 'block';
                
                // 2Ï¥à ÌõÑ ÏûêÎèô Ïà®ÍπÄ
                setTimeout(() => {
                    syncIndicator.style.display = 'none';
                }, 2000);
            }
        }

        // Ï∂©Îèå Í≤ΩÍ≥† ÌëúÏãú
        function showConflictWarning() {
            const conflictWarning = document.getElementById('conflictWarning');
            if (conflictWarning) {
                conflictWarning.style.display = 'block';
                
                // 5Ï¥à ÌõÑ ÏûêÎèô Ïà®ÍπÄ
                setTimeout(() => {
                    conflictWarning.style.display = 'none';
                }, 5000);
            }
        }

        // Ìé∏Ïßë Î∂àÍ∞Ä ÏÉÅÌÉú ÏÑ§Ï†ï
        function setEditingDisabled(disabled, message = '') {
            const editableElements = ['beforeContent', 'afterContent', 'workNotes'];
            const editableButtons = ['saveBtn', 'saveNotesBtn', 'beforeImageBtn', 'afterImageBtn', 'menuEditBtn'];
            
            editableElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.disabled = disabled;
                    if (disabled) {
                        element.placeholder = message;
                        element.style.background = '#f8f9fa';
                        element.style.color = '#6c757d';
                    } else {
                        element.placeholder = '';
                        element.style.background = '';
                        element.style.color = '';
                    }
                }
            });
            
            editableButtons.forEach(id => {
                const button = document.getElementById(id);
                if (button) {
                    button.disabled = disabled;
                    if (disabled) {
                        button.title = message;
                    } else {
                        button.title = '';
                    }
                }
            });
        }

        // Supabase Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
        async function testSupabaseConnection() {
            try {
                const { data, error } = await supabase.from('mokpo_projects').select('id').limit(1);
                if (error && error.code === '42P01') {
                    // ÌÖåÏù¥Î∏îÏù¥ ÏóÜÎäî Í≤ΩÏö∞ ÏÉùÏÑ± ÏïàÎÇ¥
                    showSupabaseSetupModal();
                }
            } catch (error) {
                // Ïó∞Í≤∞ Ïã§Ìå® Ïãú localStorageÎ°ú Ìè¥Î∞±
                isSupabaseReady = false;
            }
        }

        // Supabase ÏÑ§Ï†ï ÏïàÎÇ¥ Î™®Îã¨
        function showSupabaseSetupModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '9999';
            
            modal.innerHTML = `
                <div class="modal-content large">
                    <div class="modal-title" style="color: #4f46e5; margin-bottom: 20px; text-align: center;">
                        ‚òÅÔ∏è Supabase Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏÑ§Ï†ï
                    </div>
                    <div style="margin-bottom: 20px; color: #666; line-height: 1.6;">
                        <p><strong>üîß SupabaseÏóêÏÑú Îã§Ïùå SQLÏùÑ Ïã§ÌñâÌïòÏó¨ ÌÖåÏù¥Î∏îÏùÑ ÏÉùÏÑ±ÌïòÏÑ∏Ïöî:</strong></p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <textarea readonly style="width: 100%; height: 300px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; font-family: monospace; font-size: 12px; background: #f8f9fa;">-- Î™©Ìè¨Ïãú ÎèÑÏÑúÍ¥Ä ÌîÑÎ°úÏ†ùÌä∏ ÌÖåÏù¥Î∏î ÏÉùÏÑ±
CREATE TABLE mokpo_projects (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    project_name TEXT NOT NULL DEFAULT 'Î™©Ìè¨Ïãú ÌÜµÌï©ÎèÑÏÑúÍ¥Ä ÌôàÌéòÏù¥ÏßÄ Í∞úÌé∏',
    pages JSONB NOT NULL DEFAULT '[]',
    work_notes TEXT DEFAULT '',
    menu_structure JSONB NOT NULL DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- RLS (Row Level Security) ÌôúÏÑ±Ìôî (ÏÑ†ÌÉùÏÇ¨Ìï≠)
ALTER TABLE mokpo_projects ENABLE ROW LEVEL SECURITY;

-- Î™®Îì† ÏÇ¨Ïö©ÏûêÍ∞Ä ÏùΩÍ∏∞/Ïì∞Í∏∞ Í∞ÄÎä•ÌïòÎèÑÎ°ù Ï†ïÏ±Ö ÏÑ§Ï†ï (Í∞úÎ∞úÏö©)
CREATE POLICY "Enable all access for mokpo_projects" ON mokpo_projects
    FOR ALL USING (true) WITH CHECK (true);</textarea>
                    </div>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
                        <h4 style="color: #856404; margin-bottom: 10px;">üìù ÏÑ§Ï†ï Î∞©Î≤ï</h4>
                        <ol style="color: #856404; font-size: 14px; margin: 0; padding-left: 20px;">
                            <li>Supabase ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú SQL EditorÎ°ú Ïù¥Îèô</li>
                            <li>ÏúÑÏùò SQL ÏΩîÎìúÎ•º Î≥µÏÇ¨ÌïòÏó¨ Ïã§Ìñâ</li>
                            <li>ÏÜåÏä§ÏΩîÎìúÏóêÏÑú SUPABASE_URLÍ≥º SUPABASE_ANON_KEY ÏàòÏ†ï</li>
                            <li>ÌéòÏù¥ÏßÄ ÏÉàÎ°úÍ≥†Ïπ®</li>
                        </ol>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn btn-primary" onclick="closeSetupModal(); location.reload();">
                            üîÑ ÏÑ§Ï†ï ÏôÑÎ£å ÌõÑ ÏÉàÎ°úÍ≥†Ïπ®
                        </button>
                        <button class="btn btn-secondary" onclick="closeSetupModal();" style="margin-left: 10px;">
                            üíæ Î°úÏª¨ Ï†ÄÏû•ÏÜå ÏÇ¨Ïö©
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            window.closeSetupModal = () => {
                modal.remove();
            };
        }

        // ==================== Ï†ÑÏó≠ Î≥ÄÏàò ====================
        let currentUserType = null;
        let currentPageIndex = 0;
        let currentCategory = null; // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÎåÄÎ©îÎâ¥
        let filteredPages = []; // ÌòÑÏû¨ Ïπ¥ÌÖåÍ≥†Î¶¨Ïùò ÌéòÏù¥ÏßÄÎì§
        let workNotes = "";
        let pages = []; // Îπà Î∞∞Ïó¥Î°ú ÏãúÏûë - initializePages()ÏóêÏÑú Ï±ÑÏõåÏßê
        
        // Ìé∏Ïßë ÌôúÎèô Ï∂îÏ†Å Î≥ÄÏàòÎì§
        let lastEditTime = null; // ÎßàÏßÄÎßâ Ìé∏Ïßë ÏãúÍ∞Ñ
        let hasUnsavedChanges = false; // Ï†ÄÏû•ÎêòÏßÄ ÏïäÏùÄ Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Ïó¨Î∂Ä
        let isActivelyEditing = false; // ÌòÑÏû¨ ÌôúÎ∞úÌûà Ìé∏Ïßë Ï§ëÏù∏ÏßÄ Ïó¨Î∂Ä
        let editingSessionId = null; // Ìé∏Ïßë ÏÑ∏ÏÖò ID
        let menuStructure = {
            "ÏûêÎ£åÍ≤ÄÏÉâ": ["ÏÜåÏû•ÏûêÎ£åÍ≤ÄÏÉâ", "ÎåÄÏ∂úÌòÑÌô©Ï°∞Ìöå", "Ïã†Í∞ÑÎèÑÏÑú", "Ï∂îÏ≤úÎèÑÏÑú", "Ï†ÑÏûêÎèÑÏÑúÍ¥Ä"],
            "Ïã†Ï≤≠¬∑Ï∞∏Ïó¨": ["ÌîÑÎ°úÍ∑∏Îû®Ïã†Ï≤≠", "Ìù¨ÎßùÎèÑÏÑúÏã†Ï≤≠", "ÏßÄÏó≠ÏÑúÏ†êÎ∞îÎ°úÎåÄÏ∂ú", "ÏãúÏÑ§Ïù¥Ïö©Ïã†Ï≤≠", "ÏûêÏõêÎ¥âÏÇ¨Ïã†Ï≤≠"],
            "ÎèÖÏÑú¬∑Î¨∏ÌôîÎßàÎãπ": ["Ïò¨Ìï¥ÏùòÏ±Ö", "Ïù¥Îã¨ÏùòÌñâÏÇ¨", "ÏòÅÌôîÏÉÅÏòÅÏïàÎÇ¥", "ÎèôÏïÑÎ¶¨ÏïàÎÇ¥"],
            "ÎèÑÏÑúÍ¥ÄÏù¥Ïö©": ["Ïù¥Ïö©ÏïàÎÇ¥", "Í≥µÏßÄÏÇ¨Ìï≠", "ÏûêÏ£ºÌïòÎäîÏßàÎ¨∏", "ÏÇ¨ÏÑúÏóêÍ≤åÎ¨ºÏñ¥Î≥¥ÏÑ∏Ïöî", "ÎèÑÏÑúÍ¥ÄÏóêÎ∞îÎûÄÎã§"],
            "ÎèÑÏÑúÍ¥ÄÏÜåÍ∞ú": ["Ïù∏ÏÇ¨Îßê", "ÎèÑÏÑúÍ¥ÄÏó∞ÌòÅ", "ÏãúÏÑ§ÌòÑÌô©", "Ï∏µÎ≥ÑÏïàÎÇ¥", "Ï∞æÏïÑÏò§ÏãúÎäîÍ∏∏"],
            "ÏûëÏùÄÎèÑÏÑúÍ¥Ä": ["ÏûëÏùÄÎèÑÏÑúÍ¥ÄÌòÑÌô©", "ÏûëÏùÄÎèÑÏÑúÍ¥ÄÏÜåÍ∞ú", "ÏûëÏùÄÎèÑÏÑúÍ¥ÄÍ≥µÏßÄÏÇ¨Ìï≠", "ÎπÑÎåÄÎ©¥ÎèÑÏÑúÎåÄÏ∂ú"]
        };
        function initializePages() {
            // ÌòÑÏû¨ Î©îÎâ¥ Íµ¨Ï°∞Î•º Í∏∞Î∞òÏúºÎ°ú ÌéòÏù¥ÏßÄ Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî
            const allMenuItems = [];
            
            // Î©îÎâ¥ Íµ¨Ï°∞ÏóêÏÑú Î™®Îì† ÏÜåÎ©îÎâ¥ ÏàòÏßë
            Object.keys(menuStructure).forEach(category => {
                menuStructure[category].forEach(menuItem => {
                    allMenuItems.push({
                        menuName: menuItem,
                        category: category
                    });
                });
            });
            
            // Í∏∞Ï°¥ Î©îÏù∏ ÌéòÏù¥ÏßÄ Ïú†ÏßÄ
            const mainPage = pages.find(p => p.menuName === "Î©îÏù∏ÌéòÏù¥ÏßÄ");
            
            // ÏÉàÎ°úÏö¥ ÌéòÏù¥ÏßÄ Î∞∞Ïó¥ ÏÉùÏÑ±
            const newPages = [];
            
            // Î©îÏù∏ ÌéòÏù¥ÏßÄ Ï∂îÍ∞Ä
            if (mainPage) {
                newPages.push(mainPage);
            } else {
                newPages.push({
                    title: "Î©îÏù∏ ÌéòÏù¥ÏßÄ",
                    category: "main",
                    beforeContent: "Í∏∞Ï°¥ Î©îÏù∏ ÌéòÏù¥ÏßÄ Î¨∏Ï†úÏ†ê:\n- Íµ¨Ïãù ÎîîÏûêÏù∏Í≥º Î†àÏù¥ÏïÑÏõÉ\n- ÏÇ¨Ïö©Ïûê Í≤ΩÌóò Î∂ÄÏ°±\n- Î™®Î∞îÏùº Î∞òÏùëÌòï ÎØ∏ÏßÄÏõê",
                    afterContent: "Î™©Ìëú Í∞úÌé∏ ÏÇ¨Ìï≠:\n- Î™®ÎçòÌïòÍ≥† ÍπîÎÅîÌïú ÎîîÏûêÏù∏\n- ÏßÅÍ¥ÄÏ†ÅÏù∏ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò\n- ÏôÑÏ†Ñ Î∞òÏùëÌòï Ïõπ ÎîîÏûêÏù∏\n- ÏÇ¨Ïö©Ïûê ÏπúÌôîÏ†Å Ïù∏ÌÑ∞ÌéòÏù¥Ïä§",
                    beforeImage: null,
                    afterImage: null,
                    isCompleted: true,
                    menuName: "Î©îÏù∏ÌéòÏù¥ÏßÄ"
                });
            }
            
            // Î©îÎâ¥ Íµ¨Ï°∞Ïùò Í∞Å ÏÜåÎ©îÎâ¥Ïóê ÎåÄÌï¥ ÌéòÏù¥ÏßÄ ÏÉùÏÑ±/ÏóÖÎç∞Ïù¥Ìä∏
            allMenuItems.forEach(item => {
                const existingPage = pages.find(p => p.menuName === item.menuName);
                
                if (existingPage) {
                    // Í∏∞Ï°¥ ÌéòÏù¥ÏßÄÍ∞Ä ÏûàÏúºÎ©¥ Ïπ¥ÌÖåÍ≥†Î¶¨Îßå ÏóÖÎç∞Ïù¥Ìä∏
                    existingPage.category = item.category;
                    newPages.push(existingPage);
                } else {
                    // ÏÉà ÌéòÏù¥ÏßÄ ÏÉùÏÑ±
                    newPages.push({
                        title: item.menuName,
                        category: item.category,
                        beforeContent: "",
                        afterContent: "",
                        beforeImage: null,
                        afterImage: null,
                        isCompleted: false,
                        menuName: item.menuName
                    });
                }
            });
            
            // Ï†ÑÏó≠ pages Î∞∞Ïó¥ ÏóÖÎç∞Ïù¥Ìä∏
            pages = newPages;
        }

        // Î°úÍ∑∏Ïù∏ Í¥ÄÎ†®
        const credentials = {
            admin: 'mokpo2024!',
            viewer: 'view2024'
        };

        function switchTab(type) {
            const tabs = document.querySelectorAll('.login-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            const label = document.getElementById('loginLabel');
            const info = document.getElementById('loginInfoText');
            const input = document.getElementById('loginInput');

            if (type === 'admin') {
                label.textContent = 'Í¥ÄÎ¶¨Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏';
                info.textContent = 'üí° Îã¥ÎãπÍ≥µÎ¨¥ÏõêÏùÄ Î™®Îì† ÎÇ¥Ïö©ÏùÑ Ìé∏ÏßëÌï† Ïàò ÏûàÏäµÎãàÎã§';
                input.placeholder = 'Í¥ÄÎ¶¨Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî';
            } else {
                label.textContent = 'ÏóÖÏ≤¥ Ï†ëÏÜç ÏΩîÎìú';
                info.textContent = 'üí° ÏóÖÏ≤¥ Îã¥ÎãπÏûêÎäî ÏßÑÌñâ ÏÉÅÌô©ÏùÑ ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§';
                input.placeholder = 'ÏóÖÏ≤¥ Ï†ÑÏö© Ï†ëÏÜç ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî';
            }
            
            input.value = '';
            input.focus();
        }

        async function attemptLogin() {
            try {
                const activeTab = document.querySelector('.login-tab.active');
                
                if (!activeTab) {
                    alert('Î°úÍ∑∏Ïù∏ ÌÉ≠ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                
                const userType = activeTab.textContent === 'Îã¥ÎãπÍ≥µÎ¨¥Ïõê' ? 'admin' : 'viewer';
                
                const passwordInput = document.getElementById('loginInput');
                if (!passwordInput) {
                    alert('ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•Ï∞ΩÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                    return;
                }
                
                const password = passwordInput.value.trim();
                
                if (!password) {
                    alert('ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                
                if (credentials[userType] === password) {
                    // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                    currentUserType = userType;
                    
                    // "Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú Ïú†ÏßÄ" Ï≤¥ÌÅ¨Î∞ïÏä§ ÌôïÏù∏
                    const rememberLogin = document.getElementById('rememberLogin').checked;
                    
                    if (rememberLogin) {
                        // Î°úÍ∑∏Ïù∏ ÏÉÅÌÉúÎ•º localStorageÏóê Ï†ÄÏû• (ÏÉàÎ°úÍ≥†Ïπ® Ïãú Ïú†ÏßÄÏö©)
                        localStorage.setItem('mokpo_login_state', JSON.stringify({
                            userType: userType,
                            loginTime: new Date().getTime(),
                            expiresIn: 24 * 60 * 60 * 1000 // 24ÏãúÍ∞Ñ ÌõÑ ÎßåÎ£å
                        }));
                    }
                    
                    // ÌôîÎ©¥ Ï†ÑÌôò
                    const loginScreen = document.getElementById('loginScreen');
                    const mainContent = document.getElementById('mainContent');
                    
                    if (loginScreen && mainContent) {
                        loginScreen.style.display = 'none';
                        mainContent.style.display = 'block';
                    }
                    
                    // UI ÏóÖÎç∞Ïù¥Ìä∏ Ìò∏Ï∂ú
                    updateUserInterface();
                    
                    // Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                    loadData();
                    
                    // ÏÑ±Í≥µ Î©îÏãúÏßÄ
                    const loginMessage = rememberLogin ? 
                        `‚úÖ ${userType === 'admin' ? 'Í¥ÄÎ¶¨Ïûê' : 'ÏóÖÏ≤¥ Îã¥ÎãπÏûê'}Î°ú Î°úÍ∑∏Ïù∏ÌñàÏäµÎãàÎã§!\nüîê Î°úÍ∑∏Ïù∏ ÏÉÅÌÉúÍ∞Ä 24ÏãúÍ∞Ñ ÎèôÏïà Ïú†ÏßÄÎê©ÎãàÎã§.` :
                        `‚úÖ ${userType === 'admin' ? 'Í¥ÄÎ¶¨Ïûê' : 'ÏóÖÏ≤¥ Îã¥ÎãπÏûê'}Î°ú Î°úÍ∑∏Ïù∏ÌñàÏäµÎãàÎã§!\nüí° Î∏åÎùºÏö∞Ï†ÄÎ•º Îã´ÏúºÎ©¥ ÏûêÎèôÏúºÎ°ú Î°úÍ∑∏ÏïÑÏõÉÎê©ÎãàÎã§.`;
                    
                    showSaveModal(loginMessage);

                    // Ïò®ÎùºÏù∏ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ (Î°úÍ∑∏Ïù∏ ÌõÑ)
                    updateUserPresence();
                    
                } else {
                    alert('‚ùå ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.');
                    passwordInput.value = '';
                }
                
            } catch (error) {
                alert('Î°úÍ∑∏Ïù∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }

        // ÏÇ¨Ïö©Ïûê presence Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
        async function updateUserPresence() {
            if (onlineUsersChannel && currentUserType) {
                try {
                    await onlineUsersChannel.track({
                        userId: generateUserId(),
                        userType: currentUserType,
                        joinedAt: new Date().toISOString(),
                        lastSeen: new Date().toISOString(),
                        userAgent: navigator.userAgent.substring(0, 100)
                    });
                } catch (error) {
                    // presence ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®Îäî Î¨¥Ïãú
                }
            }
        }

        // ÏûêÎèô Î°úÍ∑∏Ïù∏ Ï≤¥ÌÅ¨ Ìï®Ïàò
        function checkAutoLogin() {
            try {
                const loginState = localStorage.getItem('mokpo_login_state');
                if (!loginState) {
                    return false; // Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥ ÏóÜÏùå
                }
                
                const loginData = JSON.parse(loginState);
                const currentTime = new Date().getTime();
                
                // ÎßåÎ£å ÏãúÍ∞Ñ Ï≤¥ÌÅ¨
                if (currentTime - loginData.loginTime > loginData.expiresIn) {
                    // ÎßåÎ£åÎêú Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥ ÏÇ≠Ï†ú
                    localStorage.removeItem('mokpo_login_state');
                    return false;
                }
                
                // ÏûêÎèô Î°úÍ∑∏Ïù∏ ÏàòÌñâ
                currentUserType = loginData.userType;
                
                // ÌôîÎ©¥ Ï†ÑÌôò
                const loginScreen = document.getElementById('loginScreen');
                const mainContent = document.getElementById('mainContent');
                
                if (loginScreen && mainContent) {
                    loginScreen.style.display = 'none';
                    mainContent.style.display = 'block';
                }
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏
                updateUserInterface();
                
                // Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                loadData();
                
                // ÏûêÎèô Î°úÍ∑∏Ïù∏ ÏïåÎ¶º (5Ï¥à ÌõÑ ÏûêÎèô Îã´Ìûò)
                showAutoLoginNotification(loginData.userType);
                
                // Ïò®ÎùºÏù∏ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ (ÏûêÎèô Î°úÍ∑∏Ïù∏ ÌõÑ)
                setTimeout(() => {
                    updateUserPresence();
                }, 1000); // 1Ï¥à ÌõÑ ÏóÖÎç∞Ïù¥Ìä∏ (Ï¥àÍ∏∞Ìôî ÏôÑÎ£å ÎåÄÍ∏∞)
                
                return true;
                
            } catch (error) {
                // Ïò§Î•ò Î∞úÏÉù Ïãú Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥ ÏÇ≠Ï†ú
                localStorage.removeItem('mokpo_login_state');
                return false;
            }
        }

        // ÏûêÎèô Î°úÍ∑∏Ïù∏ ÏïåÎ¶º ÌëúÏãú
        function showAutoLoginNotification(userType) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(45deg, #28a745, #20c997);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 600;
                font-size: 14px;
                max-width: 300px;
                animation: slideInRight 0.3s ease;
            `;
            
            notification.innerHTML = `
                üîê ÏûêÎèô Î°úÍ∑∏Ïù∏ ÏôÑÎ£å<br>
                <small>${userType === 'admin' ? 'Í¥ÄÎ¶¨Ïûê' : 'ÏóÖÏ≤¥ Îã¥ÎãπÏûê'}Î°ú Ï†ëÏÜçÎêòÏóàÏäµÎãàÎã§</small>
            `;
            
            // Ïï†ÎãàÎ©îÏù¥ÏÖò Ïä§ÌÉÄÏùº Ï∂îÍ∞Ä
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOutRight {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            // 5Ï¥à ÌõÑ ÏûêÎèô Ï†úÍ±∞
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }

        function logout() {
            // Î°úÍ∑∏ÏïÑÏõÉ Ï†ÑÏö© Ïª§Ïä§ÌÖÄ Î™®Îã¨ ÏÉùÏÑ±
            createLogoutConfirmModal();
        }

        function createLogoutConfirmModal() {
            // Í∏∞Ï°¥ Î™®Îã¨Ïù¥ ÏûàÎã§Î©¥ Ï†úÍ±∞
            const existingModal = document.getElementById('logoutConfirmModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // ÏÉà Î°úÍ∑∏ÏïÑÏõÉ Î™®Îã¨ ÏÉùÏÑ±
            const modal = document.createElement('div');
            modal.id = 'logoutConfirmModal';
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '9999';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-title" style="color: #ff9800; margin-bottom: 20px;">
                        üö™ Î°úÍ∑∏ÏïÑÏõÉ ÌôïÏù∏
                    </div>
                    <div class="modal-message" style="margin-bottom: 30px; white-space: pre-line;">
                        Ï†ïÎßê Î°úÍ∑∏ÏïÑÏõÉÌïòÏãúÍ≤†ÏäµÎãàÍπå?

‚ö†Ô∏è ÏßÑÌñâ Ï§ëÏù∏ ÏûëÏóÖÏù¥ Ï†ÄÏû•ÎêòÏßÄ ÏïäÏùÑ Ïàò ÏûàÏäµÎãàÎã§.
üíæ ÌòÑÏû¨ ÏûëÏóÖÏùÄ ÏûêÎèôÏúºÎ°ú Ï†ÄÏû•Îê©ÎãàÎã§.
                    </div>
                    <div class="modal-buttons">
                        <button class="modal-btn" style="background: #ff9800; color: white;" onclick="confirmLogout()">
                            üö™ Î°úÍ∑∏ÏïÑÏõÉ
                        </button>
                        <button class="modal-btn" style="background: #6c757d; color: white;" onclick="cancelLogout()">
                            ‚úñÔ∏è Ï∑®ÏÜå
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Ï†ÑÏó≠ Ìï®ÏàòÎ°ú Îì±Î°ù
            window.confirmLogout = () => {
                modal.remove();
                performLogout();
            };
            
            window.cancelLogout = () => {
                modal.remove();
            };
            
            // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Ï∑®ÏÜå
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function performLogout() {
            // ÌòÑÏû¨ ÏûëÏóÖ Ï†ÄÏû•
            if (currentUserType === 'admin') {
                try {
                    saveCurrentPage(false);
                    if (workNotes) {
                        saveData(); // ÏóÖÎ¨¥ Î©îÎ™® Ï†ÄÏû•
                    }
                } catch (error) {
                    // Ï†ÄÏû• Ï§ë Ïò§Î•ò Î¨¥Ïãú
                }
            }
            
            // ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
            currentUserType = null;
            currentCategory = null;
            filteredPages = [];
            currentPageIndex = 0;
            
            // UI Ï¥àÍ∏∞Ìôî
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('loginInput').value = '';
            
            // Î°úÍ∑∏Ïù∏ ÌÉ≠ Ï¥àÍ∏∞Ìôî
            const tabs = document.querySelectorAll('.login-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            tabs[0].classList.add('active'); // Ï≤´ Î≤àÏß∏ ÌÉ≠ ÌôúÏÑ±Ìôî
            
            // Î°úÍ∑∏Ïù∏ Ìèº Ï¥àÍ∏∞Ìôî
            const label = document.getElementById('loginLabel');
            const info = document.getElementById('loginInfoText');
            const input = document.getElementById('loginInput');
            
            label.textContent = 'Í¥ÄÎ¶¨Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏';
            info.textContent = 'üí° Îã¥ÎãπÍ≥µÎ¨¥ÏõêÏùÄ Î™®Îì† ÎÇ¥Ïö©ÏùÑ Ìé∏ÏßëÌï† Ïàò ÏûàÏäµÎãàÎã§';
            input.placeholder = 'ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî';
            
            // Î°úÍ∑∏ÏïÑÏõÉ ÏÑ±Í≥µ Î©îÏãúÏßÄ
            setTimeout(() => {
                showSaveModal('‚úÖ Î°úÍ∑∏ÏïÑÏõÉÎêòÏóàÏäµÎãàÎã§!\nÏûëÏóÖ ÎÇ¥Ïö©Ïù¥ ÏûêÎèôÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.\n\nÎã§Ïãú Ïù¥Ïö©ÌïòÏãúÎ†§Î©¥ Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
            }, 200);
        }

        function updateUserInterface() {
            const isAdmin = currentUserType === 'admin';
            const readonlyNotice = document.getElementById('readonlyNotice');
            const userBadge = document.getElementById('userBadge');
            const userName = document.getElementById('userName');

            if (isAdmin) {
                userBadge.textContent = 'Í¥ÄÎ¶¨Ïûê';
                userBadge.className = 'user-badge admin';
                userName.textContent = 'Îã¥ÎãπÍ≥µÎ¨¥Ïõê';
                readonlyNotice.style.display = 'none';
            } else {
                userBadge.textContent = 'ÏóÖÏ≤¥';
                userBadge.className = 'user-badge viewer';
                userName.textContent = 'ÏóÖÏ≤¥ Îã¥ÎãπÏûê';
                readonlyNotice.style.display = 'block';
                
                // ÏóÖÏ≤¥ Îã¥ÎãπÏûêÎäî Ìï≠ÏÉÅ ÏùΩÍ∏∞ Ï†ÑÏö©
                readonlyNotice.innerHTML = `
                    üìñ ÌòÑÏû¨ <strong>ÏùΩÍ∏∞ Ï†ÑÏö© Î™®Îìú</strong>ÏûÖÎãàÎã§. ÏßÑÌñâ ÏÉÅÌô©ÏùÑ ÌôïÏù∏Ìï† Ïàò ÏûàÏßÄÎßå Ìé∏ÏßëÏùÄ Ìï† Ïàò ÏóÜÏäµÎãàÎã§.<br>
                    üí° Í¥ÄÎ¶¨ÏûêÎßå Ìé∏Ïßë Í∂åÌïúÏù¥ ÏûàÏúºÎ©∞, Î≥ÄÍ≤ΩÏÇ¨Ìï≠ÏùÄ Ïã§ÏãúÍ∞ÑÏúºÎ°ú ÎèôÍ∏∞ÌôîÎê©ÎãàÎã§.
                `;
            }

            // Ìé∏Ïßë Í∂åÌïú ÏÑ§Ï†ï
            const editableElements = ['beforeContent', 'afterContent', 'workNotes'];
            editableElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (!isAdmin) {
                        element.disabled = true;
                        element.placeholder = 'ÏùΩÍ∏∞ Ï†ÑÏö© - Í¥ÄÎ¶¨ÏûêÎßå Ìé∏Ïßë Í∞ÄÎä•';
                        element.style.background = '#f8f9fa';
                        element.style.color = '#6c757d';
                    } else if (!editingUser) {
                        element.disabled = false;
                        element.placeholder = '';
                        element.style.background = '';
                        element.style.color = '';
                    }
                }
            });

            const adminOnlyButtons = [
                'saveBtn', 'addPageBtn', 'deleteBtn', 'saveNotesBtn',
                'beforeImageBtn', 'afterImageBtn', 'uploadBtn', 'resetBtn', 'menuEditBtn', 
                'uploadBackupBtn', 'compressedBackupBtn', 'clearStorageBtn'
            ];
            
            adminOnlyButtons.forEach(id => {
                const button = document.getElementById(id);
                if (button) {
                    if (!isAdmin) {
                        button.disabled = true;
                        button.style.display = 'none';
                        button.title = 'Í¥ÄÎ¶¨ÏûêÎßå ÏÇ¨Ïö© Í∞ÄÎä•Ìï©ÎãàÎã§';
                    } else if (!editingUser) {
                        button.disabled = false;
                        button.style.display = '';
                        button.title = '';
                    }
                }
            });

            const imageControls = document.querySelectorAll('.image-controls');
            imageControls.forEach(control => {
                control.style.display = isAdmin && !editingUser ? '' : 'none';
            });
        }

        // ==================== Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•/Î°úÎìú (Supabase + localStorage ÌïòÏù¥Î∏åÎ¶¨Îìú) ====================
        
        async function saveData() {
            const data = {
                pages: pages,
                workNotes: workNotes,
                menuStructure: menuStructure,
                lastUpdated: new Date().toISOString(),
                version: '1.0'
            };

            // Îç∞Ïù¥ÌÑ∞ ÌÅ¨Í∏∞ Ï≤¥ÌÅ¨
            const dataString = JSON.stringify(data);
            const dataSizeBytes = new Blob([dataString]).size;
            const dataSizeMB = (dataSizeBytes / (1024 * 1024)).toFixed(2);
            
            console.log(`Ï†ÄÏû• ÏãúÎèÑ: ${dataSizeMB}MB`, {
                pages: pages.length,
                images: pages.reduce((count, p) => count + (p.beforeImage ? 1 : 0) + (p.afterImage ? 1 : 0), 0)
            });

            // ÌÅ¨Í∏∞Í∞Ä ÎÑàÎ¨¥ ÌÅ∞ Í≤ΩÏö∞ Í≤ΩÍ≥†
            if (dataSizeBytes > 8 * 1024 * 1024) { // 8MB Ï¥àÍ≥º
                console.warn('Îç∞Ïù¥ÌÑ∞ ÌÅ¨Í∏∞Í∞Ä Îß§Ïö∞ ÌÅΩÎãàÎã§:', dataSizeMB + 'MB');
                showSaveErrorModal(`‚ö†Ô∏è Îç∞Ïù¥ÌÑ∞ ÌÅ¨Í∏∞ Í≤ΩÍ≥†`, 
                    `ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞ ÌÅ¨Í∏∞: ${dataSizeMB}MB\n\nÏ†ÄÏû•ÏÜå ÌïúÍ≥ÑÏóê Í∞ÄÍπåÏõåÏßÄÍ≥† ÏûàÏäµÎãàÎã§.\nÏù¥ÎØ∏ÏßÄ ÏµúÏ†ÅÌôîÎ•º Í∂åÏû•Ìï©ÎãàÎã§.`);
            }

            // Supabase Ï†ÄÏû• ÏãúÎèÑ
            if (isSupabaseReady && supabase) {
                try {
                    // Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏
                    const { data: existingData, error: selectError } = await supabase
                        .from('mokpo_projects')
                        .select('id')
                        .limit(1);

                    if (selectError && selectError.code !== '42P01') {
                        throw selectError;
                    }

                    const projectData = {
                        project_name: 'Î™©Ìè¨Ïãú ÌÜµÌï©ÎèÑÏÑúÍ¥Ä ÌôàÌéòÏù¥ÏßÄ Í∞úÌé∏',
                        pages: JSON.stringify(data.pages),
                        work_notes: data.workNotes,
                        menu_structure: JSON.stringify(data.menuStructure),
                        updated_at: new Date().toISOString()
                    };

                    let result;
                    if (existingData && existingData.length > 0) {
                        // ÏóÖÎç∞Ïù¥Ìä∏
                        result = await supabase
                            .from('mokpo_projects')
                            .update(projectData)
                            .eq('id', existingData[0].id);
                    } else {
                        // ÏÉàÎ°ú ÏÉùÏÑ±
                        result = await supabase
                            .from('mokpo_projects')
                            .insert([projectData]);
                    }

                    if (result.error) {
                        throw result.error;
                    }

                    console.log('Supabase Ï†ÄÏû• ÏÑ±Í≥µ');
                    
                    // Supabase Ï†ÄÏû• ÏÑ±Í≥µ Ïãú localStorageÏóêÎèÑ Î∞±ÏóÖ
                    try {
                        localStorage.setItem('mokpo_library_data', dataString);
                        console.log('localStorage Î∞±ÏóÖ ÏÑ±Í≥µ');
                    } catch (localError) {
                        console.warn('localStorage Î∞±ÏóÖ Ïã§Ìå®:', localError);
                        showSaveErrorModal('‚ö†Ô∏è Î°úÏª¨ Î∞±ÏóÖ Ïã§Ìå®', 
                            `ÌÅ¥ÎùºÏö∞Îìú Ï†ÄÏû•ÏùÄ ÏÑ±Í≥µÌñàÏßÄÎßå Î°úÏª¨ Î∞±ÏóÖÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\n\nÏò§Î•ò: ${localError.message}\n\nÎ∏åÎùºÏö∞Ï†Ä Ï†ÄÏû• Í≥µÍ∞ÑÏù¥ Î∂ÄÏ°±Ìï† Ïàò ÏûàÏäµÎãàÎã§.`);
                    }
                    
                    // Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ Î≥ÄÍ≤Ω Î∏åÎ°úÎìúÏ∫êÏä§Ìä∏ (Í¥ÄÎ¶¨ÏûêÎßå)
                    if (currentUserType === 'admin') {
                        broadcastDataUpdate();
                    }
                    
                    // ÏÉÅÌÉú ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
                    updateConnectionStatus('‚òÅÔ∏è ÌÅ¥ÎùºÏö∞Îìú Ï†ÄÏû• ÏôÑÎ£å');
                    return true;

                } catch (error) {
                    console.error('Supabase Ï†ÄÏû• Ïã§Ìå®:', error);
                    
                    // Supabase Ïã§Ìå® Ïãú localStorageÎ°ú Ìè¥Î∞±
                    try {
                        localStorage.setItem('mokpo_library_data', dataString);
                        console.log('localStorage Ìè¥Î∞± Ï†ÄÏû• ÏÑ±Í≥µ');
                        updateConnectionStatus('üíæ Î°úÏª¨ Ï†ÄÏû• (ÌÅ¥ÎùºÏö∞Îìú Ïó∞Í≤∞ Ïã§Ìå®)');
                        
                        // Supabase Ïò§Î•ò ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÌëúÏãú
                        showSaveErrorModal('‚òÅÔ∏è ÌÅ¥ÎùºÏö∞Îìú Ï†ÄÏû• Ïã§Ìå®', 
                            `ÌÅ¥ÎùºÏö∞Îìú Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏßÄÎßå Î°úÏª¨ÏóêÎäî Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.\n\nÏò§Î•ò Ï†ïÎ≥¥: ${error.message}\n\nÎç∞Ïù¥ÌÑ∞ ÌÅ¨Í∏∞: ${dataSizeMB}MB`);
                        
                        return true;
                    } catch (localError) {
                        console.error('localStorage Ìè¥Î∞±ÎèÑ Ïã§Ìå®:', localError);
                        updateConnectionStatus('‚ùå Ï†ÄÏû• Ïã§Ìå®');
                        
                        // ÏôÑÏ†ÑÌïú Ï†ÄÏû• Ïã§Ìå®
                        showSaveErrorModal('üí• Ï†ÄÏû• ÏôÑÏ†Ñ Ïã§Ìå®', 
                            `Î™®Îì† Ï†ÄÏû• Î∞©ÏãùÏù¥ Ïã§Ìå®ÌñàÏäµÎãàÎã§!\n\nÌÅ¥ÎùºÏö∞Îìú Ïò§Î•ò: ${error.message}\nÎ°úÏª¨ Ïò§Î•ò: ${localError.message}\n\nÎç∞Ïù¥ÌÑ∞ ÌÅ¨Í∏∞: ${dataSizeMB}MB\n\nÏ¶âÏãú Î∞±ÏóÖÏùÑ Îã§Ïö¥Î°úÎìúÌïòÍ≥† Ïù¥ÎØ∏ÏßÄÎ•º ÏµúÏ†ÅÌôîÌïòÏÑ∏Ïöî.`);
                        
                        return false;
                    }
                }
            } else {
                // Supabase ÎØ∏ÏÑ§Ï†ï Ïãú localStorage ÏÇ¨Ïö©
                try {
                    localStorage.setItem('mokpo_library_data', dataString);
                    console.log('localStorage Ï†ÄÏû• ÏÑ±Í≥µ');
                    updateConnectionStatus('üíæ Î°úÏª¨ Ï†ÄÏû•');
                    return true;
                } catch (error) {
                    console.error('localStorage Ï†ÄÏû• Ïã§Ìå®:', error);
                    updateConnectionStatus('‚ùå Î°úÏª¨ Ï†ÄÏû• Ïã§Ìå®');
                    
                    // localStorage Ï†ÄÏû• Ïã§Ìå® ÏÉÅÏÑ∏ Ï†ïÎ≥¥
                    showSaveErrorModal('üíæ Î°úÏª¨ Ï†ÄÏû• Ïã§Ìå®', 
                        `Î°úÏª¨ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\n\nÏò§Î•ò: ${error.message}\nÎç∞Ïù¥ÌÑ∞ ÌÅ¨Í∏∞: ${dataSizeMB}MB\n\nÏõêÏù∏:\n‚Ä¢ Î∏åÎùºÏö∞Ï†Ä Ï†ÄÏû• Í≥µÍ∞Ñ Î∂ÄÏ°±\n‚Ä¢ Ïù¥ÎØ∏ÏßÄ Îç∞Ïù¥ÌÑ∞ Í≥ºÎã§\n‚Ä¢ Í∞úÏù∏Ï†ïÎ≥¥ Î≥¥Ìò∏ Î™®Îìú\n\nÌï¥Í≤∞Î∞©Î≤ï:\n‚Ä¢ Ïù¥ÎØ∏ÏßÄ ÏµúÏ†ÅÌôî\n‚Ä¢ Î∏åÎùºÏö∞Ï†Ä Ï∫êÏãú Ï†ïÎ¶¨\n‚Ä¢ Îã§Î•∏ Î∏åÎùºÏö∞Ï†Ä ÏÇ¨Ïö©`);
                    
                    return false;
                }
            }
        }

        function showSaveErrorModal(title, message) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '9999';

            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-title" style="color: #dc3545; margin-bottom: 20px; text-align: center;">
                        ${title}
                    </div>
                    <div class="modal-message" style="margin-bottom: 30px; white-space: pre-line; text-align: left; line-height: 1.6; font-size: 14px;">
                        ${message}
                    </div>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="closeSaveErrorModal()" style="margin-right: 10px;">
                            ‚úñÔ∏è Îã´Í∏∞
                        </button>
                        <button class="btn btn-secondary" onclick="showDataSizeAnalysis(); closeSaveErrorModal();" style="margin-right: 10px;">
                            üìä Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù
                        </button>
                        <button class="btn btn-secondary" onclick="downloadBackup(); closeSaveErrorModal();">
                            üì• Í∏¥Í∏â Î∞±ÏóÖ
                        </button>
                    </div>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <h4 style="color: #856404; margin-bottom: 10px;">üö® ÎåÄÏö©Îüâ ÌååÏùº Î≥µÏõê Í∞ÄÏù¥Îìú</h4>
                        <p style="color: #856404; font-size: 13px; margin: 0; line-height: 1.5;">
                            <strong>Ï¶âÏãú ÏãúÎèÑÌï¥Î≥º Î∞©Î≤ï:</strong><br>
                            1. üóúÔ∏è "ÏïïÏ∂ï Î∞±ÏóÖ ÏÉùÏÑ±" ‚Üí ÏõêÎ≥∏ÏùÑ ÏïïÏ∂ïÌïòÏó¨ ÏÉà Î∞±ÏóÖ ÏÉùÏÑ±<br>
                            2. üîÑ Î∏åÎùºÏö∞Ï†Ä ÏÉàÎ°úÍ≥†Ïπ® ÌõÑ Îã§Ïãú ÏãúÎèÑ<br>
                            3. üíæ Îã§Î•∏ Î∏åÎùºÏö∞Ï†ÄÏóêÏÑú ÏãúÎèÑ<br>
                            4. üì± ÏãúÌÅ¨Î¶ø/ÌîÑÎùºÏù¥Îπó Î™®ÎìúÏóêÏÑú ÏãúÎèÑ<br><br>
                            <strong>Í∑ºÎ≥∏ Ìï¥Í≤∞Ï±Ö:</strong><br>
                            ‚Ä¢ Î∏åÎùºÏö∞Ï†Ä Ï∫êÏãú ÏôÑÏ†Ñ Ï†ïÎ¶¨<br>
                            ‚Ä¢ Ïù¥ÎØ∏ÏßÄÎ•º Í∞úÎ≥ÑÏ†ÅÏúºÎ°ú ÏóÖÎ°úÎìú<br>
                            ‚Ä¢ ÌÖçÏä§Ìä∏Îßå Î≥µÏõê ÌõÑ Ïù¥ÎØ∏ÏßÄ Ï∂îÍ∞Ä
                        </p>
                    </div>
                </div>
            `;

            window.closeSaveErrorModal = () => {
                modal.remove();
            };

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            document.body.appendChild(modal);
        }

        // ÎåÄÏö©Îüâ Î∞±ÏóÖ ÏÑ±Í≥µ Î™®Îã¨
        function showLargeBackupSuccessModal(fileSizeMB, originalPages, textSaved, imageRestored) {
            const imagesCount = originalPages ? originalPages.reduce((count, p) => 
                count + (p.beforeImage ? 1 : 0) + (p.afterImage ? 1 : 0), 0) : 0;
            
            let message = `‚úÖ ÎåÄÏö©Îüâ Î∞±ÏóÖ Î≥µÏõê ÏôÑÎ£å!\n\n`;
            message += `üìÅ ÏõêÎ≥∏ ÌÅ¨Í∏∞: ${fileSizeMB}MB\n`;
            message += `üìä Î≥µÏõêÎêú ÌéòÏù¥ÏßÄ: ${pages.length}Í∞ú\n`;
            message += `‚úÖ ÏôÑÎ£åÎêú ÌéòÏù¥ÏßÄ: ${pages.filter(p => p.isCompleted).length}Í∞ú\n\n`;
            
            if (textSaved) {
                message += `üìù ÌÖçÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞: ‚úÖ Î≥µÏõê ÏôÑÎ£å\n`;
            } else {
                message += `üìù ÌÖçÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞: ‚ö†Ô∏è ÌÅ¥ÎùºÏö∞ÎìúÏóêÎßå Ï†ÄÏû•\n`;
            }
            
            if (imagesCount > 0) {
                if (imageRestored) {
                    message += `üñºÔ∏è Ïù¥ÎØ∏ÏßÄ ${imagesCount}Í∞ú: ‚úÖ Î≥µÏõê ÏãúÎèÑÎê®\n`;
                } else {
                    message += `üñºÔ∏è Ïù¥ÎØ∏ÏßÄ ${imagesCount}Í∞ú: ‚è≠Ô∏è Í±¥ÎÑàÎúÄ\n`;
                }
            }
            
            message += `\nüíæ Ï†ÄÏû• ÏúÑÏπò: ${isSupabaseReady ? '‚òÅÔ∏è ÌÅ¥ÎùºÏö∞Îìú' : 'üíæ Î°úÏª¨'}\n\n`;
            
            if (!textSaved || !imageRestored) {
                message += `üí° Ïù¥ÎØ∏ÏßÄÎäî Í∞úÎ≥ÑÏ†ÅÏúºÎ°ú Îã§Ïãú ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.`;
            }
            
            showSaveModal(message);
        }

        async function loadData() {
            // SupabaseÏóêÏÑú Î°úÎìú ÏãúÎèÑ
            if (isSupabaseReady && supabase) {
                try {
                    const { data: supabaseData, error } = await supabase
                        .from('mokpo_projects')
                        .select('*')
                        .order('updated_at', { ascending: false })
                        .limit(1);

                    if (!error && supabaseData && supabaseData.length > 0) {
                        const projectData = supabaseData[0];
                        
                        // Supabase Îç∞Ïù¥ÌÑ∞ ÌååÏã±
                        if (projectData.menu_structure) {
                            menuStructure = JSON.parse(projectData.menu_structure);
                        }
                        if (projectData.pages) {
                            pages = JSON.parse(projectData.pages);
                        }
                        if (projectData.work_notes) {
                            workNotes = projectData.work_notes;
                            document.getElementById('workNotes').value = workNotes;
                        }

                        // localStorageÏóêÎèÑ Î∞±ÏóÖ
                        const backupData = {
                            pages: pages,
                            workNotes: workNotes,
                            menuStructure: menuStructure,
                            lastUpdated: projectData.updated_at,
                            version: '1.0'
                        };
                        localStorage.setItem('mokpo_library_data', JSON.stringify(backupData));
                        
                        updateConnectionStatus('‚òÅÔ∏è ÌÅ¥ÎùºÏö∞Îìú Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å');
                        
                        // ÌéòÏù¥ÏßÄ Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî Î∞è UI ÏóÖÎç∞Ïù¥Ìä∏
                        initializePages();
                        updateAllDisplays();
                        renderMenuGrid();
                        return;
                    }
                } catch (error) {
                    // Supabase Ïã§Ìå® Ïãú localStorageÎ°ú Ìè¥Î∞±
                }
            }

            // localStorageÏóêÏÑú Î°úÎìú (Ìè¥Î∞± ÎòêÎäî Í∏∞Î≥∏)
            try {
                const savedData = localStorage.getItem('mokpo_library_data');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    if (data.menuStructure) {
                        menuStructure = data.menuStructure;
                    }
                    if (data.pages) {
                        pages = data.pages;
                    }
                    if (data.workNotes) {
                        workNotes = data.workNotes;
                        document.getElementById('workNotes').value = workNotes;
                    }
                }
                updateConnectionStatus('üíæ Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å');
            } catch (error) {
                updateConnectionStatus('‚ö†Ô∏è Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®');
            }
            
            // ÌéòÏù¥ÏßÄ Îç∞Ïù¥ÌÑ∞Î•º ÌòÑÏû¨ Î©îÎâ¥ Íµ¨Ï°∞ÏôÄ ÎèôÍ∏∞Ìôî
            initializePages();
            updateAllDisplays();
            renderMenuGrid();
        }

        // Ïó∞Í≤∞ ÏÉÅÌÉú ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
        function updateConnectionStatus(message) {
            const statusElement = document.querySelector('.status-indicator-inline');
            if (statusElement) {
                statusElement.textContent = message;
                
                // ÏÉâÏÉÅ Î≥ÄÍ≤Ω
                if (message.includes('ÌÅ¥ÎùºÏö∞Îìú')) {
                    statusElement.style.background = 'linear-gradient(45deg, #4f46e5, #7c3aed)';
                } else if (message.includes('Î°úÏª¨')) {
                    statusElement.style.background = 'linear-gradient(45deg, #059669, #0d9488)';
                } else if (message.includes('Ïã§Ìå®')) {
                    statusElement.style.background = 'linear-gradient(45deg, #dc2626, #b91c1c)';
                }
            }
        }

        function renderMenuGrid() {
            const menuGrid = document.getElementById('menuGrid');
            menuGrid.innerHTML = '';
            
            Object.keys(menuStructure).forEach(category => {
                const column = document.createElement('div');
                column.className = 'menu-column';
                
                const header = document.createElement('div');
                header.className = 'menu-header';
                header.textContent = category;
                header.style.cursor = 'pointer';
                
                // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Ïπ¥ÌÖåÍ≥†Î¶¨ ÌëúÏãú
                if (currentCategory === category) {
                    header.classList.add('active');
                }
                
                header.addEventListener('click', function() {
                    handleCategoryClick(category);
                });
                column.appendChild(header);
                
                menuStructure[category].forEach(menuItem => {
                    const item = document.createElement('div');
                    item.className = 'menu-item';
                    item.setAttribute('data-page', menuItem);
                    item.textContent = menuItem;
                    item.addEventListener('click', function() {
                        handleMenuClick(menuItem, category);
                    });
                    column.appendChild(item);
                });
                
                menuGrid.appendChild(column);
            });
            
            updateMenuItemStyles();
        }

        function handleCategoryClick(categoryName) {
            currentCategory = categoryName;
            
            // Ìï¥Îãπ Ïπ¥ÌÖåÍ≥†Î¶¨Ïùò ÌéòÏù¥ÏßÄÎì§ ÌïÑÌÑ∞ÎßÅ
            filteredPages = pages.filter(page => {
                return menuStructure[categoryName].includes(page.menuName);
            });
            
            if (filteredPages.length > 0) {
                // Ï≤´ Î≤àÏß∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
                currentPageIndex = 0;
                loadFilteredPage(currentPageIndex);
                updatePageNavigation();
                
                // Î©îÎâ¥ Ï†úÎ™© Î∂ÄÎ∂ÑÏúºÎ°ú Ïä§ÌÅ¨Î°§
                setTimeout(() => {
                    const pageTitle = document.getElementById('pageTitle');
                    pageTitle.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 300);
                
                showSaveModal(`üìÇ ${categoryName} Ïπ¥ÌÖåÍ≥†Î¶¨Í∞Ä ÏÑ†ÌÉùÎêòÏóàÏäµÎãàÎã§!\n${filteredPages.length}Í∞úÏùò ÌéòÏù¥ÏßÄÍ∞Ä ÏûàÏäµÎãàÎã§.`);
            } else {
                // ÌéòÏù¥ÏßÄÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞
                currentPageIndex = 0;
                document.getElementById('pageTitle').textContent = `${categoryName} > ÌéòÏù¥ÏßÄ ÏóÜÏùå`;
                document.getElementById('beforeContent').value = '';
                document.getElementById('afterContent').value = '';
                
                // Ïù¥ÎØ∏ÏßÄ Ïª®ÌÖåÏù¥ÎÑà Ï¥àÍ∏∞Ìôî
                loadImages(null, null);
                
                updatePageNavigation();
                showSaveModal(`üìÇ ${categoryName} Ïπ¥ÌÖåÍ≥†Î¶¨Í∞Ä ÏÑ†ÌÉùÎêòÏóàÏäµÎãàÎã§.\nÏïÑÏßÅ ÌéòÏù¥ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§. ÏÜåÎ©îÎâ¥Î•º ÌÅ¥Î¶≠ÌïòÏó¨ ÏÉà ÌéòÏù¥ÏßÄÎ•º Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî.`);
            }
            
            // Î©îÎâ¥ Í∑∏Î¶¨Îìú ÏóÖÎç∞Ïù¥Ìä∏ (ÏÑ†ÌÉùÎêú Ïπ¥ÌÖåÍ≥†Î¶¨ Í∞ïÏ°∞)
            renderMenuGrid();
        }

        async function handleMenuClick(menuName, categoryName = null) {
            // Ïπ¥ÌÖåÍ≥†Î¶¨Í∞Ä ÏßÄÏ†ïÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ Ï∞æÍ∏∞
            if (!categoryName) {
                for (const [cat, items] of Object.entries(menuStructure)) {
                    if (items.includes(menuName)) {
                        categoryName = cat;
                        break;
                    }
                }
            }
            
            // Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ§Ï†ï
            currentCategory = categoryName;
            filteredPages = pages.filter(page => {
                return menuStructure[categoryName].includes(page.menuName);
            });
            
            // Ìï¥Îãπ ÌéòÏù¥ÏßÄ Ï∞æÍ∏∞
            const pageIndex = filteredPages.findIndex(p => p.menuName === menuName);
            
            if (pageIndex !== -1) {
                currentPageIndex = pageIndex;
                loadFilteredPage(currentPageIndex);
                updatePageNavigation();
                
                setTimeout(() => {
                    const pageTitle = document.getElementById('pageTitle');
                    pageTitle.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 300);
                
            } else if (currentUserType === 'admin') {
                if (confirm(`'${menuName}' ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°ú Ï∂îÍ∞ÄÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                    const newPage = {
                        title: menuName,
                        category: categoryName,
                        beforeContent: '',
                        afterContent: '',
                        beforeImage: null,
                        afterImage: null,
                        isCompleted: false,
                        menuName: menuName
                    };
                    
                    pages.push(newPage);
                    
                    // ÌïÑÌÑ∞Îêú ÌéòÏù¥ÏßÄ Î™©Î°ù Îã§Ïãú ÏÉùÏÑ±
                    filteredPages = pages.filter(page => {
                        return menuStructure[categoryName].includes(page.menuName);
                    });
                    
                    currentPageIndex = filteredPages.length - 1;
                    updateAllDisplays();
                    await saveData();
                    
                    loadFilteredPage(currentPageIndex);
                    updatePageNavigation();
                    
                    setTimeout(() => {
                        const pageTitle = document.getElementById('pageTitle');
                        pageTitle.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                    }, 300);
                }
            }
        }

        function openMenuEditor() {
            if (currentUserType !== 'admin') return;
            
            const modal = document.getElementById('menuEditorModal');
            const editor = document.getElementById('menuEditor');
            
            editor.innerHTML = '';
            
            Object.keys(menuStructure).forEach(category => {
                const categoryDiv = createCategoryEditor(category, menuStructure[category]);
                editor.appendChild(categoryDiv);
            });
            
            modal.style.display = 'block';
        }

        function createCategoryEditor(categoryName, menuItems) {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'category-editor';
            categoryDiv.setAttribute('data-category-name', categoryName); // ÏïàÏ†ÑÌïú Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
            
            const header = document.createElement('div');
            header.className = 'category-header';
            header.innerHTML = `
                <div class="category-title">${categoryName}</div>
                <div class="category-controls">
                    <button class="small-btn edit" onclick="editCategoryByElement(this)">‚úèÔ∏è ÏàòÏ†ï</button>
                    <button class="small-btn delete" onclick="deleteCategoryByElement(this)">üóëÔ∏è ÏÇ≠Ï†ú</button>
                </div>
            `;
            categoryDiv.appendChild(header);
            
            const itemsList = document.createElement('div');
            itemsList.className = 'menu-items-list';
            
            menuItems.forEach((item, index) => {
                const itemEditor = createMenuItemEditor(categoryName, item, index);
                itemsList.appendChild(itemEditor);
            });
            
            const safeId = categoryName.replace(/[^a-zA-Z0-9Í∞Ä-Ìû£]/g, '_');
            const addSection = document.createElement('div');
            addSection.className = 'add-menu-item';
            addSection.innerHTML = `
                <input type="text" placeholder="ÏÉà ÏÜåÎ©îÎâ¥ Ïù¥Î¶Ñ" class="menu-item-input" 
                       id="newItem_${safeId}">
                <button class="small-btn" style="background: #28a745; color: white;" 
                        onclick="addMenuItemByElement(this)">‚ûï Ï∂îÍ∞Ä</button>
            `;
            addSection.setAttribute('data-category-name', categoryName);
            itemsList.appendChild(addSection);
            
            categoryDiv.appendChild(itemsList);
            return categoryDiv;
        }

        function editCategoryByElement(button) {
            const categoryEditor = button.closest('.category-editor');
            const oldName = categoryEditor.getAttribute('data-category-name');
            
            console.log('Editing category:', oldName);
            
            const newName = prompt('ÏÉà ÎåÄÎ©îÎâ¥ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', oldName);
            if (newName && newName.trim() && newName !== oldName) {
                const trimmedName = newName.trim();
                if (menuStructure[trimmedName]) {
                    alert('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî ÎåÄÎ©îÎâ¥ Ïù¥Î¶ÑÏûÖÎãàÎã§.');
                    return;
                }
                
                console.log('Changing category name from', oldName, 'to', trimmedName);
                
                // Î©îÎâ¥ Íµ¨Ï°∞ ÏóÖÎç∞Ïù¥Ìä∏
                menuStructure[trimmedName] = menuStructure[oldName];
                delete menuStructure[oldName];
                
                // ÌéòÏù¥ÏßÄ Ï†ïÎ≥¥ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                pages.forEach(page => {
                    if (page.category === oldName) {
                        page.category = trimmedName;
                    }
                });
                
                console.log('Category renamed successfully');
                saveData();
                openMenuEditor(); // Ìé∏ÏßëÍ∏∞ ÏÉàÎ°úÍ≥†Ïπ®
            }
        }

        function deleteCategoryByElement(button) {
            const categoryEditor = button.closest('.category-editor');
            const categoryName = categoryEditor.getAttribute('data-category-name');
            
            console.log('Attempting to delete category:', categoryName);
            
            if (Object.keys(menuStructure).length <= 1) {
                alert('ÏµúÏÜå 1Í∞úÏùò ÎåÄÎ©îÎâ¥Îäî ÌïÑÏöîÌï©ÎãàÎã§.');
                return;
            }
            
            // Ïª§Ïä§ÌÖÄ ÌôïÏù∏ Î™®Îã¨ ÏÉùÏÑ±
            createCustomConfirmModal(
                `ÎåÄÎ©îÎâ¥ ÏÇ≠Ï†ú ÌôïÏù∏`,
                `Ï†ïÎßê '${categoryName}' ÎåÄÎ©îÎâ¥Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n‚ö†Ô∏è Ïù¥ ÎåÄÎ©îÎâ¥Ïóê ÏÜçÌïú Î™®Îì† ÏÜåÎ©îÎâ¥ÏôÄ Í¥ÄÎ†® ÌéòÏù¥ÏßÄÎèÑ Ìï®Íªò ÏÇ≠Ï†úÎê©ÎãàÎã§.\n‚ö†Ô∏è Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.`,
                () => {
                    console.log('User confirmed category deletion');
                    performCategoryDeletion(categoryName);
                },
                () => {
                    console.log('User cancelled category deletion');
                }
            );
        }

        function performCategoryDeletion(categoryName) {
            console.log('Performing category deletion:', categoryName);
            
            // Í¥ÄÎ†® ÌéòÏù¥ÏßÄÎì§ ÏÇ≠Ï†ú
            const menuItems = menuStructure[categoryName];
            if (menuItems) {
                menuItems.forEach(menuItem => {
                    const pageIndex = pages.findIndex(p => p.menuName === menuItem);
                    if (pageIndex !== -1) {
                        console.log('Deleting page:', pages[pageIndex].title);
                        pages.splice(pageIndex, 1);
                    }
                });
            }
            
            // Î©îÎâ¥ Íµ¨Ï°∞ÏóêÏÑú ÏÇ≠Ï†ú
            delete menuStructure[categoryName];
            console.log('Category deleted from menu structure');
            
            // ÌòÑÏû¨ ÌéòÏù¥ÏßÄ Ïù∏Îç±Ïä§ Ï°∞Ï†ï
            if (currentPageIndex >= pages.length) {
                currentPageIndex = Math.max(0, pages.length - 1);
            }
            
            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Ïπ¥ÌÖåÍ≥†Î¶¨Í∞Ä ÏÇ≠Ï†úÎêú Í≤ΩÏö∞ Ï¥àÍ∏∞Ìôî
            if (currentCategory === categoryName) {
                currentCategory = null;
                filteredPages = [];
            }
            
            saveData();
            openMenuEditor(); // Ìé∏ÏßëÍ∏∞ ÏÉàÎ°úÍ≥†Ïπ®
            showSaveModal(`‚úÖ '${categoryName}' ÎåÄÎ©îÎâ¥Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.\nÍ¥ÄÎ†® ÌéòÏù¥ÏßÄÎì§ÎèÑ Ìï®Íªò ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.`);
        }

        function addMenuItemByElement(button) {
            const addSection = button.closest('.add-menu-item');
            const categoryName = addSection.getAttribute('data-category-name');
            const input = addSection.querySelector('.menu-item-input');
            const itemName = input.value.trim();
            
            console.log('Adding menu item to category:', categoryName, 'item:', itemName);
            
            if (!itemName) {
                alert('ÏÜåÎ©îÎâ¥ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            const allMenuItems = Object.values(menuStructure).flat();
            if (allMenuItems.includes(itemName)) {
                alert('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî ÏÜåÎ©îÎâ¥ Ïù¥Î¶ÑÏûÖÎãàÎã§.');
                return;
            }
            
            menuStructure[categoryName].push(itemName);
            
            // ÏÉà ÏÜåÎ©îÎâ¥Ïóê ÎåÄÌïú ÌéòÏù¥ÏßÄ ÏûêÎèô ÏÉùÏÑ±
            pages.push({
                title: itemName,
                category: categoryName,
                beforeContent: "",
                afterContent: "",
                beforeImage: null,
                afterImage: null,
                isCompleted: false,
                menuName: itemName
            });
            
            input.value = '';
            console.log('Menu item added successfully');
            openMenuEditor();
        }

        function createMenuItemEditor(categoryName, itemName, index) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'menu-item-editor';
            
            // Î©îÎâ¥ Ïù¥Î¶ÑÏúºÎ°ú ÏãùÎ≥ÑÌïòÎèÑÎ°ù Î≥ÄÍ≤Ω
            itemDiv.setAttribute('data-category', categoryName);
            itemDiv.setAttribute('data-item-name', itemName);
            
            itemDiv.innerHTML = `
                <input type="text" value="${itemName}" class="menu-item-input" 
                       onchange="updateMenuItemByName(this, '${categoryName}', '${itemName}')">
                <button class="small-btn edit" onclick="moveMenuItemUpByName(this)">‚¨ÜÔ∏è</button>
                <button class="small-btn edit" onclick="moveMenuItemDownByName(this)">‚¨áÔ∏è</button>
                <button class="small-btn delete" onclick="deleteMenuItemByName(this)">üóëÔ∏è</button>
            `;
            return itemDiv;
        }

        function deleteMenuItemByName(button) {
            const itemEditor = button.closest('.menu-item-editor');
            const categoryName = itemEditor.getAttribute('data-category');
            const itemName = itemEditor.getAttribute('data-item-name');
            
            if (!menuStructure[categoryName]) {
                alert('Ïπ¥ÌÖåÍ≥†Î¶¨Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§: ' + categoryName);
                return;
            }
            
            // Î∞∞Ïó¥Ïù¥ ÏïÑÎãå Í≤ΩÏö∞ Î∞∞Ïó¥Î°ú Î≥ÄÌôò
            if (!Array.isArray(menuStructure[categoryName])) {
                menuStructure[categoryName] = Object.values(menuStructure[categoryName]);
            }
            
            if (menuStructure[categoryName].length <= 1) {
                alert('Í∞Å ÎåÄÎ©îÎâ¥ÏóêÎäî ÏµúÏÜå 1Í∞úÏùò ÏÜåÎ©îÎâ¥Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§.');
                return;
            }
            
            const index = menuStructure[categoryName].findIndex(item => item === itemName);
            
            if (index === -1) {
                alert('ÏÜåÎ©îÎâ¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§: ' + itemName);
                return;
            }
            
            // Ïª§Ïä§ÌÖÄ ÌôïÏù∏ Î™®Îã¨ ÏÉùÏÑ± (confirm ÎåÄÏã†)
            createCustomConfirmModal(
                `ÏÜåÎ©îÎâ¥ ÏÇ≠Ï†ú ÌôïÏù∏`,
                `'${itemName}' ÏÜåÎ©îÎâ¥Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n‚ö†Ô∏è Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.\n‚ö†Ô∏è Í¥ÄÎ†®Îêú ÌéòÏù¥ÏßÄÎèÑ Ìï®Íªò ÏÇ≠Ï†úÎê©ÎãàÎã§.`,
                () => {
                    performDeletion(categoryName, itemName, index);
                },
                () => {
                    // Ï∑®ÏÜå Ïãú ÏïÑÎ¨¥Í≤ÉÎèÑ ÌïòÏßÄ ÏïäÏùå
                }
            );
        }

        function createCustomConfirmModal(title, message, onConfirm, onCancel) {
            // Í∏∞Ï°¥ Î™®Îã¨Ïù¥ ÏûàÎã§Î©¥ Ï†úÍ±∞
            const existingModal = document.getElementById('customConfirmModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // ÏÉà Î™®Îã¨ ÏÉùÏÑ±
            const modal = document.createElement('div');
            modal.id = 'customConfirmModal';
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '9999';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-title" style="color: #dc3545; margin-bottom: 20px;">
                        üóëÔ∏è ${title}
                    </div>
                    <div class="modal-message" style="margin-bottom: 30px; white-space: pre-line;">
                        ${message}
                    </div>
                    <div class="modal-buttons">
                        <button class="modal-btn" style="background: #dc3545; color: white;" onclick="confirmCustomModal()">
                            üóëÔ∏è ÏÇ≠Ï†úÌïòÍ∏∞
                        </button>
                        <button class="modal-btn" style="background: #6c757d; color: white;" onclick="cancelCustomModal()">
                            ‚úñÔ∏è Ï∑®ÏÜå
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Ï†ÑÏó≠ Ìï®ÏàòÎ°ú Îì±Î°ù
            window.confirmCustomModal = () => {
                modal.remove();
                onConfirm();
            };
            
            window.cancelCustomModal = () => {
                modal.remove();
                onCancel();
            };
            
            // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Ï∑®ÏÜå
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                    onCancel();
                }
            });
        }

        function performDeletion(categoryName, itemName, index) {
            // Í¥ÄÎ†® ÌéòÏù¥ÏßÄ ÏÇ≠Ï†ú
            const pageIndex = pages.findIndex(p => p.menuName === itemName);
            if (pageIndex !== -1) {
                pages.splice(pageIndex, 1);
                if (currentPageIndex >= pages.length) {
                    currentPageIndex = Math.max(0, pages.length - 1);
                }
            }
            
            // Î©îÎâ¥ Ìï≠Î™© ÏÇ≠Ï†ú
            menuStructure[categoryName].splice(index, 1);
            
            // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
            saveData();
            
            // ÌéòÏù¥ÏßÄ Îç∞Ïù¥ÌÑ∞ Ïû¨ÎèôÍ∏∞Ìôî
            initializePages();
            
            // ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏
            renderMenuGrid();
            updateAllDisplays();
            
            // Î©îÎâ¥ Ìé∏ÏßëÍ∏∞ ÏÉàÎ°úÍ≥†Ïπ®
            setTimeout(() => {
                openMenuEditor();
            }, 100);
            
            // ÏÑ±Í≥µ Î©îÏãúÏßÄ
            showSaveModal(`‚úÖ '${itemName}' ÏÜåÎ©îÎâ¥Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.\nÌéòÏù¥ÏßÄ Îç∞Ïù¥ÌÑ∞ÎèÑ ÏûêÎèôÏúºÎ°ú ÎèôÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.`);
        }

        function moveMenuItemUpByName(button) {
            const itemEditor = button.closest('.menu-item-editor');
            const categoryName = itemEditor.getAttribute('data-category');
            const itemName = itemEditor.getAttribute('data-item-name');
            
            // Î∞∞Ïó¥ ÌôïÏù∏ Î∞è Î≥ÄÌôò
            if (!Array.isArray(menuStructure[categoryName])) {
                menuStructure[categoryName] = Object.values(menuStructure[categoryName]);
            }
            
            const items = menuStructure[categoryName];
            const index = items.findIndex(item => item === itemName);
            
            if (index <= 0) return;
            
            [items[index], items[index - 1]] = [items[index - 1], items[index]];
            saveData();
            openMenuEditor();
        }

        function moveMenuItemDownByName(button) {
            const itemEditor = button.closest('.menu-item-editor');
            const categoryName = itemEditor.getAttribute('data-category');
            const itemName = itemEditor.getAttribute('data-item-name');
            
            // Î∞∞Ïó¥ ÌôïÏù∏ Î∞è Î≥ÄÌôò
            if (!Array.isArray(menuStructure[categoryName])) {
                menuStructure[categoryName] = Object.values(menuStructure[categoryName]);
            }
            
            const items = menuStructure[categoryName];
            const index = items.findIndex(item => item === itemName);
            
            if (index === -1 || index === items.length - 1) return;
            
            [items[index], items[index + 1]] = [items[index + 1], items[index]];
            saveData();
            openMenuEditor();
        }

        async function updateMenuItemByName(input, categoryName, originalName) {
            const trimmedValue = input.value.trim();
            if (!trimmedValue) {
                alert('ÏÜåÎ©îÎâ¥ Ïù¥Î¶ÑÏùÄ ÎπÑÏñ¥ÏûàÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                openMenuEditor();
                return;
            }
            
            // Î∞∞Ïó¥ ÌôïÏù∏ Î∞è Î≥ÄÌôò
            if (!Array.isArray(menuStructure[categoryName])) {
                menuStructure[categoryName] = Object.values(menuStructure[categoryName]);
            }
            
            const allMenuItems = Object.values(menuStructure).flat();
            const otherItems = allMenuItems.filter(item => item !== originalName);
            
            if (otherItems.includes(trimmedValue)) {
                alert('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî ÏÜåÎ©îÎâ¥ Ïù¥Î¶ÑÏûÖÎãàÎã§.');
                openMenuEditor();
                return;
            }
            
            // Î©îÎâ¥ Íµ¨Ï°∞ÏóêÏÑú ÏóÖÎç∞Ïù¥Ìä∏
            const index = menuStructure[categoryName].findIndex(item => item === originalName);
            if (index !== -1) {
                menuStructure[categoryName][index] = trimmedValue;
            }
            
            // ÌéòÏù¥ÏßÄ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
            const page = pages.find(p => p.menuName === originalName);
            if (page) {
                page.menuName = trimmedValue;
                page.title = trimmedValue;
            }
            
            await saveData();
        }

        function editCategoryName(oldName) {
            const newName = prompt('ÏÉà ÎåÄÎ©îÎâ¥ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', oldName);
            if (newName && newName.trim() && newName !== oldName) {
                const trimmedName = newName.trim();
                if (menuStructure[trimmedName]) {
                    alert('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî ÎåÄÎ©îÎâ¥ Ïù¥Î¶ÑÏûÖÎãàÎã§.');
                    return;
                }
                
                menuStructure[trimmedName] = menuStructure[oldName];
                delete menuStructure[oldName];
                
                pages.forEach(page => {
                    if (page.category === oldName) {
                        page.category = trimmedName;
                    }
                });
                
                openMenuEditor();
            }
        }

        function deleteCategory(categoryName) {
            if (Object.keys(menuStructure).length <= 1) {
                alert('ÏµúÏÜå 1Í∞úÏùò ÎåÄÎ©îÎâ¥Îäî ÌïÑÏöîÌï©ÎãàÎã§.');
                return;
            }
            
            if (confirm(`Ï†ïÎßê '${categoryName}' ÎåÄÎ©îÎâ¥Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                const menuItems = menuStructure[categoryName];
                menuItems.forEach(menuItem => {
                    const pageIndex = pages.findIndex(p => p.menuName === menuItem);
                    if (pageIndex !== -1) pages.splice(pageIndex, 1);
                });
                
                delete menuStructure[categoryName];
                
                if (currentPageIndex >= pages.length) {
                    currentPageIndex = Math.max(0, pages.length - 1);
                }
                
                openMenuEditor();
            }
        }

        function addMenuItem(categoryName) {
            const safeId = categoryName.replace(/[^a-zA-Z0-9Í∞Ä-Ìû£]/g, '_');
            const inputId = `newItem_${safeId}`;
            const input = document.getElementById(inputId);
            const itemName = input.value.trim();
            
            if (!itemName) {
                alert('ÏÜåÎ©îÎâ¥ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            const allMenuItems = Object.values(menuStructure).flat();
            if (allMenuItems.includes(itemName)) {
                alert('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî ÏÜåÎ©îÎâ¥ Ïù¥Î¶ÑÏûÖÎãàÎã§.');
                return;
            }
            
            menuStructure[categoryName].push(itemName);
            input.value = '';
            
            // ÏÉà ÏÜåÎ©îÎâ¥Ïóê ÎåÄÌïú ÌéòÏù¥ÏßÄ ÏûêÎèô ÏÉùÏÑ±
            pages.push({
                title: itemName,
                category: categoryName,
                beforeContent: "",
                afterContent: "",
                beforeImage: null,
                afterImage: null,
                isCompleted: false,
                menuName: itemName
            });
            
            openMenuEditor();
        }

        function updateMenuItem(categoryName, index, newValue) {
            const trimmedValue = newValue.trim();
            if (!trimmedValue) {
                alert('ÏÜåÎ©îÎâ¥ Ïù¥Î¶ÑÏùÄ ÎπÑÏñ¥ÏûàÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                openMenuEditor();
                return;
            }
            
            const allMenuItems = Object.values(menuStructure).flat();
            const oldValue = menuStructure[categoryName][index];
            const otherItems = allMenuItems.filter(item => item !== oldValue);
            
            if (otherItems.includes(trimmedValue)) {
                alert('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî ÏÜåÎ©îÎâ¥ Ïù¥Î¶ÑÏûÖÎãàÎã§.');
                openMenuEditor();
                return;
            }
            
            const page = pages.find(p => p.menuName === oldValue);
            if (page) {
                page.menuName = trimmedValue;
                page.title = trimmedValue;
            }
            
            menuStructure[categoryName][index] = trimmedValue;
        }

        function moveMenuItemUp(categoryName, index) {
            if (index === 0) return;
            
            const items = menuStructure[categoryName];
            [items[index], items[index - 1]] = [items[index - 1], items[index]];
            openMenuEditor();
        }

        function moveMenuItemDown(categoryName, index) {
            const items = menuStructure[categoryName];
            if (index === items.length - 1) return;
            
            [items[index], items[index + 1]] = [items[index + 1], items[index]];
            openMenuEditor();
        }

        function deleteMenuItem(categoryName, index) {
            if (menuStructure[categoryName].length <= 1) {
                alert('Í∞Å ÎåÄÎ©îÎâ¥ÏóêÎäî ÏµúÏÜå 1Í∞úÏùò ÏÜåÎ©îÎâ¥Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§.');
                return;
            }
            
            const menuItem = menuStructure[categoryName][index];
            if (confirm(`Ï†ïÎßê '${menuItem}' ÏÜåÎ©îÎâ¥Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                const pageIndex = pages.findIndex(p => p.menuName === menuItem);
                if (pageIndex !== -1) {
                    pages.splice(pageIndex, 1);
                    if (currentPageIndex >= pages.length) {
                        currentPageIndex = Math.max(0, pages.length - 1);
                    }
                }
                
                menuStructure[categoryName].splice(index, 1);
                openMenuEditor();
            }
        }

        async function addNewCategory() {
            const input = document.getElementById('newCategoryName');
            const categoryName = input.value.trim();
            
            if (!categoryName) {
                alert('ÎåÄÎ©îÎâ¥ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            if (menuStructure[categoryName]) {
                alert('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî ÎåÄÎ©îÎâ¥ Ïù¥Î¶ÑÏûÖÎãàÎã§.');
                return;
            }
            
            menuStructure[categoryName] = ['ÏÉà ÏÜåÎ©îÎâ¥'];
            input.value = '';
            await saveData();
            openMenuEditor();
        }

        async function resetData() {
            if (confirm('Ï†ïÎßê Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n‚ö†Ô∏è Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.\n‚ö†Ô∏è SupabaseÏôÄ Î°úÏª¨ Ï†ÄÏû•ÏÜåÏùò Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎê©ÎãàÎã§.')) {
                try {
                    // Supabase Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú (Í∞ÄÎä•Ìïú Í≤ΩÏö∞)
                    if (isSupabaseReady && supabase) {
                        try {
                            const { error } = await supabase
                                .from('mokpo_projects')
                                .delete()
                                .neq('id', '00000000-0000-0000-0000-000000000000'); // Î™®Îì† Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
                            
                            if (error) {
                                // ÏÇ≠Ï†ú Ïã§Ìå®Ìï¥ÎèÑ Í≥ÑÏÜç ÏßÑÌñâ
                            }
                        } catch (error) {
                            // Supabase ÏÇ≠Ï†ú Ïã§Ìå®Ìï¥ÎèÑ Í≥ÑÏÜç ÏßÑÌñâ
                        }
                    }
                    
                    // Î°úÏª¨ Ï†ÄÏû•ÏÜå ÏÇ≠Ï†ú
                    localStorage.removeItem('mokpo_library_data');
                    
                    // ÌéòÏù¥ÏßÄ ÏÉàÎ°úÍ≥†Ïπ®
                    location.reload();
                } catch (error) {
                    alert('Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
                }
            }
        }

        function saveMenuStructure() {
            // Î©îÎâ¥ Íµ¨Ï°∞ Ï†ÄÏû• ÌõÑ ÌéòÏù¥ÏßÄ Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî
            saveData();
            initializePages(); // ÌéòÏù¥ÏßÄ Îç∞Ïù¥ÌÑ∞Î•º ÏÉà Î©îÎâ¥ Íµ¨Ï°∞Ïóê ÎßûÍ≤å ÏóÖÎç∞Ïù¥Ìä∏
            renderMenuGrid();
            updateAllDisplays();
            closeMenuEditor();
            showSaveModal('Î©îÎâ¥ Íµ¨Ï°∞Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!\nÌéòÏù¥ÏßÄ Îç∞Ïù¥ÌÑ∞ÎèÑ ÏûêÎèôÏúºÎ°ú ÎèôÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.');
        }

        function closeMenuEditor() {
            document.getElementById('menuEditorModal').style.display = 'none';
        }

        function updateAllDisplays() {
            updateProgress();
            updateMenuItemStyles();
            updatePageSelector();
            loadPage(currentPageIndex);
        }

        function updateMenuItemStyles() {
            document.querySelectorAll('.menu-item').forEach(item => {
                const menuName = item.getAttribute('data-page');
                const page = pages.find(p => p.menuName === menuName);
                
                // Î™®Îì† ÌÅ¥ÎûòÏä§ Ï¥àÍ∏∞Ìôî
                item.classList.remove('page-exists', 'page-completed', 'current-page');
                
                if (page) {
                    item.classList.add('page-exists');
                    if (page.isCompleted) {
                        item.classList.add('page-completed');
                    }
                    
                    // ÌòÑÏû¨ Ìé∏Ïßë Ï§ëÏù∏ ÌéòÏù¥ÏßÄ Í∞ïÏ°∞
                    if (currentCategory) {
                        const currentPage = filteredPages[currentPageIndex];
                        if (currentPage && currentPage.menuName === menuName) {
                            item.classList.add('current-page');
                        }
                    } else {
                        const currentPage = pages[currentPageIndex];
                        if (currentPage && currentPage.menuName === menuName) {
                            item.classList.add('current-page');
                        }
                    }
                }
            });
        }

        function updatePageSelector() {
            const pageSelector = document.getElementById('pageSelector');
            pageSelector.innerHTML = '';
            
            pages.forEach((page, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${index + 1}. ${page.title}`;
                if (index === currentPageIndex) {
                    option.selected = true;
                }
                pageSelector.appendChild(option);
            });
        }

        function loadPage(index) {
            if (index < 0 || index >= pages.length) return;
            
            const page = pages[index];
            document.getElementById('pageTitle').textContent = page.title;
            document.getElementById('beforeContent').value = page.beforeContent;
            document.getElementById('afterContent').value = page.afterContent;
            
            loadImages(page.beforeImage, page.afterImage);
            updateNavigationButtons();
            updateMenuItemStyles(); // ÌòÑÏû¨ ÌéòÏù¥ÏßÄ Í∞ïÏ°∞ ÏóÖÎç∞Ïù¥Ìä∏
            
            document.getElementById('currentPageNum').textContent = index + 1;
            document.getElementById('totalPageNum').textContent = pages.length;
        }

        function loadImages(beforeImage, afterImage) {
            const beforeContainer = document.getElementById('beforeImageContainer');
            const afterContainer = document.getElementById('afterImageContainer');
            
            if (beforeImage) {
                beforeContainer.innerHTML = `
                    <img src="${beforeImage}" class="uploaded-image" alt="Í∞úÌé∏ Ï†Ñ Ïù¥ÎØ∏ÏßÄ">
                    <div class="image-controls">
                        <button onclick="removeBeforeImage()">√ó</button>
                    </div>
                `;
            } else {
                beforeContainer.innerHTML = `
                    <div class="image-placeholder">
                        ÌòÑÏû¨ ÌôîÎ©¥ Ïù¥ÎØ∏ÏßÄÎ•º ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî
                    </div>
                    <div class="image-controls">
                        <button onclick="removeBeforeImage()">√ó</button>
                    </div>
                `;
            }
            
            if (afterImage) {
                afterContainer.innerHTML = `
                    <img src="${afterImage}" class="uploaded-image" alt="Í∞úÌé∏ ÌõÑ Ïù¥ÎØ∏ÏßÄ">
                    <div class="image-controls">
                        <button onclick="removeAfterImage()">√ó</button>
                    </div>
                `;
            } else {
                afterContainer.innerHTML = `
                    <div class="image-placeholder">
                        Î™©Ìëú ÌôîÎ©¥ Ïù¥ÎØ∏ÏßÄÎ•º ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî
                    </div>
                    <div class="image-controls">
                        <button onclick="removeAfterImage()">√ó</button>
                    </div>
                `;
            }
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            prevBtn.disabled = currentPageIndex === 0;
            nextBtn.disabled = currentPageIndex === pages.length - 1;
        }

        function updateProgress() {
            const completedPages = pages.filter(page => page.isCompleted).length;
            const totalPages = pages.length;
            const progress = totalPages > 0 ? (completedPages / totalPages) * 100 : 0;
            
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = 
                `${Math.round(progress)}% ÏôÑÎ£å (${completedPages}/${totalPages} ÌéòÏù¥ÏßÄ)`;
            
            document.getElementById('totalPages').textContent = `${totalPages}Í∞ú`;
            document.getElementById('completedPages').textContent = `${completedPages}Í∞ú`;
        }

        function previousPage() {
            if (currentPageIndex > 0) {
                savePage(false);
                currentPageIndex--;
                loadPage(currentPageIndex);
            }
        }

        function nextPage() {
            if (currentPageIndex < pages.length - 1) {
                savePage(false);
                currentPageIndex++;
                loadPage(currentPageIndex);
            }
        }

        function goToPage(index) {
            savePage(false);
            currentPageIndex = parseInt(index);
            loadPage(currentPageIndex);
        }

        function loadFilteredPage(index) {
            if (index < 0 || index >= filteredPages.length) return;
            
            const page = filteredPages[index];
            document.getElementById('pageTitle').textContent = `${currentCategory} > ${page.title}`;
            document.getElementById('beforeContent').value = page.beforeContent;
            document.getElementById('afterContent').value = page.afterContent;
            
            loadImages(page.beforeImage, page.afterImage);
            updateNavigationButtons();
            updateMenuItemStyles(); // ÌòÑÏû¨ ÌéòÏù¥ÏßÄ Í∞ïÏ°∞ ÏóÖÎç∞Ïù¥Ìä∏
            
            document.getElementById('currentPageNum').textContent = index + 1;
            document.getElementById('totalPageNum').textContent = filteredPages.length;
        }

        function updatePageNavigation() {
            const categorySelector = document.getElementById('categorySelector');
            const pageSelector = document.getElementById('pageSelector');
            
            // ÎåÄÎ©îÎâ¥ ÏÑ†ÌÉùÍ∏∞ ÏóÖÎç∞Ïù¥Ìä∏
            categorySelector.innerHTML = '<option value="">üìÇ ÎåÄÎ©îÎâ¥ ÏÑ†ÌÉù</option>';
            Object.keys(menuStructure).forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = `üìÇ ${category}`;
                if (currentCategory === category) {
                    option.selected = true;
                }
                categorySelector.appendChild(option);
            });
            
            // ÏÜåÎ©îÎâ¥ ÏÑ†ÌÉùÍ∏∞ ÏóÖÎç∞Ïù¥Ìä∏
            if (currentCategory) {
                pageSelector.disabled = false;
                pageSelector.innerHTML = '<option value="">üìÑ ÏÜåÎ©îÎâ¥ ÏÑ†ÌÉù</option>';
                
                filteredPages.forEach((page, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `üìÑ ${page.title}`;
                    if (index === currentPageIndex) {
                        option.selected = true;
                    }
                    pageSelector.appendChild(option);
                });
            } else {
                pageSelector.disabled = true;
                pageSelector.innerHTML = '<option value="">üìÑ Î®ºÏ†Ä ÎåÄÎ©îÎâ¥Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';
            }
        }

        function onCategoryChange(categoryName) {
            if (categoryName) {
                handleCategoryClick(categoryName);
            } else {
                // Ï†ÑÏ≤¥ Î≥¥Í∏∞ Î™®ÎìúÎ°ú Ï†ÑÌôò
                currentCategory = null;
                filteredPages = [];
                currentPageIndex = 0;
                
                if (pages.length > 0) {
                    loadPage(0);
                } else {
                    document.getElementById('pageTitle').textContent = 'Î©îÏù∏ ÌéòÏù¥ÏßÄ';
                    document.getElementById('beforeContent').value = '';
                    document.getElementById('afterContent').value = '';
                }
                
                updatePageNavigation();
                renderMenuGrid();
                showSaveModal('üìÇ Ï†ÑÏ≤¥ ÌéòÏù¥ÏßÄ Î≥¥Í∏∞ Î™®ÎìúÎ°ú Ï†ÑÌôòÎêòÏóàÏäµÎãàÎã§.');
            }
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (currentCategory) {
                // Ïπ¥ÌÖåÍ≥†Î¶¨ Î™®Îìú
                prevBtn.disabled = currentPageIndex === 0;
                nextBtn.disabled = currentPageIndex === filteredPages.length - 1;
            } else {
                // Ï†ÑÏ≤¥ Î™®Îìú
                prevBtn.disabled = currentPageIndex === 0;
                nextBtn.disabled = currentPageIndex === pages.length - 1;
            }
        }

        function previousPage() {
            if (currentCategory) {
                // Ïπ¥ÌÖåÍ≥†Î¶¨ Î™®Îìú
                if (currentPageIndex > 0) {
                    autoSavePage(); // ÏûêÎèô Ï†ÄÏû•
                    currentPageIndex--;
                    loadFilteredPage(currentPageIndex);
                }
            } else {
                // Ï†ÑÏ≤¥ Î™®Îìú
                if (currentPageIndex > 0) {
                    autoSavePage(); // ÏûêÎèô Ï†ÄÏû•
                    currentPageIndex--;
                    loadPage(currentPageIndex);
                }
            }
        }

        function nextPage() {
            if (currentCategory) {
                // Ïπ¥ÌÖåÍ≥†Î¶¨ Î™®Îìú
                if (currentPageIndex < filteredPages.length - 1) {
                    autoSavePage(); // ÏûêÎèô Ï†ÄÏû•
                    currentPageIndex++;
                    loadFilteredPage(currentPageIndex);
                }
            } else {
                // Ï†ÑÏ≤¥ Î™®Îìú
                if (currentPageIndex < pages.length - 1) {
                    autoSavePage(); // ÏûêÎèô Ï†ÄÏû•
                    currentPageIndex++;
                    loadPage(currentPageIndex);
                }
            }
        }

        function goToPage(index) {
            if (currentCategory) {
                // Ïπ¥ÌÖåÍ≥†Î¶¨ Î™®Îìú
                autoSavePage(); // ÏûêÎèô Ï†ÄÏû•
                currentPageIndex = parseInt(index);
                loadFilteredPage(currentPageIndex);
            } else {
                // Ï†ÑÏ≤¥ Î™®Îìú
                autoSavePage(); // ÏûêÎèô Ï†ÄÏû•
                currentPageIndex = parseInt(index);
                loadPage(currentPageIndex);
            }
        }

        function saveCurrentPage(showModal = true) {
            if (currentUserType !== 'admin') return;
            
            let currentPage;
            if (currentCategory) {
                currentPage = filteredPages[currentPageIndex];
            } else {
                currentPage = pages[currentPageIndex];
            }
            
            if (!currentPage) {
                return;
            }

            // Ï†ÄÏû• ÏãúÏûë ÌëúÏãú
            if (!showModal) {
                showSyncIndicator('üíæ Ï†ÄÏû• Ï§ë...');
            }
            
            // ÌÖçÏä§Ìä∏ ÎÇ¥Ïö© Ï†ÄÏû•
            const beforeContent = document.getElementById('beforeContent').value;
            const afterContent = document.getElementById('afterContent').value;
            
            currentPage.beforeContent = beforeContent;
            currentPage.afterContent = afterContent;
            
            // ÏôÑÎ£å ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            const isCompleted = updatePageCompletionStatus(currentPage);
            
            // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Î∞è Í≤∞Í≥º ÌôïÏù∏
            saveData().then(success => {
                if (success) {
                    if (showModal) {
                        const statusText = isCompleted ? '‚úÖ ÏôÑÎ£åÎê®' : '‚è≥ ÏßÑÌñâ Ï§ë';
                        showSaveModal(`üíæ '${currentPage.title}' ÌéòÏù¥ÏßÄÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!\n\nÏÉÅÌÉú: ${statusText}`);
                    } else {
                        showSyncIndicator('‚úÖ Ï†ÄÏû• ÏôÑÎ£å');
                    }
                    hasUnsavedChanges = false;
                } else {
                    // Ï†ÄÏû• Ïã§Ìå® Ï≤òÎ¶¨
                    if (showModal) {
                        showSaveModal(`‚ùå '${currentPage.title}' ÌéòÏù¥ÏßÄ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\n\nüìä Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑùÏùÑ ÌÜµÌï¥ ÏõêÏù∏ÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.`);
                    } else {
                        showSyncIndicator('‚ùå Ï†ÄÏû• Ïã§Ìå®');
                    }
                }
            }).catch(error => {
                console.error('ÌéòÏù¥ÏßÄ Ï†ÄÏû• Ï§ë ÏòàÏô∏ Î∞úÏÉù:', error);
                showSyncIndicator('üí• Ï†ÄÏû• Ïò§Î•ò');
                if (showModal) {
                    showSaveErrorModal('üí• ÌéòÏù¥ÏßÄ Ï†ÄÏû• Ïò§Î•ò', 
                        `'${currentPage.title}' Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\n\nÏò§Î•ò Ï†ïÎ≥¥: ${error.message}\n\nÎç∞Ïù¥ÌÑ∞ Î∞±ÏóÖÏùÑ Í∂åÏû•Ìï©ÎãàÎã§.`);
                }
            });
        }

        // ÏïàÏ†ÑÌïú ÏûêÎèô Ï†ÄÏû• (Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù Ìè¨Ìï®)
        async function safeAutoSave() {
            if (currentUserType !== 'admin' || !hasUnsavedChanges) {
                return false;
            }
            
            // ÌòÑÏû¨ ÌôîÎ©¥Ïùò ÎÇ¥Ïö©Ïù¥ ÎπÑÏñ¥ÏûàÏßÄ ÏïäÏùÄÏßÄ ÌôïÏù∏
            const beforeContent = document.getElementById('beforeContent').value.trim();
            const afterContent = document.getElementById('afterContent').value.trim();
            const workNotesContent = document.getElementById('workNotes').value.trim();
            
            // Î™®Îì† ÎÇ¥Ïö©Ïù¥ ÎπÑÏñ¥ÏûàÏúºÎ©¥ Ï†ÄÏû•ÌïòÏßÄ ÏïäÏùå (Îç∞Ïù¥ÌÑ∞ ÏÜêÏã§ Î∞©ÏßÄ)
            if (!beforeContent && !afterContent && !workNotesContent) {
                console.log('ÏûêÎèôÏ†ÄÏû• Í±¥ÎÑàÎúÄ: Î™®Îì† ÎÇ¥Ïö©Ïù¥ ÎπÑÏñ¥ÏûàÏùå');
                return false;
            }
            
            try {
                console.log('ÏïàÏ†ÑÌïú ÏûêÎèôÏ†ÄÏû• ÏãúÏûë:', new Date().toLocaleTimeString());
                showSyncIndicator('üíæ ÏûêÎèô Ï†ÄÏû• Ï§ë...');
                
                const success = await saveCurrentPageWithoutModal();
                
                if (success) {
                    hasUnsavedChanges = false;
                    console.log('ÏïàÏ†ÑÌïú ÏûêÎèôÏ†ÄÏû• ÏôÑÎ£å');
                    showSyncIndicator('‚úÖ ÏûêÎèô Ï†ÄÏû•Îê®');
                    return true;
                } else {
                    console.error('ÏûêÎèôÏ†ÄÏû• Ïã§Ìå®: saveData returned false');
                    showSyncIndicator('‚ö†Ô∏è ÏûêÎèôÏ†ÄÏû• Ïã§Ìå®');
                    return false;
                }
            } catch (error) {
                console.error('ÏûêÎèôÏ†ÄÏû• ÏòàÏô∏:', error);
                showSyncIndicator('üí• ÏûêÎèôÏ†ÄÏû• Ïò§Î•ò');
                
                // ÏπòÎ™ÖÏ†ÅÏù∏ Ïò§Î•òÏù∏ Í≤ΩÏö∞ ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÏïåÎ¶º
                if (error.message.includes('quota') || error.message.includes('storage')) {
                    setTimeout(() => {
                        showSaveErrorModal('üö® ÏûêÎèôÏ†ÄÏû• Ïã§Ìå®', 
                            `ÏûêÎèôÏ†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\n\nÏõêÏù∏: Ï†ÄÏû• Í≥µÍ∞Ñ Î∂ÄÏ°±\n\nÏ¶âÏãú Î∞±ÏóÖÏùÑ Îã§Ïö¥Î°úÎìúÌïòÍ≥† Ïù¥ÎØ∏ÏßÄÎ•º ÏµúÏ†ÅÌôîÌïòÏÑ∏Ïöî.`);
                    }, 2000);
                }
                
                return false;
            }
        }

        // Î™®Îã¨ ÏóÜÏù¥ ÌéòÏù¥ÏßÄ Ï†ÄÏû•
        async function saveCurrentPageWithoutModal() {
            if (currentUserType !== 'admin') return false;
            
            let currentPage;
            if (currentCategory) {
                currentPage = filteredPages[currentPageIndex];
            } else {
                currentPage = pages[currentPageIndex];
            }
            
            if (!currentPage) {
                return false;
            }
            
            // ÌÖçÏä§Ìä∏ ÎÇ¥Ïö© Ï†ÄÏû•
            const beforeContent = document.getElementById('beforeContent').value;
            const afterContent = document.getElementById('afterContent').value;
            
            currentPage.beforeContent = beforeContent;
            currentPage.afterContent = afterContent;
            
            // ÏôÑÎ£å ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            updatePageCompletionStatus(currentPage);
            
            // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
            return await saveData();
        }

        function savePage(showModal = true) {
            // Ïπ¥ÌÖåÍ≥†Î¶¨ Î™®ÎìúÏóêÏÑúÎäî saveCurrentPage ÏÇ¨Ïö©
            if (currentCategory) {
                saveCurrentPage(showModal);
                return;
            }
            
            if (currentUserType !== 'admin') return;
            
            // Ï†ÄÏû• ÏãúÏûë ÌëúÏãú
            showSyncIndicator('üíæ Ï†ÄÏû• Ï§ë...');
            
            const currentPage = pages[currentPageIndex];
            currentPage.beforeContent = document.getElementById('beforeContent').value;
            currentPage.afterContent = document.getElementById('afterContent').value;
            
            const beforeCompleted = currentPage.beforeContent.trim() !== '' || currentPage.beforeImage;
            const afterCompleted = currentPage.afterContent.trim() !== '' || currentPage.afterImage;
            
            currentPage.isCompleted = beforeCompleted && afterCompleted;
            
            updateProgress();
            updateMenuItemStyles();
            
            // Ï†ÄÏû• Ïã§Ìñâ Î∞è Í≤∞Í≥º ÌôïÏù∏
            saveData().then(success => {
                if (success) {
                    if (showModal) {
                        showSaveModal(`‚úÖ '${currentPage.title}' ÌéòÏù¥ÏßÄÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!`);
                    } else {
                        showSyncIndicator('‚úÖ Ï†ÄÏû• ÏôÑÎ£å');
                    }
                    hasUnsavedChanges = false;
                } else {
                    // Ï†ÄÏû• Ïã§Ìå® Ïãú Ï∂îÍ∞Ä Ï≤òÎ¶¨
                    if (showModal) {
                        showSaveModal(`‚ùå '${currentPage.title}' ÌéòÏù¥ÏßÄ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\n\nüìä Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑùÏùÑ ÌÜµÌï¥ ÏõêÏù∏ÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.`);
                    } else {
                        showSyncIndicator('‚ùå Ï†ÄÏû• Ïã§Ìå®');
                    }
                }
            }).catch(error => {
                console.error('Ï†ÄÏû• Ï§ë ÏòàÏô∏ Î∞úÏÉù:', error);
                showSyncIndicator('üí• Ï†ÄÏû• Ïò§Î•ò');
                if (showModal) {
                    showSaveErrorModal('üí• Ï†ÄÏû• Ïò§Î•ò', 
                        `ÌéòÏù¥ÏßÄ Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\n\nÏò§Î•ò Ï†ïÎ≥¥: ${error.message}\n\nÎç∞Ïù¥ÌÑ∞ Î∂ÑÏÑùÏùÑ ÌÜµÌï¥ ÏõêÏù∏ÏùÑ ÌôïÏù∏ÌïòÍ≥† Î∞±ÏóÖÏùÑ Îã§Ïö¥Î°úÎìúÌïòÏÑ∏Ïöî.`);
                }
            });
        }

        function saveWorkNotes() {
            if (currentUserType !== 'admin') return;
            
            // Ï†ÄÏû• ÏãúÏûë ÌëúÏãú
            showSyncIndicator('üíæ Î©îÎ™® Ï†ÄÏû• Ï§ë...');
            
            workNotes = document.getElementById('workNotes').value;
            
            saveData().then(success => {
                if (success) {
                    showSaveModal('‚úÖ ÏóÖÎ¨¥ ÏßÄÏãúÏÇ¨Ìï≠ Î∞è Î©îÎ™®Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!');
                    hasUnsavedChanges = false;
                } else {
                    showSaveModal('‚ùå ÏóÖÎ¨¥ Î©îÎ™® Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\n\nüìä Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑùÏùÑ ÌÜµÌï¥ ÏõêÏù∏ÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.');
                }
            }).catch(error => {
                console.error('Î©îÎ™® Ï†ÄÏû• Ï§ë ÏòàÏô∏ Î∞úÏÉù:', error);
                showSaveErrorModal('üí• Î©îÎ™® Ï†ÄÏû• Ïò§Î•ò', 
                    `ÏóÖÎ¨¥ Î©îÎ™® Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\n\nÏò§Î•ò Ï†ïÎ≥¥: ${error.message}`);
            });
        }

        function uploadBeforeImage() {
            if (currentUserType !== 'admin') return;
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    // ÌååÏùº ÌÅ¨Í∏∞ Ï≤¥ÌÅ¨ (10MB Ï†úÌïú)
                    if (file.size > 10 * 1024 * 1024) {
                        showSaveErrorModal('üìÅ ÌååÏùº ÌÅ¨Í∏∞ Ï¥àÍ≥º', 
                            `ÏÑ†ÌÉùÌïú Ïù¥ÎØ∏ÏßÄÍ∞Ä ÎÑàÎ¨¥ ÌÅΩÎãàÎã§.\n\nÌååÏùº ÌÅ¨Í∏∞: ${(file.size / (1024 * 1024)).toFixed(2)}MB\nÍ∂åÏû• ÌÅ¨Í∏∞: 1MB Ïù¥Ìïò\n\nÏù¥ÎØ∏ÏßÄÎ•º ÏïïÏ∂ïÌï¥ÏÑú Îã§Ïãú ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî.`);
                        return;
                    }
                    
                    // Ï†ÄÏû• ÏãúÏûë ÌëúÏãú
                    showSyncIndicator('üì∏ Ïù¥ÎØ∏ÏßÄ Ï≤òÎ¶¨ Ï§ë...');
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // ÌòÑÏû¨ ÌéòÏù¥ÏßÄ Ï∞æÍ∏∞
                        let currentPage;
                        if (currentCategory) {
                            currentPage = filteredPages[currentPageIndex];
                        } else {
                            currentPage = pages[currentPageIndex];
                        }
                        
                        if (currentPage) {
                            // Ïù¥ÎØ∏ÏßÄ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                            currentPage.beforeImage = e.target.result;
                            
                            // Ìé∏Ïßë ÌôúÎèô Í∏∞Î°ù
                            markEditingActivity();
                            
                            // Ïù¥ÎØ∏ÏßÄ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
                            loadImages(currentPage.beforeImage, currentPage.afterImage);
                            
                            // Ï¶âÏãú Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                            saveData().then(success => {
                                if (success) {
                                    // ÏôÑÎ£å ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                                    updatePageCompletionStatus(currentPage);
                                    
                                    // Ï†ÄÏû• ÏôÑÎ£å ÌëúÏãú
                                    hasUnsavedChanges = false;
                                    
                                    showSaveModal(`‚úÖ '${currentPage.title}' ÌéòÏù¥ÏßÄÏùò Í∞úÌé∏ Ï†Ñ Ïù¥ÎØ∏ÏßÄÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!`);
                                } else {
                                    // Ï†ÄÏû• Ïã§Ìå®
                                    showSaveErrorModal('üíæ Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû• Ïã§Ìå®', 
                                        `Ïù¥ÎØ∏ÏßÄÎäî ÏóÖÎ°úÎìúÎêòÏóàÏßÄÎßå Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\n\nÎç∞Ïù¥ÌÑ∞ ÌÅ¨Í∏∞Í∞Ä ÎÑàÎ¨¥ ÌÅ¥ Ïàò ÏûàÏäµÎãàÎã§.\nÎ∞±ÏóÖÏùÑ Îã§Ïö¥Î°úÎìúÌïòÍ≥† Ïù¥ÎØ∏ÏßÄÎ•º ÏïïÏ∂ïÌï¥Î≥¥ÏÑ∏Ïöî.`);
                                }
                            }).catch(error => {
                                console.error('Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû• Ï§ë Ïò§Î•ò:', error);
                                showSaveErrorModal('üí• Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû• Ïò§Î•ò', 
                                    `Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\n\nÏò§Î•ò: ${error.message}\n\nÎã§Ïãú ÏãúÎèÑÌïòÍ±∞ÎÇò Ïù¥ÎØ∏ÏßÄÎ•º ÏïïÏ∂ïÌï¥Î≥¥ÏÑ∏Ïöî.`);
                            });
                        } else {
                            alert('ÌòÑÏû¨ ÌéòÏù¥ÏßÄÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                        }
                    };
                    
                    reader.onerror = function() {
                        showSaveErrorModal('üìÅ ÌååÏùº ÏùΩÍ∏∞ Ïò§Î•ò', 
                            'Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏùÑ ÏùΩÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\n\nÎã§Î•∏ Ïù¥ÎØ∏ÏßÄÎ•º ÏÑ†ÌÉùÌïòÍ±∞ÎÇò Î∏åÎùºÏö∞Ï†ÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Î≥¥ÏÑ∏Ïöî.');
                    };
                    
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function uploadAfterImage() {
            if (currentUserType !== 'admin') return;
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    // ÌååÏùº ÌÅ¨Í∏∞ Ï≤¥ÌÅ¨ (10MB Ï†úÌïú)
                    if (file.size > 10 * 1024 * 1024) {
                        showSaveErrorModal('üìÅ ÌååÏùº ÌÅ¨Í∏∞ Ï¥àÍ≥º', 
                            `ÏÑ†ÌÉùÌïú Ïù¥ÎØ∏ÏßÄÍ∞Ä ÎÑàÎ¨¥ ÌÅΩÎãàÎã§.\n\nÌååÏùº ÌÅ¨Í∏∞: ${(file.size / (1024 * 1024)).toFixed(2)}MB\nÍ∂åÏû• ÌÅ¨Í∏∞: 1MB Ïù¥Ìïò\n\nÏù¥ÎØ∏ÏßÄÎ•º ÏïïÏ∂ïÌï¥ÏÑú Îã§Ïãú ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî.`);
                        return;
                    }
                    
                    // Ï†ÄÏû• ÏãúÏûë ÌëúÏãú
                    showSyncIndicator('üì∏ Ïù¥ÎØ∏ÏßÄ Ï≤òÎ¶¨ Ï§ë...');
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // ÌòÑÏû¨ ÌéòÏù¥ÏßÄ Ï∞æÍ∏∞
                        let currentPage;
                        if (currentCategory) {
                            currentPage = filteredPages[currentPageIndex];
                        } else {
                            currentPage = pages[currentPageIndex];
                        }
                        
                        if (currentPage) {
                            // Ïù¥ÎØ∏ÏßÄ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                            currentPage.afterImage = e.target.result;
                            
                            // Ìé∏Ïßë ÌôúÎèô Í∏∞Î°ù
                            markEditingActivity();
                            
                            // Ïù¥ÎØ∏ÏßÄ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
                            loadImages(currentPage.beforeImage, currentPage.afterImage);
                            
                            // Ï¶âÏãú Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                            saveData().then(success => {
                                if (success) {
                                    // ÏôÑÎ£å ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                                    updatePageCompletionStatus(currentPage);
                                    
                                    // Ï†ÄÏû• ÏôÑÎ£å ÌëúÏãú
                                    hasUnsavedChanges = false;
                                    
                                    showSaveModal(`‚úÖ '${currentPage.title}' ÌéòÏù¥ÏßÄÏùò Í∞úÌé∏ ÌõÑ Ïù¥ÎØ∏ÏßÄÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!`);
                                } else {
                                    // Ï†ÄÏû• Ïã§Ìå®
                                    showSaveErrorModal('üíæ Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû• Ïã§Ìå®', 
                                        `Ïù¥ÎØ∏ÏßÄÎäî ÏóÖÎ°úÎìúÎêòÏóàÏßÄÎßå Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\n\nÎç∞Ïù¥ÌÑ∞ ÌÅ¨Í∏∞Í∞Ä ÎÑàÎ¨¥ ÌÅ¥ Ïàò ÏûàÏäµÎãàÎã§.\nÎ∞±ÏóÖÏùÑ Îã§Ïö¥Î°úÎìúÌïòÍ≥† Ïù¥ÎØ∏ÏßÄÎ•º ÏïïÏ∂ïÌï¥Î≥¥ÏÑ∏Ïöî.`);
                                }
                            }).catch(error => {
                                console.error('Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû• Ï§ë Ïò§Î•ò:', error);
                                showSaveErrorModal('üí• Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû• Ïò§Î•ò', 
                                    `Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\n\nÏò§Î•ò: ${error.message}\n\nÎã§Ïãú ÏãúÎèÑÌïòÍ±∞ÎÇò Ïù¥ÎØ∏ÏßÄÎ•º ÏïïÏ∂ïÌï¥Î≥¥ÏÑ∏Ïöî.`);
                            });
                        } else {
                            alert('ÌòÑÏû¨ ÌéòÏù¥ÏßÄÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                        }
                    };
                    
                    reader.onerror = function() {
                        showSaveErrorModal('üìÅ ÌååÏùº ÏùΩÍ∏∞ Ïò§Î•ò', 
                            'Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏùÑ ÏùΩÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\n\nÎã§Î•∏ Ïù¥ÎØ∏ÏßÄÎ•º ÏÑ†ÌÉùÌïòÍ±∞ÎÇò Î∏åÎùºÏö∞Ï†ÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Î≥¥ÏÑ∏Ïöî.');
                    };
                    
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function updatePageCompletionStatus(page) {
            const beforeCompleted = page.beforeContent.trim() !== '' || page.beforeImage;
            const afterCompleted = page.afterContent.trim() !== '' || page.afterImage;
            
            const wasCompleted = page.isCompleted;
            page.isCompleted = beforeCompleted && afterCompleted;
            
            // UI ÏóÖÎç∞Ïù¥Ìä∏
            updateProgress();
            updateMenuItemStyles();
            
            return page.isCompleted;
        }

        function removeBeforeImage() {
            if (currentUserType !== 'admin') return;
            
            // ÌòÑÏû¨ ÌéòÏù¥ÏßÄ Ï∞æÍ∏∞
            let currentPage;
            if (currentCategory) {
                currentPage = filteredPages[currentPageIndex];
            } else {
                currentPage = pages[currentPageIndex];
            }
            
            if (currentPage) {
                currentPage.beforeImage = null;
                markEditingActivity(); // Ìé∏Ïßë ÌôúÎèô Í∏∞Î°ù
                loadImages(currentPage.beforeImage, currentPage.afterImage);
                
                saveData().then(success => {
                    if (success) {
                        updatePageCompletionStatus(currentPage);
                        hasUnsavedChanges = false; // Ï†ÄÏû• ÏôÑÎ£å ÌëúÏãú
                        showSaveModal(`‚úÖ '${currentPage.title}' ÌéòÏù¥ÏßÄÏùò Í∞úÌé∏ Ï†Ñ Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.`);
                    } else {
                        showSaveModal(`‚ö†Ô∏è Ïù¥ÎØ∏ÏßÄÎäî ÏÇ≠Ï†úÎêòÏóàÏßÄÎßå Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\nÎ∞±ÏóÖÏùÑ Îã§Ïö¥Î°úÎìúÌïòÏÑ∏Ïöî.`);
                    }
                }).catch(error => {
                    console.error('Ïù¥ÎØ∏ÏßÄ ÏÇ≠Ï†ú Ï†ÄÏû• Ï§ë Ïò§Î•ò:', error);
                    showSaveErrorModal('üí• ÏÇ≠Ï†ú Ï†ÄÏû• Ïò§Î•ò', 
                        `Ïù¥ÎØ∏ÏßÄ ÏÇ≠Ï†ú ÌõÑ Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\n\nÏò§Î•ò: ${error.message}`);
                });
            }
        }

        function removeAfterImage() {
            if (currentUserType !== 'admin') return;
            
            // ÌòÑÏû¨ ÌéòÏù¥ÏßÄ Ï∞æÍ∏∞
            let currentPage;
            if (currentCategory) {
                currentPage = filteredPages[currentPageIndex];
            } else {
                currentPage = pages[currentPageIndex];
            }
            
            if (currentPage) {
                currentPage.afterImage = null;
                markEditingActivity(); // Ìé∏Ïßë ÌôúÎèô Í∏∞Î°ù
                loadImages(currentPage.beforeImage, currentPage.afterImage);
                
                saveData().then(success => {
                    if (success) {
                        updatePageCompletionStatus(currentPage);
                        hasUnsavedChanges = false; // Ï†ÄÏû• ÏôÑÎ£å ÌëúÏãú
                        showSaveModal(`‚úÖ '${currentPage.title}' ÌéòÏù¥ÏßÄÏùò Í∞úÌé∏ ÌõÑ Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.`);
                    } else {
                        showSaveModal(`‚ö†Ô∏è Ïù¥ÎØ∏ÏßÄÎäî ÏÇ≠Ï†úÎêòÏóàÏßÄÎßå Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\nÎ∞±ÏóÖÏùÑ Îã§Ïö¥Î°úÎìúÌïòÏÑ∏Ïöî.`);
                    }
                }).catch(error => {
                    console.error('Ïù¥ÎØ∏ÏßÄ ÏÇ≠Ï†ú Ï†ÄÏû• Ï§ë Ïò§Î•ò:', error);
                    showSaveErrorModal('üí• ÏÇ≠Ï†ú Ï†ÄÏû• Ïò§Î•ò', 
                        `Ïù¥ÎØ∏ÏßÄ ÏÇ≠Ï†ú ÌõÑ Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\n\nÏò§Î•ò: ${error.message}`);
                });
            }
        }

        function addNewPage() {
            if (currentUserType !== 'admin') return;
            
            const title = prompt('ÏÉà ÌéòÏù¥ÏßÄ Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:');
            if (!title || !title.trim()) return;
            
            const newPage = {
                title: title.trim(),
                category: "service",
                beforeContent: '',
                afterContent: '',
                beforeImage: null,
                afterImage: null,
                isCompleted: false,
                menuName: title.trim()
            };
            
            pages.push(newPage);
            updateAllDisplays();
            saveData();
            
            currentPageIndex = pages.length - 1;
            loadPage(currentPageIndex);
            
            showSaveModal(`'${title}' ÌéòÏù¥ÏßÄÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!`);
        }

        function deleteCurrentPage() {
            if (currentUserType !== 'admin') return;
            
            if (pages.length <= 1) {
                alert('ÏµúÏÜå 1Í∞úÏùò ÌéòÏù¥ÏßÄÎäî ÌïÑÏöîÌï©ÎãàÎã§.');
                return;
            }
            
            const pageTitle = pages[currentPageIndex].title;
            
            if (confirm(`Ï†ïÎßê '${pageTitle}' ÌéòÏù¥ÏßÄÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                pages.splice(currentPageIndex, 1);
                
                if (currentPageIndex >= pages.length) {
                    currentPageIndex = pages.length - 1;
                }
                
                updateAllDisplays();
                saveData();
                
                showSaveModal(`'${pageTitle}' ÌéòÏù¥ÏßÄÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.`);
            }
        }

        async function downloadBackup() {
            try {
                // SupabaseÏôÄ localStorage Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º Ìè¨Ìï®Ìïú Î∞±ÏóÖ ÏÉùÏÑ±
                const localData = {
                    pages: pages,
                    workNotes: workNotes,
                    menuStructure: menuStructure,
                    exportDate: new Date().toISOString(),
                    projectName: 'Î™©Ìè¨Ïãú ÌÜµÌï©ÎèÑÏÑúÍ¥Ä ÌôàÌéòÏù¥ÏßÄ Í∞úÌé∏',
                    version: '1.0',
                    totalPages: pages.length,
                    completedPages: pages.filter(p => p.isCompleted).length,
                    dataSource: 'hybrid',
                    supabaseEnabled: isSupabaseReady
                };

                // SupabaseÏóêÏÑú ÏµúÏã† Îç∞Ïù¥ÌÑ∞ÎèÑ Í∞ÄÏ†∏Ïò§Í∏∞ (Í∞ÄÎä•Ìïú Í≤ΩÏö∞)
                if (isSupabaseReady && supabase) {
                    try {
                        const { data: supabaseData, error } = await supabase
                            .from('mokpo_projects')
                            .select('*')
                            .order('updated_at', { ascending: false })
                            .limit(1);

                        if (!error && supabaseData && supabaseData.length > 0) {
                            localData.supabaseData = supabaseData[0];
                            localData.supabaseLastUpdated = supabaseData[0].updated_at;
                        }
                    } catch (error) {
                        // Supabase Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå® Ïãú Î°úÏª¨ Îç∞Ïù¥ÌÑ∞Îßå ÏÇ¨Ïö©
                    }
                }
                
                const jsonString = JSON.stringify(localData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                
                const url = URL.createObjectURL(blob);
                const fileName = `Î™©Ìè¨ÏãúÎèÑÏÑúÍ¥Ä_Í∞úÌé∏ÌòÑÌô©_${new Date().toISOString().split('T')[0]}.json`;
                
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                a.style.display = 'none';
                
                // DOMÏóê Ï∂îÍ∞ÄÌïòÍ≥† ÌÅ¥Î¶≠
                document.body.appendChild(a);
                
                // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Í∞ïÏ†ú Ïã§Ìñâ
                a.click();
                
                // Ï†ïÎ¶¨
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                // ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
                const message = `‚úÖ Î∞±ÏóÖ ÌååÏùºÏù¥ Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§!

üìÅ ÌååÏùºÎ™Ö: ${fileName}
üìä Ï¥ù ÌéòÏù¥ÏßÄ: ${localData.totalPages}Í∞ú
‚úÖ ÏôÑÎ£åÎêú ÌéòÏù¥ÏßÄ: ${localData.completedPages}Í∞ú
üìÖ Î∞±ÏóÖ ÎÇ†Ïßú: ${new Date().toLocaleDateString('ko-KR')}
${isSupabaseReady ? '‚òÅÔ∏è Supabase Îç∞Ïù¥ÌÑ∞ Ìè¨Ìï®' : 'üíæ Î°úÏª¨ Îç∞Ïù¥ÌÑ∞Îßå Ìè¨Ìï®'}

üí° ÌååÏùºÏù¥ Îã§Ïö¥Î°úÎìúÎêòÏßÄ ÏïäÏïòÎã§Î©¥ Î∏åÎùºÏö∞Ï†ÄÏùò Îã§Ïö¥Î°úÎìú Ï∞®Îã®ÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.`;
                
                showSaveModal(message);
                
            } catch (error) {
                // ÏóêÎü¨ Î∞úÏÉù Ïãú ÎåÄÏïà Ï†úÍ≥µ
                showBackupDataModal();
            }
        }

        function showBackupDataModal() {
            // Í∏∞Ï°¥ Î™®Îã¨ Ï†úÍ±∞
            const existingModal = document.getElementById('backupDataModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const data = {
                pages: pages,
                workNotes: workNotes,
                menuStructure: menuStructure,
                exportDate: new Date().toISOString(),
                projectName: 'Î™©Ìè¨Ïãú ÌÜµÌï©ÎèÑÏÑúÍ¥Ä ÌôàÌéòÏù¥ÏßÄ Í∞úÌé∏',
                version: '1.0'
            };
            
            const jsonString = JSON.stringify(data, null, 2);
            
            // Î∞±ÏóÖ Îç∞Ïù¥ÌÑ∞ ÌëúÏãú Î™®Îã¨ ÏÉùÏÑ±
            const modal = document.createElement('div');
            modal.id = 'backupDataModal';
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '9999';
            
            modal.innerHTML = `
                <div class="modal-content large">
                    <div class="modal-title" style="color: #28a745; margin-bottom: 20px; text-align: center;">
                        üíæ Î∞±ÏóÖ Îç∞Ïù¥ÌÑ∞
                    </div>
                    <div style="margin-bottom: 20px; text-align: center; color: #666;">
                        <p>ÌååÏùº Îã§Ïö¥Î°úÎìúÍ∞Ä ÏßÄÏõêÎêòÏßÄ ÏïäÎäî ÌôòÍ≤ΩÏûÖÎãàÎã§.</p>
                        <p>ÏïÑÎûò Îç∞Ïù¥ÌÑ∞Î•º Î≥µÏÇ¨ÌïòÏó¨ ÌÖçÏä§Ìä∏ ÌååÏùºÎ°ú Ï†ÄÏû•Ìï¥Ï£ºÏÑ∏Ïöî.</p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">
                            üìÑ ÌååÏùºÎ™Ö: Î™©Ìè¨ÏãúÎèÑÏÑúÍ¥Ä_Í∞úÌé∏ÌòÑÌô©_${new Date().toISOString().split('T')[0]}.json
                        </label>
                        <textarea readonly style="width: 100%; height: 400px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; font-family: monospace; font-size: 12px; background: #f8f9fa;">${jsonString}</textarea>
                    </div>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="copyBackupData()" style="margin-right: 10px;">
                            üìã Îç∞Ïù¥ÌÑ∞ Î≥µÏÇ¨
                        </button>
                        <button class="btn btn-secondary" onclick="closeBackupDataModal()">
                            ‚úñÔ∏è Îã´Í∏∞
                        </button>
                    </div>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <h4 style="color: #856404; margin-bottom: 10px;">üí° ÏÇ¨Ïö© Î∞©Î≤ï</h4>
                        <p style="margin: 5px 0; font-size: 14px; color: #856404;">
                            1. "Îç∞Ïù¥ÌÑ∞ Î≥µÏÇ¨" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Î∞±ÏóÖ Îç∞Ïù¥ÌÑ∞Î•º ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨<br>
                            2. ÌÖçÏä§Ìä∏ ÏóêÎîîÌÑ∞(Î©îÎ™®Ïû• Îì±)Î•º Ïó¥Í≥† Ctrl+VÎ°ú Î∂ôÏó¨ÎÑ£Í∏∞<br>
                            3. ÌååÏùºÏùÑ .json ÌôïÏû•ÏûêÎ°ú Ï†ÄÏû•<br>
                            4. ÎÇòÏ§ëÏóê "Î∞±ÏóÖ ÏóÖÎ°úÎìú" Í∏∞Îä•ÏúºÎ°ú Î≥µÏõê Í∞ÄÎä•
                        </p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Ï†ÑÏó≠ Ìï®ÏàòÎ°ú Îì±Î°ù
            window.copyBackupData = () => {
                const textarea = modal.querySelector('textarea');
                textarea.select();
                textarea.setSelectionRange(0, 99999); // Î™®Î∞îÏùº ÏßÄÏõê
                
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        showSaveModal('‚úÖ Î∞±ÏóÖ Îç∞Ïù¥ÌÑ∞Í∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!\n\nÏù¥Ï†ú ÌÖçÏä§Ìä∏ ÏóêÎîîÌÑ∞Ïóê Î∂ôÏó¨ÎÑ£Í≥† .json ÌååÏùºÎ°ú Ï†ÄÏû•ÌïòÏÑ∏Ïöî.');
                    } else {
                        throw new Error('Î≥µÏÇ¨ Ïã§Ìå®');
                    }
                } catch (err) {
                    // ÏàòÎèô Î≥µÏÇ¨ ÏïàÎÇ¥
                    textarea.focus();
                    showSaveModal('üìã Ctrl+AÎ°ú Ï†ÑÏ≤¥ ÏÑ†ÌÉù ÌõÑ Ctrl+CÎ°ú Î≥µÏÇ¨Ìï¥Ï£ºÏÑ∏Ïöî.\n\nÍ∑∏ Îã§Ïùå ÌÖçÏä§Ìä∏ ÏóêÎîîÌÑ∞Ïóê Î∂ôÏó¨ÎÑ£Í≥† .json ÌååÏùºÎ°ú Ï†ÄÏû•ÌïòÏÑ∏Ïöî.');
                }
            };
            
            window.closeBackupDataModal = () => {
                modal.remove();
            };
            
            // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        async function uploadBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async function(event) {
                const file = event.target.files[0];
                if (file) {
                    // ÌååÏùº ÌÅ¨Í∏∞ Ï≤¥ÌÅ¨ Î∞è Í≤ΩÍ≥†
                    const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    console.log(`Î∞±ÏóÖ ÌååÏùº ÌÅ¨Í∏∞: ${fileSizeMB}MB`);
                    
                    if (file.size > 100 * 1024 * 1024) { // 100MB Ï¥àÍ≥º
                        showSaveErrorModal('üìÅ ÌååÏùº ÌÅ¨Í∏∞ Ï¥àÍ≥º', 
                            `ÌååÏùºÏù¥ ÎÑàÎ¨¥ ÌÅΩÎãàÎã§ (${fileSizeMB}MB)\n\nÏµúÎåÄ 100MBÍπåÏßÄ ÏßÄÏõêÎê©ÎãàÎã§.\nÎã§Î•∏ Î∞±ÏóÖ ÌååÏùºÏùÑ ÏÇ¨Ïö©Ìï¥Ï£ºÏÑ∏Ïöî.`);
                        return;
                    }
                    
                    // Ï¶âÏãú Ï≤òÎ¶¨ ÏãúÏûë (ÌôïÏù∏Ï∞Ω ÏóÜÏù¥)
                    showProgressModal(`üì¶ ÎåÄÏö©Îüâ Î∞±ÏóÖ Ï≤òÎ¶¨ Ï§ë...\n\nÌååÏùº ÌÅ¨Í∏∞: ${fileSizeMB}MB\n\nÏ≤òÎ¶¨ Îã®Í≥Ñ:\n1Ô∏è‚É£ ÌååÏùº Î∂ÑÏÑù Ï§ë...`);
                    
                    try {
                        console.log('ÎåÄÏö©Îüâ ÌååÏùº ÏùΩÍ∏∞ ÏãúÏûë...');
                        
                        // ÎåÄÏö©Îüâ ÌååÏùº Ï†ÑÏö© ÏùΩÍ∏∞ Ìï®Ïàò ÏÇ¨Ïö©
                        const fileContent = await readLargeFile(file, fileSizeMB);
                        
                        updateProgressModal(`2Ô∏è‚É£ JSON Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù Ï§ë...\nÌÅ¨Í∏∞: ${fileSizeMB}MB`);
                        
                        console.log('JSON ÌååÏã± ÏãúÏûë...');
                        const data = JSON.parse(fileContent);
                        
                        console.log('Î∞±ÏóÖ Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù:', {
                            pages: data.pages?.length || 0,
                            images: data.pages?.reduce((count, p) => count + (p.beforeImage ? 1 : 0) + (p.afterImage ? 1 : 0), 0) || 0,
                            menuCategories: Object.keys(data.menuStructure || {}).length
                        });
                        
                        updateProgressModal(`3Ô∏è‚É£ Îç∞Ïù¥ÌÑ∞ Î≥µÏõê Ï§ÄÎπÑ Ï§ë...\nÌéòÏù¥ÏßÄ: ${data.pages?.length || 0}Í∞ú`);
                        
                        // Îã®Í≥ÑÎ≥Ñ Î≥µÏõê Ï≤òÎ¶¨
                        await restoreLargeBackupWithProgress(data, fileSizeMB);
                        
                        closeProgressModal();
                        
                    } catch (error) {
                        console.error('Î∞±ÏóÖ Î≥µÏõê Ïã§Ìå®:', error);
                        closeProgressModal();
                        
                        if (error.name === 'SyntaxError') {
                            showSaveErrorModal('üìÑ ÌååÏùº ÌòïÏãù Ïò§Î•ò', 
                                `JSON ÌååÏùºÏù¥ ÏÜêÏÉÅÎêòÏóàÍ±∞ÎÇò Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.\n\nÌååÏùº ÌÅ¨Í∏∞: ${fileSizeMB}MB\n\nÎã§Î•∏ Î∞±ÏóÖ ÌååÏùºÏùÑ ÏÇ¨Ïö©ÌïòÍ±∞ÎÇò ÏïïÏ∂ï Î∞±ÏóÖÏùÑ ÏãúÎèÑÌï¥Î≥¥ÏÑ∏Ïöî.`);
                        } else if (error.message.includes('quota') || error.message.includes('storage')) {
                            showLargeFileErrorModal(fileSizeMB);
                        } else if (error.message.includes('memory') || error.message.includes('allocation')) {
                            showMemoryErrorModal(fileSizeMB);
                        } else {
                            showSaveErrorModal('üí• Î≥µÏõê Ïã§Ìå®', 
                                `Î∞±ÏóÖ Î≥µÏõê Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\n\nÏò§Î•ò: ${error.message}\nÌååÏùº ÌÅ¨Í∏∞: ${fileSizeMB}MB\n\nÏ†ÄÏû•ÏÜå Ï†ïÎ¶¨Î•º Î®ºÏ†Ä ÏãúÎèÑÌï¥Î≥¥ÏÑ∏Ïöî.`);
                        }
                    }
                }
            };
            input.click();
        }

        // ÎåÄÏö©Îüâ ÌååÏùº Ï†ÑÏö© ÏùΩÍ∏∞ Ìï®Ïàò
        function readLargeFile(file, fileSizeMB) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                // ÏùΩÍ∏∞ ÏãúÏûë
                reader.onloadstart = function() {
                    console.log('ÌååÏùº ÏùΩÍ∏∞ ÏãúÏûë...');
                };
                
                // ÏßÑÌñâÎ•† ÌëúÏãú
                reader.onprogress = function(e) {
                    if (e.lengthComputable) {
                        const percentComplete = ((e.loaded / e.total) * 100).toFixed(1);
                        console.log(`ÌååÏùº ÏùΩÍ∏∞ ÏßÑÌñâÎ•†: ${percentComplete}%`);
                        updateProgressModal(`1Ô∏è‚É£ ÌååÏùº ÏùΩÍ∏∞ Ï§ë... ${percentComplete}%\nÌÅ¨Í∏∞: ${fileSizeMB}MB`);
                    }
                };
                
                // ÏùΩÍ∏∞ ÏôÑÎ£å
                reader.onload = function(e) {
                    console.log('ÌååÏùº ÏùΩÍ∏∞ ÏôÑÎ£å');
                    resolve(e.target.result);
                };
                
                // ÏùΩÍ∏∞ Ïã§Ìå®
                reader.onerror = function(error) {
                    console.error('ÌååÏùº ÏùΩÍ∏∞ Ïã§Ìå®:', error);
                    reject(new Error(`ÌååÏùº ÏùΩÍ∏∞ Ïã§Ìå®: ${error.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'}`));
                };
                
                // ÏùΩÍ∏∞ Ï§ëÎã®
                reader.onabort = function() {
                    console.error('ÌååÏùº ÏùΩÍ∏∞ Ï§ëÎã®Îê®');
                    reject(new Error('ÌååÏùº ÏùΩÍ∏∞Í∞Ä Ï§ëÎã®ÎêòÏóàÏäµÎãàÎã§.'));
                };
                
                // ÌÉÄÏûÑÏïÑÏõÉ ÏÑ§Ï†ï (5Î∂Ñ)
                const timeout = setTimeout(() => {
                    reader.abort();
                    reject(new Error(`ÌååÏùº ÏùΩÍ∏∞ ÏãúÍ∞Ñ Ï¥àÍ≥º (5Î∂Ñ)\nÌååÏùºÏù¥ ÎÑàÎ¨¥ ÌÅ¨Í±∞ÎÇò Î∏åÎùºÏö∞Ï†Ä ÌïúÍ≥ÑÎ•º Ï¥àÍ≥ºÌñàÏäµÎãàÎã§.`));
                }, 5 * 60 * 1000);
                
                reader.onload = function(e) {
                    clearTimeout(timeout);
                    console.log('ÌååÏùº ÏùΩÍ∏∞ ÏôÑÎ£å');
                    resolve(e.target.result);
                };
                
                reader.onerror = function(error) {
                    clearTimeout(timeout);
                    console.error('ÌååÏùº ÏùΩÍ∏∞ Ïã§Ìå®:', error);
                    reject(new Error(`ÌååÏùº ÏùΩÍ∏∞ Ïã§Ìå®: Î∏åÎùºÏö∞Ï†Ä Î©îÎ™®Î¶¨ Î∂ÄÏ°±Ïù¥Í±∞ÎÇò ÌååÏùºÏù¥ ÏÜêÏÉÅÎêòÏóàÏäµÎãàÎã§.`));
                };
                
                try {
                    console.log('FileReader ÏãúÏûë...');
                    reader.readAsText(file, 'UTF-8');
                } catch (error) {
                    clearTimeout(timeout);
                    reject(new Error(`ÌååÏùº ÏùΩÍ∏∞ ÏãúÏûë Ïã§Ìå®: ${error.message}`));
                }
            });
        }

        // ÏßÑÌñâ ÏÉÅÌô© Î™®Îã¨
        let progressModal = null;
        let progressTimeout = null;
        
        function showProgressModal(message) {
            closeProgressModal(); // Í∏∞Ï°¥ Î™®Îã¨ Ï†ïÎ¶¨
            
            progressModal = document.createElement('div');
            progressModal.className = 'modal';
            progressModal.style.display = 'block';
            progressModal.style.zIndex = '9999';
            
            progressModal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-title" style="color: #17a2b8; margin-bottom: 20px;">
                        üöÄ ÎåÄÏö©Îüâ Î∞±ÏóÖ Î≥µÏõê Ï§ë
                    </div>
                    <div id="progressMessage" class="modal-message" style="margin-bottom: 30px; line-height: 1.8; white-space: pre-line; text-align: center; font-family: monospace;">
                        ${message}
                    </div>
                    <div id="progressTimer" style="text-align: center; margin-bottom: 20px; color: #6c757d; font-size: 12px;">
                        Í≤ΩÍ≥º ÏãúÍ∞Ñ: 0Ï¥à
                    </div>
                    <div style="background: #d1ecf1; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                        <div style="color: #0c5460; font-size: 14px;">
                            ‚è≥ Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî...<br>
                            Î∏åÎùºÏö∞Ï†ÄÎ•º Îã´ÏßÄ ÎßàÏÑ∏Ïöî!
                        </div>
                    </div>
                    <div id="emergencyControls" style="text-align: center; display: none;">
                        <button class="btn btn-secondary" onclick="skipImageRestore()" style="margin-right: 10px; padding: 8px 15px; font-size: 13px;">
                            ‚è≠Ô∏è Ïù¥ÎØ∏ÏßÄ Í±¥ÎÑàÎõ∞Í∏∞
                        </button>
                        <button class="btn btn-secondary" onclick="forceCompleteRestore()" style="padding: 8px 15px; font-size: 13px;">
                            üö™ ÏßÄÍ∏à ÏôÑÎ£åÌïòÍ∏∞
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(progressModal);
            
            // ÌÉÄÏù¥Î®∏ ÏãúÏûë
            let startTime = Date.now();
            const timerInterval = setInterval(() => {
                if (!progressModal) {
                    clearInterval(timerInterval);
                    return;
                }
                
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const timerElement = progressModal.querySelector('#progressTimer');
                if (timerElement) {
                    timerElement.textContent = `Í≤ΩÍ≥º ÏãúÍ∞Ñ: ${elapsed}Ï¥à`;
                }
                
                // 30Ï¥à ÌõÑ Í∏¥Í∏â Ï°∞Ïπò Î≤ÑÌäº ÌëúÏãú
                if (elapsed >= 30) {
                    const emergencyControls = progressModal.querySelector('#emergencyControls');
                    if (emergencyControls) {
                        emergencyControls.style.display = 'block';
                    }
                }
                
                // 2Î∂Ñ ÌõÑ ÏûêÎèôÏúºÎ°ú Ïù¥ÎØ∏ÏßÄ Í±¥ÎÑàÎõ∞Í∏∞ Ï†úÏïà
                if (elapsed >= 120) {
                    updateProgressModal(`‚ö†Ô∏è Ï≤òÎ¶¨ ÏãúÍ∞ÑÏù¥ Ïò§Îûò Í±∏Î¶¨Í≥† ÏûàÏäµÎãàÎã§.\n\nÏù¥ÎØ∏ÏßÄ Î≥µÏõêÏùÑ Í±¥ÎÑàÎõ∞ÏãúÍ≤†ÏäµÎãàÍπå?\nÌÖçÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞Îäî Ïù¥ÎØ∏ Î≥µÏõêÎêòÏóàÏäµÎãàÎã§.`);
                    clearInterval(timerInterval);
                }
            }, 1000);
            
            // Ï†ÑÏó≠ Ìï®Ïàò Îì±Î°ù
            window.skipImageRestore = () => {
                console.log('ÏÇ¨Ïö©ÏûêÍ∞Ä Ïù¥ÎØ∏ÏßÄ Î≥µÏõê Í±¥ÎÑàÎõ∞Í∏∞ ÏÑ†ÌÉù');
                clearInterval(timerInterval);
                closeProgressModal();
                showSaveModal('‚úÖ ÌÖçÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ Î≥µÏõê ÏôÑÎ£å!\n\nÏù¥ÎØ∏ÏßÄÎäî Í±¥ÎÑàÎõ∞ÏóàÏäµÎãàÎã§.\nÍ∞úÎ≥ÑÏ†ÅÏúºÎ°ú Îã§Ïãú ÏóÖÎ°úÎìúÌï† Ïàò ÏûàÏäµÎãàÎã§.');
            };
            
            window.forceCompleteRestore = () => {
                console.log('ÏÇ¨Ïö©ÏûêÍ∞Ä Í∞ïÏ†ú ÏôÑÎ£å ÏÑ†ÌÉù');
                clearInterval(timerInterval);
                closeProgressModal();
                showSaveModal('‚úÖ Î∞±ÏóÖ Î≥µÏõêÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!\n\nÏùºÎ∂Ä Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏôÑÏ†ÑÌûà Ï≤òÎ¶¨ÎêòÏßÄ ÏïäÏïòÏùÑ Ïàò ÏûàÏßÄÎßå,\nÌÖçÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞Îäî Î™®Îëê Î≥µÏõêÎêòÏóàÏäµÎãàÎã§.');
            };
        }
        
        function updateProgressModal(message) {
            if (progressModal) {
                const messageElement = progressModal.querySelector('#progressMessage');
                if (messageElement) {
                    messageElement.textContent = message;
                }
            }
        }
        
        function closeProgressModal() {
            if (progressModal) {
                progressModal.remove();
                progressModal = null;
            }
            if (progressTimeout) {
                clearTimeout(progressTimeout);
                progressTimeout = null;
            }
        }

        // ÏßÑÌñâ ÏÉÅÌô©Í≥º Ìï®Íªò ÎåÄÏö©Îüâ Î∞±ÏóÖ Î≥µÏõê
        async function restoreLargeBackupWithProgress(data, fileSizeMB) {
            try {
                console.log('ÎåÄÏö©Îüâ Î∞±ÏóÖ Î≥µÏõê ÏãúÏûë:', fileSizeMB + 'MB');
                
                updateProgressModal(`4Ô∏è‚É£ Ï†ÄÏû•ÏÜå Ï§ÄÎπÑ Ï§ë...\nÍ∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ Ï§ë...`);
                
                // Î®ºÏ†Ä Í∏∞Ï°¥ localStorage Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ Î∞è Ï†ïÎ¶¨
                const existingBackup = await createEmergencyBackup();
                
                // localStorage ÏôÑÏ†Ñ Ï†ïÎ¶¨
                console.log('Í∏∞Ï°¥ Ï†ÄÏû•ÏÜå Ï†ïÎ¶¨ Ï§ë...');
                localStorage.removeItem('mokpo_library_data');
                
                // Î©îÎ™®Î¶¨ Ï†ïÎ¶¨
                if (window.gc) {
                    window.gc();
                }
                
                updateProgressModal(`5Ô∏è‚É£ Î©îÎâ¥ Íµ¨Ï°∞ Î≥µÏõê Ï§ë...\nÏπ¥ÌÖåÍ≥†Î¶¨: ${Object.keys(data.menuStructure || {}).length}Í∞ú`);
                
                // 1Îã®Í≥Ñ: Î©îÎâ¥ Íµ¨Ï°∞ Î≥µÏõê
                if (data.menuStructure) {
                    console.log('Î©îÎâ¥ Íµ¨Ï°∞ Î≥µÏõê...');
                    menuStructure = data.menuStructure;
                }
                
                updateProgressModal(`6Ô∏è‚É£ ÌÖçÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ Ï§ë...\nÌéòÏù¥ÏßÄ: ${data.pages?.length || 0}Í∞ú`);
                
                // 2Îã®Í≥Ñ: ÌÖçÏä§Ìä∏Îßå Î≥µÏõê (Ïù¥ÎØ∏ÏßÄ Ï†úÏô∏)
                if (data.pages) {
                    console.log('ÌÖçÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞Îßå Î≥µÏõê...');
                    const textOnlyPages = data.pages.map(page => ({
                        ...page,
                        beforeImage: null,
                        afterImage: null,
                        hasBeforeImage: !!page.beforeImage,
                        hasAfterImage: !!page.afterImage
                    }));
                    pages = textOnlyPages;
                }
                
                updateProgressModal(`7Ô∏è‚É£ ÏóÖÎ¨¥ Î©îÎ™® Î≥µÏõê Ï§ë...\n${data.workNotes ? 'Î©îÎ™® ÏûàÏùå' : 'Î©îÎ™® ÏóÜÏùå'}`);
                
                // 3Îã®Í≥Ñ: ÏóÖÎ¨¥ Î©îÎ™® Î≥µÏõê
                if (data.workNotes) {
                    console.log('ÏóÖÎ¨¥ Î©îÎ™® Î≥µÏõê...');
                    workNotes = data.workNotes;
                    document.getElementById('workNotes').value = workNotes;
                }
                
                updateProgressModal(`8Ô∏è‚É£ ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë...\nÏù∏ÌÑ∞ÌéòÏù¥Ïä§ Í∞±Ïã†...`);
                
                // 4Îã®Í≥Ñ: UI ÏóÖÎç∞Ïù¥Ìä∏
                console.log('UI ÏóÖÎç∞Ïù¥Ìä∏...');
                initializePages();
                updateAllDisplays();
                renderMenuGrid();
                
                updateProgressModal(`9Ô∏è‚É£ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ï§ë...\nÌÖçÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•...`);
                
                // 5Îã®Í≥Ñ: ÌÖçÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞Îßå Ï†ÄÏû• ÏãúÎèÑ
                console.log('ÌÖçÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• ÏãúÎèÑ...');
                const textSaveSuccess = await saveTextOnlyData();
                
                if (!textSaveSuccess) {
                    console.log('localStorage Ïã§Ìå®, SupabaseÎßå ÏÇ¨Ïö©...');
                    await saveToSupabaseOnly();
                }
                
                // Ïù¥ÎØ∏ÏßÄ Í∞úÏàò ÌôïÏù∏
                const imagesCount = data.pages ? data.pages.reduce((count, p) => 
                    count + (p.beforeImage ? 1 : 0) + (p.afterImage ? 1 : 0), 0) : 0;
                
                if (imagesCount > 0) {
                    updateProgressModal(`üîü Ïù¥ÎØ∏ÏßÄ Î≥µÏõê Ï§ÄÎπÑ...\nÎ∞úÍ≤¨Îêú Ïù¥ÎØ∏ÏßÄ: ${imagesCount}Í∞ú`);
                    
                    // 6Îã®Í≥Ñ: Ïù¥ÎØ∏ÏßÄ Î≥µÏõê ÏÑ†ÌÉù
                    const imageRestoreChoice = await showImageRestoreChoice(data.pages, existingBackup);
                    
                    if (imageRestoreChoice) {
                        updateProgressModal(`üñºÔ∏è Ïù¥ÎØ∏ÏßÄ Î≥µÏõê Ï§ë...\n${imagesCount}Í∞ú Ï≤òÎ¶¨...`);
                        await restoreImagesInBatches(data.pages, fileSizeMB);
                    }
                } else {
                    updateProgressModal(`‚úÖ Î≥µÏõê ÏôÑÎ£å!\nÏù¥ÎØ∏ÏßÄ ÏóÜÏùå - ÌÖçÏä§Ìä∏Îßå Ï≤òÎ¶¨Îê®`);
                }
                
                // ÏÑ±Í≥µ Î©îÏãúÏßÄ
                await new Promise(resolve => setTimeout(resolve, 1000)); // 1Ï¥à ÎåÄÍ∏∞
                showLargeBackupSuccessModal(fileSizeMB, data.pages, textSaveSuccess, imagesCount > 0);
                
            } catch (error) {
                console.error('ÎåÄÏö©Îüâ Î≥µÏõê Ïã§Ìå®:', error);
                throw error;
            }
        }

        // Î©îÎ™®Î¶¨ Î∂ÄÏ°± Ïò§Î•ò Î™®Îã¨
        function showMemoryErrorModal(fileSizeMB) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '9999';

            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-title" style="color: #dc3545; margin-bottom: 20px;">
                        üíæ Î∏åÎùºÏö∞Ï†Ä Î©îÎ™®Î¶¨ Î∂ÄÏ°± (${fileSizeMB}MB)
                    </div>
                    <div class="modal-message" style="margin-bottom: 30px; line-height: 1.6;">
                        ÌååÏùºÏù¥ ÎÑàÎ¨¥ Ïª§ÏÑú Î∏åÎùºÏö∞Ï†ÄÍ∞Ä Ï≤òÎ¶¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.<br><br>
                        
                        <strong>üì± Ï¶âÏãú Ìï¥Í≤∞ Î∞©Î≤ï:</strong><br>
                        1. üßπ Ï†ÄÏû•ÏÜå Ï†ïÎ¶¨ ‚Üí Î©îÎ™®Î¶¨ ÌôïÎ≥¥<br>
                        2. üóúÔ∏è ÏïïÏ∂ï Î∞±ÏóÖ ÏÉùÏÑ± ‚Üí Ïö©Îüâ Ï§ÑÏù¥Í∏∞<br>
                        3. üîÑ Î∏åÎùºÏö∞Ï†Ä Ïû¨ÏãúÏûë ‚Üí Î©îÎ™®Î¶¨ Î¶¨ÏÖã<br>
                        4. üíª Îã§Î•∏ Î∏åÎùºÏö∞Ï†Ä ÏÇ¨Ïö© (Chrome Í∂åÏû•)
                    </div>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="color: #856404; font-size: 14px;">
                            <strong>üí° Í∂åÏû•:</strong> Î®ºÏ†Ä "Ï†ÄÏû•ÏÜå Ï†ïÎ¶¨"Î•º Ïã§ÌñâÌïú ÌõÑ<br>
                            ÏïïÏ∂ï Î∞±ÏóÖÏùÑ ÏÉùÏÑ±ÌïòÏó¨ Ïö©ÎüâÏùÑ Ï§ÑÏù¥ÏÑ∏Ïöî.
                        </div>
                    </div>
                    <div class="modal-buttons">
                        <button class="modal-btn" style="background: #ffc107; color: black;" onclick="closeMemoryModal(); clearStorageAndRetry();">
                            üßπ Ï†ÄÏû•ÏÜå Ï†ïÎ¶¨
                        </button>
                        <button class="modal-btn" style="background: #17a2b8; color: white;" onclick="closeMemoryModal(); createCompressedBackup();">
                            üóúÔ∏è ÏïïÏ∂ï Î∞±ÏóÖ
                        </button>
                        <button class="modal-btn" style="background: #6c757d; color: white;" onclick="closeMemoryModal();">
                            ‚úñÔ∏è Îã´Í∏∞
                        </button>
                    </div>
                </div>
            `;

            window.closeMemoryModal = () => {
                modal.remove();
            };

            document.body.appendChild(modal);
        }

        // ÎåÄÏö©Îüâ Î∞±ÏóÖ Î≥µÏõê Ï≤òÎ¶¨
        async function restoreLargeBackup(data, fileSizeMB) {
            try {
                console.log('ÎåÄÏö©Îüâ Î∞±ÏóÖ Î≥µÏõê ÏãúÏûë:', fileSizeMB + 'MB');
                
                // Î®ºÏ†Ä Í∏∞Ï°¥ localStorage Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ Î∞è Ï†ïÎ¶¨
                const existingBackup = await createEmergencyBackup();
                
                // localStorage ÏôÑÏ†Ñ Ï†ïÎ¶¨
                console.log('Í∏∞Ï°¥ Ï†ÄÏû•ÏÜå Ï†ïÎ¶¨ Ï§ë...');
                localStorage.removeItem('mokpo_library_data');
                
                // Í∞ÄÎπÑÏßÄ Ïª¨Î†âÏÖò Ïú†ÎèÑ
                if (window.gc) {
                    window.gc();
                }
                
                // 1Îã®Í≥Ñ: Î©îÎâ¥ Íµ¨Ï°∞ Î≥µÏõê
                if (data.menuStructure) {
                    console.log('Î©îÎâ¥ Íµ¨Ï°∞ Î≥µÏõê...');
                    menuStructure = data.menuStructure;
                }
                
                // 2Îã®Í≥Ñ: ÌÖçÏä§Ìä∏Îßå Î≥µÏõê (Ïù¥ÎØ∏ÏßÄ Ï†úÏô∏)
                if (data.pages) {
                    console.log('ÌÖçÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞Îßå Î≥µÏõê...');
                    const textOnlyPages = data.pages.map(page => ({
                        ...page,
                        beforeImage: null,
                        afterImage: null,
                        hasBeforeImage: !!page.beforeImage, // Ïù¥ÎØ∏ÏßÄ Ï°¥Ïû¨ Ïó¨Î∂ÄÎßå Í∏∞Î°ù
                        hasAfterImage: !!page.afterImage    // Ïù¥ÎØ∏ÏßÄ Ï°¥Ïû¨ Ïó¨Î∂ÄÎßå Í∏∞Î°ù
                    }));
                    pages = textOnlyPages;
                }
                
                // 3Îã®Í≥Ñ: ÏóÖÎ¨¥ Î©îÎ™® Î≥µÏõê
                if (data.workNotes) {
                    console.log('ÏóÖÎ¨¥ Î©îÎ™® Î≥µÏõê...');
                    workNotes = data.workNotes;
                    document.getElementById('workNotes').value = workNotes;
                }
                
                // 4Îã®Í≥Ñ: UI ÏóÖÎç∞Ïù¥Ìä∏
                console.log('UI ÏóÖÎç∞Ïù¥Ìä∏...');
                initializePages();
                updateAllDisplays();
                renderMenuGrid();
                
                // 5Îã®Í≥Ñ: ÌÖçÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞Îßå Ï†ÄÏû• ÏãúÎèÑ (Ïö©Îüâ Ï†àÏïΩ)
                console.log('ÌÖçÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• ÏãúÎèÑ...');
                const textSaveSuccess = await saveTextOnlyData();
                
                if (!textSaveSuccess) {
                    // ÌÖçÏä§Ìä∏ Ï†ÄÏû•ÎèÑ Ïã§Ìå®ÌïòÎ©¥ SupabaseÎßå ÏÇ¨Ïö©
                    console.log('localStorage Ïã§Ìå®, SupabaseÎßå ÏÇ¨Ïö©...');
                    await saveToSupabaseOnly();
                }
                
                // 6Îã®Í≥Ñ: Ïù¥ÎØ∏ÏßÄ Î≥µÏõê ÏãúÎèÑ (ÏÑ†ÌÉùÏ†Å)
                const imageRestoreChoice = await showImageRestoreChoice(data.pages, existingBackup);
                
                if (imageRestoreChoice) {
                    await restoreImagesInBatches(data.pages, fileSizeMB);
                }
                
                // ÏÑ±Í≥µ Î©îÏãúÏßÄ
                showLargeBackupSuccessModal(fileSizeMB, data.pages, textSaveSuccess, imageRestoreChoice);
                
            } catch (error) {
                console.error('ÎåÄÏö©Îüâ Î≥µÏõê Ïã§Ìå®:', error);
                throw error;
            }
        }

        // Í∏¥Í∏â Î∞±ÏóÖ ÏÉùÏÑ± (Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Î≥¥Ìò∏)
        async function createEmergencyBackup() {
            try {
                const existingData = localStorage.getItem('mokpo_library_data');
                if (existingData) {
                    console.log('Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Í∏¥Í∏â Î∞±ÏóÖ ÏÉùÏÑ±...');
                    const emergencyBackup = {
                        data: JSON.parse(existingData),
                        timestamp: new Date().toISOString(),
                        type: 'emergency_backup'
                    };
                    
                    // ÏÑ∏ÏÖò Ïä§ÌÜ†Î¶¨ÏßÄÏóê ÏûÑÏãú Ï†ÄÏû•
                    try {
                        sessionStorage.setItem('mokpo_emergency_backup', JSON.stringify(emergencyBackup));
                        console.log('Í∏¥Í∏â Î∞±ÏóÖ ÏôÑÎ£å');
                        return emergencyBackup;
                    } catch (error) {
                        console.warn('Í∏¥Í∏â Î∞±ÏóÖ Ïã§Ìå®:', error);
                        return null;
                    }
                }
                return null;
            } catch (error) {
                console.warn('Í∏¥Í∏â Î∞±ÏóÖ ÏÉùÏÑ± Ïã§Ìå®:', error);
                return null;
            }
        }

        // ÌÖçÏä§Ìä∏Îßå Ï†ÄÏû• (Ïù¥ÎØ∏ÏßÄ Ï†úÏô∏)
        async function saveTextOnlyData() {
            try {
                const textOnlyData = {
                    pages: pages.map(p => ({
                        ...p,
                        beforeImage: null,
                        afterImage: null
                    })),
                    workNotes: workNotes,
                    menuStructure: menuStructure,
                    lastUpdated: new Date().toISOString(),
                    version: '1.0-text-only'
                };

                const dataString = JSON.stringify(textOnlyData);
                const dataSizeKB = (new Blob([dataString]).size / 1024).toFixed(1);
                
                console.log(`ÌÖçÏä§Ìä∏ Ï†ÑÏö© Îç∞Ïù¥ÌÑ∞ ÌÅ¨Í∏∞: ${dataSizeKB}KB`);
                
                // localStorageÏóê Ï†ÄÏû• ÏãúÎèÑ
                localStorage.setItem('mokpo_library_data', dataString);
                console.log('ÌÖçÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ localStorage Ï†ÄÏû• ÏÑ±Í≥µ');
                
                // SupabaseÏóêÎèÑ Ï†ÄÏû•
                if (isSupabaseReady && supabase) {
                    await saveToSupabaseOnly();
                }
                
                return true;
            } catch (error) {
                console.error('ÌÖçÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïã§Ìå®:', error);
                return false;
            }
        }

        // Supabase Ï†ÑÏö© Ï†ÄÏû•
        async function saveToSupabaseOnly() {
            if (!isSupabaseReady || !supabase) {
                console.log('Supabase ÏÇ¨Ïö© Î∂àÍ∞Ä');
                return false;
            }
            
            try {
                const { data: existingData, error: selectError } = await supabase
                    .from('mokpo_projects')
                    .select('id')
                    .limit(1);

                const projectData = {
                    project_name: 'Î™©Ìè¨Ïãú ÌÜµÌï©ÎèÑÏÑúÍ¥Ä ÌôàÌéòÏù¥ÏßÄ Í∞úÌé∏',
                    pages: JSON.stringify(pages),
                    work_notes: workNotes,
                    menu_structure: JSON.stringify(menuStructure),
                    updated_at: new Date().toISOString()
                };

                let result;
                if (existingData && existingData.length > 0) {
                    result = await supabase
                        .from('mokpo_projects')
                        .update(projectData)
                        .eq('id', existingData[0].id);
                } else {
                    result = await supabase
                        .from('mokpo_projects')
                        .insert([projectData]);
                }

                if (result.error) {
                    throw result.error;
                }

                console.log('Supabase Ï†ÄÏû• ÏÑ±Í≥µ');
                updateConnectionStatus('‚òÅÔ∏è ÌÅ¥ÎùºÏö∞Îìú Ï†ÑÏö© Ï†ÄÏû•');
                return true;
            } catch (error) {
                console.error('Supabase Ï†ÄÏû• Ïã§Ìå®:', error);
                return false;
            }
        }

        // Ïù¥ÎØ∏ÏßÄ Î≥µÏõê ÏÑ†ÌÉù Î™®Îã¨
        function showImageRestoreChoice(originalPages, emergencyBackup) {
            return new Promise((resolve) => {
                const imagesCount = originalPages ? originalPages.reduce((count, p) => 
                    count + (p.beforeImage ? 1 : 0) + (p.afterImage ? 1 : 0), 0) : 0;
                
                if (imagesCount === 0) {
                    resolve(false);
                    return;
                }

                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.style.zIndex = '9999';

                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-title" style="color: #17a2b8; margin-bottom: 20px;">
                            üñºÔ∏è Ïù¥ÎØ∏ÏßÄ Î≥µÏõê ÏÑ†ÌÉù
                        </div>
                        <div class="modal-message" style="margin-bottom: 30px; line-height: 1.6;">
                            ÌÖçÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î≥µÏõêÎêòÏóàÏäµÎãàÎã§!<br><br>
                            
                            <strong>Î∞úÍ≤¨Îêú Ïù¥ÎØ∏ÏßÄ: ${imagesCount}Í∞ú</strong><br><br>
                            
                            Ïù¥ÎØ∏ÏßÄÎ•º ÏßÄÍ∏à Î≥µÏõêÌïòÏãúÍ≤†ÏäµÎãàÍπå?<br>
                            (Ïö©ÎüâÏù¥ ÌÅ¥ Í≤ΩÏö∞ Ïã§Ìå®Ìï† Ïàò ÏûàÏäµÎãàÎã§)
                        </div>
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="color: #856404; font-size: 14px;">
                                <strong>üí° Í∂åÏû•ÏÇ¨Ìï≠:</strong><br>
                                ‚Ä¢ ÌÖçÏä§Ìä∏ÎßåÏúºÎ°úÎèÑ ÏûëÏóÖ Í≥ÑÏÜç Í∞ÄÎä•<br>
                                ‚Ä¢ Ïù¥ÎØ∏ÏßÄÎäî ÎÇòÏ§ëÏóê Í∞úÎ≥Ñ ÏóÖÎ°úÎìú Í∞ÄÎä•<br>
                                ‚Ä¢ Ïö©Îüâ Î∂ÄÏ°± Ïãú ÏïïÏ∂ï Î∞±ÏóÖ ÏÇ¨Ïö©
                            </div>
                        </div>
                        <div class="modal-buttons">
                            <button class="modal-btn" style="background: #28a745; color: white;" onclick="chooseImageRestore(true)">
                                üñºÔ∏è Ïù¥ÎØ∏ÏßÄÎèÑ Î≥µÏõê
                            </button>
                            <button class="modal-btn" style="background: #6c757d; color: white;" onclick="chooseImageRestore(false)">
                                üìù ÌÖçÏä§Ìä∏Îßå ÏÇ¨Ïö©
                            </button>
                        </div>
                    </div>
                `;

                window.chooseImageRestore = (choice) => {
                    modal.remove();
                    resolve(choice);
                };

                document.body.appendChild(modal);
            });
        }

        // Î∞∞Ïπò Îã®ÏúÑÎ°ú Ïù¥ÎØ∏ÏßÄ Î≥µÏõê (Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ)
        async function restoreImagesInBatches(originalPages, fileSizeMB) {
            if (!originalPages) return;
            
            const batchSize = 2; // Ìïú Î≤àÏóê 2Í∞úÏî© Ï≤òÎ¶¨ (ÏÜçÎèÑ Ìñ•ÏÉÅ)
            let processedCount = 0;
            let successCount = 0;
            let failedCount = 0;
            
            const totalImages = originalPages.reduce((count, p) => 
                count + (p.beforeImage ? 1 : 0) + (p.afterImage ? 1 : 0), 0);
            
            console.log('Î∞∞Ïπò Îã®ÏúÑ Ïù¥ÎØ∏ÏßÄ Î≥µÏõê ÏãúÏûë...');
            updateProgressModal(`üñºÔ∏è Ïù¥ÎØ∏ÏßÄ Î≥µÏõê Ï§ë...\nÏßÑÌñâÎ•†: 0/${totalImages} (0%)`);
            
            for (let i = 0; i < originalPages.length; i += batchSize) {
                const batch = originalPages.slice(i, i + batchSize);
                
                for (const originalPage of batch) {
                    const pageIndex = originalPages.indexOf(originalPage);
                    const currentPage = pages[pageIndex];
                    
                    if (!currentPage) continue;
                    
                    // Before Ïù¥ÎØ∏ÏßÄ Î≥µÏõê ÏãúÎèÑ
                    if (originalPage.beforeImage) {
                        try {
                            currentPage.beforeImage = originalPage.beforeImage;
                            successCount++;
                            processedCount++;
                            
                            const progressPercent = Math.round((processedCount / totalImages) * 100);
                            updateProgressModal(`üñºÔ∏è Ïù¥ÎØ∏ÏßÄ Î≥µÏõê Ï§ë...\nÏßÑÌñâÎ•†: ${processedCount}/${totalImages} (${progressPercent}%)\nÌòÑÏû¨: ${currentPage.title} (Before)`);
                            
                            console.log(`Ïù¥ÎØ∏ÏßÄ Î≥µÏõê ÏÑ±Í≥µ: ${currentPage.title} (Before)`);
                        } catch (error) {
                            failedCount++;
                            processedCount++;
                            console.warn(`Ïù¥ÎØ∏ÏßÄ Î≥µÏõê Ïã§Ìå®: ${currentPage.title} (Before)`, error);
                        }
                    }
                    
                    // After Ïù¥ÎØ∏ÏßÄ Î≥µÏõê ÏãúÎèÑ
                    if (originalPage.afterImage) {
                        try {
                            currentPage.afterImage = originalPage.afterImage;
                            successCount++;
                            processedCount++;
                            
                            const progressPercent = Math.round((processedCount / totalImages) * 100);
                            updateProgressModal(`üñºÔ∏è Ïù¥ÎØ∏ÏßÄ Î≥µÏõê Ï§ë...\nÏßÑÌñâÎ•†: ${processedCount}/${totalImages} (${progressPercent}%)\nÌòÑÏû¨: ${currentPage.title} (After)`);
                            
                            console.log(`Ïù¥ÎØ∏ÏßÄ Î≥µÏõê ÏÑ±Í≥µ: ${currentPage.title} (After)`);
                        } catch (error) {
                            failedCount++;
                            processedCount++;
                            console.warn(`Ïù¥ÎØ∏ÏßÄ Î≥µÏõê Ïã§Ìå®: ${currentPage.title} (After)`, error);
                        }
                    }
                }
                
                // Î∞∞ÏπòÎßàÎã§ Ï†ÄÏû• ÏãúÎèÑ (ÌÉÄÏûÑÏïÑÏõÉ Ï†ÅÏö©)
                if (successCount > 0 && (i + batchSize) % 6 === 0) { // 6Í∞úÎßàÎã§ Ï†ÄÏû•
                    try {
                        console.log(`Ï§ëÍ∞Ñ Ï†ÄÏû• ÏãúÎèÑ... (${successCount}Í∞ú Ïù¥ÎØ∏ÏßÄ)`);
                        updateProgressModal(`üñºÔ∏è Ïù¥ÎØ∏ÏßÄ Î≥µÏõê Ï§ë...\nÏßÑÌñâÎ•†: ${processedCount}/${totalImages}\nüíæ Ï§ëÍ∞Ñ Ï†ÄÏû• Ï§ë...`);
                        
                        // Supabase Ï†ÄÏû•Ïóê ÌÉÄÏûÑÏïÑÏõÉ Ï†ÅÏö© (30Ï¥à)
                        await Promise.race([
                            saveToSupabaseOnly(),
                            new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('Ï†ÄÏû• ÌÉÄÏûÑÏïÑÏõÉ')), 30000)
                            )
                        ]);
                        
                        console.log('Ï§ëÍ∞Ñ Ï†ÄÏû• ÏÑ±Í≥µ');
                    } catch (error) {
                        console.warn('Ï§ëÍ∞Ñ Ï†ÄÏû• Ïã§Ìå®, Í≥ÑÏÜç ÏßÑÌñâ:', error);
                        updateProgressModal(`üñºÔ∏è Ïù¥ÎØ∏ÏßÄ Î≥µÏõê Ï§ë...\nÏßÑÌñâÎ•†: ${processedCount}/${totalImages}\n‚ö†Ô∏è Ï†ÄÏû• ÏßÄÏó∞ - Í≥ÑÏÜç ÏßÑÌñâ Ï§ë...`);
                    }
                }
                
                // Î©îÎ™®Î¶¨ Ï†àÏïΩÏùÑ ÏúÑÌïú ÏßßÏùÄ ÎåÄÍ∏∞
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            
            // ÏµúÏ¢Ö Ï†ÄÏû• ÏãúÎèÑ
            updateProgressModal(`üñºÔ∏è Ïù¥ÎØ∏ÏßÄ Î≥µÏõê ÏôÑÎ£å!\nÏµúÏ¢Ö Ï†ÄÏû• Ï§ë...\nÏÑ±Í≥µ: ${successCount}Í∞ú, Ïã§Ìå®: ${failedCount}Í∞ú`);
            
            try {
                console.log('ÏµúÏ¢Ö Ï†ÄÏû• ÏãúÎèÑ...');
                await Promise.race([
                    saveToSupabaseOnly(),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('ÏµúÏ¢Ö Ï†ÄÏû• ÌÉÄÏûÑÏïÑÏõÉ')), 45000)
                    )
                ]);
                console.log('ÏµúÏ¢Ö Ï†ÄÏû• ÏÑ±Í≥µ');
            } catch (error) {
                console.warn('ÏµúÏ¢Ö Ï†ÄÏû• Ïã§Ìå®:', error);
                updateProgressModal(`‚ö†Ô∏è ÏµúÏ¢Ö Ï†ÄÏû• Ïã§Ìå®\nÌïòÏßÄÎßå Ïù¥ÎØ∏ÏßÄÎäî Î≥µÏõêÎêòÏóàÏäµÎãàÎã§.\nÏàòÎèôÏúºÎ°ú Ï†ÄÏû•Ìï¥Ï£ºÏÑ∏Ïöî.`);
                
                // 3Ï¥à ÌõÑ ÏôÑÎ£å Ï≤òÎ¶¨
                setTimeout(() => {
                    closeProgressModal();
                    showSaveModal(`‚úÖ Ïù¥ÎØ∏ÏßÄ Î≥µÏõê ÏôÑÎ£å!\n\nÏÑ±Í≥µ: ${successCount}Í∞ú\nÏã§Ìå®: ${failedCount}Í∞ú\n\n‚ö†Ô∏è ÌÅ¥ÎùºÏö∞Îìú Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\n"Ï†ÄÏû•" Î≤ÑÌäºÏùÑ ÎàåÎü¨Ï£ºÏÑ∏Ïöî.`);
                }, 3000);
                
                return { successCount, failedCount };
            }
            
            console.log(`Ïù¥ÎØ∏ÏßÄ Î≥µÏõê ÏôÑÎ£å: ÏÑ±Í≥µ ${successCount}Í∞ú, Ïã§Ìå® ${failedCount}Í∞ú`);
            return { successCount, failedCount };
        }

        // Ï†ÄÏû•ÏÜå Ï†ïÎ¶¨ Î∞è Ïû¨ÏãúÎèÑ Í∏∞Îä•
        async function clearStorageAndRetry() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '9999';

            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-title" style="color: #ffc107; margin-bottom: 20px;">
                        üßπ Ï†ÄÏû•ÏÜå Ï†ïÎ¶¨
                    </div>
                    <div class="modal-message" style="margin-bottom: 30px; line-height: 1.6;">
                        ÌòÑÏû¨ Ï†ÄÏû•ÏÜåÍ∞Ä Í∞ÄÎìù Ï∞®ÏÑú ÏÉà Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.<br><br>
                        
                        <strong>Ï†ÄÏû•ÏÜåÎ•º Ï†ïÎ¶¨ÌïòÏó¨ Í≥µÍ∞ÑÏùÑ ÌôïÎ≥¥ÌïòÏãúÍ≤†ÏäµÎãàÍπå?</strong><br><br>
                        
                        ‚ö†Ô∏è Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Îäî ÏûêÎèôÏúºÎ°ú Î∞±ÏóÖÎê©ÎãàÎã§.<br>
                        ‚úÖ Ï†ïÎ¶¨ ÌõÑ ÎåÄÏö©Îüâ Î∞±ÏóÖ Î∂àÎü¨Ïò§Í∏∞Í∞Ä Í∞ÄÎä•Ìï¥ÏßëÎãàÎã§.
                    </div>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="color: #856404; font-size: 14px;">
                            <strong>üìã Ï†ïÎ¶¨ Í≥ºÏ†ï:</strong><br>
                            1. ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞ Í∏¥Í∏â Î∞±ÏóÖ<br>
                            2. Î∏åÎùºÏö∞Ï†Ä Ï†ÄÏû•ÏÜå ÏôÑÏ†Ñ Ï†ïÎ¶¨<br>
                            3. Î©îÎ™®Î¶¨ ÏµúÏ†ÅÌôî<br>
                            4. ÎåÄÏö©Îüâ ÌååÏùº Î∂àÎü¨Ïò§Í∏∞ Ï§ÄÎπÑ ÏôÑÎ£å
                        </div>
                    </div>
                    <div class="modal-buttons">
                        <button class="modal-btn" style="background: #ffc107; color: black;" onclick="performStorageCleanup()">
                            üßπ Ï†ïÎ¶¨ ÏãúÏûë
                        </button>
                        <button class="modal-btn" style="background: #6c757d; color: white;" onclick="cancelStorageCleanup()">
                            ‚úñÔ∏è Ï∑®ÏÜå
                        </button>
                    </div>
                </div>
            `;

            window.performStorageCleanup = async () => {
                modal.remove();
                await executeStorageCleanup();
            };

            window.cancelStorageCleanup = () => {
                modal.remove();
            };

            document.body.appendChild(modal);
        }

        // Ï†ÄÏû•ÏÜå Ï†ïÎ¶¨ Ïã§Ìñâ
        async function executeStorageCleanup() {
            try {
                showSaveModal('üßπ Ï†ÄÏû•ÏÜå Ï†ïÎ¶¨ Ï§ë...\n\nÏû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî...');
                
                // 1Îã®Í≥Ñ: ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞ Í∏¥Í∏â Î∞±ÏóÖ
                console.log('1Îã®Í≥Ñ: Í∏¥Í∏â Î∞±ÏóÖ ÏÉùÏÑ±...');
                const currentData = {
                    pages: pages,
                    workNotes: workNotes,
                    menuStructure: menuStructure,
                    timestamp: new Date().toISOString(),
                    type: 'pre_cleanup_backup'
                };
                
                // ÏÑ∏ÏÖò Ïä§ÌÜ†Î¶¨ÏßÄÏóê Î∞±ÏóÖ (localStorageÎ≥¥Îã§ ÎèÖÎ¶ΩÏ†Å)
                try {
                    sessionStorage.setItem('mokpo_cleanup_backup', JSON.stringify(currentData));
                    console.log('Í∏¥Í∏â Î∞±ÏóÖ ÏôÑÎ£å');
                } catch (error) {
                    console.warn('ÏÑ∏ÏÖò Î∞±ÏóÖ Ïã§Ìå®:', error);
                }
                
                // 2Îã®Í≥Ñ: localStorage ÏôÑÏ†Ñ Ï†ïÎ¶¨
                console.log('2Îã®Í≥Ñ: localStorage Ï†ïÎ¶¨...');
                localStorage.clear(); // Î™®Îì† localStorage Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
                
                // 3Îã®Í≥Ñ: Ï∫êÏãú Î∞è ÏûÑÏãú Îç∞Ïù¥ÌÑ∞ Ï†ïÎ¶¨
                console.log('3Îã®Í≥Ñ: Ï∫êÏãú Ï†ïÎ¶¨...');
                if ('caches' in window) {
                    try {
                        const cacheNames = await caches.keys();
                        await Promise.all(
                            cacheNames.map(cacheName => caches.delete(cacheName))
                        );
                        console.log('Ï∫êÏãú Ï†ïÎ¶¨ ÏôÑÎ£å');
                    } catch (error) {
                        console.warn('Ï∫êÏãú Ï†ïÎ¶¨ Ïã§Ìå®:', error);
                    }
                }
                
                // 4Îã®Í≥Ñ: Î©îÎ™®Î¶¨ Ï†ïÎ¶¨ Ïú†ÎèÑ
                console.log('4Îã®Í≥Ñ: Î©îÎ™®Î¶¨ ÏµúÏ†ÅÌôî...');
                if (window.gc) {
                    window.gc(); // Í∞ÄÎπÑÏßÄ Ïª¨Î†âÏÖò (Chrome Í∞úÎ∞úÏûê ÎèÑÍµ¨ÏóêÏÑú ÌôúÏÑ±ÌôîÎêú Í≤ΩÏö∞)
                }
                
                // 5Îã®Í≥Ñ: Î≥ÄÏàò Ï¥àÍ∏∞Ìôî
                console.log('5Îã®Í≥Ñ: Î≥ÄÏàò Ï¥àÍ∏∞Ìôî...');
                pages = [];
                workNotes = '';
                currentPageIndex = 0;
                currentCategory = null;
                filteredPages = [];
                
                // UI Ï¥àÍ∏∞Ìôî
                document.getElementById('workNotes').value = '';
                updateAllDisplays();
                renderMenuGrid();
                
                // ÏôÑÎ£å Î©îÏãúÏßÄ
                const message = `‚úÖ Ï†ÄÏû•ÏÜå Ï†ïÎ¶¨ ÏôÑÎ£å!\n\nüìä ÌôïÎ≥¥Îêú Í≥µÍ∞Ñ: ÏµúÎåÄ 10MB+\nüíæ Î∞±ÏóÖ ÏúÑÏπò: ÏÑ∏ÏÖò Ïä§ÌÜ†Î¶¨ÏßÄ\nüîÑ ÏãúÏä§ÌÖú ÏÉÅÌÉú: ÏµúÏ†ÅÌôîÎê®\n\nÏù¥Ï†ú ÎåÄÏö©Îüâ Î∞±ÏóÖ ÌååÏùºÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏûàÏäµÎãàÎã§!\n\nüì§ "Î∂àÎü¨Ïò§Í∏∞" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ 22.12MB ÌååÏùºÏùÑ Îã§Ïãú ÏãúÎèÑÌï¥Î≥¥ÏÑ∏Ïöî.`;
                
                showSaveModal(message);
                
                // Ïó∞Í≤∞ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                updateConnectionStatus('üßπ Ï†ÄÏû•ÏÜå Ï†ïÎ¶¨Îê® - Î∂àÎü¨Ïò§Í∏∞ Ï§ÄÎπÑ ÏôÑÎ£å');
                
            } catch (error) {
                console.error('Ï†ÄÏû•ÏÜå Ï†ïÎ¶¨ Ïã§Ìå®:', error);
                showSaveErrorModal('üßπ Ï†ïÎ¶¨ Ïã§Ìå®', 
                    `Ï†ÄÏû•ÏÜå Ï†ïÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\n\nÏò§Î•ò: ${error.message}\n\nÏàòÎèôÏúºÎ°ú Î∏åÎùºÏö∞Ï†Ä Ï∫êÏãúÎ•º Ï†ïÎ¶¨Ìï¥Î≥¥ÏÑ∏Ïöî.`);
            }
        }

        // ÏÑ∏ÏÖò Î∞±ÏóÖ Î≥µÏõê Í∏∞Îä•
        async function restoreFromSessionBackup() {
            try {
                const sessionBackup = sessionStorage.getItem('mokpo_cleanup_backup');
                if (sessionBackup) {
                    const backupData = JSON.parse(sessionBackup);
                    
                    if (backupData.pages) pages = backupData.pages;
                    if (backupData.workNotes) {
                        workNotes = backupData.workNotes;
                        document.getElementById('workNotes').value = workNotes;
                    }
                    if (backupData.menuStructure) menuStructure = backupData.menuStructure;
                    
                    updateAllDisplays();
                    renderMenuGrid();
                    
                    showSaveModal('‚úÖ Ï†ïÎ¶¨ Ï†Ñ Îç∞Ïù¥ÌÑ∞Í∞Ä Î≥µÏõêÎêòÏóàÏäµÎãàÎã§!');
                    return true;
                }
                return false;
            } catch (error) {
                console.error('ÏÑ∏ÏÖò Î∞±ÏóÖ Î≥µÏõê Ïã§Ìå®:', error);
                return false;
            }
        }

        // ÎåÄÏö©Îüâ ÌååÏùº Ï†ÄÏû•ÏÜå Î∂ÄÏ°± Ïò§Î•ò Î™®Îã¨
        function showLargeFileErrorModal(fileSizeMB) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '9999';

            modal.innerHTML = `
                <div class="modal-content large">
                    <div class="modal-title" style="color: #dc3545; margin-bottom: 20px; text-align: center;">
                        üíæ Ï†ÄÏû• Í≥µÍ∞Ñ Î∂ÄÏ°± (${fileSizeMB}MB)
                    </div>
                    <div style="background: #f8d7da; padding: 20px; border-radius: 10px; border-left: 4px solid #dc3545; margin-bottom: 20px;">
                        <h4 style="color: #721c24; margin-bottom: 15px;">‚ö†Ô∏è Î∏åÎùºÏö∞Ï†Ä Ï†ÄÏû• ÌïúÍ≥Ñ ÎèÑÎã¨</h4>
                        <div style="color: #721c24; line-height: 1.6; font-size: 14px;">
                            ÌòÑÏû¨ Ï†ÄÏû•ÏÜåÍ∞Ä Í∞ÄÎìù Ï∞®ÏÑú ${fileSizeMB}MB Î∞±ÏóÖ ÌååÏùºÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.<br>
                            Î∏åÎùºÏö∞Ï†ÄÎäî Î≥¥ÌÜµ 5-10MBÍπåÏßÄÎßå Ï†ÄÏû•Ìï† Ïàò ÏûàÏäµÎãàÎã§.
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px;">
                            <h5 style="color: #856404; margin-bottom: 10px;">üßπ Ï¶âÏãú Ìï¥Í≤∞</h5>
                            <div style="color: #856404; font-size: 13px; line-height: 1.5;">
                                1. Ï†ÄÏû•ÏÜå Ï†ïÎ¶¨ (1Î∂Ñ)<br>
                                2. ÎåÄÏö©Îüâ Î∞±ÏóÖ Î∂àÎü¨Ïò§Í∏∞<br>
                                3. ÌÖçÏä§Ìä∏Îßå Î®ºÏ†Ä Î≥µÏõê<br>
                                4. Ïù¥ÎØ∏ÏßÄÎäî ÏÑ†ÌÉùÏ†Å Î≥µÏõê
                            </div>
                        </div>
                        <div style="background: #d1ecf1; padding: 15px; border-radius: 8px;">
                            <h5 style="color: #0c5460; margin-bottom: 10px;">üîß ÎåÄÏïà Î∞©Î≤ï</h5>
                            <div style="color: #0c5460; font-size: 13px; line-height: 1.5;">
                                1. ÏïïÏ∂ï Î∞±ÏóÖ ÏÉùÏÑ±<br>
                                2. Îã§Î•∏ Î∏åÎùºÏö∞Ï†Ä ÏÇ¨Ïö©<br>
                                3. ÏãúÌÅ¨Î¶ø Î™®Îìú ÏãúÎèÑ<br>
                                4. Ïù¥ÎØ∏ÏßÄ Í∞úÎ≥Ñ ÏóÖÎ°úÎìú
                            </div>
                        </div>
                    </div>

                    <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #155724; margin-bottom: 15px;">üéØ Í∂åÏû• Ìï¥Í≤∞ ÏàúÏÑú</h4>
                        <div style="color: #155724; line-height: 1.6;">
                            <strong>1Îã®Í≥Ñ:</strong> "Ï†ÄÏû•ÏÜå Ï†ïÎ¶¨" ÌÅ¥Î¶≠ ‚Üí Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ ÌõÑ Í≥µÍ∞Ñ ÌôïÎ≥¥<br>
                            <strong>2Îã®Í≥Ñ:</strong> Îã§Ïãú "Î∂àÎü¨Ïò§Í∏∞" ÌÅ¥Î¶≠ ‚Üí 22.12MB ÌååÏùº ÏÑ†ÌÉù<br>
                            <strong>3Îã®Í≥Ñ:</strong> ÌÖçÏä§Ìä∏ Î≥µÏõê ÏôÑÎ£å ÌõÑ Ïù¥ÎØ∏ÏßÄ ÏÑ†ÌÉùÏ†Å Î≥µÏõê<br>
                            <strong>ÏôÑÎ£å:</strong> Î™®Îì† ÏûëÏóÖ Îç∞Ïù¥ÌÑ∞ Î≥µÏõêÎê®!
                        </div>
                    </div>

                    <div style="text-align: center;">
                        <button class="btn btn-primary" style="background: #ffc107; color: black; margin-right: 10px;" onclick="closeLargeFileModal(); clearStorageAndRetry();">
                            üßπ Ï†ÄÏû•ÏÜå Ï†ïÎ¶¨ÌïòÍ≥† Ïû¨ÏãúÎèÑ
                        </button>
                        <button class="btn btn-secondary" onclick="closeLargeFileModal(); createCompressedBackup();" style="margin-right: 10px;">
                            üóúÔ∏è ÏïïÏ∂ï Î∞±ÏóÖ ÏÉùÏÑ±
                        </button>
                        <button class="btn btn-secondary" onclick="closeLargeFileModal();">
                            ‚úñÔ∏è Îã´Í∏∞
                        </button>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px; text-align: center;">
                        <div style="color: #6c757d; font-size: 12px;">
                            üí° ÏûëÏóÖÌïú Îç∞Ïù¥ÌÑ∞Îäî ÏïàÏ†ÑÌïòÍ≤å Î≥¥Í¥ÄÎê©ÎãàÎã§. Í±±Ï†ïÌïòÏßÄ ÎßàÏÑ∏Ïöî!
                        </div>
                    </div>
                </div>
            `;

            window.closeLargeFileModal = () => {
                modal.remove();
            };

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            document.body.appendChild(modal);
        }

        // Ïù¥ÎØ∏ÏßÄ Îã®Í≥ÑÎ≥Ñ Î≥µÏõê
        async function restoreImagesGradually(originalPages, fileSizeMB) {
            if (!originalPages) return;
            
            const imagesCount = originalPages.reduce((count, p) => 
                count + (p.beforeImage ? 1 : 0) + (p.afterImage ? 1 : 0), 0);
            
            if (imagesCount === 0) {
                console.log('Î≥µÏõêÌï† Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§.');
                showSuccessfulRestoreModal(fileSizeMB, imagesCount, true);
                return;
            }
            
            console.log(`${imagesCount}Í∞ú Ïù¥ÎØ∏ÏßÄ Î≥µÏõê ÏãúÏûë...`);
            
            try {
                let restoredImages = 0;
                let failedImages = 0;
                
                // Ïù¥ÎØ∏ÏßÄÎ•º ÌïòÎÇòÏî© Î≥µÏõê (Î©îÎ™®Î¶¨ Ï†àÏïΩ)
                for (let i = 0; i < originalPages.length; i++) {
                    const originalPage = originalPages[i];
                    const currentPage = pages[i];
                    
                    if (!currentPage) continue;
                    
                    // Before Ïù¥ÎØ∏ÏßÄ Î≥µÏõê
                    if (originalPage.beforeImage) {
                        try {
                            currentPage.beforeImage = originalPage.beforeImage;
                            restoredImages++;
                            console.log(`Ïù¥ÎØ∏ÏßÄ Î≥µÏõê ÏßÑÌñâ: ${restoredImages}/${imagesCount}`);
                        } catch (error) {
                            console.warn('Before Ïù¥ÎØ∏ÏßÄ Î≥µÏõê Ïã§Ìå®:', error);
                            failedImages++;
                        }
                    }
                    
                    // After Ïù¥ÎØ∏ÏßÄ Î≥µÏõê
                    if (originalPage.afterImage) {
                        try {
                            currentPage.afterImage = originalPage.afterImage;
                            restoredImages++;
                            console.log(`Ïù¥ÎØ∏ÏßÄ Î≥µÏõê ÏßÑÌñâ: ${restoredImages}/${imagesCount}`);
                        } catch (error) {
                            console.warn('After Ïù¥ÎØ∏ÏßÄ Î≥µÏõê Ïã§Ìå®:', error);
                            failedImages++;
                        }
                    }
                    
                    // 5Í∞úÎßàÎã§ Ï§ëÍ∞Ñ Ï†ÄÏû• ÏãúÎèÑ
                    if ((i + 1) % 5 === 0) {
                        try {
                            console.log(`Ï§ëÍ∞Ñ Ï†ÄÏû• ÏãúÎèÑ... (${i + 1}/${originalPages.length} ÌéòÏù¥ÏßÄ)`);
                            await saveData();
                            console.log('Ï§ëÍ∞Ñ Ï†ÄÏû• ÏÑ±Í≥µ');
                        } catch (error) {
                            console.warn('Ï§ëÍ∞Ñ Ï†ÄÏû• Ïã§Ìå®, Í≥ÑÏÜç ÏßÑÌñâ:', error);
                        }
                    }
                }
                
                // ÏµúÏ¢Ö Ï†ÄÏû•
                console.log('ÏµúÏ¢Ö Ï†ÄÏû• ÏãúÎèÑ...');
                const finalSaveSuccess = await saveData();
                
                // Í≤∞Í≥º ÌëúÏãú
                showSuccessfulRestoreModal(fileSizeMB, imagesCount, finalSaveSuccess, restoredImages, failedImages);
                
            } catch (error) {
                console.error('Ïù¥ÎØ∏ÏßÄ Î≥µÏõê Ï§ë Ïò§Î•ò:', error);
                
                // Ïù¥ÎØ∏ÏßÄ ÏóÜÏù¥ÎùºÎèÑ ÌÖçÏä§Ìä∏Îäî Î≥µÏõêÎê®
                showSaveErrorModal('üñºÔ∏è Ïù¥ÎØ∏ÏßÄ Î≥µÏõê Î∂ÄÎ∂Ñ Ïã§Ìå®', 
                    `ÌÖçÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞Îäî ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î≥µÏõêÎêòÏóàÏßÄÎßå,\nÏù¥ÎØ∏ÏßÄ Î≥µÏõê Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\n\nÏõêÏù∏: Ï†ÄÏû• Í≥µÍ∞Ñ Î∂ÄÏ°±\n\nÌï¥Í≤∞ Î∞©Î≤ï:\n1. Î∏åÎùºÏö∞Ï†Ä Ï∫êÏãú Ï†ïÎ¶¨\n2. Ïù¥ÎØ∏ÏßÄ ÏïïÏ∂ï Î∞±ÏóÖ ÏÉùÏÑ±\n3. Ïù¥ÎØ∏ÏßÄÎ•º Í∞úÎ≥ÑÏ†ÅÏúºÎ°ú ÏóÖÎ°úÎìú`);
            }
        }

        // ÏïïÏ∂ïÎêú Î∞±ÏóÖ ÏÉùÏÑ± (Ïù¥ÎØ∏ÏßÄ ÏµúÏ†ÅÌôî)
        async function createCompressedBackup() {
            try {
                showSaveModal('üóúÔ∏è ÏïïÏ∂ï Î∞±ÏóÖ ÏÉùÏÑ± Ï§ë...\n\nÏù¥ÎØ∏ÏßÄÎ•º ÏïïÏ∂ïÌïòÍ≥† ÏûàÏäµÎãàÎã§.\nÏû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî...');
                
                // Ïù¥ÎØ∏ÏßÄ ÏïïÏ∂ïÎêú ÌéòÏù¥ÏßÄ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
                const compressedPages = await Promise.all(pages.map(async (page) => {
                    const compressedPage = { ...page };
                    
                    // Before Ïù¥ÎØ∏ÏßÄ ÏïïÏ∂ï
                    if (page.beforeImage) {
                        try {
                            compressedPage.beforeImage = await compressImage(page.beforeImage, 0.6); // 60% ÌíàÏßà
                        } catch (error) {
                            console.warn('Before Ïù¥ÎØ∏ÏßÄ ÏïïÏ∂ï Ïã§Ìå®:', error);
                            compressedPage.beforeImage = page.beforeImage; // ÏõêÎ≥∏ Ïú†ÏßÄ
                        }
                    }
                    
                    // After Ïù¥ÎØ∏ÏßÄ ÏïïÏ∂ï
                    if (page.afterImage) {
                        try {
                            compressedPage.afterImage = await compressImage(page.afterImage, 0.6); // 60% ÌíàÏßà
                        } catch (error) {
                            console.warn('After Ïù¥ÎØ∏ÏßÄ ÏïïÏ∂ï Ïã§Ìå®:', error);
                            compressedPage.afterImage = page.afterImage; // ÏõêÎ≥∏ Ïú†ÏßÄ
                        }
                    }
                    
                    return compressedPage;
                }));

                const compressedData = {
                    pages: compressedPages,
                    workNotes: workNotes,
                    menuStructure: menuStructure,
                    exportDate: new Date().toISOString(),
                    projectName: 'Î™©Ìè¨Ïãú ÌÜµÌï©ÎèÑÏÑúÍ¥Ä ÌôàÌéòÏù¥ÏßÄ Í∞úÌé∏ (ÏïïÏ∂ï)',
                    version: '1.0-compressed',
                    totalPages: compressedPages.length,
                    completedPages: compressedPages.filter(p => p.isCompleted).length,
                    dataSource: 'compressed',
                    compressionApplied: true,
                    originalImageCount: pages.reduce((count, p) => count + (p.beforeImage ? 1 : 0) + (p.afterImage ? 1 : 0), 0)
                };
                
                // ÏïïÏ∂ï Ï†ÑÌõÑ ÌÅ¨Í∏∞ ÎπÑÍµê
                const originalSize = new Blob([JSON.stringify({
                    pages: pages,
                    workNotes: workNotes,
                    menuStructure: menuStructure
                })]).size;
                
                const compressedSize = new Blob([JSON.stringify(compressedData)]).size;
                const compressionRatio = ((1 - compressedSize / originalSize) * 100).toFixed(1);
                
                const jsonString = JSON.stringify(compressedData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                
                const url = URL.createObjectURL(blob);
                const fileName = `Î™©Ìè¨ÏãúÎèÑÏÑúÍ¥Ä_ÏïïÏ∂ïÎ∞±ÏóÖ_${new Date().toISOString().split('T')[0]}.json`;
                
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                a.style.display = 'none';
                
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                // ÏÑ±Í≥µ Î©îÏãúÏßÄ
                const message = `‚úÖ ÏïïÏ∂ï Î∞±ÏóÖÏù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!

üìÅ ÌååÏùºÎ™Ö: ${fileName}
üìä Ï¥ù ÌéòÏù¥ÏßÄ: ${compressedData.totalPages}Í∞ú
‚úÖ ÏôÑÎ£åÎêú ÌéòÏù¥ÏßÄ: ${compressedData.completedPages}Í∞ú
üñºÔ∏è Ïù¥ÎØ∏ÏßÄ: ${compressedData.originalImageCount}Í∞ú

üìâ ÏïïÏ∂ï Ìö®Í≥º:
‚Ä¢ ÏõêÎ≥∏ ÌÅ¨Í∏∞: ${(originalSize / (1024 * 1024)).toFixed(2)}MB
‚Ä¢ ÏïïÏ∂ï ÌÅ¨Í∏∞: ${(compressedSize / (1024 * 1024)).toFixed(2)}MB
‚Ä¢ Ï†àÏïΩÎ•†: ${compressionRatio}%

üí° ÏïïÏ∂ïÎêú Î∞±ÏóÖÏùÄ ÌíàÏßàÏù¥ ÏïΩÍ∞Ñ ÎÇÆÏïÑÏßÄÏßÄÎßå Ïö©ÎüâÏù¥ ÌÅ¨Í≤å Ï§ÑÏñ¥Îì≠ÎãàÎã§.`;
                
                showSaveModal(message);
                
            } catch (error) {
                console.error('ÏïïÏ∂ï Î∞±ÏóÖ ÏÉùÏÑ± Ïã§Ìå®:', error);
                showSaveErrorModal('üóúÔ∏è ÏïïÏ∂ï Î∞±ÏóÖ Ïã§Ìå®', 
                    `ÏïïÏ∂ï Î∞±ÏóÖ ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\n\nÏò§Î•ò: ${error.message}\n\nÏùºÎ∞ò Î∞±ÏóÖÏùÑ ÏÇ¨Ïö©Ìï¥Ï£ºÏÑ∏Ïöî.`);
            }
        }

        // Ïù¥ÎØ∏ÏßÄ ÏïïÏ∂ï Ìï®Ïàò
        function compressImage(dataURL, quality = 0.6) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // ÏµúÎåÄ ÌÅ¨Í∏∞ Ï†úÌïú (1920x1080)
                    const maxWidth = 1920;
                    const maxHeight = 1080;
                    
                    let { width, height } = img;
                    
                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width = width * ratio;
                        height = height * ratio;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Ïù¥ÎØ∏ÏßÄ Í∑∏Î¶¨Í∏∞
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // ÏïïÏ∂ïÎêú Îç∞Ïù¥ÌÑ∞ URL ÏÉùÏÑ±
                    try {
                        const compressedDataURL = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedDataURL);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                img.onerror = function() {
                    reject(new Error('Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®'));
                };
                
                img.src = dataURL;
            });
        }

        // ÏÑ±Í≥µÏ†ÅÏù∏ Î≥µÏõê Í≤∞Í≥º Î™®Îã¨
        function showSuccessfulRestoreModal(fileSizeMB, totalImages, saveSuccess, restoredImages = 0, failedImages = 0) {
            const hasImages = totalImages > 0;
            
            let message = `‚úÖ Î∞±ÏóÖ ÌååÏùºÏùÑ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∂àÎü¨ÏôîÏäµÎãàÎã§!\n\n`;
            message += `üìÅ ÌååÏùº ÌÅ¨Í∏∞: ${fileSizeMB}MB\n`;
            message += `üìä Î≥µÏõêÎêú ÌéòÏù¥ÏßÄ: ${pages.length}Í∞ú\n`;
            message += `‚úÖ ÏôÑÎ£åÎêú ÌéòÏù¥ÏßÄ: ${pages.filter(p => p.isCompleted).length}Í∞ú\n`;
            
            if (hasImages) {
                message += `üñºÔ∏è Ï†ÑÏ≤¥ Ïù¥ÎØ∏ÏßÄ: ${totalImages}Í∞ú\n`;
                if (restoredImages > 0) {
                    message += `‚úÖ Î≥µÏõêÎêú Ïù¥ÎØ∏ÏßÄ: ${restoredImages}Í∞ú\n`;
                }
                if (failedImages > 0) {
                    message += `‚ùå Ïã§Ìå®Ìïú Ïù¥ÎØ∏ÏßÄ: ${failedImages}Í∞ú\n`;
                }
            }
            
            if (saveSuccess) {
                message += isSupabaseReady ? 
                    '\n‚òÅÔ∏è Îç∞Ïù¥ÌÑ∞Í∞Ä ÌÅ¥ÎùºÏö∞ÎìúÏóê Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.' : 
                    '\nüíæ Îç∞Ïù¥ÌÑ∞Í∞Ä Î°úÏª¨Ïóê Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.';
            } else {
                message += '\n‚ö†Ô∏è ÏùºÎ∂Ä Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏùÑ Ïàò ÏûàÏäµÎãàÎã§.';
            }
            
            if (failedImages > 0) {
                message += '\n\nüí° Ïã§Ìå®Ìïú Ïù¥ÎØ∏ÏßÄÎäî Í∞úÎ≥ÑÏ†ÅÏúºÎ°ú Îã§Ïãú ÏóÖÎ°úÎìúÌï¥Ï£ºÏÑ∏Ïöî.';
            }
            
            showSaveModal(message);
        }

        // Îç∞Ïù¥ÌÑ∞ ÌÅ¨Í∏∞ Î∂ÑÏÑù Ìï®Ïàò
        function showDataSizeAnalysis() {
            try {
                const analysis = analyzeDataSize();
                const modal = createDataAnalysisModal(analysis);
                document.body.appendChild(modal);
            } catch (error) {
                alert('Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }

        function analyzeDataSize() {
            const data = {
                pages: pages,
                workNotes: workNotes,
                menuStructure: menuStructure
            };

            // Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ ÌÅ¨Í∏∞
            const totalDataString = JSON.stringify(data);
            const totalSizeBytes = new Blob([totalDataString]).size;
            const totalSizeMB = (totalSizeBytes / (1024 * 1024)).toFixed(2);

            // Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù
            let imageCount = 0;
            let totalImageSize = 0;
            let largestImageSize = 0;
            let largestImagePage = '';

            pages.forEach((page, index) => {
                if (page.beforeImage) {
                    imageCount++;
                    const imageSize = new Blob([page.beforeImage]).size;
                    totalImageSize += imageSize;
                    if (imageSize > largestImageSize) {
                        largestImageSize = imageSize;
                        largestImagePage = `${page.title} (Í∞úÌé∏ Ï†Ñ)`;
                    }
                }
                if (page.afterImage) {
                    imageCount++;
                    const imageSize = new Blob([page.afterImage]).size;
                    totalImageSize += imageSize;
                    if (imageSize > largestImageSize) {
                        largestImageSize = imageSize;
                        largestImagePage = `${page.title} (Í∞úÌé∏ ÌõÑ)`;
                    }
                }
            });

            // ÌÖçÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ ÌÅ¨Í∏∞
            const textData = {
                pages: pages.map(p => ({
                    ...p,
                    beforeImage: null,
                    afterImage: null
                })),
                workNotes: workNotes,
                menuStructure: menuStructure
            };
            const textSizeBytes = new Blob([JSON.stringify(textData)]).size;

            // localStorage ÏÇ¨Ïö©Îüâ Ï≤¥ÌÅ¨
            let localStorageUsed = 0;
            let localStorageTotal = 0;
            try {
                // localStorage ÌÅ¨Í∏∞ Ï∂îÏ†ï
                const localData = localStorage.getItem('mokpo_library_data');
                if (localData) {
                    localStorageUsed = new Blob([localData]).size;
                }

                // localStorage ÌïúÍ≥Ñ ÌÖåÏä§Ìä∏ (ÎåÄÎûµÏ†Å)
                const testKey = '__storage_test__';
                let testSize = 0;
                try {
                    for (let i = 0; i < 10; i++) {
                        const testData = 'x'.repeat(1024 * 1024); // 1MBÏî© ÌÖåÏä§Ìä∏
                        localStorage.setItem(testKey, testData);
                        testSize += 1024 * 1024;
                    }
                } catch (e) {
                    // Ï†ÄÏû• Ïã§Ìå® ÏãúÏ†êÏóêÏÑú ÎåÄÎûµÏ†ÅÏù∏ ÌïúÍ≥Ñ ÌôïÏù∏
                } finally {
                    localStorage.removeItem(testKey);
                }
                localStorageTotal = Math.max(testSize, 5 * 1024 * 1024); // ÏµúÏÜå 5MB
            } catch (error) {
                localStorageTotal = 5 * 1024 * 1024; // Í∏∞Î≥∏Í∞í 5MB
            }

            return {
                totalPages: pages.length,
                imageCount: imageCount,
                totalSizeBytes: totalSizeBytes,
                totalSizeMB: totalSizeMB,
                textSizeBytes: textSizeBytes,
                totalImageSize: totalImageSize,
                totalImageSizeMB: (totalImageSize / (1024 * 1024)).toFixed(2),
                largestImageSize: largestImageSize,
                largestImageSizeMB: (largestImageSize / (1024 * 1024)).toFixed(2),
                largestImagePage: largestImagePage,
                localStorageUsed: localStorageUsed,
                localStorageUsedMB: (localStorageUsed / (1024 * 1024)).toFixed(2),
                localStorageTotal: localStorageTotal,
                localStorageTotalMB: (localStorageTotal / (1024 * 1024)).toFixed(2),
                storageUsagePercent: ((localStorageUsed / localStorageTotal) * 100).toFixed(1),
                isNearLimit: (localStorageUsed / localStorageTotal) > 0.8,
                isCritical: (localStorageUsed / localStorageTotal) > 0.95
            };
        }

        function createDataAnalysisModal(analysis) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '9999';

            const statusIcon = analysis.isCritical ? 'üî¥' : analysis.isNearLimit ? 'üü°' : 'üü¢';
            const statusText = analysis.isCritical ? 'ÏúÑÌóò' : analysis.isNearLimit ? 'Ï£ºÏùò' : 'ÏñëÌò∏';
            const statusColor = analysis.isCritical ? '#dc3545' : analysis.isNearLimit ? '#ffc107' : '#28a745';

            modal.innerHTML = `
                <div class="modal-content large">
                    <div class="modal-title" style="color: ${statusColor}; margin-bottom: 20px; text-align: center;">
                        üìä Îç∞Ïù¥ÌÑ∞ ÌÅ¨Í∏∞ Î∂ÑÏÑù ${statusIcon}
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <!-- Ï†ÑÏ≤¥ ÌòÑÌô© -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <h4 style="color: #495057; margin-bottom: 15px;">üìã Ï†ÑÏ≤¥ ÌòÑÌô©</h4>
                            <div style="margin-bottom: 10px;">
                                <strong>Ï¥ù ÌéòÏù¥ÏßÄ:</strong> ${analysis.totalPages}Í∞ú
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>Ï¥ù Ïù¥ÎØ∏ÏßÄ:</strong> ${analysis.imageCount}Í∞ú
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞:</strong> ${analysis.totalSizeMB}MB
                            </div>
                            <div>
                                <strong>ÏÉÅÌÉú:</strong> <span style="color: ${statusColor}; font-weight: bold;">${statusText}</span>
                            </div>
                        </div>

                        <!-- Ï†ÄÏû•ÏÜå ÏÇ¨Ïö©Îüâ -->
                        <div style="background: #e8f5e8; padding: 20px; border-radius: 10px;">
                            <h4 style="color: #155724; margin-bottom: 15px;">üíæ Ï†ÄÏû•ÏÜå ÏÇ¨Ïö©Îüâ</h4>
                            <div style="margin-bottom: 10px;">
                                <strong>ÏÇ¨Ïö©Îüâ:</strong> ${analysis.localStorageUsedMB}MB / ${analysis.localStorageTotalMB}MB
                            </div>
                            <div style="margin-bottom: 15px;">
                                <strong>ÏÇ¨Ïö©Î•†:</strong> ${analysis.storageUsagePercent}%
                            </div>
                            <div style="background: #e9ecef; height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="height: 100%; background: ${statusColor}; width: ${analysis.storageUsagePercent}%; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <!-- Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù -->
                        <div style="background: #fff3cd; padding: 20px; border-radius: 10px;">
                            <h4 style="color: #856404; margin-bottom: 15px;">üñºÔ∏è Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù</h4>
                            <div style="margin-bottom: 10px;">
                                <strong>Ïù¥ÎØ∏ÏßÄ Ï¥ù ÌÅ¨Í∏∞:</strong> ${analysis.totalImageSizeMB}MB
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>Í∞ÄÏû• ÌÅ∞ Ïù¥ÎØ∏ÏßÄ:</strong> ${analysis.largestImageSizeMB}MB
                            </div>
                            <div style="font-size: 12px; color: #856404;">
                                ${analysis.largestImagePage}
                            </div>
                        </div>

                        <!-- ÌÖçÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ -->
                        <div style="background: #d1ecf1; padding: 20px; border-radius: 10px;">
                            <h4 style="color: #0c5460; margin-bottom: 15px;">üìù ÌÖçÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞</h4>
                            <div style="margin-bottom: 10px;">
                                <strong>ÌÖçÏä§Ìä∏ ÌÅ¨Í∏∞:</strong> ${(analysis.textSizeBytes / 1024).toFixed(1)}KB
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>Ïù¥ÎØ∏ÏßÄ ÎπÑÏú®:</strong> ${((analysis.totalImageSize / analysis.totalSizeBytes) * 100).toFixed(1)}%
                            </div>
                        </div>
                    </div>

                    ${analysis.isNearLimit ? `
                        <div style="background: ${analysis.isCritical ? '#f8d7da' : '#fff3cd'}; padding: 20px; border-radius: 10px; border-left: 4px solid ${statusColor}; margin-bottom: 20px;">
                            <h4 style="color: ${analysis.isCritical ? '#721c24' : '#856404'}; margin-bottom: 15px;">
                                ‚ö†Ô∏è ${analysis.isCritical ? 'Ï†ÄÏû•ÏÜå ÌïúÍ≥Ñ ÏûÑÎ∞ï!' : 'Ï†ÄÏû•ÏÜå ÏÇ¨Ïö©Îüâ Ï£ºÏùò'}
                            </h4>
                            <div style="color: ${analysis.isCritical ? '#721c24' : '#856404'}; line-height: 1.6;">
                                ${analysis.isCritical ? 
                                    '‚Ä¢ Ï†ÄÏû•ÏÜå ÏÇ¨Ïö©ÎüâÏù¥ 95%Î•º Ï¥àÍ≥ºÌñàÏäµÎãàÎã§.<br>‚Ä¢ Îçî Ïù¥ÏÉÅ Îç∞Ïù¥ÌÑ∞Î•º Ï†ÄÏû•ÌïòÍ∏∞ Ïñ¥Î†§Ïö∏ Ïàò ÏûàÏäµÎãàÎã§.<br>‚Ä¢ Ï¶âÏãú Ïù¥ÎØ∏ÏßÄ ÏµúÏ†ÅÌôîÎÇò Îç∞Ïù¥ÌÑ∞ Ï†ïÎ¶¨Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§.' :
                                    '‚Ä¢ Ï†ÄÏû•ÏÜå ÏÇ¨Ïö©ÎüâÏù¥ 80%Î•º Ï¥àÍ≥ºÌñàÏäµÎãàÎã§.<br>‚Ä¢ Ïù¥ÎØ∏ÏßÄ ÏµúÏ†ÅÌôîÎ•º Í≥†Î†§Ìï¥Î≥¥ÏÑ∏Ïöî.<br>‚Ä¢ Î∂àÌïÑÏöîÌïú Îç∞Ïù¥ÌÑ∞Î•º Ï†ïÎ¶¨ÌïòÎ©¥ ÎèÑÏõÄÏù¥ Îê©ÎãàÎã§.'
                                }
                            </div>
                        </div>
                    ` : ''}

                    <div style="background: #e8f4f8; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #0c5460; margin-bottom: 15px;">üí° ÏµúÏ†ÅÌôî Î∞©Î≤ï</h4>
                        <div style="color: #0c5460; line-height: 1.6; font-size: 14px;">
                            <strong>1. Ïù¥ÎØ∏ÏßÄ ÏïïÏ∂ï:</strong> Ïù¥ÎØ∏ÏßÄÎ•º ÏóÖÎ°úÎìúÌïòÍ∏∞ Ï†ÑÏóê ÏïïÏ∂ïÌïòÏÑ∏Ïöî (Í∂åÏû•: 1MB Ïù¥Ìïò)<br>
                            <strong>2. Î∂àÌïÑÏöîÌïú ÌéòÏù¥ÏßÄ ÏÇ≠Ï†ú:</strong> ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÎäî ÌéòÏù¥ÏßÄÎ•º Ï†ïÎ¶¨ÌïòÏÑ∏Ïöî<br>
                            <strong>3. Î∞±ÏóÖ ÌõÑ Ï¥àÍ∏∞Ìôî:</strong> Î∞±ÏóÖÏùÑ Îã§Ïö¥Î°úÎìúÌïú ÌõÑ ÏãúÏä§ÌÖúÏùÑ Ï¥àÍ∏∞ÌôîÌïòÏÑ∏Ïöî<br>
                            <strong>4. Ïô∏Î∂Ä Ïù¥ÎØ∏ÏßÄ Ìò∏Ïä§ÌåÖ:</strong> Ïù¥ÎØ∏ÏßÄÎ•º Ïô∏Î∂Ä ÏÑúÎπÑÏä§Ïóê ÏóÖÎ°úÎìúÌïòÍ≥† URLÎßå Ï†ÄÏû•ÌïòÏÑ∏Ïöî
                        </div>
                    </div>

                    <div style="text-align: center;">
                        <button class="btn btn-primary" onclick="closeDataAnalysisModal()" style="margin-right: 10px;">
                            ‚úñÔ∏è Îã´Í∏∞
                        </button>
                        <button class="btn btn-secondary" onclick="closeDataAnalysisModal(); clearStorageAndRetry();" style="margin-right: 10px;">
                            üßπ Ï†ÄÏû•ÏÜå Ï†ïÎ¶¨
                        </button>
                        <button class="btn btn-secondary" onclick="closeDataAnalysisModal(); createCompressedBackup();" style="margin-right: 10px;">
                            üóúÔ∏è ÏïïÏ∂ï Î∞±ÏóÖ ÏÉùÏÑ±
                        </button>
                        ${analysis.isNearLimit ? `
                            <button class="btn btn-secondary" onclick="showImageOptimizationTips()" style="margin-right: 10px;">
                                üõ†Ô∏è ÏµúÏ†ÅÌôî Í∞ÄÏù¥Îìú
                            </button>
                        ` : ''}
                        <button class="btn btn-secondary" onclick="refreshDataAnalysis()">
                            üîÑ ÏÉàÎ°úÍ≥†Ïπ®
                        </button>
                    </div>
                </div>
            `;

            // Ï†ÑÏó≠ Ìï®Ïàò Îì±Î°ù
            window.closeDataAnalysisModal = () => {
                modal.remove();
            };

            window.refreshDataAnalysis = () => {
                modal.remove();
                showDataSizeAnalysis();
            };

            window.showImageOptimizationTips = () => {
                modal.remove();
                showImageOptimizationModal();
            };

            // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            return modal;
        }

        function showImageOptimizationModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '9999';

            modal.innerHTML = `
                <div class="modal-content large">
                    <div class="modal-title" style="color: #17a2b8; margin-bottom: 20px; text-align: center;">
                        üõ†Ô∏è Ïù¥ÎØ∏ÏßÄ ÏµúÏ†ÅÌôî Í∞ÄÏù¥Îìú
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #495057; margin-bottom: 15px;">üìè Í∂åÏû• Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="margin-bottom: 8px;"><strong>‚Ä¢ ÌååÏùº ÌÅ¨Í∏∞:</strong> 1MB Ïù¥Ìïò (Í∂åÏû•: 500KB Ïù¥Ìïò)</div>
                            <div style="margin-bottom: 8px;"><strong>‚Ä¢ Ìï¥ÏÉÅÎèÑ:</strong> 1920x1080 Ïù¥Ìïò</div>
                            <div style="margin-bottom: 8px;"><strong>‚Ä¢ ÌòïÏãù:</strong> JPEG (ÏÇ¨ÏßÑ), PNG (Ïä§ÌÅ¨Î¶∞ÏÉ∑), WebP (ÏµúÏ†Å)</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #495057; margin-bottom: 15px;">üîß ÏïïÏ∂ï ÎèÑÍµ¨ Ï∂îÏ≤ú</h4>
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="margin-bottom: 8px;"><strong>‚Ä¢ Ïò®ÎùºÏù∏:</strong> TinyPNG, Compressor.io, Squoosh.app</div>
                            <div style="margin-bottom: 8px;"><strong>‚Ä¢ ÌîÑÎ°úÍ∑∏Îû®:</strong> Adobe Photoshop, GIMP (Î¨¥Î£å)</div>
                            <div style="margin-bottom: 8px;"><strong>‚Ä¢ Î∏åÎùºÏö∞Ï†Ä:</strong> Í∞úÎ∞úÏûêÎèÑÍµ¨ > Ïä§ÌÅ¨Î¶∞ÏÉ∑ (ÏïïÏ∂ïÎê®)</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #495057; margin-bottom: 15px;">‚ö° Îπ†Î•∏ Ìï¥Í≤∞ Î∞©Î≤ï</h4>
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                            <div style="margin-bottom: 8px;"><strong>1. Ïä§ÌÅ¨Î¶∞ÏÉ∑ ÏïïÏ∂ï:</strong> Ïä§ÌÅ¨Î¶∞ÏÉ∑ÏùÑ Ï∞çÏùÄ ÌõÑ Í∑∏Î¶ºÌåêÏóêÏÑú Ï†ÄÏû• Ïãú JPEG ÏÑ†ÌÉù</div>
                            <div style="margin-bottom: 8px;"><strong>2. Î∏åÎùºÏö∞Ï†Ä ÏïïÏ∂ï:</strong> Ïù¥ÎØ∏ÏßÄÎ•º Î∏åÎùºÏö∞Ï†ÄÏóê ÎìúÎûòÍ∑∏ ÌõÑ Ïö∞ÌÅ¥Î¶≠ > Îã§Î•∏ Ïù¥Î¶ÑÏúºÎ°ú Ï†ÄÏû•</div>
                            <div style="margin-bottom: 8px;"><strong>3. Ïò®ÎùºÏù∏ ÏïïÏ∂ï:</strong> TinyPNG.comÏóêÏÑú Î¨¥Î£åÎ°ú ÏïïÏ∂ï (80% Ïö©Îüâ Í∞êÏÜå)</div>
                        </div>
                    </div>

                    <div style="text-align: center;">
                        <button class="btn btn-primary" onclick="closeImageOptModal()">
                            ‚úñÔ∏è Îã´Í∏∞
                        </button>
                    </div>
                </div>
            `;

            window.closeImageOptModal = () => {
                modal.remove();
            };

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            document.body.appendChild(modal);
        }

        function showSaveModal(message) {
            document.getElementById('saveMessage').textContent = message;
            document.getElementById('saveModal').style.display = 'block';
        }

        function closeSaveModal() {
            document.getElementById('saveModal').style.display = 'none';
        }

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
        document.addEventListener('DOMContentLoaded', function() {
            // Supabase Ï¥àÍ∏∞Ìôî (Ï†ëÏÜçÏûê Ïàò Í¥ÄÎ¶¨ Ìè¨Ìï®)
            initializeSupabase();
            
            // ÏûêÎèô Î°úÍ∑∏Ïù∏ Ï≤¥ÌÅ¨ (ÏÉàÎ°úÍ≥†Ïπ® Ïãú Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú Î≥µÏõê)
            const autoLoginSuccess = checkAutoLogin();
            
            // ÏûêÎèô Î°úÍ∑∏Ïù∏Ïù¥ Ïã§Ìå®Ìïú Í≤ΩÏö∞ÏóêÎßå Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ ÌëúÏãú
            if (!autoLoginSuccess) {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainContent').style.display = 'none';
            }
            
            // Ï†ëÏÜçÏûê Ïàò ÌëúÏãú Ï¥àÍ∏∞Ìôî (ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ)
            setTimeout(() => {
                updateOnlineCountDisplay();
            }, 500);
            
            // Ìé∏Ïßë Í∞êÏßÄÎ•º ÏúÑÌïú Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
            setupEditingDetection();
            
            document.getElementById('loginInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    attemptLogin();
                }
            });
            
            window.addEventListener('click', function(event) {
                const saveModal = document.getElementById('saveModal');
                const menuModal = document.getElementById('menuEditorModal');
                if (event.target === saveModal) {
                    closeSaveModal();
                }
                if (event.target === menuModal) {
                    closeMenuEditor();
                }
            });
            
            // Ïä§ÎßàÌä∏ ÏûêÎèô Ï†ÄÏû• (Ìé∏Ïßë ÌôúÎèôÏù¥ ÏûàÏùÑ ÎïåÎßå)
            setInterval(async () => {
                if (currentUserType === 'admin' && !isReceivingUpdate && hasUnsavedChanges) {
                    // Ìé∏Ïßë ÌôúÎèô Ï≤¥ÌÅ¨
                    if (checkEditingActivity()) {
                        const now = new Date().getTime();
                        const timeSinceLastEdit = now - lastEditTime;
                        
                        // ÎßàÏßÄÎßâ Ìé∏Ïßë ÌõÑ 10Ï¥àÍ∞Ä ÏßÄÎÇòÏïº ÏûêÎèôÏ†ÄÏû• (ÌÉÄÏù¥Ìïë Ï§ëÏóêÎäî Ï†ÄÏû• ÏïàÌï®)
                        if (timeSinceLastEdit > 10000) {
                            try {
                                console.log('Ïä§ÎßàÌä∏ ÏûêÎèôÏ†ÄÏû• Ïã§Ìñâ:', new Date().toLocaleTimeString());
                                const success = await safeAutoSave();
                                if (success) {
                                    showSyncIndicator('üíæ ÏûêÎèô Ï†ÄÏû•Îê®');
                                }
                            } catch (error) {
                                console.error('ÏûêÎèô Ï†ÄÏû• Ïã§Ìå®:', error);
                            }
                        }
                    } else {
                        // Ìé∏Ïßë ÌôúÎèôÏù¥ ÏóÜÏúºÎ©¥ Ï†ÄÏû•ÎêòÏßÄ ÏïäÏùÄ Î≥ÄÍ≤ΩÏÇ¨Ìï≠ ÌîåÎûòÍ∑∏ Ìï¥Ï†ú
                        console.log('Ìé∏Ïßë ÌôúÎèô ÏóÜÏùå - ÏûêÎèôÏ†ÄÏû• Í±¥ÎÑàÎúÄ');
                    }
                }
            }, 15000); // 15Ï¥àÎßàÎã§ Ï≤¥ÌÅ¨
            
            // Ìé∏Ïßë ÏÉÅÌÉú ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏ (5Ï¥àÎßàÎã§)
            setInterval(() => {
                if (currentUserType === 'admin') {
                    const editStatus = document.getElementById('editStatus');
                    if (!editStatus) {
                        // Ìé∏Ïßë ÏÉÅÌÉú ÌëúÏãú ÏöîÏÜå ÏÉùÏÑ±
                        const statusDiv = document.createElement('div');
                        statusDiv.id = 'editStatus';
                        statusDiv.style.cssText = `
                            position: fixed;
                            bottom: 80px;
                            right: 20px;
                            padding: 8px 12px;
                            border-radius: 20px;
                            font-size: 12px;
                            font-weight: 600;
                            z-index: 1000;
                            display: none;
                        `;
                        document.body.appendChild(statusDiv);
                    }
                    
                    const editStatusDiv = document.getElementById('editStatus');
                    if (hasUnsavedChanges && isActivelyEditing) {
                        editStatusDiv.style.display = 'block';
                        editStatusDiv.style.background = 'linear-gradient(45deg, #ff9800, #f57c00)';
                        editStatusDiv.style.color = 'white';
                        editStatusDiv.textContent = '‚úèÔ∏è Ìé∏Ïßë Ï§ë...';
                    } else if (hasUnsavedChanges) {
                        editStatusDiv.style.display = 'block';
                        editStatusDiv.style.background = 'linear-gradient(45deg, #ffc107, #ffb300)';
                        editStatusDiv.style.color = 'white';
                        editStatusDiv.textContent = 'üíæ Ï†ÄÏû• ÎåÄÍ∏∞ Ï§ë';
                    } else {
                        editStatusDiv.style.display = 'none';
                    }
                }
            }, 5000);
            
            // ÌéòÏù¥ÏßÄ Ï¢ÖÎ£å Ï†Ñ Ï†ÄÏû• Î∞è Ï†ïÎ¶¨
            window.addEventListener('beforeunload', async function(e) {
                // Ï†ÄÏû•ÎêòÏßÄ ÏïäÏùÄ Î≥ÄÍ≤ΩÏÇ¨Ìï≠Ïù¥ ÏûàÏúºÎ©¥ ÎßàÏßÄÎßâ Ï†ÄÏû• ÏãúÎèÑ
                if (currentUserType === 'admin' && hasUnsavedChanges) {
                    try {
                        console.log('ÌéòÏù¥ÏßÄ Ï¢ÖÎ£å Ï†Ñ ÎßàÏßÄÎßâ Ï†ÄÏû• ÏãúÎèÑ');
                        await safeAutoSave();
                    } catch (error) {
                        console.error('Ï¢ÖÎ£å Ï†Ñ Ï†ÄÏû• Ïã§Ìå®:', error);
                    }
                }
                
                // Ìé∏Ïßë Ï¢ÖÎ£å Î∏åÎ°úÎìúÏ∫êÏä§Ìä∏
                broadcastEditingStopped();
                
                // Ïò®ÎùºÏù∏ ÏÇ¨Ïö©ÏûêÏóêÏÑú Ï†úÍ±∞
                if (onlineUsersChannel) {
                    try {
                        await onlineUsersChannel.untrack();
                        onlineUsersChannel.unsubscribe();
                    } catch (error) {
                        // Ï†ïÎ¶¨ Ïã§Ìå® Î¨¥Ïãú
                    }
                }
                
                // Îç∞Ïù¥ÌÑ∞ Ï±ÑÎÑê Ï†ïÎ¶¨
                if (dataChannel) {
                    try {
                        dataChannel.unsubscribe();
                    } catch (error) {
                        // Ï†ïÎ¶¨ Ïã§Ìå® Î¨¥Ïãú
                    }
                }
            });
        });

        // Ìé∏Ïßë Í∞êÏßÄ ÏãúÏä§ÌÖú ÏÑ§Ï†ï
        function setupEditingDetection() {
            const editableElements = ['beforeContent', 'afterContent', 'workNotes'];
            let editingTimeout = null;
            
            editableElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    // Ìè¨Ïª§Ïä§ Ïãú Ìé∏Ïßë ÏãúÏûë
                    element.addEventListener('focus', () => {
                        if (currentUserType === 'admin' && !editingUser) {
                            console.log(`Ìé∏Ïßë ÏãúÏûë: ${id}`);
                            markEditingActivity();
                            broadcastEditingStarted();
                        }
                    });
                    
                    // ÏûÖÎ†• Ïãú Ìé∏Ïßë ÌôúÎèô Í∏∞Î°ù
                    element.addEventListener('input', () => {
                        if (currentUserType === 'admin') {
                            console.log(`Ìé∏Ïßë ÌôúÎèô: ${id}`, element.value.length, 'Í∏ÄÏûê');
                            markEditingActivity(); // Ìé∏Ïßë ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
                            
                            // Í∏∞Ï°¥ ÌÉÄÏù¥Î®∏ Ï∑®ÏÜå
                            if (editingTimeout) {
                                clearTimeout(editingTimeout);
                            }
                            
                            // 5Ï¥à ÌõÑ Ìé∏Ïßë Ï¢ÖÎ£å (ÏûÖÎ†•Ïù¥ Î©àÏ∂îÎ©¥)
                            editingTimeout = setTimeout(() => {
                                console.log('Ìé∏Ïßë ÌôúÎèô ÌÉÄÏûÑÏïÑÏõÉ');
                                broadcastEditingStopped();
                            }, 5000);
                        }
                    });
                    
                    // ÌÇ§ ÏûÖÎ†• Í∞êÏßÄ (Î∂ôÏó¨ÎÑ£Í∏∞, ÏÇ≠Ï†ú Îì±)
                    element.addEventListener('keydown', () => {
                        if (currentUserType === 'admin') {
                            markEditingActivity();
                        }
                    });
                    
                    // Î∂ôÏó¨ÎÑ£Í∏∞ Í∞êÏßÄ
                    element.addEventListener('paste', () => {
                        if (currentUserType === 'admin') {
                            console.log(`Î∂ôÏó¨ÎÑ£Í∏∞ Í∞êÏßÄ: ${id}`);
                            markEditingActivity();
                        }
                    });
                    
                    // Î∏îÎü¨ Ïãú Ìé∏Ïßë Ï¢ÖÎ£å (ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ)
                    element.addEventListener('blur', () => {
                        if (currentUserType === 'admin' && isEditing) {
                            setTimeout(() => {
                                // Îã§Î•∏ Ìé∏Ïßë Í∞ÄÎä•Ìïú ÏöîÏÜåÏóê Ìè¨Ïª§Ïä§Í∞Ä ÏóÜÏúºÎ©¥ Ìé∏Ïßë Ï¢ÖÎ£å
                                const focusedElement = document.activeElement;
                                if (!editableElements.includes(focusedElement.id)) {
                                    console.log('Ìé∏Ïßë Ï¢ÖÎ£å: Ìè¨Ïª§Ïä§ ÏïÑÏõÉ');
                                    broadcastEditingStopped();
                                }
                            }, 100);
                        }
                    });
                }
            });
            
            // Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìúÎèÑ Ìé∏Ïßë ÌôúÎèôÏúºÎ°ú Í∞ÑÏ£º
            const imageButtons = ['beforeImageBtn', 'afterImageBtn'];
            imageButtons.forEach(id => {
                const button = document.getElementById(id);
                if (button) {
                    button.addEventListener('click', () => {
                        if (currentUserType === 'admin') {
                            console.log(`Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú ÏãúÏûë: ${id}`);
                            markEditingActivity();
                        }
                    });
                }
            });
        }
    </script>
</body>
</html>