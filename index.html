<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª©í¬ì‹œ í†µí•©ë„ì„œê´€ í™ˆí˜ì´ì§€ ê°œí¸ í˜„í™© ê´€ë¦¬</title>
    
    <!-- Supabase JavaScript Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #8d6e63 0%, #5d4037 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .login-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 450px;
            width: 90%;
            text-align: center;
        }

        .login-header h2 {
            color: #8d6e63;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .login-header p {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .login-tabs {
            display: flex;
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
        }

        .login-tab {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .login-tab.active {
            background: #8d6e63;
            color: white;
        }

        .login-form .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .login-form label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .login-form input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .login-form input:focus {
            outline: none;
            border-color: #8d6e63;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #8d6e63, #a1887f);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(141, 110, 99, 0.3);
        }

        .login-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #8d6e63;
        }

        .login-info p {
            margin: 5px 0;
            font-size: 12px;
            color: #666;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #f5f3f0 0%, #e8e2db 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.08);
            border: 1px solid #d7ccc8;
        }

        .mokpo-header {
            background: rgba(139, 115, 85, 0.95);
            color: white;
            padding: 15px 30px;
            margin: -30px -30px 20px -30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .mokpo-header .logo {
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mokpo-header .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }

        .user-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .user-badge.admin {
            background: #28a745;
            color: white;
        }

        .user-badge.viewer {
            background: #17a2b8;
            color: white;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #8d6e63;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin: 0;
        }

        .status-indicator-inline {
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .status-indicator-inline:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .status-indicator-inline.clickable {
            cursor: pointer;
            user-select: none;
        }

        .status-indicator-inline.clickable:hover {
            background: linear-gradient(45deg, #20c997, #17a2b8);
        }

        .status-indicator-inline.clickable:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .readonly-notice {
            background: linear-gradient(45deg, #17a2b8, #20c997);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            display: none;
            line-height: 1.6;
        }

        .editing-indicator {
            background: linear-gradient(45deg, #ff9800, #f57c00);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            animation: pulse 2s infinite;
        }

        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(40, 167, 69, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1000;
            display: none;
            backdrop-filter: blur(10px);
        }

        .conflict-warning {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            display: none;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1px;
            background: #e9ecef;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }

        .menu-column {
            background: white;
            min-height: 400px;
        }

        .menu-header {
            background: linear-gradient(45deg, #8d6e63, #a1887f);
            color: white;
            padding: 15px 12px;
            font-weight: 700;
            font-size: 16px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .menu-header:hover {
            background: linear-gradient(45deg, #6d4c41, #8d6e63);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .menu-header.active {
            background: linear-gradient(45deg, #4caf50, #66bb6a);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .menu-header::after {
            content: "ğŸ“‚";
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
        }

        .menu-header.active::after {
            content: "ğŸ“‚âœ…";
        }

        .menu-item {
            padding: 10px 12px;
            border-bottom: 1px solid #f8f9fa;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
            color: #333;
            text-align: center;
            position: relative;
        }

        .menu-item:hover {
            background: #f8f9fa;
            color: #8d6e63;
            font-weight: 600;
            transform: translateX(3px);
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item.page-exists {
            background: linear-gradient(45deg, rgba(141, 110, 99, 0.1), rgba(161, 136, 127, 0.1));
            border-left: 3px solid #8d6e63;
        }

        .menu-item.page-completed {
            background: linear-gradient(45deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.1));
            border-left: 3px solid #28a745;
        }

        .menu-item.page-completed::after {
            content: "âœ“";
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: #28a745;
            font-weight: bold;
        }

        .menu-item.current-page {
            background: linear-gradient(45deg, rgba(63, 81, 181, 0.15), rgba(63, 81, 181, 0.15));
            border-left: 4px solid #3f51b5;
            font-weight: 700;
            color: #3f51b5;
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(63, 81, 181, 0.2);
        }

        .menu-item.current-page::before {
            content: "ğŸ‘ï¸";
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
        }

        .page-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .nav-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
            color: #333;
        }

        .nav-btn:hover:not(:disabled) {
            background: #8d6e63;
            color: white;
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .page-counter {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            flex-wrap: wrap;
        }

        .page-selector {
            padding: 8px 12px;
            border: 2px solid #8d6e63;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            background: white;
            color: #8d6e63;
            min-width: 140px;
        }

        .page-selector:disabled {
            background: #f8f9fa;
            color: #6c757d;
            border-color: #dee2e6;
            cursor: not-allowed;
        }

        .page-title {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(45deg, #8d6e63, #a1887f);
            color: white;
            border-radius: 10px;
            font-size: 20px;
            font-weight: 600;
        }

        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .comparison-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            min-height: 600px;
            display: flex;
            flex-direction: column;
        }

        .comparison-panel:hover {
            transform: translateY(-5px);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
            flex-shrink: 0;
        }

        .before-header {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .after-header {
            background: linear-gradient(45deg, #4ecdc4, #44bd32);
            color: white;
        }

        .panel-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .image-btn {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .image-container {
            margin-bottom: 15px;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: white;
            min-height: 300px;
            max-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            flex: 2;
            overflow: hidden;
        }

        .image-placeholder {
            text-align: center;
            color: #6c757d;
            font-size: 14px;
        }

        .uploaded-image {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            object-fit: contain;
        }

        .image-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: none;
        }

        .image-container:hover .image-controls {
            display: block;
        }

        .image-controls button {
            background: rgba(220, 53, 69, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 14px;
            cursor: pointer;
            margin-left: 5px;
        }

        .content-area {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            background: #f8f9fa;
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .content-area textarea {
            width: 100%;
            height: 100%;
            min-height: 150px;
            border: none;
            background: transparent;
            resize: none;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.6;
            flex: 1;
        }

        .content-area textarea:focus {
            outline: none;
        }

        .content-area textarea:disabled {
            background: #f8f9fa;
            color: #6c757d;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #8d6e63, #a1887f);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(141, 110, 99, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #dee2e6;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c82333;
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .progress-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .progress-bar {
            background: #e9ecef;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #8d6e63, #a1887f);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .project-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .info-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .info-item strong {
            display: block;
            color: #8d6e63;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .info-item span {
            color: #333;
            font-size: 16px;
            font-weight: 600;
        }

        .notes-section {
            margin-top: 30px;
            padding: 20px;
            background: #fff3cd;
            border-radius: 10px;
            border-left: 5px solid #ffc107;
        }

        .notes-section h4 {
            color: #856404;
            margin-bottom: 15px;
        }

        .notes-section textarea {
            width: 100%;
            padding: 15px;
            border: 1px solid #ffd700;
            border-radius: 8px;
            background: white;
            min-height: 120px;
            font-family: inherit;
        }

        .notes-section textarea:disabled {
            background: #f8f9fa;
            color: #6c757d;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }

        .modal-content.large {
            max-width: 900px;
            margin: 5% auto;
            text-align: left;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .modal-title.save {
            color: #28a745;
        }

        .modal-message {
            color: #333;
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 25px;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        .modal-btn-ok {
            background: #28a745;
            color: white;
        }

        .modal-btn-ok:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .backup-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #e8f5e8;
            border-radius: 15px;
            border-left: 5px solid #28a745;
        }

        .backup-section h4 {
            color: #155724;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .backup-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .backup-btn {
            padding: 12px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .backup-btn:hover:not(:disabled) {
            background: #218838;
            transform: translateY(-2px);
        }

        .backup-btn.secondary {
            background: #17a2b8;
        }

        .backup-btn.secondary:hover:not(:disabled) {
            background: #138496;
        }

        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            display: none;
        }

        .menu-editor {
            max-height: 600px;
            overflow-y: auto;
        }

        .category-editor {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            margin-bottom: 20px;
            background: white;
        }

        .category-header {
            background: linear-gradient(45deg, #8d6e63, #a1887f);
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-title {
            font-weight: 600;
            font-size: 16px;
        }

        .category-controls {
            display: flex;
            gap: 10px;
        }

        .small-btn {
            padding: 5px 10px;
            font-size: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .small-btn.edit {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .small-btn.delete {
            background: #dc3545;
            color: white;
        }

        .small-btn:hover {
            transform: scale(1.05);
        }

        .menu-items-list {
            padding: 20px;
        }

        .menu-item-editor {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .menu-item-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 14px;
        }

        .menu-item-editor .small-btn {
            min-width: 60px;
        }

        .add-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            background: #e8f5e8;
            border-radius: 8px;
            border: 2px dashed #28a745;
        }

        .add-category-section {
            margin-top: 30px;
            padding: 20px;
            background: #fff3cd;
            border-radius: 10px;
            border: 2px dashed #ffc107;
        }

        .editor-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }

        @media (max-width: 1200px) {
            .menu-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .comparison-container {
                grid-template-columns: 1fr;
            }
            
            .menu-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .page-navigation {
                flex-direction: column;
                gap: 10px;
            }
            
            .project-info {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 15px;
            }

            .header h1 {
                font-size: 24px;
            }

            .status-indicator-inline {
                font-size: 11px;
                padding: 8px 12px;
            }

            /* ëª¨ë°”ì¼ì—ì„œ ì ‘ì†ì ìˆ˜ í‘œì‹œ ê°„ì†Œí™” */
            #onlineUsersCount span:nth-child(3) {
                display: none; /* "ëª… ì ‘ì†" í…ìŠ¤íŠ¸ ìˆ¨ê¹€ */
            }
        }

        @media (max-width: 480px) {
            .menu-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginScreen" class="login-overlay" style="display: none;">
        <div class="login-container">
            <div class="login-header">
                <h2>ğŸ›ï¸ ëª©í¬ì‹œ í†µí•©ë„ì„œê´€</h2>
                <p>í™ˆí˜ì´ì§€ ê°œí¸ í˜„í™© ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
            </div>
            
            <div class="login-tabs">
                <button class="login-tab active" onclick="switchTab('admin')">ë‹´ë‹¹ê³µë¬´ì›</button>
                <button class="login-tab" onclick="switchTab('viewer')">ì—…ì²´ ë‹´ë‹¹ì</button>
            </div>
            
            <div class="login-form">
                <div class="form-group">
                    <label id="loginLabel">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="loginInput" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                
                <div class="form-group" style="text-align: left;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; color: #666;">
                        <input type="checkbox" id="rememberLogin" checked style="margin: 0;">
                        ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€ (24ì‹œê°„)
                    </label>
                </div>
                
                <button class="login-btn" onclick="attemptLogin()">ğŸ”“ ì ‘ì†í•˜ê¸°</button>
                <div class="login-info">
                    <p id="loginInfoText">ğŸ’¡ ë‹´ë‹¹ê³µë¬´ì›ì€ ëª¨ë“  ë‚´ìš©ì„ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                    <p>ğŸ”’ ëª¨ë“  ë°ì´í„°ëŠ” ì•ˆì „í•˜ê²Œ ì €ì¥ë©ë‹ˆë‹¤</p>
                    <p>ğŸ” ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€ ì‹œ ìƒˆë¡œê³ ì¹¨í•´ë„ ìë™ ë¡œê·¸ì¸ë©ë‹ˆë‹¤</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="mainContent" style="display: none;">
        <div class="mokpo-header">
            <div class="logo">
                ğŸ›ï¸ ëª©í¬ì‹œí†µí•©ë„ì„œê´€ MOKPO CITY LIBRARY
            </div>
            <div class="user-info">
                <span class="user-badge" id="userBadge">ê´€ë¦¬ì</span>
                <span id="userName">ë‹´ë‹¹ê³µë¬´ì›</span>
                <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
        
        <div class="header">
            <h1>ğŸ›ï¸ ëª©í¬ì‹œ í†µí•©ë„ì„œê´€ í™ˆí˜ì´ì§€ ê°œí¸ í˜„í™© ê´€ë¦¬</h1>
            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                <div class="status-indicator-inline">
                    â˜ï¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...
                </div>
                <div id="onlineUsersCount" class="status-indicator-inline clickable" onclick="showOnlineUsersModal()" title="í´ë¦­í•˜ë©´ ì ‘ì†ì ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤">
                    <span style="display: flex; align-items: center; gap: 5px;">
                        <span style="width: 8px; height: 8px; background: white; border-radius: 50%; animation: pulse 2s infinite;"></span>
                        <span style="font-weight: 600;">1</span>
                        <span style="font-size: 11px;">ëª… ì ‘ì†</span>
                        <span style="font-size: 10px; opacity: 0.8;">â—</span>
                    </span>
                </div>
                <button class="btn btn-secondary" onclick="console.log('Backup clicked!'); if(currentUserType === 'admin') { downloadBackup(); } else { alert('ê´€ë¦¬ìë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.'); }" id="downloadBackupBtn" style="padding: 8px 15px; font-size: 12px;">
                    ğŸ“¥ ë°±ì—… ë‹¤ìš´ë¡œë“œ
                </button>
            </div>
        </div>

        <div class="readonly-notice" id="readonlyNotice">
            ğŸ“– í˜„ì¬ <strong>ì½ê¸° ì „ìš© ëª¨ë“œ</strong>ì…ë‹ˆë‹¤. ì§„í–‰ ìƒí™©ì„ í™•ì¸í•  ìˆ˜ ìˆì§€ë§Œ í¸ì§‘ì€ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
        </div>

        <div class="editing-indicator" id="editingIndicator" style="display: none;">
            âœï¸ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ í¸ì§‘ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
        </div>

        <div class="conflict-warning" id="conflictWarning" style="display: none;">
            âš ï¸ ë°ì´í„° ì¶©ëŒì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ìµœì‹  ë°ì´í„°ë¥¼ í™•ì¸í•˜ì„¸ìš”.
        </div>

        <div style="margin-bottom: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="color: #8B7355; margin: 0; text-align: center; flex: 1;">ğŸ“‹ ëª©í¬ì‹œí†µí•©ë„ì„œê´€ ì£¼ìš” ë©”ë‰´ êµ¬ì¡°</h4>
                <button class="btn btn-primary" onclick="openMenuEditor()" id="menuEditBtn" style="display: none;">âš™ï¸ ë©”ë‰´ í¸ì§‘</button>
            </div>
            
            <div class="menu-grid" id="menuGrid">
                <!-- ë©”ë‰´ê°€ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
            
            <div style="background: linear-gradient(45deg, #495057, #6c757d); color: white; padding: 15px; margin-top: 15px; border-radius: 8px; font-size: 14px; text-align: center;">
                <strong>ğŸ“Œ ê°œí¸ ë°©í–¥:</strong> ëª©í¬ì‹œí†µí•©ë„ì„œê´€ì˜ ê¸°ì¡´ ë©”ë‰´ êµ¬ì¡°ë¥¼ ê¹”ë”í•˜ê²Œ ì •ë¦¬í•˜ì—¬ ì‚¬ìš©ìê°€ ì‰½ê²Œ ì°¾ì„ ìˆ˜ ìˆë„ë¡ ê°œí¸<br>
                <strong>ğŸ’¡ ì‚¬ìš©ë²•:</strong> ê° ë©”ë‰´ë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ í˜ì´ì§€ë¡œ ì´ë™í•˜ê³  ê°œí¸ í˜„í™©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
            </div>
        </div>

        <div class="page-navigation">
            <button class="nav-btn" id="prevBtn" onclick="previousPage()">â—€ ì´ì „</button>
            <div class="page-counter">
                <span id="currentPageNum">1</span> / <span id="totalPageNum">6</span>
                
                <!-- ëŒ€ë©”ë‰´ ì„ íƒ -->
                <select class="page-selector" id="categorySelector" onchange="onCategoryChange(this.value)">
                    <option value="">ğŸ“‚ ëŒ€ë©”ë‰´ ì„ íƒ</option>
                    <!-- ì˜µì…˜ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </select>
                
                <!-- ì†Œë©”ë‰´ ì„ íƒ -->
                <select class="page-selector" id="pageSelector" onchange="goToPage(this.value)" disabled>
                    <option value="">ğŸ“„ ì†Œë©”ë‰´ ì„ íƒ</option>
                    <!-- ì˜µì…˜ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </select>
            </div>
            <button class="nav-btn" id="nextBtn" onclick="nextPage()">ë‹¤ìŒ â–¶</button>
        </div>

        <div class="page-title" id="pageTitle">
            ë©”ì¸ í˜ì´ì§€
        </div>

        <div class="comparison-container">
            <div class="comparison-panel">
                <div class="panel-header before-header">
                    <h3>ğŸ“‹ ê°œí¸ ì „ (í˜„ì¬ ìƒíƒœ)</h3>
                    <button class="image-btn" onclick="uploadBeforeImage()" id="beforeImageBtn">ğŸ“· ì´ë¯¸ì§€ ì—…ë¡œë“œ</button>
                </div>
                <div class="image-container" id="beforeImageContainer">
                    <div class="image-placeholder">
                        í˜„ì¬ í™”ë©´ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”
                    </div>
                    <div class="image-controls">
                        <button onclick="removeBeforeImage()">Ã—</button>
                    </div>
                </div>
                <div class="content-area">
                    <textarea id="beforeContent" placeholder="í˜„ì¬ í˜ì´ì§€ì˜ ë¬¸ì œì ê³¼ ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„ì„ ì‘ì„±í•˜ì„¸ìš”..."></textarea>
                </div>
            </div>

            <div class="comparison-panel">
                <div class="panel-header after-header">
                    <h3>âœ… ê°œí¸ í›„ (ëª©í‘œ ìƒíƒœ)</h3>
                    <button class="image-btn" onclick="uploadAfterImage()" id="afterImageBtn">ğŸ“· ì´ë¯¸ì§€ ì—…ë¡œë“œ</button>
                </div>
                <div class="image-container" id="afterImageContainer">
                    <div class="image-placeholder">
                        ëª©í‘œ í™”ë©´ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”
                    </div>
                    <div class="image-controls">
                        <button onclick="removeAfterImage()">Ã—</button>
                    </div>
                </div>
                <div class="content-area">
                    <textarea id="afterContent" placeholder="ìš¸ì£¼í†µí•©ë„ì„œê´€ì„ ì°¸ê³ í•œ ê°œí¸ ëª©í‘œì™€ ì™„ë£Œ ì‚¬í•­ì„ ì‘ì„±í•˜ì„¸ìš”..."></textarea>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="savePage()" id="saveBtn">ğŸ’¾ í˜„ì¬ í˜ì´ì§€ ì €ì¥</button>
        </div>

        <div class="notes-section">
            <h4>ğŸ“ ì—…ë¬´ ì§€ì‹œì‚¬í•­ ë° ë©”ëª¨</h4>
            <textarea id="workNotes" placeholder="ì—…ì²´ì— ì „ë‹¬í•  ì—…ë¬´ ì§€ì‹œì‚¬í•­ì´ë‚˜ ì¤‘ìš”í•œ ë©”ëª¨ë¥¼ ì‘ì„±í•˜ì„¸ìš”...

ì˜ˆì‹œ:
- 3ë¶„ê¸° ì™„ë£Œ ì˜ˆì • í•­ëª©: í”„ë¡œê·¸ë¨ ì‹ ì²­ í˜ì´ì§€, í¬ë§ë„ì„œ ì‹ ì²­ í˜ì´ì§€
- 4ë¶„ê¸° ìš°ì„  ì§„í–‰ í•­ëª©: ì „ì²´ ê²Œì‹œíŒ ì‹œìŠ¤í…œ ê°œí¸
- ìš¸ì£¼í†µí•©ë„ì„œê´€ ì°¸ê³  í¬ì¸íŠ¸: ê¹”ë”í•œ ë„¤ë¹„ê²Œì´ì…˜, ì§ê´€ì ì¸ ê²€ìƒ‰ UI
- ë©”ì¸ í˜ì´ì§€ ê°œí¸ ì™„ë£Œ - ë‚˜ë¨¸ì§€ ì„¸ë¶€ í˜ì´ì§€ ê°œí¸ ìš°ì„  ì§„í–‰ í•„ìš”"></textarea>
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn btn-primary" onclick="saveWorkNotes()" id="saveNotesBtn">ğŸ’¾ ì—…ë¬´ ì§€ì‹œì‚¬í•­ ì €ì¥</button>
            </div>
        </div>

        <div class="progress-section">
            <h4>ğŸ“ˆ ì „ì²´ ì§„í–‰ë¥ </h4>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 16.7%"></div>
            </div>
            <p id="progressText">16.7% ì™„ë£Œ (1/6 í˜ì´ì§€)</p>
        </div>

        <div class="project-info">
            <div class="info-item">
                <strong>í˜„ì¬ ë¶„ê¸°</strong>
                <span>3ë¶„ê¸° ì§„í–‰ ì¤‘</span>
            </div>
            <div class="info-item">
                <strong>ë²¤ì¹˜ë§ˆí‚¹ ì‚¬ì´íŠ¸</strong>
                <span>ìš¸ì£¼í†µí•©ë„ì„œê´€</span>
            </div>
            <div class="info-item">
                <strong>ì „ì²´ í˜ì´ì§€</strong>
                <span id="totalPages">6ê°œ</span>
            </div>
            <div class="info-item">
                <strong>ì™„ë£Œ í˜ì´ì§€</strong>
                <span id="completedPages">1ê°œ</span>
            </div>
        </div>
    </div>

    <!-- ë™ê¸°í™” ìƒíƒœ í‘œì‹œ -->
    <div class="sync-indicator" id="syncIndicator">
        ğŸ”„ ë™ê¸°í™” ì¤‘...
    </div>

    <!-- ì €ì¥ ì™„ë£Œ ëª¨ë‹¬ -->
    <div id="saveModal" class="modal">
        <div class="modal-content">
            <div class="modal-title save">âœ… ì €ì¥ ì™„ë£Œ</div>
            <div class="modal-message" id="saveMessage">
                ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-ok" onclick="closeSaveModal()">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- ë©”ë‰´ í¸ì§‘ ëª¨ë‹¬ -->
    <div id="menuEditorModal" class="modal">
        <div class="modal-content large">
            <div class="modal-title" style="text-align: center; margin-bottom: 20px; color: #8d6e63;">
                âš™ï¸ ë©”ë‰´ êµ¬ì¡° í¸ì§‘
            </div>
            
            <div class="menu-editor" id="menuEditor">
                <!-- ë©”ë‰´ í¸ì§‘ ë‚´ìš©ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
            
            <div class="add-category-section">
                <h4 style="color: #856404; margin-bottom: 15px;">â• ìƒˆ ëŒ€ë©”ë‰´ ì¶”ê°€</h4>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="newCategoryName" placeholder="ìƒˆ ëŒ€ë©”ë‰´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" 
                           style="flex: 1; padding: 10px; border: 1px solid #ffd700; border-radius: 5px;">
                    <button class="btn btn-primary" onclick="addNewCategory()">ì¶”ê°€</button>
                </div>
            </div>
            
            <div class="editor-buttons">
                <button class="btn btn-primary" onclick="saveMenuStructure()">ğŸ’¾ ì €ì¥</button>
                <button class="btn btn-secondary" onclick="closeMenuEditor()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== SUPABASE ì„¤ì • ====================
        // ğŸ”§ Supabase í”„ë¡œì íŠ¸ ì„¤ì • (ì‚¬ìš©ìê°€ ë³€ê²½í•´ì•¼ í•¨)
        // 
        // ğŸ“ ì„¤ì • ë°©ë²•:
        // 1. https://supabase.com ì—ì„œ ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±
        // 2. í”„ë¡œì íŠ¸ ëŒ€ì‹œë³´ë“œì—ì„œ Settings > API ë©”ë‰´ë¡œ ì´ë™
        // 3. ì•„ë˜ ê°’ë“¤ì„ ë³µì‚¬í•˜ì—¬ êµì²´:
        //    - Project URL â†’ SUPABASE_URL
        //    - anon public key â†’ SUPABASE_ANON_KEY
        // 4. SQL Editorì—ì„œ í…Œì´ë¸” ìƒì„± (ì•± ì‹¤í–‰ ì‹œ ì•ˆë‚´ í‘œì‹œë¨)
        // 5. í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        //
        // âš ï¸ ì£¼ì˜: ì‹¤ì œ í”„ë¡œì íŠ¸ì—ì„œëŠ” RLS(Row Level Security) ì„¤ì • ê¶Œì¥
        //
        const SUPABASE_URL = 'https://ifuixpcizqkyhubjsqmf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmdWl4cGNpenFreWh1YmpzcW1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxNDgyMzEsImV4cCI6MjA2ODcyNDIzMX0.iyPP4G2R8FsxXriYyxIVDGrS76K1Nt6p1kaaxF9nd6M';

        // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
        let supabase = null;
        let isSupabaseReady = false;
        let onlineUsersChannel = null; // ì‹¤ì‹œê°„ ì ‘ì†ì ì±„ë„
        let dataChannel = null; // ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™” ì±„ë„
        let currentOnlineCount = 1; // í˜„ì¬ ì ‘ì†ì ìˆ˜ (ê¸°ë³¸ê°’: ìê¸° ìì‹ )
        let onlineUsers = new Set(); // ì ‘ì† ì¤‘ì¸ ì‚¬ìš©ìë“¤
        let isEditing = false; // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ì§€ ì—¬ë¶€
        let editingUser = null; // í¸ì§‘ ì¤‘ì¸ ì‚¬ìš©ì ì •ë³´
        let lastDataVersion = null; // ë§ˆì§€ë§‰ ë°ì´í„° ë²„ì „
        let isReceivingUpdate = false; // ì™¸ë¶€ ì—…ë°ì´íŠ¸ ìˆ˜ì‹  ì¤‘ì¸ì§€ ì—¬ë¶€

        // Supabase ì´ˆê¸°í™” í•¨ìˆ˜
        function initializeSupabase() {
            try {
                if (SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY_HERE') {
                    // Supabase ì„¤ì •ì´ ì•ˆëœ ê²½ìš° localStorage ì‚¬ìš©
                    isSupabaseReady = false;
                    initializeLocalOnlineCount(); // ë¡œì»¬ ì‹œë®¬ë ˆì´ì…˜
                    return false;
                }
                
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                isSupabaseReady = true;
                
                // ì—°ê²° í…ŒìŠ¤íŠ¸
                testSupabaseConnection();
                
                // ì‹¤ì‹œê°„ ì ‘ì†ì ìˆ˜ ì´ˆê¸°í™”
                initializeOnlineUsers();
                
                return true;
            } catch (error) {
                isSupabaseReady = false;
                initializeLocalOnlineCount(); // ë¡œì»¬ ì‹œë®¬ë ˆì´ì…˜
                return false;
            }
        }

        // ì‹¤ì‹œê°„ ì ‘ì†ì ê´€ë¦¬ (Supabase Realtime)
        function initializeOnlineUsers() {
            if (!supabase) return;
            
            try {
                // ê³ ìœ í•œ ì‚¬ìš©ì ID ìƒì„±
                const userId = generateUserId();
                
                // Realtime ì±„ë„ ìƒì„±
                onlineUsersChannel = supabase.channel('online_users', {
                    config: {
                        presence: {
                            key: userId
                        }
                    }
                });

                // ì ‘ì†ì ìƒíƒœ ë³€í™” ê°ì§€
                onlineUsersChannel
                    .on('presence', { event: 'sync' }, () => {
                        const presenceState = onlineUsersChannel.presenceState();
                        const users = Object.keys(presenceState);
                        currentOnlineCount = users.length;
                        
                        // ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
                        onlineUsers.clear();
                        users.forEach(userId => {
                            const userData = presenceState[userId][0];
                            onlineUsers.add(userData);
                        });
                        
                        updateOnlineCountDisplay();
                    })
                    .on('presence', { event: 'join' }, ({ newPresences }) => {
                        // ìƒˆ ì‚¬ìš©ì ì ‘ì†
                        updateOnlineCountDisplay();
                    })
                    .on('presence', { event: 'leave' }, ({ leftPresences }) => {
                        // ì‚¬ìš©ì í‡´ì¥
                        updateOnlineCountDisplay();
                    });

                // ì±„ë„ êµ¬ë… ë° ìì‹ ì˜ presence ë“±ë¡
                onlineUsersChannel.subscribe(async (status) => {
                    if (status === 'SUBSCRIBED') {
                        // ìì‹ ì˜ ì •ë³´ë¥¼ presenceì— ë“±ë¡
                        await onlineUsersChannel.track({
                            userId: userId,
                            userType: currentUserType || 'guest',
                            joinedAt: new Date().toISOString(),
                            lastSeen: new Date().toISOString(),
                            userAgent: navigator.userAgent.substring(0, 100) // ê°„ë‹¨í•œ ë¸Œë¼ìš°ì € ì •ë³´
                        });
                    }
                });

            } catch (error) {
                // Realtime ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ì‹œë®¬ë ˆì´ì…˜
                initializeLocalOnlineCount();
            }
        }

        // ê³ ìœ í•œ ì‚¬ìš©ì ID ìƒì„±
        function generateUserId() {
            // ê¸°ì¡´ IDê°€ ìˆìœ¼ë©´ ì¬ì‚¬ìš©, ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
            let userId = localStorage.getItem('mokpo_user_id');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('mokpo_user_id', userId);
            }
            return userId;
        }

        // ë¡œì»¬ ì ‘ì†ì ìˆ˜ ì‹œë®¬ë ˆì´ì…˜ (Supabase ì—°ê²° ì‹¤íŒ¨ ì‹œ)
        function initializeLocalOnlineCount() {
            // ì‹¤ì œ ì‹¤ì‹œê°„ì€ ì•„ë‹ˆì§€ë§Œ ë™ì ì¸ ëŠë‚Œì„ ì£¼ê¸° ìœ„í•œ ì‹œë®¬ë ˆì´ì…˜
            currentOnlineCount = Math.floor(Math.random() * 3) + 1; // 1-3ëª… ì‚¬ì´
            updateOnlineCountDisplay();
            
            // ì£¼ê¸°ì ìœ¼ë¡œ ì•½ê°„ì”© ë³€í™” (ì‹¤ì œ ì‚¬ìš©ìê°€ ìˆëŠ” ê²ƒì²˜ëŸ¼)
            setInterval(() => {
                const change = Math.random() - 0.5; // -0.5 ~ 0.5
                if (Math.random() < 0.3) { // 30% í™•ë¥ ë¡œ ë³€í™”
                    currentOnlineCount = Math.max(1, Math.min(5, currentOnlineCount + (change > 0 ? 1 : -1)));
                    updateOnlineCountDisplay();
                }
            }, 45000); // 45ì´ˆë§ˆë‹¤ ì²´í¬
        }

        // ì ‘ì†ì ìˆ˜ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateOnlineCountDisplay() {
            const onlineIndicator = document.getElementById('onlineUsersCount');
            if (onlineIndicator) {
                const isRealtime = isSupabaseReady && onlineUsersChannel;
                onlineIndicator.innerHTML = `
                    <span style="display: flex; align-items: center; gap: 5px;">
                        <span style="width: 8px; height: 8px; background: #28a745; border-radius: 50%; animation: pulse 2s infinite;"></span>
                        <span style="font-weight: 600;">${currentOnlineCount}</span>
                        <span style="font-size: 11px;">${currentOnlineCount === 1 ? 'ëª… ì ‘ì†' : 'ëª… ì ‘ì†'}</span>
                        ${isRealtime ? 
                            '<span style="font-size: 10px; color: #28a745;">â—</span>' : 
                            '<span style="font-size: 10px; color: #ffc107;">â—</span>'
                        }
                    </span>
                `;
                
                // í„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
                if (!document.getElementById('pulse-animation')) {
                    const style = document.createElement('style');
                    style.id = 'pulse-animation';
                    style.textContent = `
                        @keyframes pulse {
                            0% { opacity: 1; transform: scale(1); }
                            50% { opacity: 0.7; transform: scale(1.1); }
                            100% { opacity: 1; transform: scale(1); }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }
        }

        // ì ‘ì†ì ìƒì„¸ ì •ë³´ ëª¨ë‹¬
        function showOnlineUsersModal() {
            if (!currentUserType) {
                alert('ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '9999';
            
            const usersList = Array.from(onlineUsers).map((user, index) => {
                const userType = user.userType === 'admin' ? 'ğŸ‘” ê´€ë¦¬ì' : 
                               user.userType === 'viewer' ? 'ğŸ‘¨â€ğŸ’¼ ì—…ì²´' : 'ğŸ‘¤ ê²ŒìŠ¤íŠ¸';
                const joinTime = new Date(user.joinedAt).toLocaleTimeString('ko-KR');
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px;">
                        <div>
                            <span style="font-weight: 600;">${userType}</span>
                            <div style="font-size: 12px; color: #666;">ì ‘ì† ì‹œê°„: ${joinTime}</div>
                        </div>
                        <span style="width: 8px; height: 8px; background: #28a745; border-radius: 50%;"></span>
                    </div>
                `;
            }).join('');
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-title" style="color: #28a745; margin-bottom: 20px; text-align: center;">
                        ğŸ‘¥ í˜„ì¬ ì ‘ì†ì í˜„í™©
                    </div>
                    <div style="margin-bottom: 20px;">
                        <div style="text-align: center; padding: 15px; background: #e8f5e8; border-radius: 10px; margin-bottom: 20px;">
                            <span style="font-size: 24px; font-weight: bold; color: #28a745;">${currentOnlineCount}ëª…</span>
                            <div style="font-size: 14px; color: #666; margin-top: 5px;">
                                ${isSupabaseReady ? 'ğŸ“¡ ì‹¤ì‹œê°„ ì—°ê²°ë¨' : 'ğŸ’¾ ë¡œì»¬ ëª¨ë“œ'}
                            </div>
                        </div>
                        ${onlineUsers.size > 0 ? usersList : `
                            <div style="text-align: center; padding: 20px; color: #666;">
                                ${isSupabaseReady ? 'ì ‘ì†ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...' : 'ë¡œì»¬ ëª¨ë“œì—ì„œëŠ” ìƒì„¸ ì •ë³´ë¥¼ ì œê³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'}
                            </div>
                        `}
                    </div>
                    <div style="text-align: center;">
                        <button class="btn btn-primary" onclick="closeOnlineUsersModal()">
                            âœ–ï¸ ë‹«ê¸°
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            window.closeOnlineUsersModal = () => {
                modal.remove();
            };
            
            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™” ì´ˆê¸°í™”
        function initializeDataSync() {
            if (!supabase) return;
            
            try {
                // ë°ì´í„° ë™ê¸°í™” ì±„ë„ ìƒì„±
                dataChannel = supabase.channel('data_sync', {
                    config: {
                        broadcast: { self: false } // ìì‹ ì˜ ë¸Œë¡œë“œìºìŠ¤íŠ¸ëŠ” ë°›ì§€ ì•ŠìŒ
                    }
                });

                // ë°ì´í„° ë³€ê²½ ì•Œë¦¼ ìˆ˜ì‹ 
                dataChannel
                    .on('broadcast', { event: 'data_updated' }, (payload) => {
                        handleRemoteDataUpdate(payload.payload);
                    })
                    .on('broadcast', { event: 'editing_started' }, (payload) => {
                        handleEditingStarted(payload.payload);
                    })
                    .on('broadcast', { event: 'editing_stopped' }, (payload) => {
                        handleEditingStopped(payload.payload);
                    });

                // ì±„ë„ êµ¬ë…
                dataChannel.subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        // êµ¬ë… ì„±ê³µ
                        updateConnectionStatus('â˜ï¸ ì‹¤ì‹œê°„ ë™ê¸°í™” í™œì„±í™”');
                    }
                });

            } catch (error) {
                // ë™ê¸°í™” ì‹¤íŒ¨ ì‹œì—ë„ ê¸°ë³¸ ê¸°ëŠ¥ì€ ìœ ì§€
            }
        }

        // ì›ê²© ë°ì´í„° ì—…ë°ì´íŠ¸ ì²˜ë¦¬
        function handleRemoteDataUpdate(updateData) {
            if (isReceivingUpdate) return; // ì¤‘ë³µ ì—…ë°ì´íŠ¸ ë°©ì§€
            
            console.log('ì›ê²© ë°ì´í„° ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', updateData.sessionId);
            
            // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ì‚¬ìš©ìëŠ” ì›ê²© ì—…ë°ì´íŠ¸ë¥¼ ë¬´ì‹œ (ë°ì´í„° ì†ì‹¤ ë°©ì§€)
            if (isActivelyEditing && editingSessionId && updateData.sessionId !== editingSessionId) {
                console.log('í¸ì§‘ ì¤‘ì´ë¯€ë¡œ ì›ê²© ì—…ë°ì´íŠ¸ ë¬´ì‹œ');
                showUpdateConflictWarning(updateData);
                return;
            }
            
            isReceivingUpdate = true;
            
            try {
                // í˜„ì¬ í¸ì§‘ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ ì—…ë°ì´íŠ¸ ì ìš©
                if (!isEditing && !hasUnsavedChanges) {
                    if (updateData.pages) {
                        pages = updateData.pages;
                        initializePages();
                        updateAllDisplays();
                        renderMenuGrid();
                    }
                    
                    if (updateData.workNotes !== undefined) {
                        workNotes = updateData.workNotes;
                        const workNotesElement = document.getElementById('workNotes');
                        if (workNotesElement && document.activeElement !== workNotesElement) {
                            workNotesElement.value = workNotes;
                        }
                    }
                    
                    if (updateData.menuStructure) {
                        menuStructure = updateData.menuStructure;
                        renderMenuGrid();
                    }
                    
                    // ì—…ë°ì´íŠ¸ ì•Œë¦¼ í‘œì‹œ
                    showUpdateNotification(updateData.updatedBy);
                } else {
                    console.log('í¸ì§‘ ì¤‘ì´ë¯€ë¡œ ì—…ë°ì´íŠ¸ ì§€ì—°');
                    // í¸ì§‘ì´ ëë‚œ í›„ ì—…ë°ì´íŠ¸í•˜ë„ë¡ ì˜ˆì•½
                    scheduleDelayedUpdate(updateData);
                }
                
            } catch (error) {
                console.error('ì›ê²© ì—…ë°ì´íŠ¸ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
            } finally {
                isReceivingUpdate = false;
            }
        }

        // ì§€ì—°ëœ ì—…ë°ì´íŠ¸ ìŠ¤ì¼€ì¤„ë§
        function scheduleDelayedUpdate(updateData) {
            setTimeout(() => {
                if (!isActivelyEditing && !hasUnsavedChanges) {
                    console.log('ì§€ì—°ëœ ì—…ë°ì´íŠ¸ ì ìš©');
                    handleRemoteDataUpdate(updateData);
                } else {
                    // ì—¬ì „íˆ í¸ì§‘ ì¤‘ì´ë©´ ë‹¤ì‹œ ì§€ì—°
                    scheduleDelayedUpdate(updateData);
                }
            }, 5000); // 5ì´ˆ í›„ ë‹¤ì‹œ ì‹œë„
        }

        // ì—…ë°ì´íŠ¸ ì¶©ëŒ ê²½ê³ 
        function showUpdateConflictWarning(updateData) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 200px;
                right: 20px;
                background: linear-gradient(45deg, #ff9800, #f57c00);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 600;
                font-size: 13px;
                max-width: 300px;
                animation: slideInRight 0.3s ease;
            `;
            
            notification.innerHTML = `
                âš ï¸ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸í–ˆìŠµë‹ˆë‹¤<br>
                <small>í¸ì§‘ ì™„ë£Œ í›„ ìë™ìœ¼ë¡œ ë™ê¸°í™”ë©ë‹ˆë‹¤</small>
            `;
            
            document.body.appendChild(notification);
            
            // 10ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 10000);
        }

        // í¸ì§‘ ì‹œì‘ ì•Œë¦¼ ì²˜ë¦¬
        function handleEditingStarted(editData) {
            if (editData.userId !== generateUserId()) {
                editingUser = editData;
                showEditingNotification(editData);
                
                // í¸ì§‘ ë¶ˆê°€ ìƒíƒœë¡œ UI ì—…ë°ì´íŠ¸
                if (currentUserType === 'admin') {
                    setEditingDisabled(true, `${editData.userType === 'admin' ? 'ë‹¤ë¥¸ ê´€ë¦¬ì' : 'ë‹¤ë¥¸ ì‚¬ìš©ì'}ê°€ í¸ì§‘ ì¤‘ì…ë‹ˆë‹¤`);
                }
            }
        }

        // í¸ì§‘ ì¢…ë£Œ ì•Œë¦¼ ì²˜ë¦¬
        function handleEditingStopped(editData) {
            if (editData.userId !== generateUserId()) {
                editingUser = null;
                hideEditingNotification();
                
                // í¸ì§‘ ê°€ëŠ¥ ìƒíƒœë¡œ UI ë³µì›
                if (currentUserType === 'admin') {
                    setEditingDisabled(false);
                }
            }
        }

        // í¸ì§‘ í™œë™ ì¶”ì  í•¨ìˆ˜ë“¤
        function markEditingActivity() {
            lastEditTime = new Date().getTime();
            hasUnsavedChanges = true;
            isActivelyEditing = true;
            
            // í¸ì§‘ ì„¸ì…˜ ID ìƒì„± (ì¤‘ë³µ ì €ì¥ ë°©ì§€)
            if (!editingSessionId) {
                editingSessionId = generateUserId() + '_' + Date.now();
            }
            
            console.log('í¸ì§‘ í™œë™ ê°ì§€:', new Date().toLocaleTimeString());
        }

        function checkEditingActivity() {
            if (!lastEditTime) return false;
            
            const now = new Date().getTime();
            const timeSinceLastEdit = now - lastEditTime;
            
            // 5ë¶„ ì´ìƒ í¸ì§‘ í™œë™ì´ ì—†ìœ¼ë©´ ë¹„í™œì„±ìœ¼ë¡œ ê°„ì£¼
            if (timeSinceLastEdit > 5 * 60 * 1000) {
                isActivelyEditing = false;
                editingSessionId = null;
                return false;
            }
            
            return isActivelyEditing;
        }

        // í¸ì§‘ ì‹œì‘ ë¸Œë¡œë“œìºìŠ¤íŠ¸
        function broadcastEditingStarted() {
            if (dataChannel && currentUserType === 'admin') {
                markEditingActivity();
                
                dataChannel.send({
                    type: 'broadcast',
                    event: 'editing_started',
                    payload: {
                        userId: generateUserId(),
                        userType: currentUserType,
                        startTime: new Date().toISOString(),
                        sessionId: editingSessionId
                    }
                });
                isEditing = true;
            }
        }

        // í¸ì§‘ ì¢…ë£Œ ë¸Œë¡œë“œìºìŠ¤íŠ¸
        function broadcastEditingStopped() {
            if (dataChannel && isEditing) {
                dataChannel.send({
                    type: 'broadcast',
                    event: 'editing_stopped',
                    payload: {
                        userId: generateUserId(),
                        userType: currentUserType,
                        endTime: new Date().toISOString(),
                        sessionId: editingSessionId
                    }
                });
                isEditing = false;
                isActivelyEditing = false;
                editingSessionId = null;
            }
        }

        // ë°ì´í„° ë³€ê²½ ë¸Œë¡œë“œìºìŠ¤íŠ¸
        function broadcastDataUpdate() {
            if (dataChannel && currentUserType === 'admin' && editingSessionId) {
                console.log('ë°ì´í„° ë³€ê²½ ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì „ì†¡');
                dataChannel.send({
                    type: 'broadcast',
                    event: 'data_updated',
                    payload: {
                        pages: pages,
                        workNotes: workNotes,
                        menuStructure: menuStructure,
                        updatedBy: currentUserType,
                        userId: generateUserId(),
                        sessionId: editingSessionId,
                        timestamp: new Date().toISOString()
                    }
                });
            }
        }

        // ì—…ë°ì´íŠ¸ ì•Œë¦¼ í‘œì‹œ
        function showUpdateNotification(updatedBy) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: linear-gradient(45deg, #17a2b8, #20c997);
                color: white;
                padding: 12px 16px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 600;
                font-size: 13px;
                max-width: 280px;
                animation: slideInRight 0.3s ease;
            `;
            
            notification.innerHTML = `
                ğŸ”„ ë°ì´í„°ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤<br>
                <small>${updatedBy === 'admin' ? 'ê´€ë¦¬ì' : 'ë‹¤ë¥¸ ì‚¬ìš©ì'}ì— ì˜í•´ ë³€ê²½ë¨</small>
            `;
            
            document.body.appendChild(notification);
            
            // 4ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        // í¸ì§‘ ì¤‘ ì•Œë¦¼ í‘œì‹œ
        function showEditingNotification(editData) {
            // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
            hideEditingNotification();
            
            // ìƒë‹¨ í¸ì§‘ ì¸ë””ì¼€ì´í„° í‘œì‹œ
            const editingIndicator = document.getElementById('editingIndicator');
            if (editingIndicator) {
                editingIndicator.style.display = 'block';
                editingIndicator.innerHTML = `
                    âœï¸ ${editData.userType === 'admin' ? 'ë‹¤ë¥¸ ê´€ë¦¬ì' : 'ì—…ì²´ ë‹´ë‹¹ì'}ê°€ í¸ì§‘ ì¤‘ì…ë‹ˆë‹¤. 
                    <span style="font-size: 12px; opacity: 0.8;">ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</span>
                `;
            }
            
            // ìš°ì¸¡ ì•Œë¦¼
            const notification = document.createElement('div');
            notification.id = 'editingNotification';
            notification.style.cssText = `
                position: fixed;
                top: 140px;
                right: 20px;
                background: linear-gradient(45deg, #ff9800, #f57c00);
                color: white;
                padding: 12px 16px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 600;
                font-size: 13px;
                max-width: 280px;
                animation: slideInRight 0.3s ease;
            `;
            
            notification.innerHTML = `
                âœï¸ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ í¸ì§‘ ì¤‘ì…ë‹ˆë‹¤<br>
                <small>${editData.userType === 'admin' ? 'ê´€ë¦¬ì' : 'ì—…ì²´ ë‹´ë‹¹ì'}ê°€ ìˆ˜ì • ì¤‘...</small>
            `;
            
            document.body.appendChild(notification);
        }

        // í¸ì§‘ ì¤‘ ì•Œë¦¼ ìˆ¨ê¹€
        function hideEditingNotification() {
            // ìƒë‹¨ ì¸ë””ì¼€ì´í„° ìˆ¨ê¹€
            const editingIndicator = document.getElementById('editingIndicator');
            if (editingIndicator) {
                editingIndicator.style.display = 'none';
            }
            
            // ìš°ì¸¡ ì•Œë¦¼ ì œê±°
            const notification = document.getElementById('editingNotification');
            if (notification) {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }
        }

        // ë™ê¸°í™” ìƒíƒœ í‘œì‹œ
        function showSyncIndicator(message = 'ğŸ”„ ë™ê¸°í™” ì¤‘...') {
            const syncIndicator = document.getElementById('syncIndicator');
            if (syncIndicator) {
                syncIndicator.textContent = message;
                syncIndicator.style.display = 'block';
                
                // 2ì´ˆ í›„ ìë™ ìˆ¨ê¹€
                setTimeout(() => {
                    syncIndicator.style.display = 'none';
                }, 2000);
            }
        }

        // ì¶©ëŒ ê²½ê³  í‘œì‹œ
        function showConflictWarning() {
            const conflictWarning = document.getElementById('conflictWarning');
            if (conflictWarning) {
                conflictWarning.style.display = 'block';
                
                // 5ì´ˆ í›„ ìë™ ìˆ¨ê¹€
                setTimeout(() => {
                    conflictWarning.style.display = 'none';
                }, 5000);
            }
        }

        // í¸ì§‘ ë¶ˆê°€ ìƒíƒœ ì„¤ì •
        function setEditingDisabled(disabled, message = '') {
            const editableElements = ['beforeContent', 'afterContent', 'workNotes'];
            const editableButtons = ['saveBtn', 'saveNotesBtn', 'beforeImageBtn', 'afterImageBtn', 'menuEditBtn'];
            
            editableElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.disabled = disabled;
                    if (disabled) {
                        element.placeholder = message;
                        element.style.background = '#f8f9fa';
                        element.style.color = '#6c757d';
                    } else {
                        element.placeholder = '';
                        element.style.background = '';
                        element.style.color = '';
                    }
                }
            });
            
            editableButtons.forEach(id => {
                const button = document.getElementById(id);
                if (button) {
                    button.disabled = disabled;
                    if (disabled) {
                        button.title = message;
                    } else {
                        button.title = '';
                    }
                }
            });
        }

        // Supabase ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testSupabaseConnection() {
            try {
                const { data, error } = await supabase.from('mokpo_projects').select('id').limit(1);
                if (error && error.code === '42P01') {
                    // í…Œì´ë¸”ì´ ì—†ëŠ” ê²½ìš° ìƒì„± ì•ˆë‚´
                    showSupabaseSetupModal();
                }
            } catch (error) {
                // ì—°ê²° ì‹¤íŒ¨ ì‹œ localStorageë¡œ í´ë°±
                isSupabaseReady = false;
            }
        }

        // Supabase ì„¤ì • ì•ˆë‚´ ëª¨ë‹¬
        function showSupabaseSetupModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '9999';
            
            modal.innerHTML = `
                <div class="modal-content large">
                    <div class="modal-title" style="color: #4f46e5; margin-bottom: 20px; text-align: center;">
                        â˜ï¸ Supabase ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
                    </div>
                    <div style="margin-bottom: 20px; color: #666; line-height: 1.6;">
                        <p><strong>ğŸ”§ Supabaseì—ì„œ ë‹¤ìŒ SQLì„ ì‹¤í–‰í•˜ì—¬ í…Œì´ë¸”ì„ ìƒì„±í•˜ì„¸ìš”:</strong></p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <textarea readonly style="width: 100%; height: 300px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; font-family: monospace; font-size: 12px; background: #f8f9fa;">-- ëª©í¬ì‹œ ë„ì„œê´€ í”„ë¡œì íŠ¸ í…Œì´ë¸” ìƒì„±
CREATE TABLE mokpo_projects (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    project_name TEXT NOT NULL DEFAULT 'ëª©í¬ì‹œ í†µí•©ë„ì„œê´€ í™ˆí˜ì´ì§€ ê°œí¸',
    pages JSONB NOT NULL DEFAULT '[]',
    work_notes TEXT DEFAULT '',
    menu_structure JSONB NOT NULL DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- RLS (Row Level Security) í™œì„±í™” (ì„ íƒì‚¬í•­)
ALTER TABLE mokpo_projects ENABLE ROW LEVEL SECURITY;

-- ëª¨ë“  ì‚¬ìš©ìê°€ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥í•˜ë„ë¡ ì •ì±… ì„¤ì • (ê°œë°œìš©)
CREATE POLICY "Enable all access for mokpo_projects" ON mokpo_projects
    FOR ALL USING (true) WITH CHECK (true);</textarea>
                    </div>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
                        <h4 style="color: #856404; margin-bottom: 10px;">ğŸ“ ì„¤ì • ë°©ë²•</h4>
                        <ol style="color: #856404; font-size: 14px; margin: 0; padding-left: 20px;">
                            <li>Supabase ëŒ€ì‹œë³´ë“œì—ì„œ SQL Editorë¡œ ì´ë™</li>
                            <li>ìœ„ì˜ SQL ì½”ë“œë¥¼ ë³µì‚¬í•˜ì—¬ ì‹¤í–‰</li>
                            <li>ì†ŒìŠ¤ì½”ë“œì—ì„œ SUPABASE_URLê³¼ SUPABASE_ANON_KEY ìˆ˜ì •</li>
                            <li>í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨</li>
                        </ol>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn btn-primary" onclick="closeSetupModal(); location.reload();">
                            ğŸ”„ ì„¤ì • ì™„ë£Œ í›„ ìƒˆë¡œê³ ì¹¨
                        </button>
                        <button class="btn btn-secondary" onclick="closeSetupModal();" style="margin-left: 10px;">
                            ğŸ’¾ ë¡œì»¬ ì €ì¥ì†Œ ì‚¬ìš©
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            window.closeSetupModal = () => {
                modal.remove();
            };
        }

        // ==================== ì „ì—­ ë³€ìˆ˜ ====================
        let currentUserType = null;
        let currentPageIndex = 0;
        let currentCategory = null; // í˜„ì¬ ì„ íƒëœ ëŒ€ë©”ë‰´
        let filteredPages = []; // í˜„ì¬ ì¹´í…Œê³ ë¦¬ì˜ í˜ì´ì§€ë“¤
        let workNotes = "";
        let pages = []; // ë¹ˆ ë°°ì—´ë¡œ ì‹œì‘ - initializePages()ì—ì„œ ì±„ì›Œì§
        
        // í¸ì§‘ í™œë™ ì¶”ì  ë³€ìˆ˜ë“¤
        let lastEditTime = null; // ë§ˆì§€ë§‰ í¸ì§‘ ì‹œê°„
        let hasUnsavedChanges = false; // ì €ì¥ë˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ ì—¬ë¶€
        let isActivelyEditing = false; // í˜„ì¬ í™œë°œíˆ í¸ì§‘ ì¤‘ì¸ì§€ ì—¬ë¶€
        let editingSessionId = null; // í¸ì§‘ ì„¸ì…˜ ID
        let menuStructure = {
            "ìë£Œê²€ìƒ‰": ["ì†Œì¥ìë£Œê²€ìƒ‰", "ëŒ€ì¶œí˜„í™©ì¡°íšŒ", "ì‹ ê°„ë„ì„œ", "ì¶”ì²œë„ì„œ", "ì „ìë„ì„œê´€"],
            "ì‹ ì²­Â·ì°¸ì—¬": ["í”„ë¡œê·¸ë¨ì‹ ì²­", "í¬ë§ë„ì„œì‹ ì²­", "ì§€ì—­ì„œì ë°”ë¡œëŒ€ì¶œ", "ì‹œì„¤ì´ìš©ì‹ ì²­", "ìì›ë´‰ì‚¬ì‹ ì²­"],
            "ë…ì„œÂ·ë¬¸í™”ë§ˆë‹¹": ["ì˜¬í•´ì˜ì±…", "ì´ë‹¬ì˜í–‰ì‚¬", "ì˜í™”ìƒì˜ì•ˆë‚´", "ë™ì•„ë¦¬ì•ˆë‚´"],
            "ë„ì„œê´€ì´ìš©": ["ì´ìš©ì•ˆë‚´", "ê³µì§€ì‚¬í•­", "ìì£¼í•˜ëŠ”ì§ˆë¬¸", "ì‚¬ì„œì—ê²Œë¬¼ì–´ë³´ì„¸ìš”", "ë„ì„œê´€ì—ë°”ë€ë‹¤"],
            "ë„ì„œê´€ì†Œê°œ": ["ì¸ì‚¬ë§", "ë„ì„œê´€ì—°í˜", "ì‹œì„¤í˜„í™©", "ì¸µë³„ì•ˆë‚´", "ì°¾ì•„ì˜¤ì‹œëŠ”ê¸¸"],
            "ì‘ì€ë„ì„œê´€": ["ì‘ì€ë„ì„œê´€í˜„í™©", "ì‘ì€ë„ì„œê´€ì†Œê°œ", "ì‘ì€ë„ì„œê´€ê³µì§€ì‚¬í•­", "ë¹„ëŒ€ë©´ë„ì„œëŒ€ì¶œ"]
        };
        function initializePages() {
            // í˜„ì¬ ë©”ë‰´ êµ¬ì¡°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í˜ì´ì§€ ë°ì´í„° ë™ê¸°í™”
            const allMenuItems = [];
            
            // ë©”ë‰´ êµ¬ì¡°ì—ì„œ ëª¨ë“  ì†Œë©”ë‰´ ìˆ˜ì§‘
            Object.keys(menuStructure).forEach(category => {
                menuStructure[category].forEach(menuItem => {
                    allMenuItems.push({
                        menuName: menuItem,
                        category: category
                    });
                });
            });
            
            // ê¸°ì¡´ ë©”ì¸ í˜ì´ì§€ ìœ ì§€
            const mainPage = pages.find(p => p.menuName === "ë©”ì¸í˜ì´ì§€");
            
            // ìƒˆë¡œìš´ í˜ì´ì§€ ë°°ì—´ ìƒì„±
            const newPages = [];
            
            // ë©”ì¸ í˜ì´ì§€ ì¶”ê°€
            if (mainPage) {
                newPages.push(mainPage);
            } else {
                newPages.push({
                    title: "ë©”ì¸ í˜ì´ì§€",
                    category: "main",
                    beforeContent: "ê¸°ì¡´ ë©”ì¸ í˜ì´ì§€ ë¬¸ì œì :\n- êµ¬ì‹ ë””ìì¸ê³¼ ë ˆì´ì•„ì›ƒ\n- ì‚¬ìš©ì ê²½í—˜ ë¶€ì¡±\n- ëª¨ë°”ì¼ ë°˜ì‘í˜• ë¯¸ì§€ì›",
                    afterContent: "ëª©í‘œ ê°œí¸ ì‚¬í•­:\n- ëª¨ë˜í•˜ê³  ê¹”ë”í•œ ë””ìì¸\n- ì§ê´€ì ì¸ ë„¤ë¹„ê²Œì´ì…˜\n- ì™„ì „ ë°˜ì‘í˜• ì›¹ ë””ìì¸\n- ì‚¬ìš©ì ì¹œí™”ì  ì¸í„°í˜ì´ìŠ¤",
                    beforeImage: null,
                    afterImage: null,
                    isCompleted: true,
                    menuName: "ë©”ì¸í˜ì´ì§€"
                });
            }
            
            // ë©”ë‰´ êµ¬ì¡°ì˜ ê° ì†Œë©”ë‰´ì— ëŒ€í•´ í˜ì´ì§€ ìƒì„±/ì—…ë°ì´íŠ¸
            allMenuItems.forEach(item => {
                const existingPage = pages.find(p => p.menuName === item.menuName);
                
                if (existingPage) {
                    // ê¸°ì¡´ í˜ì´ì§€ê°€ ìˆìœ¼ë©´ ì¹´í…Œê³ ë¦¬ë§Œ ì—…ë°ì´íŠ¸
                    existingPage.category = item.category;
                    newPages.push(existingPage);
                } else {
                    // ìƒˆ í˜ì´ì§€ ìƒì„±
                    newPages.push({
                        title: item.menuName,
                        category: item.category,
                        beforeContent: "",
                        afterContent: "",
                        beforeImage: null,
                        afterImage: null,
                        isCompleted: false,
                        menuName: item.menuName
                    });
                }
            });
            
            // ì „ì—­ pages ë°°ì—´ ì—…ë°ì´íŠ¸
            pages = newPages;
        }

        // ë¡œê·¸ì¸ ê´€ë ¨
        const credentials = {
            admin: 'mokpo2024!',
            viewer: 'view2024'
        };

        function switchTab(type) {
            const tabs = document.querySelectorAll('.login-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            const label = document.getElementById('loginLabel');
            const info = document.getElementById('loginInfoText');
            const input = document.getElementById('loginInput');

            if (type === 'admin') {
                label.textContent = 'ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸';
                info.textContent = 'ğŸ’¡ ë‹´ë‹¹ê³µë¬´ì›ì€ ëª¨ë“  ë‚´ìš©ì„ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤';
                input.placeholder = 'ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”';
            } else {
                label.textContent = 'ì—…ì²´ ì ‘ì† ì½”ë“œ';
                info.textContent = 'ğŸ’¡ ì—…ì²´ ë‹´ë‹¹ìëŠ” ì§„í–‰ ìƒí™©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤';
                input.placeholder = 'ì—…ì²´ ì „ìš© ì ‘ì† ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”';
            }
            
            input.value = '';
            input.focus();
        }

        async function attemptLogin() {
            try {
                const activeTab = document.querySelector('.login-tab.active');
                
                if (!activeTab) {
                    alert('ë¡œê·¸ì¸ íƒ­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                const userType = activeTab.textContent === 'ë‹´ë‹¹ê³µë¬´ì›' ? 'admin' : 'viewer';
                
                const passwordInput = document.getElementById('loginInput');
                if (!passwordInput) {
                    alert('ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì°½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const password = passwordInput.value.trim();
                
                if (!password) {
                    alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                if (credentials[userType] === password) {
                    // ìƒíƒœ ì—…ë°ì´íŠ¸
                    currentUserType = userType;
                    
                    // "ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€" ì²´í¬ë°•ìŠ¤ í™•ì¸
                    const rememberLogin = document.getElementById('rememberLogin').checked;
                    
                    if (rememberLogin) {
                        // ë¡œê·¸ì¸ ìƒíƒœë¥¼ localStorageì— ì €ì¥ (ìƒˆë¡œê³ ì¹¨ ì‹œ ìœ ì§€ìš©)
                        localStorage.setItem('mokpo_login_state', JSON.stringify({
                            userType: userType,
                            loginTime: new Date().getTime(),
                            expiresIn: 24 * 60 * 60 * 1000 // 24ì‹œê°„ í›„ ë§Œë£Œ
                        }));
                    }
                    
                    // í™”ë©´ ì „í™˜
                    const loginScreen = document.getElementById('loginScreen');
                    const mainContent = document.getElementById('mainContent');
                    
                    if (loginScreen && mainContent) {
                        loginScreen.style.display = 'none';
                        mainContent.style.display = 'block';
                    }
                    
                    // UI ì—…ë°ì´íŠ¸ í˜¸ì¶œ
                    updateUserInterface();
                    
                    // ë°ì´í„° ë¡œë“œ
                    loadData();
                    
                    // ì„±ê³µ ë©”ì‹œì§€
                    const loginMessage = rememberLogin ? 
                        `âœ… ${userType === 'admin' ? 'ê´€ë¦¬ì' : 'ì—…ì²´ ë‹´ë‹¹ì'}ë¡œ ë¡œê·¸ì¸í–ˆìŠµë‹ˆë‹¤!\nğŸ” ë¡œê·¸ì¸ ìƒíƒœê°€ 24ì‹œê°„ ë™ì•ˆ ìœ ì§€ë©ë‹ˆë‹¤.` :
                        `âœ… ${userType === 'admin' ? 'ê´€ë¦¬ì' : 'ì—…ì²´ ë‹´ë‹¹ì'}ë¡œ ë¡œê·¸ì¸í–ˆìŠµë‹ˆë‹¤!\nğŸ’¡ ë¸Œë¼ìš°ì €ë¥¼ ë‹«ìœ¼ë©´ ìë™ìœ¼ë¡œ ë¡œê·¸ì•„ì›ƒë©ë‹ˆë‹¤.`;
                    
                    showSaveModal(loginMessage);

                    // ì˜¨ë¼ì¸ ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸ (ë¡œê·¸ì¸ í›„)
                    updateUserPresence();
                    
                } else {
                    alert('âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    passwordInput.value = '';
                }
                
            } catch (error) {
                alert('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì‚¬ìš©ì presence ì •ë³´ ì—…ë°ì´íŠ¸
        async function updateUserPresence() {
            if (onlineUsersChannel && currentUserType) {
                try {
                    await onlineUsersChannel.track({
                        userId: generateUserId(),
                        userType: currentUserType,
                        joinedAt: new Date().toISOString(),
                        lastSeen: new Date().toISOString(),
                        userAgent: navigator.userAgent.substring(0, 100)
                    });
                } catch (error) {
                    // presence ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ëŠ” ë¬´ì‹œ
                }
            }
        }

        // ìë™ ë¡œê·¸ì¸ ì²´í¬ í•¨ìˆ˜
        function checkAutoLogin() {
            try {
                const loginState = localStorage.getItem('mokpo_login_state');
                if (!loginState) {
                    return false; // ë¡œê·¸ì¸ ì •ë³´ ì—†ìŒ
                }
                
                const loginData = JSON.parse(loginState);
                const currentTime = new Date().getTime();
                
                // ë§Œë£Œ ì‹œê°„ ì²´í¬
                if (currentTime - loginData.loginTime > loginData.expiresIn) {
                    // ë§Œë£Œëœ ë¡œê·¸ì¸ ì •ë³´ ì‚­ì œ
                    localStorage.removeItem('mokpo_login_state');
                    return false;
                }
                
                // ìë™ ë¡œê·¸ì¸ ìˆ˜í–‰
                currentUserType = loginData.userType;
                
                // í™”ë©´ ì „í™˜
                const loginScreen = document.getElementById('loginScreen');
                const mainContent = document.getElementById('mainContent');
                
                if (loginScreen && mainContent) {
                    loginScreen.style.display = 'none';
                    mainContent.style.display = 'block';
                }
                
                // UI ì—…ë°ì´íŠ¸
                updateUserInterface();
                
                // ë°ì´í„° ë¡œë“œ
                loadData();
                
                // ìë™ ë¡œê·¸ì¸ ì•Œë¦¼ (5ì´ˆ í›„ ìë™ ë‹«í˜)
                showAutoLoginNotification(loginData.userType);
                
                // ì˜¨ë¼ì¸ ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸ (ìë™ ë¡œê·¸ì¸ í›„)
                setTimeout(() => {
                    updateUserPresence();
                }, 1000); // 1ì´ˆ í›„ ì—…ë°ì´íŠ¸ (ì´ˆê¸°í™” ì™„ë£Œ ëŒ€ê¸°)
                
                return true;
                
            } catch (error) {
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë¡œê·¸ì¸ ì •ë³´ ì‚­ì œ
                localStorage.removeItem('mokpo_login_state');
                return false;
            }
        }

        // ìë™ ë¡œê·¸ì¸ ì•Œë¦¼ í‘œì‹œ
        function showAutoLoginNotification(userType) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(45deg, #28a745, #20c997);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 600;
                font-size: 14px;
                max-width: 300px;
                animation: slideInRight 0.3s ease;
            `;
            
            notification.innerHTML = `
                ğŸ” ìë™ ë¡œê·¸ì¸ ì™„ë£Œ<br>
                <small>${userType === 'admin' ? 'ê´€ë¦¬ì' : 'ì—…ì²´ ë‹´ë‹¹ì'}ë¡œ ì ‘ì†ë˜ì—ˆìŠµë‹ˆë‹¤</small>
            `;
            
            // ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ ì¶”ê°€
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOutRight {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            // 5ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }

        function logout() {
            // ë¡œê·¸ì•„ì›ƒ ì „ìš© ì»¤ìŠ¤í…€ ëª¨ë‹¬ ìƒì„±
            createLogoutConfirmModal();
        }

        function createLogoutConfirmModal() {
            // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆë‹¤ë©´ ì œê±°
            const existingModal = document.getElementById('logoutConfirmModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // ìƒˆ ë¡œê·¸ì•„ì›ƒ ëª¨ë‹¬ ìƒì„±
            const modal = document.createElement('div');
            modal.id = 'logoutConfirmModal';
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '9999';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-title" style="color: #ff9800; margin-bottom: 20px;">
                        ğŸšª ë¡œê·¸ì•„ì›ƒ í™•ì¸
                    </div>
                    <div class="modal-message" style="margin-bottom: 30px; white-space: pre-line;">
                        ì •ë§ ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?

âš ï¸ ì§„í–‰ ì¤‘ì¸ ì‘ì—…ì´ ì €ì¥ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ğŸ’¾ í˜„ì¬ ì‘ì—…ì€ ìë™ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.
                    </div>
                    <div class="modal-buttons">
                        <button class="modal-btn" style="background: #ff9800; color: white;" onclick="confirmLogout()">
                            ğŸšª ë¡œê·¸ì•„ì›ƒ
                        </button>
                        <button class="modal-btn" style="background: #6c757d; color: white;" onclick="cancelLogout()">
                            âœ–ï¸ ì·¨ì†Œ
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
            window.confirmLogout = () => {
                modal.remove();
                performLogout();
            };
            
            window.cancelLogout = () => {
                modal.remove();
            };
            
            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ì·¨ì†Œ
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function performLogout() {
            // í˜„ì¬ ì‘ì—… ì €ì¥
            if (currentUserType === 'admin') {
                try {
                    saveCurrentPage(false);
                    if (workNotes) {
                        saveData(); // ì—…ë¬´ ë©”ëª¨ ì €ì¥
                    }
                } catch (error) {
                    // ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë¬´ì‹œ
                }
            }
            
            // ìƒíƒœ ì´ˆê¸°í™”
            currentUserType = null;
            currentCategory = null;
            filteredPages = [];
            currentPageIndex = 0;
            
            // UI ì´ˆê¸°í™”
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('loginInput').value = '';
            
            // ë¡œê·¸ì¸ íƒ­ ì´ˆê¸°í™”
            const tabs = document.querySelectorAll('.login-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            tabs[0].classList.add('active'); // ì²« ë²ˆì§¸ íƒ­ í™œì„±í™”
            
            // ë¡œê·¸ì¸ í¼ ì´ˆê¸°í™”
            const label = document.getElementById('loginLabel');
            const info = document.getElementById('loginInfoText');
            const input = document.getElementById('loginInput');
            
            label.textContent = 'ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸';
            info.textContent = 'ğŸ’¡ ë‹´ë‹¹ê³µë¬´ì›ì€ ëª¨ë“  ë‚´ìš©ì„ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤';
            input.placeholder = 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”';
            
            // ë¡œê·¸ì•„ì›ƒ ì„±ê³µ ë©”ì‹œì§€
            setTimeout(() => {
                showSaveModal('âœ… ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤!\nì‘ì—… ë‚´ìš©ì´ ìë™ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n\në‹¤ì‹œ ì´ìš©í•˜ì‹œë ¤ë©´ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            }, 200);
        }

        function updateUserInterface() {
            const isAdmin = currentUserType === 'admin';
            const readonlyNotice = document.getElementById('readonlyNotice');
            const userBadge = document.getElementById('userBadge');
            const userName = document.getElementById('userName');

            if (isAdmin) {
                userBadge.textContent = 'ê´€ë¦¬ì';
                userBadge.className = 'user-badge admin';
                userName.textContent = 'ë‹´ë‹¹ê³µë¬´ì›';
                readonlyNotice.style.display = 'none';
            } else {
                userBadge.textContent = 'ì—…ì²´';
                userBadge.className = 'user-badge viewer';
                userName.textContent = 'ì—…ì²´ ë‹´ë‹¹ì';
                readonlyNotice.style.display = 'block';
                
                // ì—…ì²´ ë‹´ë‹¹ìëŠ” í•­ìƒ ì½ê¸° ì „ìš©
                readonlyNotice.innerHTML = `
                    ğŸ“– í˜„ì¬ <strong>ì½ê¸° ì „ìš© ëª¨ë“œ</strong>ì…ë‹ˆë‹¤. ì§„í–‰ ìƒí™©ì„ í™•ì¸í•  ìˆ˜ ìˆì§€ë§Œ í¸ì§‘ì€ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
                    ğŸ’¡ ê´€ë¦¬ìë§Œ í¸ì§‘ ê¶Œí•œì´ ìˆìœ¼ë©°, ë³€ê²½ì‚¬í•­ì€ ì‹¤ì‹œê°„ìœ¼ë¡œ ë™ê¸°í™”ë©ë‹ˆë‹¤.
                `;
            }

            // í¸ì§‘ ê¶Œí•œ ì„¤ì •
            const editableElements = ['beforeContent', 'afterContent', 'workNotes'];
            editableElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (!isAdmin) {
                        element.disabled = true;
                        element.placeholder = 'ì½ê¸° ì „ìš© - ê´€ë¦¬ìë§Œ í¸ì§‘ ê°€ëŠ¥';
                        element.style.background = '#f8f9fa';
                        element.style.color = '#6c757d';
                    } else if (!editingUser) {
                        element.disabled = false;
                        element.placeholder = '';
                        element.style.background = '';
                        element.style.color = '';
                    }
                }
            });

            const adminOnlyButtons = [
                'saveBtn', 'addPageBtn', 'deleteBtn', 'saveNotesBtn',
                'beforeImageBtn', 'afterImageBtn', 'uploadBtn', 'resetBtn', 'menuEditBtn'
            ];
            
            adminOnlyButtons.forEach(id => {
                const button = document.getElementById(id);
                if (button) {
                    if (!isAdmin) {
                        button.disabled = true;
                        button.style.display = 'none';
                        button.title = 'ê´€ë¦¬ìë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤';
                    } else if (!editingUser) {
                        button.disabled = false;
                        button.style.display = '';
                        button.title = '';
                    }
                }
            });

            const imageControls = document.querySelectorAll('.image-controls');
            imageControls.forEach(control => {
                control.style.display = isAdmin && !editingUser ? '' : 'none';
            });
        }

        // ==================== ë°ì´í„° ì €ì¥/ë¡œë“œ (Supabase + localStorage í•˜ì´ë¸Œë¦¬ë“œ) ====================
        
        async function saveData() {
            const data = {
                pages: pages,
                workNotes: workNotes,
                menuStructure: menuStructure,
                lastUpdated: new Date().toISOString(),
                version: '1.0'
            };

            // Supabase ì €ì¥ ì‹œë„
            if (isSupabaseReady && supabase) {
                try {
                    // ê¸°ì¡´ ë°ì´í„° í™•ì¸
                    const { data: existingData, error: selectError } = await supabase
                        .from('mokpo_projects')
                        .select('id')
                        .limit(1);

                    if (selectError && selectError.code !== '42P01') {
                        throw selectError;
                    }

                    const projectData = {
                        project_name: 'ëª©í¬ì‹œ í†µí•©ë„ì„œê´€ í™ˆí˜ì´ì§€ ê°œí¸',
                        pages: JSON.stringify(data.pages),
                        work_notes: data.workNotes,
                        menu_structure: JSON.stringify(data.menuStructure),
                        updated_at: new Date().toISOString()
                    };

                    let result;
                    if (existingData && existingData.length > 0) {
                        // ì—…ë°ì´íŠ¸
                        result = await supabase
                            .from('mokpo_projects')
                            .update(projectData)
                            .eq('id', existingData[0].id);
                    } else {
                        // ìƒˆë¡œ ìƒì„±
                        result = await supabase
                            .from('mokpo_projects')
                            .insert([projectData]);
                    }

                    if (result.error) {
                        throw result.error;
                    }

                    // Supabase ì €ì¥ ì„±ê³µ ì‹œ localStorageì—ë„ ë°±ì—…
                    localStorage.setItem('mokpo_library_data', JSON.stringify(data));
                    
                    // ì‹¤ì‹œê°„ ë°ì´í„° ë³€ê²½ ë¸Œë¡œë“œìºìŠ¤íŠ¸ (ê´€ë¦¬ìë§Œ)
                    if (currentUserType === 'admin') {
                        broadcastDataUpdate();
                    }
                    
                    // ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
                    updateConnectionStatus('â˜ï¸ í´ë¼ìš°ë“œ ì €ì¥ ì™„ë£Œ');
                    return true;

                } catch (error) {
                    // Supabase ì‹¤íŒ¨ ì‹œ localStorageë¡œ í´ë°±
                    localStorage.setItem('mokpo_library_data', JSON.stringify(data));
                    updateConnectionStatus('ğŸ’¾ ë¡œì»¬ ì €ì¥ (í´ë¼ìš°ë“œ ì—°ê²° ì‹¤íŒ¨)');
                    return true;
                }
            } else {
                // Supabase ë¯¸ì„¤ì • ì‹œ localStorage ì‚¬ìš©
                try {
                    localStorage.setItem('mokpo_library_data', JSON.stringify(data));
                    updateConnectionStatus('ğŸ’¾ ë¡œì»¬ ì €ì¥');
                    return true;
                } catch (error) {
                    return false;
                }
            }
        }

        async function loadData() {
            // Supabaseì—ì„œ ë¡œë“œ ì‹œë„
            if (isSupabaseReady && supabase) {
                try {
                    const { data: supabaseData, error } = await supabase
                        .from('mokpo_projects')
                        .select('*')
                        .order('updated_at', { ascending: false })
                        .limit(1);

                    if (!error && supabaseData && supabaseData.length > 0) {
                        const projectData = supabaseData[0];
                        
                        // Supabase ë°ì´í„° íŒŒì‹±
                        if (projectData.menu_structure) {
                            menuStructure = JSON.parse(projectData.menu_structure);
                        }
                        if (projectData.pages) {
                            pages = JSON.parse(projectData.pages);
                        }
                        if (projectData.work_notes) {
                            workNotes = projectData.work_notes;
                            document.getElementById('workNotes').value = workNotes;
                        }

                        // localStorageì—ë„ ë°±ì—…
                        const backupData = {
                            pages: pages,
                            workNotes: workNotes,
                            menuStructure: menuStructure,
                            lastUpdated: projectData.updated_at,
                            version: '1.0'
                        };
                        localStorage.setItem('mokpo_library_data', JSON.stringify(backupData));
                        
                        updateConnectionStatus('â˜ï¸ í´ë¼ìš°ë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
                        
                        // í˜ì´ì§€ ë°ì´í„° ë™ê¸°í™” ë° UI ì—…ë°ì´íŠ¸
                        initializePages();
                        updateAllDisplays();
                        renderMenuGrid();
                        return;
                    }
                } catch (error) {
                    // Supabase ì‹¤íŒ¨ ì‹œ localStorageë¡œ í´ë°±
                }
            }

            // localStorageì—ì„œ ë¡œë“œ (í´ë°± ë˜ëŠ” ê¸°ë³¸)
            try {
                const savedData = localStorage.getItem('mokpo_library_data');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    if (data.menuStructure) {
                        menuStructure = data.menuStructure;
                    }
                    if (data.pages) {
                        pages = data.pages;
                    }
                    if (data.workNotes) {
                        workNotes = data.workNotes;
                        document.getElementById('workNotes').value = workNotes;
                    }
                }
                updateConnectionStatus('ğŸ’¾ ë¡œì»¬ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
            } catch (error) {
                updateConnectionStatus('âš ï¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
            }
            
            // í˜ì´ì§€ ë°ì´í„°ë¥¼ í˜„ì¬ ë©”ë‰´ êµ¬ì¡°ì™€ ë™ê¸°í™”
            initializePages();
            updateAllDisplays();
            renderMenuGrid();
        }

        // ì—°ê²° ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateConnectionStatus(message) {
            const statusElement = document.querySelector('.status-indicator-inline');
            if (statusElement) {
                statusElement.textContent = message;
                
                // ìƒ‰ìƒ ë³€ê²½
                if (message.includes('í´ë¼ìš°ë“œ')) {
                    statusElement.style.background = 'linear-gradient(45deg, #4f46e5, #7c3aed)';
                } else if (message.includes('ë¡œì»¬')) {
                    statusElement.style.background = 'linear-gradient(45deg, #059669, #0d9488)';
                } else if (message.includes('ì‹¤íŒ¨')) {
                    statusElement.style.background = 'linear-gradient(45deg, #dc2626, #b91c1c)';
                }
            }
        }

        function renderMenuGrid() {
            const menuGrid = document.getElementById('menuGrid');
            menuGrid.innerHTML = '';
            
            Object.keys(menuStructure).forEach(category => {
                const column = document.createElement('div');
                column.className = 'menu-column';
                
                const header = document.createElement('div');
                header.className = 'menu-header';
                header.textContent = category;
                header.style.cursor = 'pointer';
                
                // í˜„ì¬ ì„ íƒëœ ì¹´í…Œê³ ë¦¬ í‘œì‹œ
                if (currentCategory === category) {
                    header.classList.add('active');
                }
                
                header.addEventListener('click', function() {
                    handleCategoryClick(category);
                });
                column.appendChild(header);
                
                menuStructure[category].forEach(menuItem => {
                    const item = document.createElement('div');
                    item.className = 'menu-item';
                    item.setAttribute('data-page', menuItem);
                    item.textContent = menuItem;
                    item.addEventListener('click', function() {
                        handleMenuClick(menuItem, category);
                    });
                    column.appendChild(item);
                });
                
                menuGrid.appendChild(column);
            });
            
            updateMenuItemStyles();
        }

        function handleCategoryClick(categoryName) {
            currentCategory = categoryName;
            
            // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ í˜ì´ì§€ë“¤ í•„í„°ë§
            filteredPages = pages.filter(page => {
                return menuStructure[categoryName].includes(page.menuName);
            });
            
            if (filteredPages.length > 0) {
                // ì²« ë²ˆì§¸ í˜ì´ì§€ë¡œ ì´ë™
                currentPageIndex = 0;
                loadFilteredPage(currentPageIndex);
                updatePageNavigation();
                
                // ë©”ë‰´ ì œëª© ë¶€ë¶„ìœ¼ë¡œ ìŠ¤í¬ë¡¤
                setTimeout(() => {
                    const pageTitle = document.getElementById('pageTitle');
                    pageTitle.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 300);
                
                showSaveModal(`ğŸ“‚ ${categoryName} ì¹´í…Œê³ ë¦¬ê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤!\n${filteredPages.length}ê°œì˜ í˜ì´ì§€ê°€ ìˆìŠµë‹ˆë‹¤.`);
            } else {
                // í˜ì´ì§€ê°€ ì—†ëŠ” ê²½ìš°
                currentPageIndex = 0;
                document.getElementById('pageTitle').textContent = `${categoryName} > í˜ì´ì§€ ì—†ìŒ`;
                document.getElementById('beforeContent').value = '';
                document.getElementById('afterContent').value = '';
                
                // ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
                loadImages(null, null);
                
                updatePageNavigation();
                showSaveModal(`ğŸ“‚ ${categoryName} ì¹´í…Œê³ ë¦¬ê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.\nì•„ì§ í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ì†Œë©”ë‰´ë¥¼ í´ë¦­í•˜ì—¬ ìƒˆ í˜ì´ì§€ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.`);
            }
            
            // ë©”ë‰´ ê·¸ë¦¬ë“œ ì—…ë°ì´íŠ¸ (ì„ íƒëœ ì¹´í…Œê³ ë¦¬ ê°•ì¡°)
            renderMenuGrid();
        }

        async function handleMenuClick(menuName, categoryName = null) {
            // ì¹´í…Œê³ ë¦¬ê°€ ì§€ì •ë˜ì§€ ì•Šì€ ê²½ìš° ì°¾ê¸°
            if (!categoryName) {
                for (const [cat, items] of Object.entries(menuStructure)) {
                    if (items.includes(menuName)) {
                        categoryName = cat;
                        break;
                    }
                }
            }
            
            // ì¹´í…Œê³ ë¦¬ ì„¤ì •
            currentCategory = categoryName;
            filteredPages = pages.filter(page => {
                return menuStructure[categoryName].includes(page.menuName);
            });
            
            // í•´ë‹¹ í˜ì´ì§€ ì°¾ê¸°
            const pageIndex = filteredPages.findIndex(p => p.menuName === menuName);
            
            if (pageIndex !== -1) {
                currentPageIndex = pageIndex;
                loadFilteredPage(currentPageIndex);
                updatePageNavigation();
                
                setTimeout(() => {
                    const pageTitle = document.getElementById('pageTitle');
                    pageTitle.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 300);
                
            } else if (currentUserType === 'admin') {
                if (confirm(`'${menuName}' í˜ì´ì§€ë¥¼ ìƒˆë¡œ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    const newPage = {
                        title: menuName,
                        category: categoryName,
                        beforeContent: '',
                        afterContent: '',
                        beforeImage: null,
                        afterImage: null,
                        isCompleted: false,
                        menuName: menuName
                    };
                    
                    pages.push(newPage);
                    
                    // í•„í„°ëœ í˜ì´ì§€ ëª©ë¡ ë‹¤ì‹œ ìƒì„±
                    filteredPages = pages.filter(page => {
                        return menuStructure[categoryName].includes(page.menuName);
                    });
                    
                    currentPageIndex = filteredPages.length - 1;
                    updateAllDisplays();
                    await saveData();
                    
                    loadFilteredPage(currentPageIndex);
                    updatePageNavigation();
                    
                    setTimeout(() => {
                        const pageTitle = document.getElementById('pageTitle');
                        pageTitle.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                    }, 300);
                }
            }
        }

        function openMenuEditor() {
            if (currentUserType !== 'admin') return;
            
            const modal = document.getElementById('menuEditorModal');
            const editor = document.getElementById('menuEditor');
            
            editor.innerHTML = '';
            
            Object.keys(menuStructure).forEach(category => {
                const categoryDiv = createCategoryEditor(category, menuStructure[category]);
                editor.appendChild(categoryDiv);
            });
            
            modal.style.display = 'block';
        }

        function createCategoryEditor(categoryName, menuItems) {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'category-editor';
            categoryDiv.setAttribute('data-category-name', categoryName); // ì•ˆì „í•œ ë°ì´í„° ì €ì¥
            
            const header = document.createElement('div');
            header.className = 'category-header';
            header.innerHTML = `
                <div class="category-title">${categoryName}</div>
                <div class="category-controls">
                    <button class="small-btn edit" onclick="editCategoryByElement(this)">âœï¸ ìˆ˜ì •</button>
                    <button class="small-btn delete" onclick="deleteCategoryByElement(this)">ğŸ—‘ï¸ ì‚­ì œ</button>
                </div>
            `;
            categoryDiv.appendChild(header);
            
            const itemsList = document.createElement('div');
            itemsList.className = 'menu-items-list';
            
            menuItems.forEach((item, index) => {
                const itemEditor = createMenuItemEditor(categoryName, item, index);
                itemsList.appendChild(itemEditor);
            });
            
            const safeId = categoryName.replace(/[^a-zA-Z0-9ê°€-í£]/g, '_');
            const addSection = document.createElement('div');
            addSection.className = 'add-menu-item';
            addSection.innerHTML = `
                <input type="text" placeholder="ìƒˆ ì†Œë©”ë‰´ ì´ë¦„" class="menu-item-input" 
                       id="newItem_${safeId}">
                <button class="small-btn" style="background: #28a745; color: white;" 
                        onclick="addMenuItemByElement(this)">â• ì¶”ê°€</button>
            `;
            addSection.setAttribute('data-category-name', categoryName);
            itemsList.appendChild(addSection);
            
            categoryDiv.appendChild(itemsList);
            return categoryDiv;
        }

        function editCategoryByElement(button) {
            const categoryEditor = button.closest('.category-editor');
            const oldName = categoryEditor.getAttribute('data-category-name');
            
            console.log('Editing category:', oldName);
            
            const newName = prompt('ìƒˆ ëŒ€ë©”ë‰´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', oldName);
            if (newName && newName.trim() && newName !== oldName) {
                const trimmedName = newName.trim();
                if (menuStructure[trimmedName]) {
                    alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ëŒ€ë©”ë‰´ ì´ë¦„ì…ë‹ˆë‹¤.');
                    return;
                }
                
                console.log('Changing category name from', oldName, 'to', trimmedName);
                
                // ë©”ë‰´ êµ¬ì¡° ì—…ë°ì´íŠ¸
                menuStructure[trimmedName] = menuStructure[oldName];
                delete menuStructure[oldName];
                
                // í˜ì´ì§€ ì •ë³´ë„ ì—…ë°ì´íŠ¸
                pages.forEach(page => {
                    if (page.category === oldName) {
                        page.category = trimmedName;
                    }
                });
                
                console.log('Category renamed successfully');
                saveData();
                openMenuEditor(); // í¸ì§‘ê¸° ìƒˆë¡œê³ ì¹¨
            }
        }

        function deleteCategoryByElement(button) {
            const categoryEditor = button.closest('.category-editor');
            const categoryName = categoryEditor.getAttribute('data-category-name');
            
            console.log('Attempting to delete category:', categoryName);
            
            if (Object.keys(menuStructure).length <= 1) {
                alert('ìµœì†Œ 1ê°œì˜ ëŒ€ë©”ë‰´ëŠ” í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            // ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ ìƒì„±
            createCustomConfirmModal(
                `ëŒ€ë©”ë‰´ ì‚­ì œ í™•ì¸`,
                `ì •ë§ '${categoryName}' ëŒ€ë©”ë‰´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ëŒ€ë©”ë‰´ì— ì†í•œ ëª¨ë“  ì†Œë©”ë‰´ì™€ ê´€ë ¨ í˜ì´ì§€ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`,
                () => {
                    console.log('User confirmed category deletion');
                    performCategoryDeletion(categoryName);
                },
                () => {
                    console.log('User cancelled category deletion');
                }
            );
        }

        function performCategoryDeletion(categoryName) {
            console.log('Performing category deletion:', categoryName);
            
            // ê´€ë ¨ í˜ì´ì§€ë“¤ ì‚­ì œ
            const menuItems = menuStructure[categoryName];
            if (menuItems) {
                menuItems.forEach(menuItem => {
                    const pageIndex = pages.findIndex(p => p.menuName === menuItem);
                    if (pageIndex !== -1) {
                        console.log('Deleting page:', pages[pageIndex].title);
                        pages.splice(pageIndex, 1);
                    }
                });
            }
            
            // ë©”ë‰´ êµ¬ì¡°ì—ì„œ ì‚­ì œ
            delete menuStructure[categoryName];
            console.log('Category deleted from menu structure');
            
            // í˜„ì¬ í˜ì´ì§€ ì¸ë±ìŠ¤ ì¡°ì •
            if (currentPageIndex >= pages.length) {
                currentPageIndex = Math.max(0, pages.length - 1);
            }
            
            // í˜„ì¬ ì„ íƒëœ ì¹´í…Œê³ ë¦¬ê°€ ì‚­ì œëœ ê²½ìš° ì´ˆê¸°í™”
            if (currentCategory === categoryName) {
                currentCategory = null;
                filteredPages = [];
            }
            
            saveData();
            openMenuEditor(); // í¸ì§‘ê¸° ìƒˆë¡œê³ ì¹¨
            showSaveModal(`âœ… '${categoryName}' ëŒ€ë©”ë‰´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\nê´€ë ¨ í˜ì´ì§€ë“¤ë„ í•¨ê»˜ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }

        function addMenuItemByElement(button) {
            const addSection = button.closest('.add-menu-item');
            const categoryName = addSection.getAttribute('data-category-name');
            const input = addSection.querySelector('.menu-item-input');
            const itemName = input.value.trim();
            
            console.log('Adding menu item to category:', categoryName, 'item:', itemName);
            
            if (!itemName) {
                alert('ì†Œë©”ë‰´ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const allMenuItems = Object.values(menuStructure).flat();
            if (allMenuItems.includes(itemName)) {
                alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì†Œë©”ë‰´ ì´ë¦„ì…ë‹ˆë‹¤.');
                return;
            }
            
            menuStructure[categoryName].push(itemName);
            
            // ìƒˆ ì†Œë©”ë‰´ì— ëŒ€í•œ í˜ì´ì§€ ìë™ ìƒì„±
            pages.push({
                title: itemName,
                category: categoryName,
                beforeContent: "",
                afterContent: "",
                beforeImage: null,
                afterImage: null,
                isCompleted: false,
                menuName: itemName
            });
            
            input.value = '';
            console.log('Menu item added successfully');
            openMenuEditor();
        }

        function createMenuItemEditor(categoryName, itemName, index) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'menu-item-editor';
            
            // ë©”ë‰´ ì´ë¦„ìœ¼ë¡œ ì‹ë³„í•˜ë„ë¡ ë³€ê²½
            itemDiv.setAttribute('data-category', categoryName);
            itemDiv.setAttribute('data-item-name', itemName);
            
            itemDiv.innerHTML = `
                <input type="text" value="${itemName}" class="menu-item-input" 
                       onchange="updateMenuItemByName(this, '${categoryName}', '${itemName}')">
                <button class="small-btn edit" onclick="moveMenuItemUpByName(this)">â¬†ï¸</button>
                <button class="small-btn edit" onclick="moveMenuItemDownByName(this)">â¬‡ï¸</button>
                <button class="small-btn delete" onclick="deleteMenuItemByName(this)">ğŸ—‘ï¸</button>
            `;
            return itemDiv;
        }

        function deleteMenuItemByName(button) {
            const itemEditor = button.closest('.menu-item-editor');
            const categoryName = itemEditor.getAttribute('data-category');
            const itemName = itemEditor.getAttribute('data-item-name');
            
            if (!menuStructure[categoryName]) {
                alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + categoryName);
                return;
            }
            
            // ë°°ì—´ì´ ì•„ë‹Œ ê²½ìš° ë°°ì—´ë¡œ ë³€í™˜
            if (!Array.isArray(menuStructure[categoryName])) {
                menuStructure[categoryName] = Object.values(menuStructure[categoryName]);
            }
            
            if (menuStructure[categoryName].length <= 1) {
                alert('ê° ëŒ€ë©”ë‰´ì—ëŠ” ìµœì†Œ 1ê°œì˜ ì†Œë©”ë‰´ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            const index = menuStructure[categoryName].findIndex(item => item === itemName);
            
            if (index === -1) {
                alert('ì†Œë©”ë‰´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + itemName);
                return;
            }
            
            // ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ ìƒì„± (confirm ëŒ€ì‹ )
            createCustomConfirmModal(
                `ì†Œë©”ë‰´ ì‚­ì œ í™•ì¸`,
                `'${itemName}' ì†Œë©”ë‰´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nâš ï¸ ê´€ë ¨ëœ í˜ì´ì§€ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`,
                () => {
                    performDeletion(categoryName, itemName, index);
                },
                () => {
                    // ì·¨ì†Œ ì‹œ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
                }
            );
        }

        function createCustomConfirmModal(title, message, onConfirm, onCancel) {
            // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆë‹¤ë©´ ì œê±°
            const existingModal = document.getElementById('customConfirmModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // ìƒˆ ëª¨ë‹¬ ìƒì„±
            const modal = document.createElement('div');
            modal.id = 'customConfirmModal';
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '9999';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-title" style="color: #dc3545; margin-bottom: 20px;">
                        ğŸ—‘ï¸ ${title}
                    </div>
                    <div class="modal-message" style="margin-bottom: 30px; white-space: pre-line;">
                        ${message}
                    </div>
                    <div class="modal-buttons">
                        <button class="modal-btn" style="background: #dc3545; color: white;" onclick="confirmCustomModal()">
                            ğŸ—‘ï¸ ì‚­ì œí•˜ê¸°
                        </button>
                        <button class="modal-btn" style="background: #6c757d; color: white;" onclick="cancelCustomModal()">
                            âœ–ï¸ ì·¨ì†Œ
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
            window.confirmCustomModal = () => {
                modal.remove();
                onConfirm();
            };
            
            window.cancelCustomModal = () => {
                modal.remove();
                onCancel();
            };
            
            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ì·¨ì†Œ
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                    onCancel();
                }
            });
        }

        function performDeletion(categoryName, itemName, index) {
            // ê´€ë ¨ í˜ì´ì§€ ì‚­ì œ
            const pageIndex = pages.findIndex(p => p.menuName === itemName);
            if (pageIndex !== -1) {
                pages.splice(pageIndex, 1);
                if (currentPageIndex >= pages.length) {
                    currentPageIndex = Math.max(0, pages.length - 1);
                }
            }
            
            // ë©”ë‰´ í•­ëª© ì‚­ì œ
            menuStructure[categoryName].splice(index, 1);
            
            // ë°ì´í„° ì €ì¥
            saveData();
            
            // í˜ì´ì§€ ë°ì´í„° ì¬ë™ê¸°í™”
            initializePages();
            
            // í™”ë©´ ì—…ë°ì´íŠ¸
            renderMenuGrid();
            updateAllDisplays();
            
            // ë©”ë‰´ í¸ì§‘ê¸° ìƒˆë¡œê³ ì¹¨
            setTimeout(() => {
                openMenuEditor();
            }, 100);
            
            // ì„±ê³µ ë©”ì‹œì§€
            showSaveModal(`âœ… '${itemName}' ì†Œë©”ë‰´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\ní˜ì´ì§€ ë°ì´í„°ë„ ìë™ìœ¼ë¡œ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }

        function moveMenuItemUpByName(button) {
            const itemEditor = button.closest('.menu-item-editor');
            const categoryName = itemEditor.getAttribute('data-category');
            const itemName = itemEditor.getAttribute('data-item-name');
            
            // ë°°ì—´ í™•ì¸ ë° ë³€í™˜
            if (!Array.isArray(menuStructure[categoryName])) {
                menuStructure[categoryName] = Object.values(menuStructure[categoryName]);
            }
            
            const items = menuStructure[categoryName];
            const index = items.findIndex(item => item === itemName);
            
            if (index <= 0) return;
            
            [items[index], items[index - 1]] = [items[index - 1], items[index]];
            saveData();
            openMenuEditor();
        }

        function moveMenuItemDownByName(button) {
            const itemEditor = button.closest('.menu-item-editor');
            const categoryName = itemEditor.getAttribute('data-category');
            const itemName = itemEditor.getAttribute('data-item-name');
            
            // ë°°ì—´ í™•ì¸ ë° ë³€í™˜
            if (!Array.isArray(menuStructure[categoryName])) {
                menuStructure[categoryName] = Object.values(menuStructure[categoryName]);
            }
            
            const items = menuStructure[categoryName];
            const index = items.findIndex(item => item === itemName);
            
            if (index === -1 || index === items.length - 1) return;
            
            [items[index], items[index + 1]] = [items[index + 1], items[index]];
            saveData();
            openMenuEditor();
        }

        async function updateMenuItemByName(input, categoryName, originalName) {
            const trimmedValue = input.value.trim();
            if (!trimmedValue) {
                alert('ì†Œë©”ë‰´ ì´ë¦„ì€ ë¹„ì–´ìˆì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                openMenuEditor();
                return;
            }
            
            // ë°°ì—´ í™•ì¸ ë° ë³€í™˜
            if (!Array.isArray(menuStructure[categoryName])) {
                menuStructure[categoryName] = Object.values(menuStructure[categoryName]);
            }
            
            const allMenuItems = Object.values(menuStructure).flat();
            const otherItems = allMenuItems.filter(item => item !== originalName);
            
            if (otherItems.includes(trimmedValue)) {
                alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì†Œë©”ë‰´ ì´ë¦„ì…ë‹ˆë‹¤.');
                openMenuEditor();
                return;
            }
            
            // ë©”ë‰´ êµ¬ì¡°ì—ì„œ ì—…ë°ì´íŠ¸
            const index = menuStructure[categoryName].findIndex(item => item === originalName);
            if (index !== -1) {
                menuStructure[categoryName][index] = trimmedValue;
            }
            
            // í˜ì´ì§€ ì •ë³´ ì—…ë°ì´íŠ¸
            const page = pages.find(p => p.menuName === originalName);
            if (page) {
                page.menuName = trimmedValue;
                page.title = trimmedValue;
            }
            
            await saveData();
        }

        function editCategoryName(oldName) {
            const newName = prompt('ìƒˆ ëŒ€ë©”ë‰´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', oldName);
            if (newName && newName.trim() && newName !== oldName) {
                const trimmedName = newName.trim();
                if (menuStructure[trimmedName]) {
                    alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ëŒ€ë©”ë‰´ ì´ë¦„ì…ë‹ˆë‹¤.');
                    return;
                }
                
                menuStructure[trimmedName] = menuStructure[oldName];
                delete menuStructure[oldName];
                
                pages.forEach(page => {
                    if (page.category === oldName) {
                        page.category = trimmedName;
                    }
                });
                
                openMenuEditor();
            }
        }

        function deleteCategory(categoryName) {
            if (Object.keys(menuStructure).length <= 1) {
                alert('ìµœì†Œ 1ê°œì˜ ëŒ€ë©”ë‰´ëŠ” í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            if (confirm(`ì •ë§ '${categoryName}' ëŒ€ë©”ë‰´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                const menuItems = menuStructure[categoryName];
                menuItems.forEach(menuItem => {
                    const pageIndex = pages.findIndex(p => p.menuName === menuItem);
                    if (pageIndex !== -1) pages.splice(pageIndex, 1);
                });
                
                delete menuStructure[categoryName];
                
                if (currentPageIndex >= pages.length) {
                    currentPageIndex = Math.max(0, pages.length - 1);
                }
                
                openMenuEditor();
            }
        }

        function addMenuItem(categoryName) {
            const safeId = categoryName.replace(/[^a-zA-Z0-9ê°€-í£]/g, '_');
            const inputId = `newItem_${safeId}`;
            const input = document.getElementById(inputId);
            const itemName = input.value.trim();
            
            if (!itemName) {
                alert('ì†Œë©”ë‰´ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const allMenuItems = Object.values(menuStructure).flat();
            if (allMenuItems.includes(itemName)) {
                alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì†Œë©”ë‰´ ì´ë¦„ì…ë‹ˆë‹¤.');
                return;
            }
            
            menuStructure[categoryName].push(itemName);
            input.value = '';
            
            // ìƒˆ ì†Œë©”ë‰´ì— ëŒ€í•œ í˜ì´ì§€ ìë™ ìƒì„±
            pages.push({
                title: itemName,
                category: categoryName,
                beforeContent: "",
                afterContent: "",
                beforeImage: null,
                afterImage: null,
                isCompleted: false,
                menuName: itemName
            });
            
            openMenuEditor();
        }

        function updateMenuItem(categoryName, index, newValue) {
            const trimmedValue = newValue.trim();
            if (!trimmedValue) {
                alert('ì†Œë©”ë‰´ ì´ë¦„ì€ ë¹„ì–´ìˆì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                openMenuEditor();
                return;
            }
            
            const allMenuItems = Object.values(menuStructure).flat();
            const oldValue = menuStructure[categoryName][index];
            const otherItems = allMenuItems.filter(item => item !== oldValue);
            
            if (otherItems.includes(trimmedValue)) {
                alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì†Œë©”ë‰´ ì´ë¦„ì…ë‹ˆë‹¤.');
                openMenuEditor();
                return;
            }
            
            const page = pages.find(p => p.menuName === oldValue);
            if (page) {
                page.menuName = trimmedValue;
                page.title = trimmedValue;
            }
            
            menuStructure[categoryName][index] = trimmedValue;
        }

        function moveMenuItemUp(categoryName, index) {
            if (index === 0) return;
            
            const items = menuStructure[categoryName];
            [items[index], items[index - 1]] = [items[index - 1], items[index]];
            openMenuEditor();
        }

        function moveMenuItemDown(categoryName, index) {
            const items = menuStructure[categoryName];
            if (index === items.length - 1) return;
            
            [items[index], items[index + 1]] = [items[index + 1], items[index]];
            openMenuEditor();
        }

        function deleteMenuItem(categoryName, index) {
            if (menuStructure[categoryName].length <= 1) {
                alert('ê° ëŒ€ë©”ë‰´ì—ëŠ” ìµœì†Œ 1ê°œì˜ ì†Œë©”ë‰´ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            const menuItem = menuStructure[categoryName][index];
            if (confirm(`ì •ë§ '${menuItem}' ì†Œë©”ë‰´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                const pageIndex = pages.findIndex(p => p.menuName === menuItem);
                if (pageIndex !== -1) {
                    pages.splice(pageIndex, 1);
                    if (currentPageIndex >= pages.length) {
                        currentPageIndex = Math.max(0, pages.length - 1);
                    }
                }
                
                menuStructure[categoryName].splice(index, 1);
                openMenuEditor();
            }
        }

        async function addNewCategory() {
            const input = document.getElementById('newCategoryName');
            const categoryName = input.value.trim();
            
            if (!categoryName) {
                alert('ëŒ€ë©”ë‰´ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (menuStructure[categoryName]) {
                alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ëŒ€ë©”ë‰´ ì´ë¦„ì…ë‹ˆë‹¤.');
                return;
            }
            
            menuStructure[categoryName] = ['ìƒˆ ì†Œë©”ë‰´'];
            input.value = '';
            await saveData();
            openMenuEditor();
        }

        async function resetData() {
            if (confirm('ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nâš ï¸ Supabaseì™€ ë¡œì»¬ ì €ì¥ì†Œì˜ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.')) {
                try {
                    // Supabase ë°ì´í„° ì‚­ì œ (ê°€ëŠ¥í•œ ê²½ìš°)
                    if (isSupabaseReady && supabase) {
                        try {
                            const { error } = await supabase
                                .from('mokpo_projects')
                                .delete()
                                .neq('id', '00000000-0000-0000-0000-000000000000'); // ëª¨ë“  ë°ì´í„° ì‚­ì œ
                            
                            if (error) {
                                // ì‚­ì œ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
                            }
                        } catch (error) {
                            // Supabase ì‚­ì œ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
                        }
                    }
                    
                    // ë¡œì»¬ ì €ì¥ì†Œ ì‚­ì œ
                    localStorage.removeItem('mokpo_library_data');
                    
                    // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                    location.reload();
                } catch (error) {
                    alert('ë°ì´í„° ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            }
        }

        function saveMenuStructure() {
            // ë©”ë‰´ êµ¬ì¡° ì €ì¥ í›„ í˜ì´ì§€ ë°ì´í„° ë™ê¸°í™”
            saveData();
            initializePages(); // í˜ì´ì§€ ë°ì´í„°ë¥¼ ìƒˆ ë©”ë‰´ êµ¬ì¡°ì— ë§ê²Œ ì—…ë°ì´íŠ¸
            renderMenuGrid();
            updateAllDisplays();
            closeMenuEditor();
            showSaveModal('ë©”ë‰´ êµ¬ì¡°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\ní˜ì´ì§€ ë°ì´í„°ë„ ìë™ìœ¼ë¡œ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function closeMenuEditor() {
            document.getElementById('menuEditorModal').style.display = 'none';
        }

        function updateAllDisplays() {
            updateProgress();
            updateMenuItemStyles();
            updatePageSelector();
            loadPage(currentPageIndex);
        }

        function updateMenuItemStyles() {
            document.querySelectorAll('.menu-item').forEach(item => {
                const menuName = item.getAttribute('data-page');
                const page = pages.find(p => p.menuName === menuName);
                
                // ëª¨ë“  í´ë˜ìŠ¤ ì´ˆê¸°í™”
                item.classList.remove('page-exists', 'page-completed', 'current-page');
                
                if (page) {
                    item.classList.add('page-exists');
                    if (page.isCompleted) {
                        item.classList.add('page-completed');
                    }
                    
                    // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ í˜ì´ì§€ ê°•ì¡°
                    if (currentCategory) {
                        const currentPage = filteredPages[currentPageIndex];
                        if (currentPage && currentPage.menuName === menuName) {
                            item.classList.add('current-page');
                        }
                    } else {
                        const currentPage = pages[currentPageIndex];
                        if (currentPage && currentPage.menuName === menuName) {
                            item.classList.add('current-page');
                        }
                    }
                }
            });
        }

        function updatePageSelector() {
            const pageSelector = document.getElementById('pageSelector');
            pageSelector.innerHTML = '';
            
            pages.forEach((page, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${index + 1}. ${page.title}`;
                if (index === currentPageIndex) {
                    option.selected = true;
                }
                pageSelector.appendChild(option);
            });
        }

        function loadPage(index) {
            if (index < 0 || index >= pages.length) return;
            
            const page = pages[index];
            document.getElementById('pageTitle').textContent = page.title;
            document.getElementById('beforeContent').value = page.beforeContent;
            document.getElementById('afterContent').value = page.afterContent;
            
            loadImages(page.beforeImage, page.afterImage);
            updateNavigationButtons();
            updateMenuItemStyles(); // í˜„ì¬ í˜ì´ì§€ ê°•ì¡° ì—…ë°ì´íŠ¸
            
            document.getElementById('currentPageNum').textContent = index + 1;
            document.getElementById('totalPageNum').textContent = pages.length;
        }

        function loadImages(beforeImage, afterImage) {
            const beforeContainer = document.getElementById('beforeImageContainer');
            const afterContainer = document.getElementById('afterImageContainer');
            
            if (beforeImage) {
                beforeContainer.innerHTML = `
                    <img src="${beforeImage}" class="uploaded-image" alt="ê°œí¸ ì „ ì´ë¯¸ì§€">
                    <div class="image-controls">
                        <button onclick="removeBeforeImage()">Ã—</button>
                    </div>
                `;
            } else {
                beforeContainer.innerHTML = `
                    <div class="image-placeholder">
                        í˜„ì¬ í™”ë©´ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”
                    </div>
                    <div class="image-controls">
                        <button onclick="removeBeforeImage()">Ã—</button>
                    </div>
                `;
            }
            
            if (afterImage) {
                afterContainer.innerHTML = `
                    <img src="${afterImage}" class="uploaded-image" alt="ê°œí¸ í›„ ì´ë¯¸ì§€">
                    <div class="image-controls">
                        <button onclick="removeAfterImage()">Ã—</button>
                    </div>
                `;
            } else {
                afterContainer.innerHTML = `
                    <div class="image-placeholder">
                        ëª©í‘œ í™”ë©´ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”
                    </div>
                    <div class="image-controls">
                        <button onclick="removeAfterImage()">Ã—</button>
                    </div>
                `;
            }
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            prevBtn.disabled = currentPageIndex === 0;
            nextBtn.disabled = currentPageIndex === pages.length - 1;
        }

        function updateProgress() {
            const completedPages = pages.filter(page => page.isCompleted).length;
            const totalPages = pages.length;
            const progress = totalPages > 0 ? (completedPages / totalPages) * 100 : 0;
            
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = 
                `${Math.round(progress)}% ì™„ë£Œ (${completedPages}/${totalPages} í˜ì´ì§€)`;
            
            document.getElementById('totalPages').textContent = `${totalPages}ê°œ`;
            document.getElementById('completedPages').textContent = `${completedPages}ê°œ`;
        }

        function previousPage() {
            if (currentPageIndex > 0) {
                savePage(false);
                currentPageIndex--;
                loadPage(currentPageIndex);
            }
        }

        function nextPage() {
            if (currentPageIndex < pages.length - 1) {
                savePage(false);
                currentPageIndex++;
                loadPage(currentPageIndex);
            }
        }

        function goToPage(index) {
            savePage(false);
            currentPageIndex = parseInt(index);
            loadPage(currentPageIndex);
        }

        function loadFilteredPage(index) {
            if (index < 0 || index >= filteredPages.length) return;
            
            const page = filteredPages[index];
            document.getElementById('pageTitle').textContent = `${currentCategory} > ${page.title}`;
            document.getElementById('beforeContent').value = page.beforeContent;
            document.getElementById('afterContent').value = page.afterContent;
            
            loadImages(page.beforeImage, page.afterImage);
            updateNavigationButtons();
            updateMenuItemStyles(); // í˜„ì¬ í˜ì´ì§€ ê°•ì¡° ì—…ë°ì´íŠ¸
            
            document.getElementById('currentPageNum').textContent = index + 1;
            document.getElementById('totalPageNum').textContent = filteredPages.length;
        }

        function updatePageNavigation() {
            const categorySelector = document.getElementById('categorySelector');
            const pageSelector = document.getElementById('pageSelector');
            
            // ëŒ€ë©”ë‰´ ì„ íƒê¸° ì—…ë°ì´íŠ¸
            categorySelector.innerHTML = '<option value="">ğŸ“‚ ëŒ€ë©”ë‰´ ì„ íƒ</option>';
            Object.keys(menuStructure).forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = `ğŸ“‚ ${category}`;
                if (currentCategory === category) {
                    option.selected = true;
                }
                categorySelector.appendChild(option);
            });
            
            // ì†Œë©”ë‰´ ì„ íƒê¸° ì—…ë°ì´íŠ¸
            if (currentCategory) {
                pageSelector.disabled = false;
                pageSelector.innerHTML = '<option value="">ğŸ“„ ì†Œë©”ë‰´ ì„ íƒ</option>';
                
                filteredPages.forEach((page, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `ğŸ“„ ${page.title}`;
                    if (index === currentPageIndex) {
                        option.selected = true;
                    }
                    pageSelector.appendChild(option);
                });
            } else {
                pageSelector.disabled = true;
                pageSelector.innerHTML = '<option value="">ğŸ“„ ë¨¼ì € ëŒ€ë©”ë‰´ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            }
        }

        function onCategoryChange(categoryName) {
            if (categoryName) {
                handleCategoryClick(categoryName);
            } else {
                // ì „ì²´ ë³´ê¸° ëª¨ë“œë¡œ ì „í™˜
                currentCategory = null;
                filteredPages = [];
                currentPageIndex = 0;
                
                if (pages.length > 0) {
                    loadPage(0);
                } else {
                    document.getElementById('pageTitle').textContent = 'ë©”ì¸ í˜ì´ì§€';
                    document.getElementById('beforeContent').value = '';
                    document.getElementById('afterContent').value = '';
                }
                
                updatePageNavigation();
                renderMenuGrid();
                showSaveModal('ğŸ“‚ ì „ì²´ í˜ì´ì§€ ë³´ê¸° ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (currentCategory) {
                // ì¹´í…Œê³ ë¦¬ ëª¨ë“œ
                prevBtn.disabled = currentPageIndex === 0;
                nextBtn.disabled = currentPageIndex === filteredPages.length - 1;
            } else {
                // ì „ì²´ ëª¨ë“œ
                prevBtn.disabled = currentPageIndex === 0;
                nextBtn.disabled = currentPageIndex === pages.length - 1;
            }
        }

        function previousPage() {
            if (currentCategory) {
                // ì¹´í…Œê³ ë¦¬ ëª¨ë“œ
                if (currentPageIndex > 0) {
                    autoSavePage(); // ìë™ ì €ì¥
                    currentPageIndex--;
                    loadFilteredPage(currentPageIndex);
                }
            } else {
                // ì „ì²´ ëª¨ë“œ
                if (currentPageIndex > 0) {
                    autoSavePage(); // ìë™ ì €ì¥
                    currentPageIndex--;
                    loadPage(currentPageIndex);
                }
            }
        }

        function nextPage() {
            if (currentCategory) {
                // ì¹´í…Œê³ ë¦¬ ëª¨ë“œ
                if (currentPageIndex < filteredPages.length - 1) {
                    autoSavePage(); // ìë™ ì €ì¥
                    currentPageIndex++;
                    loadFilteredPage(currentPageIndex);
                }
            } else {
                // ì „ì²´ ëª¨ë“œ
                if (currentPageIndex < pages.length - 1) {
                    autoSavePage(); // ìë™ ì €ì¥
                    currentPageIndex++;
                    loadPage(currentPageIndex);
                }
            }
        }

        function goToPage(index) {
            if (currentCategory) {
                // ì¹´í…Œê³ ë¦¬ ëª¨ë“œ
                autoSavePage(); // ìë™ ì €ì¥
                currentPageIndex = parseInt(index);
                loadFilteredPage(currentPageIndex);
            } else {
                // ì „ì²´ ëª¨ë“œ
                autoSavePage(); // ìë™ ì €ì¥
                currentPageIndex = parseInt(index);
                loadPage(currentPageIndex);
            }
        }

        function saveCurrentPage(showModal = true) {
            if (currentUserType !== 'admin') return;
            
            let currentPage;
            if (currentCategory) {
                currentPage = filteredPages[currentPageIndex];
            } else {
                currentPage = pages[currentPageIndex];
            }
            
            if (!currentPage) {
                return;
            }
            
            // í…ìŠ¤íŠ¸ ë‚´ìš© ì €ì¥
            const beforeContent = document.getElementById('beforeContent').value;
            const afterContent = document.getElementById('afterContent').value;
            
            currentPage.beforeContent = beforeContent;
            currentPage.afterContent = afterContent;
            
            // ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸
            const isCompleted = updatePageCompletionStatus(currentPage);
            
            // ë°ì´í„° ì €ì¥
            saveData();
            
            if (showModal) {
                const statusText = isCompleted ? 'âœ… ì™„ë£Œë¨' : 'â³ ì§„í–‰ ì¤‘';
                showSaveModal(`ğŸ’¾ '${currentPage.title}' í˜ì´ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nìƒíƒœ: ${statusText}`);
            }
        }

        // í˜ì´ì§€ ì „í™˜ ì‹œ ìë™ ì €ì¥
        function autoSavePage() {
            if (currentUserType === 'admin' && hasUnsavedChanges) {
                console.log('ìë™ ì €ì¥ ì¤‘... (í¸ì§‘ í™œë™ ê°ì§€ë¨)');
                return saveCurrentPage(false);
            }
            return Promise.resolve();
        }

        // ì•ˆì „í•œ ìë™ ì €ì¥ (ë°ì´í„° ê²€ì¦ í¬í•¨)
        async function safeAutoSave() {
            if (currentUserType !== 'admin' || !hasUnsavedChanges) {
                return false;
            }
            
            // í˜„ì¬ í™”ë©´ì˜ ë‚´ìš©ì´ ë¹„ì–´ìˆì§€ ì•Šì€ì§€ í™•ì¸
            const beforeContent = document.getElementById('beforeContent').value.trim();
            const afterContent = document.getElementById('afterContent').value.trim();
            const workNotesContent = document.getElementById('workNotes').value.trim();
            
            // ëª¨ë“  ë‚´ìš©ì´ ë¹„ì–´ìˆìœ¼ë©´ ì €ì¥í•˜ì§€ ì•ŠìŒ (ë°ì´í„° ì†ì‹¤ ë°©ì§€)
            if (!beforeContent && !afterContent && !workNotesContent) {
                console.log('ìë™ì €ì¥ ê±´ë„ˆëœ€: ëª¨ë“  ë‚´ìš©ì´ ë¹„ì–´ìˆìŒ');
                return false;
            }
            
            try {
                await saveCurrentPage(false);
                hasUnsavedChanges = false;
                console.log('ì•ˆì „í•œ ìë™ì €ì¥ ì™„ë£Œ');
                return true;
            } catch (error) {
                console.error('ìë™ì €ì¥ ì‹¤íŒ¨:', error);
                return false;
            }
        }

        function savePage(showModal = true) {
            // ì¹´í…Œê³ ë¦¬ ëª¨ë“œì—ì„œëŠ” saveCurrentPage ì‚¬ìš©
            if (currentCategory) {
                saveCurrentPage(showModal);
                return;
            }
            
            if (currentUserType !== 'admin') return;
            
            const currentPage = pages[currentPageIndex];
            currentPage.beforeContent = document.getElementById('beforeContent').value;
            currentPage.afterContent = document.getElementById('afterContent').value;
            
            const beforeCompleted = currentPage.beforeContent.trim() !== '' || currentPage.beforeImage;
            const afterCompleted = currentPage.afterContent.trim() !== '' || currentPage.afterImage;
            
            currentPage.isCompleted = beforeCompleted && afterCompleted;
            
            updateProgress();
            updateMenuItemStyles();
            saveData();
            
            if (showModal) {
                showSaveModal(`'${currentPage.title}' í˜ì´ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            }
        }

        function saveWorkNotes() {
            if (currentUserType !== 'admin') return;
            
            workNotes = document.getElementById('workNotes').value;
            saveData();
            showSaveModal('ì—…ë¬´ ì§€ì‹œì‚¬í•­ ë° ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        function uploadBeforeImage() {
            if (currentUserType !== 'admin') return;
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // í˜„ì¬ í˜ì´ì§€ ì°¾ê¸°
                        let currentPage;
                        if (currentCategory) {
                            currentPage = filteredPages[currentPageIndex];
                        } else {
                            currentPage = pages[currentPageIndex];
                        }
                        
                        if (currentPage) {
                            // ì´ë¯¸ì§€ ë°ì´í„° ì €ì¥
                            currentPage.beforeImage = e.target.result;
                            
                            // í¸ì§‘ í™œë™ ê¸°ë¡
                            markEditingActivity();
                            
                            // ì´ë¯¸ì§€ í‘œì‹œ ì—…ë°ì´íŠ¸
                            loadImages(currentPage.beforeImage, currentPage.afterImage);
                            
                            // ì¦‰ì‹œ ë°ì´í„° ì €ì¥
                            saveData();
                            
                            // ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸
                            updatePageCompletionStatus(currentPage);
                            
                            // ì €ì¥ ì™„ë£Œ í‘œì‹œ
                            hasUnsavedChanges = false;
                            
                            showSaveModal(`âœ… '${currentPage.title}' í˜ì´ì§€ì˜ ê°œí¸ ì „ ì´ë¯¸ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                        } else {
                            alert('í˜„ì¬ í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        }
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function uploadAfterImage() {
            if (currentUserType !== 'admin') return;
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // í˜„ì¬ í˜ì´ì§€ ì°¾ê¸°
                        let currentPage;
                        if (currentCategory) {
                            currentPage = filteredPages[currentPageIndex];
                        } else {
                            currentPage = pages[currentPageIndex];
                        }
                        
                        if (currentPage) {
                            // ì´ë¯¸ì§€ ë°ì´í„° ì €ì¥
                            currentPage.afterImage = e.target.result;
                            
                            // í¸ì§‘ í™œë™ ê¸°ë¡
                            markEditingActivity();
                            
                            // ì´ë¯¸ì§€ í‘œì‹œ ì—…ë°ì´íŠ¸
                            loadImages(currentPage.beforeImage, currentPage.afterImage);
                            
                            // ì¦‰ì‹œ ë°ì´í„° ì €ì¥
                            saveData();
                            
                            // ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸
                            updatePageCompletionStatus(currentPage);
                            
                            // ì €ì¥ ì™„ë£Œ í‘œì‹œ
                            hasUnsavedChanges = false;
                            
                            showSaveModal(`âœ… '${currentPage.title}' í˜ì´ì§€ì˜ ê°œí¸ í›„ ì´ë¯¸ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                        } else {
                            alert('í˜„ì¬ í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        }
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function updatePageCompletionStatus(page) {
            const beforeCompleted = page.beforeContent.trim() !== '' || page.beforeImage;
            const afterCompleted = page.afterContent.trim() !== '' || page.afterImage;
            
            const wasCompleted = page.isCompleted;
            page.isCompleted = beforeCompleted && afterCompleted;
            
            // UI ì—…ë°ì´íŠ¸
            updateProgress();
            updateMenuItemStyles();
            
            return page.isCompleted;
        }

        function removeBeforeImage() {
            if (currentUserType !== 'admin') return;
            
            // í˜„ì¬ í˜ì´ì§€ ì°¾ê¸°
            let currentPage;
            if (currentCategory) {
                currentPage = filteredPages[currentPageIndex];
            } else {
                currentPage = pages[currentPageIndex];
            }
            
            if (currentPage) {
                currentPage.beforeImage = null;
                markEditingActivity(); // í¸ì§‘ í™œë™ ê¸°ë¡
                loadImages(currentPage.beforeImage, currentPage.afterImage);
                saveData();
                updatePageCompletionStatus(currentPage);
                hasUnsavedChanges = false; // ì €ì¥ ì™„ë£Œ í‘œì‹œ
                showSaveModal(`'${currentPage.title}' í˜ì´ì§€ì˜ ê°œí¸ ì „ ì´ë¯¸ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            }
        }

        function removeAfterImage() {
            if (currentUserType !== 'admin') return;
            
            // í˜„ì¬ í˜ì´ì§€ ì°¾ê¸°
            let currentPage;
            if (currentCategory) {
                currentPage = filteredPages[currentPageIndex];
            } else {
                currentPage = pages[currentPageIndex];
            }
            
            if (currentPage) {
                currentPage.afterImage = null;
                markEditingActivity(); // í¸ì§‘ í™œë™ ê¸°ë¡
                loadImages(currentPage.beforeImage, currentPage.afterImage);
                saveData();
                updatePageCompletionStatus(currentPage);
                hasUnsavedChanges = false; // ì €ì¥ ì™„ë£Œ í‘œì‹œ
                showSaveModal(`'${currentPage.title}' í˜ì´ì§€ì˜ ê°œí¸ í›„ ì´ë¯¸ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            }
        }

        function addNewPage() {
            if (currentUserType !== 'admin') return;
            
            const title = prompt('ìƒˆ í˜ì´ì§€ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:');
            if (!title || !title.trim()) return;
            
            const newPage = {
                title: title.trim(),
                category: "service",
                beforeContent: '',
                afterContent: '',
                beforeImage: null,
                afterImage: null,
                isCompleted: false,
                menuName: title.trim()
            };
            
            pages.push(newPage);
            updateAllDisplays();
            saveData();
            
            currentPageIndex = pages.length - 1;
            loadPage(currentPageIndex);
            
            showSaveModal(`'${title}' í˜ì´ì§€ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        }

        function deleteCurrentPage() {
            if (currentUserType !== 'admin') return;
            
            if (pages.length <= 1) {
                alert('ìµœì†Œ 1ê°œì˜ í˜ì´ì§€ëŠ” í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            const pageTitle = pages[currentPageIndex].title;
            
            if (confirm(`ì •ë§ '${pageTitle}' í˜ì´ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                pages.splice(currentPageIndex, 1);
                
                if (currentPageIndex >= pages.length) {
                    currentPageIndex = pages.length - 1;
                }
                
                updateAllDisplays();
                saveData();
                
                showSaveModal(`'${pageTitle}' í˜ì´ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            }
        }

        async function downloadBackup() {
            try {
                // Supabaseì™€ localStorage ëª¨ë“  ë°ì´í„°ë¥¼ í¬í•¨í•œ ë°±ì—… ìƒì„±
                const localData = {
                    pages: pages,
                    workNotes: workNotes,
                    menuStructure: menuStructure,
                    exportDate: new Date().toISOString(),
                    projectName: 'ëª©í¬ì‹œ í†µí•©ë„ì„œê´€ í™ˆí˜ì´ì§€ ê°œí¸',
                    version: '1.0',
                    totalPages: pages.length,
                    completedPages: pages.filter(p => p.isCompleted).length,
                    dataSource: 'hybrid',
                    supabaseEnabled: isSupabaseReady
                };

                // Supabaseì—ì„œ ìµœì‹  ë°ì´í„°ë„ ê°€ì ¸ì˜¤ê¸° (ê°€ëŠ¥í•œ ê²½ìš°)
                if (isSupabaseReady && supabase) {
                    try {
                        const { data: supabaseData, error } = await supabase
                            .from('mokpo_projects')
                            .select('*')
                            .order('updated_at', { ascending: false })
                            .limit(1);

                        if (!error && supabaseData && supabaseData.length > 0) {
                            localData.supabaseData = supabaseData[0];
                            localData.supabaseLastUpdated = supabaseData[0].updated_at;
                        }
                    } catch (error) {
                        // Supabase ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ë°ì´í„°ë§Œ ì‚¬ìš©
                    }
                }
                
                const jsonString = JSON.stringify(localData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                
                const url = URL.createObjectURL(blob);
                const fileName = `ëª©í¬ì‹œë„ì„œê´€_ê°œí¸í˜„í™©_${new Date().toISOString().split('T')[0]}.json`;
                
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                a.style.display = 'none';
                
                // DOMì— ì¶”ê°€í•˜ê³  í´ë¦­
                document.body.appendChild(a);
                
                // í´ë¦­ ì´ë²¤íŠ¸ ê°•ì œ ì‹¤í–‰
                a.click();
                
                // ì •ë¦¬
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                const message = `âœ… ë°±ì—… íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!

ğŸ“ íŒŒì¼ëª…: ${fileName}
ğŸ“Š ì´ í˜ì´ì§€: ${localData.totalPages}ê°œ
âœ… ì™„ë£Œëœ í˜ì´ì§€: ${localData.completedPages}ê°œ
ğŸ“… ë°±ì—… ë‚ ì§œ: ${new Date().toLocaleDateString('ko-KR')}
${isSupabaseReady ? 'â˜ï¸ Supabase ë°ì´í„° í¬í•¨' : 'ğŸ’¾ ë¡œì»¬ ë°ì´í„°ë§Œ í¬í•¨'}

ğŸ’¡ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì§€ ì•Šì•˜ë‹¤ë©´ ë¸Œë¼ìš°ì €ì˜ ë‹¤ìš´ë¡œë“œ ì°¨ë‹¨ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`;
                
                showSaveModal(message);
                
            } catch (error) {
                // ì—ëŸ¬ ë°œìƒ ì‹œ ëŒ€ì•ˆ ì œê³µ
                showBackupDataModal();
            }
        }

        function showBackupDataModal() {
            // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
            const existingModal = document.getElementById('backupDataModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const data = {
                pages: pages,
                workNotes: workNotes,
                menuStructure: menuStructure,
                exportDate: new Date().toISOString(),
                projectName: 'ëª©í¬ì‹œ í†µí•©ë„ì„œê´€ í™ˆí˜ì´ì§€ ê°œí¸',
                version: '1.0'
            };
            
            const jsonString = JSON.stringify(data, null, 2);
            
            // ë°±ì—… ë°ì´í„° í‘œì‹œ ëª¨ë‹¬ ìƒì„±
            const modal = document.createElement('div');
            modal.id = 'backupDataModal';
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '9999';
            
            modal.innerHTML = `
                <div class="modal-content large">
                    <div class="modal-title" style="color: #28a745; margin-bottom: 20px; text-align: center;">
                        ğŸ’¾ ë°±ì—… ë°ì´í„°
                    </div>
                    <div style="margin-bottom: 20px; text-align: center; color: #666;">
                        <p>íŒŒì¼ ë‹¤ìš´ë¡œë“œê°€ ì§€ì›ë˜ì§€ ì•ŠëŠ” í™˜ê²½ì…ë‹ˆë‹¤.</p>
                        <p>ì•„ë˜ ë°ì´í„°ë¥¼ ë³µì‚¬í•˜ì—¬ í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ì €ì¥í•´ì£¼ì„¸ìš”.</p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">
                            ğŸ“„ íŒŒì¼ëª…: ëª©í¬ì‹œë„ì„œê´€_ê°œí¸í˜„í™©_${new Date().toISOString().split('T')[0]}.json
                        </label>
                        <textarea readonly style="width: 100%; height: 400px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; font-family: monospace; font-size: 12px; background: #f8f9fa;">${jsonString}</textarea>
                    </div>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="copyBackupData()" style="margin-right: 10px;">
                            ğŸ“‹ ë°ì´í„° ë³µì‚¬
                        </button>
                        <button class="btn btn-secondary" onclick="closeBackupDataModal()">
                            âœ–ï¸ ë‹«ê¸°
                        </button>
                    </div>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <h4 style="color: #856404; margin-bottom: 10px;">ğŸ’¡ ì‚¬ìš© ë°©ë²•</h4>
                        <p style="margin: 5px 0; font-size: 14px; color: #856404;">
                            1. "ë°ì´í„° ë³µì‚¬" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë°±ì—… ë°ì´í„°ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬<br>
                            2. í…ìŠ¤íŠ¸ ì—ë””í„°(ë©”ëª¨ì¥ ë“±)ë¥¼ ì—´ê³  Ctrl+Vë¡œ ë¶™ì—¬ë„£ê¸°<br>
                            3. íŒŒì¼ì„ .json í™•ì¥ìë¡œ ì €ì¥<br>
                            4. ë‚˜ì¤‘ì— "ë°±ì—… ì—…ë¡œë“œ" ê¸°ëŠ¥ìœ¼ë¡œ ë³µì› ê°€ëŠ¥
                        </p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
            window.copyBackupData = () => {
                const textarea = modal.querySelector('textarea');
                textarea.select();
                textarea.setSelectionRange(0, 99999); // ëª¨ë°”ì¼ ì§€ì›
                
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        showSaveModal('âœ… ë°±ì—… ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì´ì œ í…ìŠ¤íŠ¸ ì—ë””í„°ì— ë¶™ì—¬ë„£ê³  .json íŒŒì¼ë¡œ ì €ì¥í•˜ì„¸ìš”.');
                    } else {
                        throw new Error('ë³µì‚¬ ì‹¤íŒ¨');
                    }
                } catch (err) {
                    // ìˆ˜ë™ ë³µì‚¬ ì•ˆë‚´
                    textarea.focus();
                    showSaveModal('ğŸ“‹ Ctrl+Aë¡œ ì „ì²´ ì„ íƒ í›„ Ctrl+Cë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.\n\nê·¸ ë‹¤ìŒ í…ìŠ¤íŠ¸ ì—ë””í„°ì— ë¶™ì—¬ë„£ê³  .json íŒŒì¼ë¡œ ì €ì¥í•˜ì„¸ìš”.');
                }
            };
            
            window.closeBackupDataModal = () => {
                modal.remove();
            };
            
            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        async function uploadBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            
                            // ë°±ì—… íŒŒì¼ ë°ì´í„° ë³µì›
                            if (data.pages) pages = data.pages;
                            if (data.workNotes) {
                                workNotes = data.workNotes;
                                document.getElementById('workNotes').value = workNotes;
                            }
                            if (data.menuStructure) menuStructure = data.menuStructure;
                            
                            // UI ì—…ë°ì´íŠ¸
                            updateAllDisplays();
                            renderMenuGrid();
                            
                            // ë°ì´í„° ì €ì¥ (Supabase + localStorage)
                            await saveData();
                            
                            // ì„±ê³µ ë©”ì‹œì§€
                            const isHybridBackup = data.dataSource === 'hybrid';
                            const hasSupabaseData = data.supabaseData !== undefined;
                            
                            let message = 'âœ… ë°±ì—… íŒŒì¼ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!\n\n';
                            message += `ğŸ“Š ë³µì›ëœ í˜ì´ì§€: ${data.totalPages || pages.length}ê°œ\n`;
                            message += `âœ… ì™„ë£Œëœ í˜ì´ì§€: ${data.completedPages || pages.filter(p => p.isCompleted).length}ê°œ\n`;
                            
                            if (isHybridBackup) {
                                message += hasSupabaseData ? 
                                    'â˜ï¸ Supabase ë°ì´í„°ê°€ í¬í•¨ëœ ë°±ì—…ì…ë‹ˆë‹¤.\n' : 
                                    'ğŸ’¾ ë¡œì»¬ ë°ì´í„° ë°±ì—…ì…ë‹ˆë‹¤.\n';
                            }
                            
                            if (isSupabaseReady) {
                                message += 'â˜ï¸ ë°ì´í„°ê°€ í´ë¼ìš°ë“œì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
                            } else {
                                message += 'ğŸ’¾ ë°ì´í„°ê°€ ë¡œì»¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
                            }
                            
                            showSaveModal(message);
                            
                        } catch (error) {
                            alert('ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë°±ì—… íŒŒì¼ì…ë‹ˆë‹¤.\n\níŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function resetData() {
            if (confirm('ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('mokpo_library_data');
                location.reload();
            }
        }

        function showSaveModal(message) {
            document.getElementById('saveMessage').textContent = message;
            document.getElementById('saveModal').style.display = 'block';
        }

        function closeSaveModal() {
            document.getElementById('saveModal').style.display = 'none';
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.addEventListener('DOMContentLoaded', function() {
            // Supabase ì´ˆê¸°í™” (ì ‘ì†ì ìˆ˜ ê´€ë¦¬ í¬í•¨)
            initializeSupabase();
            
            // ìë™ ë¡œê·¸ì¸ ì²´í¬ (ìƒˆë¡œê³ ì¹¨ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ ë³µì›)
            const autoLoginSuccess = checkAutoLogin();
            
            // ìë™ ë¡œê·¸ì¸ì´ ì‹¤íŒ¨í•œ ê²½ìš°ì—ë§Œ ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ
            if (!autoLoginSuccess) {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainContent').style.display = 'none';
            }
            
            // ì ‘ì†ì ìˆ˜ í‘œì‹œ ì´ˆê¸°í™” (ì•½ê°„ì˜ ì§€ì—° í›„)
            setTimeout(() => {
                updateOnlineCountDisplay();
            }, 500);
            
            // í¸ì§‘ ê°ì§€ë¥¼ ìœ„í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            setupEditingDetection();
            
            document.getElementById('loginInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    attemptLogin();
                }
            });
            
            window.addEventListener('click', function(event) {
                const saveModal = document.getElementById('saveModal');
                const menuModal = document.getElementById('menuEditorModal');
                if (event.target === saveModal) {
                    closeSaveModal();
                }
                if (event.target === menuModal) {
                    closeMenuEditor();
                }
            });
            
            // ìŠ¤ë§ˆíŠ¸ ìë™ ì €ì¥ (í¸ì§‘ í™œë™ì´ ìˆì„ ë•Œë§Œ)
            setInterval(async () => {
                if (currentUserType === 'admin' && !isReceivingUpdate && hasUnsavedChanges) {
                    // í¸ì§‘ í™œë™ ì²´í¬
                    if (checkEditingActivity()) {
                        const now = new Date().getTime();
                        const timeSinceLastEdit = now - lastEditTime;
                        
                        // ë§ˆì§€ë§‰ í¸ì§‘ í›„ 10ì´ˆê°€ ì§€ë‚˜ì•¼ ìë™ì €ì¥ (íƒ€ì´í•‘ ì¤‘ì—ëŠ” ì €ì¥ ì•ˆí•¨)
                        if (timeSinceLastEdit > 10000) {
                            try {
                                console.log('ìŠ¤ë§ˆíŠ¸ ìë™ì €ì¥ ì‹¤í–‰:', new Date().toLocaleTimeString());
                                const success = await safeAutoSave();
                                if (success) {
                                    showSyncIndicator('ğŸ’¾ ìë™ ì €ì¥ë¨');
                                }
                            } catch (error) {
                                console.error('ìë™ ì €ì¥ ì‹¤íŒ¨:', error);
                            }
                        }
                    } else {
                        // í¸ì§‘ í™œë™ì´ ì—†ìœ¼ë©´ ì €ì¥ë˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ í”Œë˜ê·¸ í•´ì œ
                        console.log('í¸ì§‘ í™œë™ ì—†ìŒ - ìë™ì €ì¥ ê±´ë„ˆëœ€');
                    }
                }
            }, 15000); // 15ì´ˆë§ˆë‹¤ ì²´í¬
            
            // í¸ì§‘ ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸ (5ì´ˆë§ˆë‹¤)
            setInterval(() => {
                if (currentUserType === 'admin') {
                    const editStatus = document.getElementById('editStatus');
                    if (!editStatus) {
                        // í¸ì§‘ ìƒíƒœ í‘œì‹œ ìš”ì†Œ ìƒì„±
                        const statusDiv = document.createElement('div');
                        statusDiv.id = 'editStatus';
                        statusDiv.style.cssText = `
                            position: fixed;
                            bottom: 80px;
                            right: 20px;
                            padding: 8px 12px;
                            border-radius: 20px;
                            font-size: 12px;
                            font-weight: 600;
                            z-index: 1000;
                            display: none;
                        `;
                        document.body.appendChild(statusDiv);
                    }
                    
                    const editStatusDiv = document.getElementById('editStatus');
                    if (hasUnsavedChanges && isActivelyEditing) {
                        editStatusDiv.style.display = 'block';
                        editStatusDiv.style.background = 'linear-gradient(45deg, #ff9800, #f57c00)';
                        editStatusDiv.style.color = 'white';
                        editStatusDiv.textContent = 'âœï¸ í¸ì§‘ ì¤‘...';
                    } else if (hasUnsavedChanges) {
                        editStatusDiv.style.display = 'block';
                        editStatusDiv.style.background = 'linear-gradient(45deg, #ffc107, #ffb300)';
                        editStatusDiv.style.color = 'white';
                        editStatusDiv.textContent = 'ğŸ’¾ ì €ì¥ ëŒ€ê¸° ì¤‘';
                    } else {
                        editStatusDiv.style.display = 'none';
                    }
                }
            }, 5000);
            
            // í˜ì´ì§€ ì¢…ë£Œ ì „ ì €ì¥ ë° ì •ë¦¬
            window.addEventListener('beforeunload', async function(e) {
                // ì €ì¥ë˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ ë§ˆì§€ë§‰ ì €ì¥ ì‹œë„
                if (currentUserType === 'admin' && hasUnsavedChanges) {
                    try {
                        console.log('í˜ì´ì§€ ì¢…ë£Œ ì „ ë§ˆì§€ë§‰ ì €ì¥ ì‹œë„');
                        await safeAutoSave();
                    } catch (error) {
                        console.error('ì¢…ë£Œ ì „ ì €ì¥ ì‹¤íŒ¨:', error);
                    }
                }
                
                // í¸ì§‘ ì¢…ë£Œ ë¸Œë¡œë“œìºìŠ¤íŠ¸
                broadcastEditingStopped();
                
                // ì˜¨ë¼ì¸ ì‚¬ìš©ìì—ì„œ ì œê±°
                if (onlineUsersChannel) {
                    try {
                        await onlineUsersChannel.untrack();
                        onlineUsersChannel.unsubscribe();
                    } catch (error) {
                        // ì •ë¦¬ ì‹¤íŒ¨ ë¬´ì‹œ
                    }
                }
                
                // ë°ì´í„° ì±„ë„ ì •ë¦¬
                if (dataChannel) {
                    try {
                        dataChannel.unsubscribe();
                    } catch (error) {
                        // ì •ë¦¬ ì‹¤íŒ¨ ë¬´ì‹œ
                    }
                }
            });
        });

        // í¸ì§‘ ê°ì§€ ì‹œìŠ¤í…œ ì„¤ì •
        function setupEditingDetection() {
            const editableElements = ['beforeContent', 'afterContent', 'workNotes'];
            let editingTimeout = null;
            
            editableElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    // í¬ì»¤ìŠ¤ ì‹œ í¸ì§‘ ì‹œì‘
                    element.addEventListener('focus', () => {
                        if (currentUserType === 'admin' && !editingUser) {
                            console.log(`í¸ì§‘ ì‹œì‘: ${id}`);
                            markEditingActivity();
                            broadcastEditingStarted();
                        }
                    });
                    
                    // ì…ë ¥ ì‹œ í¸ì§‘ í™œë™ ê¸°ë¡
                    element.addEventListener('input', () => {
                        if (currentUserType === 'admin') {
                            console.log(`í¸ì§‘ í™œë™: ${id}`, element.value.length, 'ê¸€ì');
                            markEditingActivity(); // í¸ì§‘ ì‹œê°„ ì—…ë°ì´íŠ¸
                            
                            // ê¸°ì¡´ íƒ€ì´ë¨¸ ì·¨ì†Œ
                            if (editingTimeout) {
                                clearTimeout(editingTimeout);
                            }
                            
                            // 5ì´ˆ í›„ í¸ì§‘ ì¢…ë£Œ (ì…ë ¥ì´ ë©ˆì¶”ë©´)
                            editingTimeout = setTimeout(() => {
                                console.log('í¸ì§‘ í™œë™ íƒ€ì„ì•„ì›ƒ');
                                broadcastEditingStopped();
                            }, 5000);
                        }
                    });
                    
                    // í‚¤ ì…ë ¥ ê°ì§€ (ë¶™ì—¬ë„£ê¸°, ì‚­ì œ ë“±)
                    element.addEventListener('keydown', () => {
                        if (currentUserType === 'admin') {
                            markEditingActivity();
                        }
                    });
                    
                    // ë¶™ì—¬ë„£ê¸° ê°ì§€
                    element.addEventListener('paste', () => {
                        if (currentUserType === 'admin') {
                            console.log(`ë¶™ì—¬ë„£ê¸° ê°ì§€: ${id}`);
                            markEditingActivity();
                        }
                    });
                    
                    // ë¸”ëŸ¬ ì‹œ í¸ì§‘ ì¢…ë£Œ (ì•½ê°„ì˜ ì§€ì—° í›„)
                    element.addEventListener('blur', () => {
                        if (currentUserType === 'admin' && isEditing) {
                            setTimeout(() => {
                                // ë‹¤ë¥¸ í¸ì§‘ ê°€ëŠ¥í•œ ìš”ì†Œì— í¬ì»¤ìŠ¤ê°€ ì—†ìœ¼ë©´ í¸ì§‘ ì¢…ë£Œ
                                const focusedElement = document.activeElement;
                                if (!editableElements.includes(focusedElement.id)) {
                                    console.log('í¸ì§‘ ì¢…ë£Œ: í¬ì»¤ìŠ¤ ì•„ì›ƒ');
                                    broadcastEditingStopped();
                                }
                            }, 100);
                        }
                    });
                }
            });
            
            // ì´ë¯¸ì§€ ì—…ë¡œë“œë„ í¸ì§‘ í™œë™ìœ¼ë¡œ ê°„ì£¼
            const imageButtons = ['beforeImageBtn', 'afterImageBtn'];
            imageButtons.forEach(id => {
                const button = document.getElementById(id);
                if (button) {
                    button.addEventListener('click', () => {
                        if (currentUserType === 'admin') {
                            console.log(`ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘: ${id}`);
                            markEditingActivity();
                        }
                    });
                }
            });
        }
    </script>
</body>
</html>